<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="IAML Program Schedule - View upcoming workplace law training programs. Multiple formats including virtual and in-person options.">
  <meta name="keywords" content="employment law training, HR training schedule, IAML programs, workplace law seminars">
  <meta name="author" content="Institute for Applied Management & Law">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

  <title>Program Schedule V2A (Minimal) - IAML</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Lato:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Main CSS -->
  <link rel="stylesheet" href="../css/main.css">

  <!-- Page-Specific Styles -->
  <style>
    /* Hero Section */
    .program-schedule-hero {
      text-align: center;
      max-width: 1000px;
      width: 100%;
      margin: 0 auto;
      padding: 40px 20px;
      padding-top: 140px;
      padding-bottom: 60px;
    }

    .program-schedule-hero .trusted-text {
      color: #3b82f6;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 32px;
    }

    .program-schedule-hero .main-headline {
      font-family: 'Playfair Display', serif;
      font-size: 3.5rem;
      font-weight: 400;
      color: white;
      line-height: 1.1;
      margin-bottom: 24px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .program-schedule-hero .description {
      font-family: 'Lato', sans-serif;
      font-size: 1.25rem;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.6;
      margin-bottom: 0;
      max-width: 850px;
      margin-left: auto;
      margin-right: auto;
    }

    .program-schedule-hero .version-badge {
      display: inline-block;
      padding: 8px 16px;
      background: var(--gold-accent);
      color: #fff;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-radius: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .program-schedule-hero {
        padding-top: 104px;
      }
      .program-schedule-hero .main-headline {
        font-size: 2.5rem;
      }
      .program-schedule-hero .description {
        font-size: 1.1rem;
      }
    }

    /* Schedule Section */
    .schedule-section {
      padding: var(--space-3xl) 0 var(--space-5xl);
      min-height: 60vh;
    }
  </style>
</head>

<body>

  <!-- ===== HEADER ===== -->
  <div id="header-placeholder"></div>

  <!-- ===== MAIN CONTENT ===== -->
  <main>

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="program-schedule-hero">
        <span class="version-badge">Version A: Minimal Rows</span>
        <p class="trusted-text">CERTIFICATE PROGRAMS &bull; IN-PERSON & VIRTUAL</p>
        <h1 class="main-headline">Upcoming Programs</h1>
        <p class="description">
          Clean, scannable layout with all block details visible. Perfect for quick comparison of program schedules.
        </p>
      </div>
    </section>

    <!-- Schedule Section -->
    <section class="schedule-section">
      <div class="schedule-v2a-container">
        <!-- Filters -->
        <div class="schedule-v2a-filters">
          <select class="schedule-v2a-filter" id="formatFilter" aria-label="Filter by format">
            <option value="">All Formats</option>
            <option value="in-person">In-Person</option>
            <option value="virtual">Virtual</option>
          </select>
          <select class="schedule-v2a-filter" id="programFilter" aria-label="Filter by program">
            <option value="">All Programs</option>
          </select>
          <button class="schedule-v2a-clear" id="clearFilters">Clear</button>
        </div>

        <!-- Program List -->
        <div class="schedule-v2a-list" id="programList" role="list">
          <div class="schedule-v2-loading">
            <div class="schedule-v2-loading-spinner"></div>
            <p>Loading programs...</p>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- ===== FOOTER ===== -->
  <div id="footer-placeholder"></div>

  <!-- Program Details Modal -->
  <div class="programModal-overlay" id="programModal" onclick="closeProgramModal(event)">
    <div class="programModal-content" onclick="event.stopPropagation();">
      <button class="programModal-close" onclick="closeProgramModal()" aria-label="Close">&times;</button>
      <div class="programModal-image" id="programModal-image"></div>
      <div class="programModal-body">
        <div class="programModal-format-badge" id="programModal-format"></div>
        <h2 class="programModal-title" id="programModal-title"></h2>
        <div class="programModal-meta">
          <div class="programModal-meta-item">
            <span class="programModal-meta-label">Dates</span>
            <span class="programModal-meta-value" id="programModal-dates"></span>
          </div>
          <div class="programModal-meta-item">
            <span class="programModal-meta-label">Duration</span>
            <span class="programModal-meta-value" id="programModal-duration"></span>
          </div>
          <div class="programModal-meta-item">
            <span class="programModal-meta-label">Location</span>
            <span class="programModal-meta-value" id="programModal-location"></span>
          </div>
        </div>
        <div class="programModal-blocks" id="programModal-blocks"></div>
        <div class="programModal-actions">
          <a href="#" class="programModal-btn programModal-btn-primary" id="programModal-register">Register Now</a>
          <a href="#" class="programModal-btn programModal-btn-secondary" id="programModal-details">View Full Details</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== SCRIPTS ===== -->
  <script src="../js/components.js" defer></script>
  <script src="../js/utm-tracking.js" defer></script>
  <script src="../js/headerBehavior.js" defer></script>
  <script src="../js/mobileMenu.js" defer></script>

  <script>
    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    const TABLE_ID = 'tblympiL1p6PmQz9i';
    let allPrograms = [];

    // Whitelist of certificate programs only (no standalone blocks, no on-demand)
    const ALLOWED_PROGRAMS = [
      'Certificate in Employee Relations Law',
      'Advanced Certificate in Strategic Employment Law',
      'Certificate in Workplace Investigations',
      'Certificate in Strategic HR Leadership',
      'Certificate in Employee Benefits Law',
      'Advanced Certificate in Employee Benefits Law'
    ];

    // Program name to slug mapping
    const PROGRAM_SLUG_MAP = {
      'Certificate in Employee Relations Law': 'employee-relations-law',
      'Advanced Certificate in Strategic Employment Law': 'strategic-employment-law',
      'Certificate in Strategic HR Leadership': 'strategic-hr',
      'Certificate in Workplace Investigations': 'workplace-investigations',
      'Certificate in Employee Benefits Law': 'employee-benefits-law',
      'Advanced Certificate in Employee Benefits Law': 'advanced-benefits-law'
    };

    // Block days mapping by program
    const BLOCK_DAYS_MAP = {
      'Certificate in Employee Relations Law': {
        1: 'Monday - Tuesday',
        2: 'Wednesday - Thursday',
        3: 'Friday'
      },
      'Certificate in Strategic HR Leadership': {
        1: 'Monday - Tuesday',
        2: 'Wednesday - Friday'
      },
      'Certificate in Employee Benefits Law': {
        1: 'Monday - Tuesday',
        2: 'Wednesday',
        3: 'Thursday - Friday'
      }
    };

    // ============================================================================
    // DATA LOADING
    // ============================================================================
    async function loadProgramsFromAirtable() {
      const listEl = document.getElementById('programList');

      try {
        const filterFormula = encodeURIComponent("{Show on Website}=TRUE()");
        const response = await fetch(
          `/api/airtable-programs?table=${TABLE_ID}&filterByFormula=${filterFormula}&sort[0][field]=Start Date&sort[0][direction]=asc`
        );

        if (!response.ok) throw new Error('Failed to load programs');

        const data = await response.json();
        const records = data.records || [];

        // Transform and filter to certificate programs only, exclude on-demand
        allPrograms = records
          .map(transformRecord)
          .filter(p => ALLOWED_PROGRAMS.includes(p.title) && p.format !== 'on-demand');

        // Populate filter dropdowns
        populateFilters(allPrograms);

        // Render programs
        renderPrograms(allPrograms);

      } catch (error) {
        console.error('Error loading programs:', error);
        listEl.innerHTML = `
          <div class="schedule-v2-empty">
            <p>Unable to load program schedule. Please try again later.</p>
          </div>
        `;
      }
    }

    function transformRecord(record) {
      const f = record.fields;
      const rawProgramName = f['Program Name'];
      const programName = Array.isArray(rawProgramName) ? rawProgramName[0] : (rawProgramName || f['Instance Name'] || 'Untitled Program');

      // Build blocks array
      const blocks = [];
      if (f['Block 1 Title']) {
        blocks.push({
          number: 1,
          title: f['Block 1 Title'],
          dates: f['Block 1 Dates'] || '',
          times: f['Block 1 Times'] || '',
          instructor: f['Full Name with Credentials (from Block 1 Instructor)']?.[0] || f['Block 1 Instructor'] || ''
        });
      }
      if (f['Block 2 Title']) {
        blocks.push({
          number: 2,
          title: f['Block 2 Title'],
          dates: f['Block 2 Dates'] || '',
          times: f['Block 2 Times'] || '',
          instructor: f['Full Name with Credentials (from Block 2 Instructor)']?.[0] || f['Block 2 Instructor'] || ''
        });
      }
      if (f['Block 3 Title']) {
        blocks.push({
          number: 3,
          title: f['Block 3 Title'],
          dates: f['Block 3 Dates'] || '',
          times: f['Block 3 Times'] || '',
          instructor: f['Full Name with Credentials (from Block 3 Instructor)']?.[0] || f['Block 3 Instructor'] || ''
        });
      }

      return {
        id: record.id,
        title: programName,
        slug: PROGRAM_SLUG_MAP[programName] || programName.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
        location: f['City'] ? `${f['City']}, ${f['State/Province'] || ''}`.trim().replace(/,\s*$/, '') : 'Virtual',
        venue: f['Location'] || (f['Format']?.toLowerCase().includes('virtual') ? 'Online Live Sessions' : ''),
        startDate: formatDisplayDate(f['Start Date']),
        endDate: formatDisplayDate(f['End Date']),
        rawStartDate: f['Start Date'],
        rawEndDate: f['End Date'],
        format: normalizeFormat(f['Format']),
        formatDisplay: f['Format'] || 'In-Person',
        image: f['Hero Image URL'] || 'https://images.unsplash.com/photo-1582719508461-905c673771fd?w=800',
        registrationUrl: f['Registration URL'] || '/register',
        enrollmentStatus: f['Enrollment Status'],
        duration: f['Duration (Days)'] || '',
        blocks: blocks
      };
    }

    function formatDisplayDate(dateStr) {
      if (!dateStr) return '';
      const [y, m, d] = dateStr.split('-').map(Number);
      const date = new Date(Date.UTC(y, m - 1, d));
      return date.toLocaleDateString('en-US', {
        month: 'long', day: 'numeric', year: 'numeric', timeZone: 'UTC'
      });
    }

    function normalizeFormat(format) {
      if (!format) return 'in-person';
      const lower = format.toLowerCase();
      if (lower.includes('virtual')) return 'virtual';
      if (lower.includes('demand')) return 'on-demand';
      return 'in-person';
    }

    function formatDateRange(rawStart, rawEnd) {
      if (!rawStart || !rawEnd) return '';

      const [sy, sm, sd] = rawStart.split('-').map(Number);
      const [ey, em, ed] = rawEnd.split('-').map(Number);

      const startMonth = new Date(Date.UTC(sy, sm - 1, sd))
        .toLocaleDateString('en-US', { month: 'long', timeZone: 'UTC' });
      const endMonth = new Date(Date.UTC(ey, em - 1, ed))
        .toLocaleDateString('en-US', { month: 'long', timeZone: 'UTC' });

      if (sy === ey && sm === em) {
        return `${startMonth} ${sd} - ${ed}, ${sy}`;
      }
      return `${startMonth} ${sd}, ${sy} - ${endMonth} ${ed}, ${ey}`;
    }

    // ============================================================================
    // FILTERS
    // ============================================================================
    function populateFilters(programs) {
      const titles = [...new Set(programs.map(p => p.title))].sort();

      const programSelect = document.getElementById('programFilter');
      programSelect.innerHTML = '<option value="">All Programs</option>';
      titles.forEach(t => {
        programSelect.innerHTML += `<option value="${t}">${t}</option>`;
      });
    }

    function filterPrograms() {
      const format = document.getElementById('formatFilter').value;
      const program = document.getElementById('programFilter').value;

      const filtered = allPrograms.filter(p => {
        if (format && p.format !== format) return false;
        if (program && p.title !== program) return false;
        return true;
      });

      renderPrograms(filtered);
    }

    // ============================================================================
    // RENDER - VERSION A (Minimal Rows)
    // ============================================================================
    function renderPrograms(programs) {
      const listEl = document.getElementById('programList');

      if (programs.length === 0) {
        listEl.innerHTML = '<div class="schedule-v2-empty"><p>No programs match your filters.</p></div>';
        return;
      }

      listEl.innerHTML = programs.map(program => {
        const programDays = BLOCK_DAYS_MAP[program.title] || {};

        const blocksHtml = program.blocks.map(block => {
          const blockDays = programDays[block.number] || '';
          return `
            <div class="schedule-v2a-block">
              <span class="schedule-v2a-block-label">Block ${block.number}</span>
              <span class="schedule-v2a-block-title">${block.title}</span>
              <span class="schedule-v2a-block-days">${blockDays}</span>
              <span class="schedule-v2a-block-instructor">${block.instructor}</span>
            </div>
          `;
        }).join('');

        return `
          <article class="schedule-v2a-row" role="listitem">
            <div class="schedule-v2a-col-image">
              <img src="${program.image}" alt="${program.title}" class="schedule-v2a-thumbnail" loading="lazy">
              <div class="schedule-v2a-program-info">
                <h3 class="schedule-v2a-title">${program.title}</h3>
                <div class="schedule-v2a-meta">
                  <span class="schedule-v2a-dates">${formatDateRange(program.rawStartDate, program.rawEndDate)}</span>
                  <span>${program.location}</span>
                  <span class="schedule-v2a-format ${program.format}">${program.formatDisplay}</span>
                </div>
              </div>
            </div>
            <div class="schedule-v2a-col-blocks">
              ${blocksHtml || '<p style="color: rgba(255,255,255,0.6); font-size: 0.875rem;">Block details coming soon</p>'}
            </div>
            <div class="schedule-v2a-col-action">
              <button class="schedule-v2a-btn-learn" onclick="openProgramModal('${program.id}')">Learn More</button>
            </div>
          </article>
        `;
      }).join('');
    }

    // ============================================================================
    // MODAL
    // ============================================================================
    function openProgramModal(programId) {
      const program = allPrograms.find(p => p.id === programId);
      if (!program) return;

      document.getElementById('programModal-image').style.backgroundImage = `url('${program.image}')`;
      document.getElementById('programModal-title').textContent = program.title;
      document.getElementById('programModal-dates').textContent = formatDateRange(program.rawStartDate, program.rawEndDate);
      document.getElementById('programModal-duration').textContent = program.duration ? `${program.duration} days` : 'Contact for details';
      document.getElementById('programModal-location').textContent = program.venue ? `${program.location} â€¢ ${program.venue}` : program.location;

      const formatBadge = document.getElementById('programModal-format');
      formatBadge.textContent = program.formatDisplay;
      formatBadge.className = `programModal-format-badge ${program.format}`;

      // Render blocks
      const blocksContainer = document.getElementById('programModal-blocks');
      if (program.blocks && program.blocks.length > 0) {
        const programDays = BLOCK_DAYS_MAP[program.title] || {};
        blocksContainer.innerHTML = `
          <h3 class="programModal-blocks-title">Program Schedule</h3>
          ${program.blocks.map(block => {
            const blockDays = programDays[block.number] || '';
            return `
            <div class="programModal-block">
              <div class="programModal-block-header">
                <span class="programModal-block-number">Block ${block.number}</span>
                <span class="programModal-block-title">${block.title}</span>
              </div>
              <div class="programModal-block-details">
                ${blockDays ? `<div class="programModal-block-days">${blockDays}</div>` : ''}
                ${block.instructor ? `<div class="programModal-block-instructor">${block.instructor}</div>` : ''}
              </div>
            </div>
          `}).join('')}
        `;
        blocksContainer.style.display = 'block';
      } else {
        blocksContainer.innerHTML = '';
        blocksContainer.style.display = 'none';
      }

      document.getElementById('programModal-register').href = program.registrationUrl;
      document.getElementById('programModal-details').href = `/programs/${program.slug}?format=${program.format}`;

      document.getElementById('programModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeProgramModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('programModal').classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    document.getElementById('formatFilter').addEventListener('change', filterPrograms);
    document.getElementById('programFilter').addEventListener('change', filterPrograms);
    document.getElementById('clearFilters').addEventListener('click', () => {
      document.getElementById('formatFilter').value = '';
      document.getElementById('programFilter').value = '';
      renderPrograms(allPrograms);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('programModal');
        if (modal.classList.contains('active')) {
          closeProgramModal();
        }
      }
    });

    // Load on page ready
    document.addEventListener('DOMContentLoaded', loadProgramsFromAirtable);
  </script>

</body>
</html>

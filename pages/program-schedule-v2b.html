<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="IAML Program Schedule - View upcoming workplace law training programs. Multiple formats including virtual and in-person options.">
  <meta name="keywords" content="employment law training, HR training schedule, IAML programs, workplace law seminars">
  <meta name="author" content="Institute for Applied Management & Law">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

  <title>Program Schedule V2B (Card-Row) - IAML</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Lato:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Main CSS -->
  <link rel="stylesheet" href="../css/main.css">

  <!-- Page-Specific Styles -->
  <style>
    /* Hero Section */
    .program-schedule-hero {
      text-align: center;
      max-width: 1000px;
      width: 100%;
      margin: 0 auto;
      padding: 40px 20px;
      padding-top: 140px;
      padding-bottom: 60px;
    }

    .program-schedule-hero .trusted-text {
      color: #3b82f6;
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 32px;
    }

    .program-schedule-hero .main-headline {
      font-family: 'Playfair Display', serif;
      font-size: 3.5rem;
      font-weight: 400;
      color: white;
      line-height: 1.1;
      margin-bottom: 24px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .program-schedule-hero .description {
      font-family: 'Lato', sans-serif;
      font-size: 1.25rem;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.6;
      margin-bottom: 0;
      max-width: 850px;
      margin-left: auto;
      margin-right: auto;
    }

    .program-schedule-hero .version-badge {
      display: inline-block;
      padding: 8px 16px;
      background: var(--blue-primary);
      color: #fff;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-radius: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .program-schedule-hero {
        padding-top: 104px;
      }
      .program-schedule-hero .main-headline {
        font-size: 2.5rem;
      }
      .program-schedule-hero .description {
        font-size: 1.1rem;
      }
    }

    /* Schedule Section */
    .schedule-section {
      padding: var(--space-3xl) 0 var(--space-5xl);
      min-height: 60vh;
    }
  </style>
</head>

<body>

  <!-- ===== HEADER ===== -->
  <div id="header-placeholder"></div>

  <!-- ===== MAIN CONTENT ===== -->
  <main>

    <!-- Hero Section -->
    <section class="hero-section">
      <div class="program-schedule-hero">
        <span class="version-badge">Version B: Card-Row Hybrid</span>
        <p class="trusted-text">CERTIFICATE PROGRAMS &bull; IN-PERSON & VIRTUAL</p>
        <h1 class="main-headline">Upcoming Programs</h1>
        <p class="description">
          Bold card-based layout with large images and visual block badges. Premium feel with clear hierarchy.
        </p>
      </div>
    </section>

    <!-- Schedule Section -->
    <section class="schedule-section">
      <div class="schedule-v2b-container">
        <!-- Filters -->
        <div class="schedule-v2b-filters">
          <select class="schedule-v2b-filter" id="programTypeFilter" aria-label="Filter by program type">
            <option value="">All Types</option>
            <option value="employment-law">Employment Law</option>
            <option value="benefits-law">Benefits Law</option>
            <option value="hr-management">HR Management</option>
          </select>
          <select class="schedule-v2b-filter" id="formatFilter" aria-label="Filter by format">
            <option value="">All Formats</option>
            <option value="in-person">In-Person</option>
            <option value="virtual">Virtual</option>
          </select>
          <select class="schedule-v2b-filter" id="programFilter" aria-label="Filter by program">
            <option value="">All Programs</option>
          </select>
          <button class="schedule-v2b-clear" id="clearFilters">Clear</button>
        </div>

        <!-- Program List -->
        <div class="schedule-v2b-list" id="programList">
          <div class="schedule-v2-loading">
            <div class="schedule-v2-loading-spinner"></div>
            <p>Loading programs...</p>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- ===== FOOTER ===== -->
  <div id="footer-placeholder"></div>

  <!-- Program Details Modal -->
  <div class="programModal-overlay" id="programModal" onclick="closeProgramModal(event)">
    <div class="programModal-content" onclick="event.stopPropagation();">
      <button class="programModal-close" onclick="closeProgramModal()" aria-label="Close">&times;</button>
      <div class="programModal-image" id="programModal-image"></div>
      <div class="programModal-body">
        <div class="programModal-format-badge" id="programModal-format"></div>
        <h2 class="programModal-title" id="programModal-title"></h2>
        <div class="programModal-meta">
          <div class="programModal-meta-item">
            <span class="programModal-meta-label">Dates</span>
            <span class="programModal-meta-value" id="programModal-dates"></span>
          </div>
          <div class="programModal-meta-item">
            <span class="programModal-meta-label">Duration</span>
            <span class="programModal-meta-value" id="programModal-duration"></span>
          </div>
          <div class="programModal-meta-item">
            <span class="programModal-meta-label">Location</span>
            <span class="programModal-meta-value" id="programModal-location"></span>
          </div>
        </div>
        <div class="programModal-blocks" id="programModal-blocks"></div>
        <div class="programModal-actions">
          <a href="#" class="programModal-btn programModal-btn-primary" id="programModal-register">Register Now</a>
          <a href="#" class="programModal-btn programModal-btn-secondary" id="programModal-details">View Full Details</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== SCRIPTS ===== -->
  <script src="../js/components.js" defer></script>
  <script src="../js/utm-tracking.js" defer></script>
  <script src="../js/headerBehavior.js" defer></script>
  <script src="../js/mobileMenu.js" defer></script>

  <script>
    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    const TABLE_ID = 'tblympiL1p6PmQz9i';
    let allPrograms = [];

    const ALLOWED_PROGRAMS = [
      'Certificate in Employee Relations Law',
      'Advanced Certificate in Strategic Employment Law',
      'Certificate in Workplace Investigations',
      'Certificate in Strategic HR Leadership',
      'Certificate in Employee Benefits Law',
      'Advanced Certificate in Employee Benefits Law'
    ];

    // Virtual component programs to fetch (these form virtual certificates when paired)
    const VIRTUAL_COMPONENT_PROGRAMS = [
      'Comprehensive Labor Relations',
      'Discrimination Prevention & Defense',
      'HR Law Fundamentals',
      'Strategic HR Management'
    ];

    // Virtual certificate definitions - which component programs combine to form a certificate
    const VIRTUAL_CERTIFICATE_DEFS = {
      'Certificate in Employee Relations Law': {
        components: ['Comprehensive Labor Relations', 'Discrimination Prevention & Defense'],
        slug: 'employee-relations-law',
        description: 'Earn your Certificate in Employee Relations Law through two virtual sessions. Complete both components within the program window to receive your full certificate.',
        image: 'https://storage.googleapis.com/iaml-images-public/programs/employee-relations-law-hero.jpg'
      },
      'Certificate in Strategic HR Leadership': {
        components: ['HR Law Fundamentals', 'Strategic HR Management'],
        slug: 'strategic-hr',
        description: 'Earn your Certificate in Strategic HR Leadership through two virtual sessions. Master HR fundamentals and strategic management to receive your full certificate.',
        image: 'https://storage.googleapis.com/iaml-images-public/programs/strategic-hr-hero.jpg'
      }
    };

    // Virtual program image library - rotate to avoid duplication across instances
    const VIRTUAL_IMAGES = {
      'Certificate in Employee Relations Law': [
        'https://i.imgur.com/sSzeD5U.jpg',
        'https://i.imgur.com/kGiKVzl.jpg',
        'https://i.imgur.com/r81GZTG.jpg'
      ],
      'Certificate in Strategic HR Leadership': [
        'https://i.imgur.com/CY3t9Ye.jpg',
        'https://i.imgur.com/Mb3eS71.jpg',
        'https://i.imgur.com/Vv4iODE.jpg'
      ]
      // Reserved for future use:
      // 'https://i.imgur.com/TDMN3ZX.jpg'
      // 'https://i.imgur.com/3wSERSo.jpg'
    };

    const PROGRAM_SLUG_MAP = {
      'Certificate in Employee Relations Law': 'employee-relations-law',
      'Advanced Certificate in Strategic Employment Law': 'strategic-employment-law',
      'Certificate in Strategic HR Leadership': 'strategic-hr',
      'Certificate in Workplace Investigations': 'workplace-investigations',
      'Certificate in Employee Benefits Law': 'employee-benefits-law',
      'Advanced Certificate in Employee Benefits Law': 'advanced-benefits-law'
    };

    const BLOCK_DAYS_MAP = {
      'Certificate in Employee Relations Law': {
        1: 'Monday - Tuesday',
        2: 'Wednesday - Thursday',
        3: 'Friday'
      },
      'Certificate in Strategic HR Leadership': {
        1: 'Monday - Tuesday',
        2: 'Wednesday - Friday'
      },
      'Certificate in Employee Benefits Law': {
        1: 'Monday - Tuesday',
        2: 'Wednesday',
        3: 'Thursday - Friday'
      }
    };

    // Program type categories - programs can belong to multiple types
    const PROGRAM_TYPE_MAP = {
      'employment-law': [
        'Certificate in Employee Relations Law',
        'Certificate in Strategic HR Leadership',
        'Certificate in Workplace Investigations',
        'Advanced Certificate in Strategic Employment Law'
      ],
      'benefits-law': [
        'Certificate in Employee Benefits Law',
        'Advanced Certificate in Employee Benefits Law'
      ],
      'hr-management': [
        'Certificate in Workplace Investigations',
        'Certificate in Strategic HR Leadership'
      ]
    };

    // Descriptions for non-block programs
    const PROGRAM_DESCRIPTIONS = {
      'Certificate in Workplace Investigations': 'Master the essential skills for conducting thorough, legally defensible workplace investigations. This intensive program covers investigation planning, interviewing techniques, evidence gathering, credibility assessment, and documentation best practices.',
      'Advanced Certificate in Strategic Employment Law': 'Elevate your expertise with advanced strategies for navigating complex employment law challenges. Designed for experienced HR professionals and attorneys seeking to deepen their knowledge of cutting-edge legal issues and emerging trends.',
      'Advanced Certificate in Employee Benefits Law': 'Build on your benefits knowledge with advanced topics including complex compliance issues, plan design strategies, and fiduciary responsibilities. Ideal for professionals ready to tackle sophisticated benefits challenges.'
    };

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    // Format date range smartly: same month = "February 24–25, 2026", different = "February 24 - March 4, 2026"
    function formatSmartDateRange(rawStartDate, rawEndDate) {
      if (!rawStartDate) return '';

      const start = new Date(rawStartDate);
      const end = rawEndDate ? new Date(rawEndDate) : null;

      const months = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];

      const startMonth = months[start.getMonth()];
      const startDay = start.getDate();
      const startYear = start.getFullYear();

      if (!end || start.getTime() === end.getTime()) {
        // Single day
        return `${startMonth} ${startDay}, ${startYear}`;
      }

      const endMonth = months[end.getMonth()];
      const endDay = end.getDate();
      const endYear = end.getFullYear();

      if (startMonth === endMonth && startYear === endYear) {
        // Same month and year: "February 24–25, 2026"
        return `${startMonth} ${startDay}–${endDay}, ${startYear}`;
      } else if (startYear === endYear) {
        // Different month, same year: "February 24 – March 4, 2026"
        return `${startMonth} ${startDay} – ${endMonth} ${endDay}, ${startYear}`;
      } else {
        // Different year: "December 28, 2025 – January 2, 2026"
        return `${startMonth} ${startDay}, ${startYear} – ${endMonth} ${endDay}, ${endYear}`;
      }
    }

    // ============================================================================
    // DATA LOADING
    // ============================================================================
    async function loadProgramsFromAirtable() {
      const listEl = document.getElementById('programList');

      try {
        const filterFormula = encodeURIComponent("{Show on Website}=TRUE()");
        const response = await fetch(
          `/api/airtable-programs?table=${TABLE_ID}&filterByFormula=${filterFormula}&sort[0][field]=Start Date&sort[0][direction]=asc`
        );

        if (!response.ok) throw new Error('Failed to load programs');

        const data = await response.json();
        const records = data.records || [];

        // Transform all records
        const allTransformed = records.map(transformRecord);

        // Filter regular certificate programs (in-person and virtual non-component)
        allPrograms = allTransformed
          .filter(p => ALLOWED_PROGRAMS.includes(p.title) && p.format !== 'on-demand');

        // Get virtual component sessions for building virtual certificate pairs
        const virtualComponents = allTransformed
          .filter(p => VIRTUAL_COMPONENT_PROGRAMS.includes(p.title) && p.format === 'virtual');

        // Build virtual certificate pairs and add to allPrograms
        const virtualCertificates = buildVirtualCertificatePairs(virtualComponents);
        allPrograms = [...allPrograms, ...virtualCertificates];

        // Sort all programs by start date
        allPrograms.sort((a, b) => {
          if (!a.rawStartDate) return 1;
          if (!b.rawStartDate) return -1;
          return new Date(a.rawStartDate) - new Date(b.rawStartDate);
        });

        populateFilters(allPrograms);
        renderPrograms(allPrograms);

      } catch (error) {
        console.error('Error loading programs:', error);
        listEl.innerHTML = `
          <div class="schedule-v2-empty">
            <p>Unable to load program schedule. Please try again later.</p>
          </div>
        `;
      }
    }

    // Build virtual certificate pairs from component sessions
    function buildVirtualCertificatePairs(virtualComponents) {
      const pairs = [];
      const PAIR_WINDOW_DAYS = 28; // Components must be within 28 days of each other
      const imageIndexes = {}; // Track which image to use next per certificate type

      for (const [certName, def] of Object.entries(VIRTUAL_CERTIFICATE_DEFS)) {
        const [comp1Name, comp2Name] = def.components;

        // Initialize image index for this certificate type
        if (imageIndexes[certName] === undefined) imageIndexes[certName] = 0;

        // Get sessions for each component, sorted by date
        const comp1Sessions = virtualComponents
          .filter(p => p.title === comp1Name)
          .sort((a, b) => new Date(a.rawStartDate) - new Date(b.rawStartDate));

        const comp2Sessions = virtualComponents
          .filter(p => p.title === comp2Name)
          .sort((a, b) => new Date(a.rawStartDate) - new Date(b.rawStartDate));

        // Find valid pairs (comp2 starts within 28 days after comp1)
        for (const s1 of comp1Sessions) {
          const s1Start = new Date(s1.rawStartDate);

          for (const s2 of comp2Sessions) {
            const s2Start = new Date(s2.rawStartDate);
            const daysDiff = (s2Start - s1Start) / (1000 * 60 * 60 * 24);

            // s2 must start after s1 and within the window
            if (daysDiff >= 0 && daysDiff <= PAIR_WINDOW_DAYS) {
              // Get rotating image from VIRTUAL_IMAGES library
              const images = VIRTUAL_IMAGES[certName] || [];
              const imageIndex = imageIndexes[certName] % (images.length || 1);
              const image = images[imageIndex] || def.image || s1.image;
              imageIndexes[certName]++;

              pairs.push({
                id: `virtual-cert-${certName.replace(/\s+/g, '-')}-${s1.rawStartDate}`,
                title: certName,
                slug: def.slug,
                isVirtualCertificate: true,
                format: 'virtual',
                formatDisplay: 'Virtual',
                image: image,
                location: 'Virtual',
                venue: 'Online Live Sessions',
                rawStartDate: s1.rawStartDate,
                rawEndDate: s2.rawEndDate || s2.rawStartDate,
                startDate: s1.startDate,
                endDate: s2.endDate,
                registrationUrl: s1.registrationUrl || '/register',
                description: def.description,
                blocks: [],
                // Store component session info for display
                virtualComponents: [
                  {
                    number: 1,
                    title: comp1Name,
                    dates: formatSmartDateRange(s1.rawStartDate, s1.rawEndDate),
                    rawStart: s1.rawStartDate,
                    rawEnd: s1.rawEndDate
                  },
                  {
                    number: 2,
                    title: comp2Name,
                    dates: formatSmartDateRange(s2.rawStartDate, s2.rawEndDate),
                    rawStart: s2.rawStartDate,
                    rawEnd: s2.rawEndDate
                  }
                ]
              });
            }
          }
        }
      }

      return pairs;
    }

    function transformRecord(record) {
      const f = record.fields;
      const rawProgramName = f['Program Name'];
      const programName = Array.isArray(rawProgramName) ? rawProgramName[0] : (rawProgramName || f['Instance Name'] || 'Untitled Program');

      const blocks = [];
      if (f['Block 1 Title']) {
        blocks.push({
          number: 1,
          title: f['Block 1 Title'],
          dates: f['Block 1 Dates'] || '',
          times: f['Block 1 Times'] || '',
          instructor: f['Full Name with Credentials (from Block 1 Instructor)']?.[0] || f['Block 1 Instructor'] || ''
        });
      }
      if (f['Block 2 Title']) {
        blocks.push({
          number: 2,
          title: f['Block 2 Title'],
          dates: f['Block 2 Dates'] || '',
          times: f['Block 2 Times'] || '',
          instructor: f['Full Name with Credentials (from Block 2 Instructor)']?.[0] || f['Block 2 Instructor'] || ''
        });
      }
      if (f['Block 3 Title']) {
        blocks.push({
          number: 3,
          title: f['Block 3 Title'],
          dates: f['Block 3 Dates'] || '',
          times: f['Block 3 Times'] || '',
          instructor: f['Full Name with Credentials (from Block 3 Instructor)']?.[0] || f['Block 3 Instructor'] || ''
        });
      }

      return {
        id: record.id,
        title: programName,
        slug: PROGRAM_SLUG_MAP[programName] || programName.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
        location: f['City'] ? `${f['City']}, ${f['State/Province'] || ''}`.trim().replace(/,\s*$/, '') : 'Virtual',
        venue: f['Location'] || (f['Format']?.toLowerCase().includes('virtual') ? 'Online Live Sessions' : ''),
        startDate: formatDisplayDate(f['Start Date']),
        endDate: formatDisplayDate(f['End Date']),
        rawStartDate: f['Start Date'],
        rawEndDate: f['End Date'],
        format: normalizeFormat(f['Format']),
        formatDisplay: f['Format'] || 'In-Person',
        image: f['Hero Image URL'] || 'https://images.unsplash.com/photo-1582719508461-905c673771fd?w=800',
        registrationUrl: f['Registration URL'] || '/register',
        enrollmentStatus: f['Enrollment Status'],
        duration: f['Duration (Days)'] || '',
        blocks: blocks
      };
    }

    function formatDisplayDate(dateStr) {
      if (!dateStr) return '';
      const [y, m, d] = dateStr.split('-').map(Number);
      const date = new Date(Date.UTC(y, m - 1, d));
      return date.toLocaleDateString('en-US', {
        month: 'long', day: 'numeric', year: 'numeric', timeZone: 'UTC'
      });
    }

    function normalizeFormat(format) {
      if (!format) return 'in-person';
      const lower = format.toLowerCase();
      if (lower.includes('virtual')) return 'virtual';
      if (lower.includes('demand')) return 'on-demand';
      return 'in-person';
    }

    function formatDateRange(rawStart, rawEnd) {
      if (!rawStart || !rawEnd) return '';
      const [sy, sm, sd] = rawStart.split('-').map(Number);
      const [ey, em, ed] = rawEnd.split('-').map(Number);
      const startMonth = new Date(Date.UTC(sy, sm - 1, sd)).toLocaleDateString('en-US', { month: 'long', timeZone: 'UTC' });
      const endMonth = new Date(Date.UTC(ey, em - 1, ed)).toLocaleDateString('en-US', { month: 'long', timeZone: 'UTC' });
      if (sy === ey && sm === em) {
        return `${startMonth} ${sd} - ${ed}, ${sy}`;
      }
      return `${startMonth} ${sd}, ${sy} - ${endMonth} ${ed}, ${ey}`;
    }

    // ============================================================================
    // FILTERS
    // ============================================================================
    function populateFilters(programs) {
      const titles = [...new Set(programs.map(p => p.title))].sort();
      const programSelect = document.getElementById('programFilter');
      programSelect.innerHTML = '<option value="">All Programs</option>';
      titles.forEach(t => {
        programSelect.innerHTML += `<option value="${t}">${t}</option>`;
      });
    }

    function filterPrograms() {
      const programType = document.getElementById('programTypeFilter').value;
      const format = document.getElementById('formatFilter').value;
      const program = document.getElementById('programFilter').value;

      const filtered = allPrograms.filter(p => {
        // Filter by program type (check if program is in the selected type's array)
        if (programType && PROGRAM_TYPE_MAP[programType]) {
          if (!PROGRAM_TYPE_MAP[programType].includes(p.title)) return false;
        }
        // Filter by format
        if (format && p.format !== format) return false;
        // Filter by specific program
        if (program && p.title !== program) return false;
        return true;
      });

      renderPrograms(filtered);
    }

    // ============================================================================
    // RENDER - VERSION B (Card-Row Hybrid)
    // ============================================================================
    function renderPrograms(programs) {
      const listEl = document.getElementById('programList');

      if (programs.length === 0) {
        listEl.innerHTML = '<div class="schedule-v2-empty"><p>No programs match your filters.</p></div>';
        return;
      }

      listEl.innerHTML = programs.map(program => {
        const programDays = BLOCK_DAYS_MAP[program.title] || {};
        const programDescription = PROGRAM_DESCRIPTIONS[program.title] || '';

        // Handle virtual certificate pairs differently
        let contentHtml;
        if (program.isVirtualCertificate && program.virtualComponents) {
          // Virtual certificate with component sessions
          contentHtml = `
            <table class="schedule-v2c-blocks-table" aria-label="Virtual sessions for ${program.title}">
              <thead>
                <tr>
                  <th>Session</th>
                  <th>Topic</th>
                  <th>Dates</th>
                </tr>
              </thead>
              <tbody>
                ${program.virtualComponents.map(comp => `
                  <tr>
                    <td data-label="Session"><span class="schedule-v2c-block-num">${comp.number}</span></td>
                    <td data-label="Topic">${comp.title}</td>
                    <td data-label="Dates">${comp.dates}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <p class="schedule-v2b-blocks-footnote">*Complete both sessions to earn your certificate</p>
          `;
        } else if (program.blocks.length > 0) {
          // Regular program with blocks
          contentHtml = `
            <table class="schedule-v2c-blocks-table" aria-label="Program blocks for ${program.title}">
              <thead>
                <tr>
                  <th>Block</th>
                  <th>Topic</th>
                  <th>Days</th>
                </tr>
              </thead>
              <tbody>
                ${program.blocks.map(block => {
                  const blockDays = programDays[block.number] || '';
                  return `
                    <tr>
                      <td data-label="Block"><span class="schedule-v2c-block-num">${block.number}</span></td>
                      <td data-label="Topic">${block.title}</td>
                      <td data-label="Days">${blockDays}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
            <p class="schedule-v2b-blocks-footnote">*Individual blocks available for separate registration</p>
          `;
        } else {
          // Non-block program with description
          const desc = program.description || programDescription || 'Program details available upon registration.';
          contentHtml = `<p class="schedule-v2b-program-description">${desc}</p>`;
        }

        return `
          <article class="schedule-v2b-card-row">
            <div class="schedule-v2b-image-col">
              <img src="${program.image}" alt="${program.title}" class="schedule-v2b-hero-image" loading="lazy">
              <div class="schedule-v2b-image-overlay">
                <span class="schedule-v2b-format-badge ${program.format}">${program.formatDisplay}</span>
              </div>
            </div>
            <div class="schedule-v2b-info-col">
              <header class="schedule-v2b-header">
                <h3 class="schedule-v2b-program-title">${program.title}</h3>
                <div class="schedule-v2b-dates-location">
                  <time datetime="${program.rawStartDate}">${formatDateRange(program.rawStartDate, program.rawEndDate)}</time>
                  <span class="schedule-v2b-location-venue">
                    <strong>${program.location}</strong>${program.venue ? ` - ${program.venue}` : ''}
                  </span>
                </div>
              </header>
              <div class="schedule-v2b-blocks-grid">
                ${contentHtml}
              </div>
            </div>
            <div class="schedule-v2b-action-col">
              <button class="schedule-v2b-learn-btn" onclick="openProgramModal('${program.id}')">
                Learn More
              </button>
            </div>
          </article>
        `;
      }).join('');
    }

    // ============================================================================
    // MODAL
    // ============================================================================
    function openProgramModal(programId) {
      const program = allPrograms.find(p => p.id === programId);
      if (!program) return;

      document.getElementById('programModal-image').style.backgroundImage = `url('${program.image}')`;
      document.getElementById('programModal-title').textContent = program.title;
      document.getElementById('programModal-dates').textContent = formatDateRange(program.rawStartDate, program.rawEndDate);
      document.getElementById('programModal-duration').textContent = program.duration ? `${program.duration} days` : 'Contact for details';
      document.getElementById('programModal-location').textContent = program.venue ? `${program.location} • ${program.venue}` : program.location;

      const formatBadge = document.getElementById('programModal-format');
      formatBadge.textContent = program.formatDisplay;
      formatBadge.className = `programModal-format-badge ${program.format}`;

      const blocksContainer = document.getElementById('programModal-blocks');
      if (program.blocks && program.blocks.length > 0) {
        const programDays = BLOCK_DAYS_MAP[program.title] || {};
        blocksContainer.innerHTML = `
          <h3 class="programModal-blocks-title">Program Schedule</h3>
          ${program.blocks.map(block => {
            const blockDays = programDays[block.number] || '';
            return `
            <div class="programModal-block">
              <div class="programModal-block-header">
                <span class="programModal-block-number">Block ${block.number}</span>
                <span class="programModal-block-title">${block.title}</span>
              </div>
              <div class="programModal-block-details">
                ${blockDays ? `<div class="programModal-block-days">${blockDays}</div>` : ''}
                ${block.instructor ? `<div class="programModal-block-instructor">${block.instructor}</div>` : ''}
              </div>
            </div>
          `}).join('')}
        `;
        blocksContainer.style.display = 'block';
      } else {
        blocksContainer.innerHTML = '';
        blocksContainer.style.display = 'none';
      }

      document.getElementById('programModal-register').href = program.registrationUrl;
      document.getElementById('programModal-details').href = `/programs/${program.slug}?format=${program.format}`;

      document.getElementById('programModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeProgramModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('programModal').classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    document.getElementById('programTypeFilter').addEventListener('change', filterPrograms);
    document.getElementById('formatFilter').addEventListener('change', filterPrograms);
    document.getElementById('programFilter').addEventListener('change', filterPrograms);
    document.getElementById('clearFilters').addEventListener('click', () => {
      document.getElementById('programTypeFilter').value = '';
      document.getElementById('formatFilter').value = '';
      document.getElementById('programFilter').value = '';
      renderPrograms(allPrograms);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('programModal');
        if (modal.classList.contains('active')) {
          closeProgramModal();
        }
      }
    });

    document.addEventListener('DOMContentLoaded', loadProgramsFromAirtable);
  </script>

</body>
</html>

name: Daily Preview Registration Test

on:
  schedule:
    # Run daily at 6 AM UTC (10 PM PST / 1 AM EST)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      preview_url:
        description: 'Preview URL to test (optional, uses latest if empty)'
        required: false
        type: string

jobs:
  registration-test:
    name: Registration Flow Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Get latest preview URL
        id: preview
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -n "${{ github.event.inputs.preview_url }}" ]; then
            echo "url=${{ github.event.inputs.preview_url }}" >> $GITHUB_OUTPUT
            echo "Using provided URL: ${{ github.event.inputs.preview_url }}"
          else
            echo "Fetching latest preview deployment..."
            RESPONSE=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&target=preview&limit=1&state=READY")

            PREVIEW_URL=$(echo $RESPONSE | jq -r '.deployments[0].url // empty')

            if [ -z "$PREVIEW_URL" ]; then
              echo "No preview deployment found, using production"
              PREVIEW_URL=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
                "https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&target=production&limit=1&state=READY" \
                | jq -r '.deployments[0].url')
            fi

            echo "url=https://${PREVIEW_URL}" >> $GITHUB_OUTPUT
            echo "Using URL: https://${PREVIEW_URL}"
          fi

      - name: Run registration tests
        id: test
        env:
          BASE_URL: ${{ steps.preview.outputs.url }}
        run: |
          echo "Testing against: $BASE_URL"
          npx playwright test qa/tests/registration.spec.js --reporter=html,list
        continue-on-error: true

      - name: Verify Stripe test payment
        if: steps.test.outcome == 'success'
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}
        run: |
          echo "Verifying latest test payment..."

          # Get the most recent test payment from the last hour
          HOUR_AGO=$(date -d '1 hour ago' +%s 2>/dev/null || date -v-1H +%s)

          PAYMENT=$(curl -s -u "$STRIPE_SECRET_KEY:" \
            "https://api.stripe.com/v1/payment_intents?limit=5&created[gte]=$HOUR_AGO" \
            | jq -r '.data[] | select(.receipt_email | test("test\\+.*@local\\.dev")) | .status' \
            | head -1)

          if [ "$PAYMENT" = "succeeded" ]; then
            echo "✅ Payment verification: PASSED"
          elif [ -z "$PAYMENT" ]; then
            echo "⚠️ No test payment found (may not be an error if invoice was selected)"
          else
            echo "❌ Payment verification: FAILED (status: $PAYMENT)"
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: registration-test-results-${{ github.run_number }}
          path: |
            playwright-report/
            qa/screenshots/
            test-results/
          retention-days: 7

      - name: Check test outcome
        if: steps.test.outcome == 'failure'
        run: |
          echo "❌ Registration tests failed!"
          echo "Check the uploaded artifacts for details."
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "## Daily Registration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target URL**: ${{ steps.preview.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Status**: ${{ steps.test.outcome == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the [test artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for full results." >> $GITHUB_STEP_SUMMARY

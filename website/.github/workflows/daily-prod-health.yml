name: Daily Production Health Check

on:
  schedule:
    # Run daily at 7 AM UTC (11 PM PST / 2 AM EST)
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  prod-health:
    name: Production Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Get production URL
        id: prod
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          PROD_URL=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&target=production&limit=1&state=READY" \
            | jq -r '.deployments[0].url')

          echo "url=https://${PROD_URL}" >> $GITHUB_OUTPUT
          echo "Production URL: https://${PROD_URL}"

      - name: Run smoke tests
        id: smoke
        env:
          BASE_URL: ${{ steps.prod.outputs.url }}
        run: |
          echo "Running smoke tests against production..."
          npx playwright test qa/tests/smoke.spec.js --reporter=html,list
        continue-on-error: true

      - name: Check API health
        id: api_health
        env:
          BASE_URL: ${{ steps.prod.outputs.url }}
        run: |
          echo "Checking API endpoints..."

          # Check airtable-programs endpoint
          PROGRAMS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${BASE_URL}/api/airtable-programs")
          echo "Programs API: $PROGRAMS_STATUS"

          # Check create-payment-intent endpoint (should return 400 without body)
          PAYMENT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${BASE_URL}/api/create-payment-intent")
          echo "Payment API: $PAYMENT_STATUS"

          # Validate responses
          if [ "$PROGRAMS_STATUS" != "200" ]; then
            echo "⚠️ Programs API returned $PROGRAMS_STATUS"
          fi

          # 400 is expected for payment endpoint without body
          if [ "$PAYMENT_STATUS" != "400" ] && [ "$PAYMENT_STATUS" != "401" ]; then
            echo "⚠️ Payment API returned unexpected status: $PAYMENT_STATUS"
          fi

          echo "API health check complete"

      - name: Check Stripe webhook health
        id: webhook_health
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
        run: |
          echo "Checking Stripe webhook health..."

          # Get webhook endpoints
          WEBHOOKS=$(curl -s -u "$STRIPE_SECRET_KEY:" \
            "https://api.stripe.com/v1/webhook_endpoints")

          WEBHOOK_STATUS=$(echo $WEBHOOKS | jq -r '.data[0].status // "unknown"')
          WEBHOOK_URL=$(echo $WEBHOOKS | jq -r '.data[0].url // "none"')

          echo "Webhook URL: $WEBHOOK_URL"
          echo "Webhook Status: $WEBHOOK_STATUS"

          if [ "$WEBHOOK_STATUS" != "enabled" ]; then
            echo "⚠️ Webhook is not enabled: $WEBHOOK_STATUS"
          fi

          # Check for failed events in last 24 hours
          YESTERDAY=$(date -d '24 hours ago' +%s 2>/dev/null || date -v-1d +%s)

          FAILED_EVENTS=$(curl -s -u "$STRIPE_SECRET_KEY:" \
            "https://api.stripe.com/v1/events?created[gte]=$YESTERDAY&limit=100" \
            | jq '[.data[] | select(.pending_webhooks > 0)] | length')

          echo "Events with pending webhooks: $FAILED_EVENTS"

          if [ "$FAILED_EVENTS" -gt 5 ]; then
            echo "⚠️ High number of pending webhook deliveries: $FAILED_EVENTS"
          else
            echo "✅ Webhook health looks good"
          fi

          # Save for summary
          echo "webhook_status=$WEBHOOK_STATUS" >> $GITHUB_OUTPUT
          echo "failed_events=$FAILED_EVENTS" >> $GITHUB_OUTPUT

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prod-health-results-${{ github.run_number }}
          path: |
            playwright-report/
            qa/screenshots/
            test-results/
          retention-days: 7

      - name: Check overall health
        if: always()
        run: |
          SMOKE_STATUS="${{ steps.smoke.outcome }}"
          WEBHOOK_STATUS="${{ steps.webhook_health.outputs.webhook_status }}"
          FAILED_EVENTS="${{ steps.webhook_health.outputs.failed_events }}"

          echo "## Production Health Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL**: ${{ steps.prod.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ steps.smoke.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Health | ✅ Checked |" >> $GITHUB_STEP_SUMMARY
          echo "| Webhook Status | ${WEBHOOK_STATUS:-unknown} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pending Webhooks | ${FAILED_EVENTS:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SMOKE_STATUS" != "success" ]; then
            echo "❌ Production health check failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ Production is healthy" >> $GITHUB_STEP_SUMMARY

      - name: Fail if smoke tests failed
        if: steps.smoke.outcome == 'failure'
        run: |
          echo "❌ Smoke tests failed!"
          exit 1

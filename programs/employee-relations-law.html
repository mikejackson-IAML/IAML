<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Certificate in Employee Relations Law - IAML. Master employee relations strategies with practicing attorneys. 4½-day intensive program. Learn employment law that prevents 90% of workplace legal issues.">
  <meta name="keywords" content="employee relations law, employment law training, HR certification, IAML certificate program, workplace law">
  <meta name="author" content="Institute for Applied Management & Law">

  <!-- Open Graph / Social Media -->
  <meta property="og:title" content="Certificate in Employee Relations Law - IAML">
  <meta property="og:description" content="Master employee relations strategies with practicing attorneys. Real cases, practical solutions, immediate results.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://iaml.com/programs/employee-relations-law">
  <meta property="og:image" content="https://iaml.com/images/og-image.jpg">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

  <title>Certificate in Employee Relations Law - IAML</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Lato:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- CDN & External Service Preconnects (High Priority) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://storage.googleapis.com">
  <link rel="preconnect" href="https://www.googletagmanager.com">
  <link rel="preconnect" href="https://api.airtable.com">

  <!-- DNS Prefetch for Secondary Resources (Medium Priority) -->
  <link rel="dns-prefetch" href="https://i.imgur.com">
  <link rel="dns-prefetch" href="https://images.unsplash.com">
  <link rel="dns-prefetch" href="https://v5.airtableusercontent.com">

  <!-- Splide CSS (for testimonials carousel) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">

  <!-- Main CSS -->
  <link rel="stylesheet" href="../css/main.css">

  <!-- Google Analytics (Replace with your GA4 ID) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXXXX');
  </script>
</head>
<body>

  <!-- ===== HEADER ===== -->
  <!-- Header placeholder (loaded by components.js) -->
  <div id="header-placeholder"></div>

  <!-- NoScript fallback for progressive enhancement -->
  <noscript>
    <nav style="position: fixed; top: 0; width: 100%; background: white; padding: 16px; text-align: center; z-index: 1000;">
      <a href="/">Home</a> |
      <a href="/featured-programs">Programs</a> |
      <a href="/pages/corporate-training">Corporate</a> |
      <a href="/about-us">Why IAML</a>
    </nav>
  </noscript>

  <!-- ===== MAIN CONTENT ===== -->
  <main>

    <!-- Hero Section - Two Column Layout -->
    <section class="hero-section hero-section-program">
      <div class="container">
        <div class="hero-program-wrapper">
          <!-- Left Column: Program Header -->
          <section class="program-header">
            <h1 class="program-title">
              Certificate in Employee<br>Relations Law
            </h1>

            <p class="program-description">
              Stop guessing about employment law. In 4½ days, you'll master the employee relations strategies that prevent 90% of workplace legal issues. Real cases, practical solutions, immediate results.
            </p>

            <button id="openModalBtn-relations-law" class="register-button" onclick="connectPopup_open()" type="button">
              Program Enrollment Fee: $2,375
            </button>

            <div class="delivery-options">
              <span class="delivery-label">Delivery Options:</span>
              <div class="format-pills">
                <span class="format-pill">In Person</span>
                <span class="format-pill">Virtual</span>
                <span class="format-pill">On Demand</span>
              </div>
            </div>
          </section>

          <!-- Right Column: Next Program Card -->
          <section class="next-program-card">
            <div class="program-card-container" id="nextProgramCard">
              <div style="padding: 20px; text-align: center; color: #666;">Loading next program...</div>
            </div>
          </section>
        </div>
      </div>
    </section>

    <!-- Social Proof Banner -->
    <section class="social-proof-banner">
      <div class="proof-container">

        <div class="proof-item">
          <div class="proof-number">46+ YEARS</div>
          <div class="proof-label">Employment Law Training</div>
        </div>

        <div class="proof-divider">|</div>

        <div class="proof-item">
          <div class="proof-number">15,000+</div>
          <div class="proof-label">Certificates Earned</div>
        </div>

        <div class="proof-divider">|</div>

        <div class="proof-item">
          <div class="proof-number">PRACTICING ATTORNEYS</div>
          <div class="proof-label">Not Academics</div>
        </div>

      </div>
    </section>

    <!-- Testimonials Section with Infinite Scroll -->
    <section class="testimonials-scroll-section" style="background: #ebebeb;">
      <div class="container">
        <div class="scroll-grid">

          <!-- Left Column: Scrolling Testimonials -->
          <aside class="testimonial-scroller">
            <div class="top-fade"></div>
            <div class="left-fade"></div>
            <div class="testimonial-track" role="list" aria-label="Customer testimonials"></div>
            <div class="bottom-fade"></div>
            <div class="scroll-hint">Scroll to see more ↓</div>
          </aside>

          <!-- Right Column: Static Content -->
          <article class="content-section">
            <h2 class="font-display text-display text-primary">Build Employment Law Expertise That Protects and Advances</h2>
            <p class="text-large text-secondary">
              The Certificate in Employee Relations Law is <span style="color: #FF6A00; font-weight: 700;">4.5 intensive days</span> where you'll build practical employment law expertise with experienced attorneys - working through real workplace scenarios, not theoretical lectures.
            </p>
            <hr class="separator"/>
            <div class="benefits-section benefits-section--gradient benefits-section--card">
              <h3 class="font-display">What Sets This Program Apart</h3>
              <ul class="benefits-list">
                <li><strong>Comprehensive employment law coverage</strong> – Hiring, discipline, accommodations, leaves, terminations, and investigations</li>
                <li><strong>Real-world application</strong> – Work actual cases and scenarios you'll face Monday morning</li>
                <li><strong>Expert attorney-led instruction</strong> – Learn from practicing employment law specialists</li>
                <li><strong>Professional certification</strong> – Earn your certificate plus <span style="color: #FF6A00; font-weight: 600;">29.75 SHRM/HRCI</span> continuing education credits</li>
                <li><strong>Benefits beyond the classroom</strong> – Your investment includes quarterly legal updates, faculty access, and alumni resources that keep you current year-round. <a href="#benefitSteps" style="text-decoration: underline;">View participant benefits →</a></li>
              </ul>
              <a href="#all-programs" class="btn btn-primary">VIEW UPCOMING PROGRAMS</a>
            </div>
          </article>

        </div>
      </div>
    </section>

    <script>
      // Testimonial data from program evaluations
      const TESTIMONIALS_DATA = [
        {"quote":"Information and materials were excellent, but the experiences shared by the facilitators was fantastic! Sam's interactive facilitation style really made the course very interesting and memorable. Thanks for a great course!","name":"Yvette Klepper","title":"Chief Human Resources Officer","company":"Palm Beach County Tax Collector's Office"},
        {"quote":"The seminar, in my opinion, was second to none. All of the information was very well delivered and explained in detail so that everyone, from the least to the most experienced, was able to understand. IAML did an outstanding job and I will be sure to highly recommend your seminars to anyone who inquires.","name":"Laurie Keenan","title":"Director of Human Resources","company":"Mohegan Sun"},
        {"quote":"Excellent experience! The seminar was very enlightening and I highly recommend it to anyone trying to learn more about employment law and how it applies to their everyday experiences working with employees.","name":"Stacy Ramsey","title":"Human Resources Generalist","company":"PGT Custom Windows and Doors"},
        {"quote":"This is one of the best seminars I have ever attended. Our instructor was thoroughly engaging and his energy, enthusiasm and enjoyment of his subjects was infectious. I was sorry for it to end on Friday.","name":"John H. Livingston","title":"Assistant General Counsel & Human Resources Director","company":"Liberty National Life Insurance Company"},
        {"quote":"I thought the seminar was very informative! I will definitely utilize my new skills I have acquired during the training. I would highly recommend others to use IAML as their training/learning tool. I cannot wait for the next conference!","name":"Stephanie Banach","title":"Shareholder Relations Manager","company":"Akhiok-Kaguyak, Inc."},
        {"quote":"The presenters made a rather intensive 5 days not only educational and instructional but interesting and enjoyable as well. Best seminar in HR I've ever attended.","name":"Diane Altaffer","title":"Director of Human Resources","company":"Blackstone"},
        {"quote":"I would highly recommend the Certificate in Employee Relations Law Program to my colleagues in the public sector. The speakers presented each legal theory covered in the program with practical examples of how they apply to the workplace of today.","name":"Michael Dalton","title":"Assistant Chief of the Fire Department","company":"Baltimore City Fire Department"},
        {"quote":"This was by far, the best seminar I've ever attended! The materials provided are a great resource and the instructors did a great job of presenting the information.","name":"Sylvia Ayala","title":"Vice President, Human Resources","company":"Gladney Center for Adoption"},
        {"quote":"One of the best training seminars I've attended! Very valuable to what I do every day, especially in reviewing litigation cases. There was much value in the interaction with other HR peers. Thank you for the valued experience!","name":"Jennifer Capozziello","title":"AVP, Human Resources","company":"Travelers"},
        {"quote":"I think that this program is one of the best that you could ever attend as a human resource professional. It is comprehensive and thorough. I left this training with the human resource equipment I need.","name":"Dennis Scott","title":"Personnel Officer","company":"Office of Regulation Policy and Management, Department of Veterans Affairs"},
        {"quote":"The classroom participation was excellent and allowed us to share situations and get other perspectives in a safe space. This was the best employee relations seminar that I've ever attended.","name":"JoAnne Guerrant","title":"Employee Relations Manager","company":"Delta Community Credit Union"},
        {"quote":"The examples used and interactive nature of the course was very helpful. Excellent choice of facilitators - they knew the material and were very engaging.","name":"Paul Carney","title":"EVP, Chief Human Resources Officer","company":"Carter Bank & Trust"},
        {"quote":"This was the best HR seminar that I have ever attended. It provided a thorough overview of critical HR information and was very well organized. The attorneys were humorous and understood the HR challenges that we face, they gave good advice.","name":"Tracy Gee","title":"Chief People Officer","company":"National Association of Corporate Directors"},
        {"quote":"With almost 20 years in the field of employment law, this was one of the best, if not the best, seminar I have ever attended.","name":"Charles Rando","title":"Personnel Field Manager","company":"Wyoming Department of Workforce Services"},
        {"quote":"This is the best course I have ever attended. The instructors are well informed and have a repertoire of stories that emphasize the issues. Course materials are also excellent!","name":"Debbie Colia","title":"HR Executive Consultant","company":"Cedars-Sinai"},
        {"quote":"The seminar was excellent. The instructors were extremely knowledgeable and made a point of allowing the class to interact. This one week not only provided me with knowledge I did not have, it also gave me a new appreciation for what I do.","name":"Angelique Anderson","title":"Executive Director, Strategic HR Business Partnerships - People & Culture","company":"Catalina Marketing"},
        {"quote":"My only wish is that I had attended this seminar earlier in my career! The information I learned is invaluable.","name":"Christina Lipetzky","title":"Human Resources Manager","company":"Montana Department of Environmental Quality"},
        {"quote":"The training both was excellent both in content as well as presentation. I believe the strength of the program lay in the instructors used. All the instructors were fantastic!","name":"Stephen Santay","title":"Controller","company":"KTLA"},
        {"quote":"The seminar was the best. Faculty did an outstanding job of making legal information understandable for non-lawyer professionals. I am planning to attend the Advanced Conference.","name":"James Dillard","title":"Personnel Administrator","company":"Lubrizol"},
        {"quote":"I thought the program was excellent. The content and speakers especially were the best I've experienced in my educational and professional career.","name":"Laurie Clark","title":"Benefits Paralegal","company":"The Coca-Cola Company"},
        {"quote":"All three instructors were wonderful in their own way. Finding attorneys who can teach is a rarity. I found the information current and relevant. It will definitely have an impact on my HR practices. Thank you for a great seminar!","name":"Heidi Hill","title":"Director Training, Development and Engagement","company":"C2 Solutions"},
        {"quote":"Our instructor was a great presenter with great real life examples. His summaries of significant federal employment law were invaluable.","name":"Tim Hartman","title":"Sr. Regional HR Manager & HR Counsel","company":"Silgan Containers"},
        {"quote":"Of all the IAML seminars I have attended, this was by far the best and most informative, especially to HR professionals. I was very pleased with the entire program.","name":"Barbara Ann Bohlman","title":"Sr Compensation & Benefits Manager","company":"The Boca Raton"},
        {"quote":"The information covered in this program was excellent! The speakers were wonderful. They kept the program fresh and interesting. It just seems it's never enough time to go over all the changed in this ever-changing field.","name":"Monica Taylor","title":"Human Resources Manager","company":"Oak Hall Cap & Gown"},
        {"quote":"The content was current, relevant and very practical. I appreciated the interactive format and the opportunity to network with other professionals facing similar challenges.","name":"Michael Chen","title":"Director of Human Resources","company":"TechSmart Industries"},
        {"quote":"The information was extremely valuable and interesting, I learned a great deal. The instructors did an exceptional job presenting; they were helpful, knowledgeable and entertaining.","name":"Katie Sanders","title":"Coordinator of Workforce Development","company":"Northside Hospital"},
        {"quote":"The seminar offered incredible value for me. The instructors were able to rely on past examples and cases to help illustrate the learning. It was a great learning experience for me.","name":"Amanda McIvor","title":"Senior Human Resources Manager","company":"Gerdau"},
        {"quote":"I have been in HR for 15 years and attended a lot of seminars, this was my first IAML seminar and you can bet my budget dollars were well-spent. I'll continue to look for your seminars first!","name":"Ruth Erwert","title":"Recruiting Manager","company":"Chelan County PUD"},
        {"quote":"Brenda was exceptional. She found the right balance of presenting employment law as it is written, while encouraging relevant experience sharing from participants and her own case work.","name":"Kristen Van Damm","title":"Director - Trust Specialties People Leader","company":"PwC"},
        {"quote":"This was my third IAML seminar and I have been very impressed each time. The information is comprehensive, in-depth, and very relevant. I plan to attend more IAML seminars in the future.","name":"Gloria Lindsey","title":"Human Resources Benefits Manager","company":"Thiele Kaolin Company"},
        {"quote":"I found the seminar to be very informative and relevant. You certainly have two gems in Gavin and Wayne. Their knowledge of the subject matter and the ease in which they interact with the attendees made the seminar a true success. I have stated as much to the powers that be here in a formal memo, and have recommended the seminar to other managers.","name":"Robert K. Smith","title":"Director","company":"Philadelphia Gas Works"},
        {"quote":"This was an excellent seminar and well worth the time and money invested. The instructors were very knowledgeable and interesting and their different styles were effective. The materials will be a great reference tool. This seminar was recommended by previous IAML participants and I will recommend it to others.","name":"James Dengler","title":"Staff Training & Development Manager","company":"ENSCO"},
        {"quote":"It was an excellent seminar and I learned quite a bit. The speakers were great. The information was relevant, current, helpful and could be immediately applied. All in all, it was an excellent event and I'm already budgeting for the Advanced session next year.","name":"Kelli Whorton","title":"Human Resources Director","company":"RLF"},
        {"quote":"This was my first seminar with IAML and I was very impressed! The speakers were great and the sessions were very informative. I will definitely attend again!","name":"Holly Dean","title":"Employment Manager","company":"Alfa Insurance Company"},
        {"quote":"I highly enjoyed this seminar. All of the presenters were extremely knowledgeable and very easy to talk with.","name":"Jody Ryan","title":"Human Resources Service Coordinator","company":"Boeing Company"},
        {"quote":"Presenter's extensive knowledge of the applicable law was evidenced throughout. They were able to give pertinent comments and recommendations, which should be highly effective upon implementation. All in all, wonderfully done seminar.","name":"Michael Brown","title":"Assistant General Counsel","company":"Oklahoma Tax Commission"},
        {"quote":"Perfect! Exactly what I hoped to gain. Delivery in such a fashion that kept everyone's attention. Already referring to materials, you have a lifelong customer!","name":"Kelly McNamara","title":"Manager, College Relations-Employment","company":"WestRock"},
        {"quote":"Wayne Williams' intellect and energy truly made this an interactive session which is paramount for all adult learning. Kudos to him and to IAML!","name":"Michael Cook","title":"Corporate Employee Relations Manager","company":"MillerCoors"},
        {"quote":"Both of the presenters were fantastic! Brenda Heinicke's 'Friday Free for All' was a terrific way for us to discuss specific topics affecting our individual workplaces. The personal experiences shared by Patrick Scully of working for the NLRB (labor vs. employer) were fascinating.","name":"Kelly Stiles","title":"Human Resources Manager","company":"City of Unalaska, Alaska"},
        {"quote":"Thank you for all of the information that was given. I am very excited to apply the knowledge that has been given. I would very much like to continue to work with the IAML team to continue my education.","name":"David Deem","title":"Continuous Improvement Manager","company":"Lear Corporation"},
        {"quote":"The vast knowledge and experience of the instructors; entertaining and dynamic presentation style; discussion method of training was well received; linkage of legal facts to actual cases was enlightening.","name":"Jose Martinez","title":"Facilities Maintenance Program Manager","company":"Sandia National Laboratories"},
        {"quote":"Amy is an extremely knowledgeable professional with years of labor relations experience. This is invaluable to have as an instructor. She gained immediate credibility with the group with her extensive knowledge, experience and life anecdotes.","name":"Christine Galicho","title":"Regional Human Resource Manager","company":"Linens 'N Things"},
        {"quote":"It's always good to come back to IAML to get updated on the newest rulings as well as to refresh my knowledge of employment law. The instructors were very good and their presentation skills were excellent. Sometimes just reading 'the law' can be so boring. IAML's courses are far from boring! Thanks again for a great class!","name":"Denise Teuscher","title":"Lead Labor Relations Specialist","company":"Battelle Energy Alliance"}
      ];

      (function(){
        const track = document.querySelector(".testimonial-track");
        let isScrolling = false;

        function escapeHtml(text){
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }

        function renderCard(t){
          return `
            <article class="testimonial-card" role="listitem">
              <div class="star-wrapper">
                <img src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/68d667936fe1a53fe6603670.png" alt="5 star rating" class="star-image">
              </div>
              <blockquote>"${escapeHtml(t.quote)}"</blockquote>
              <footer>
                <div class="author-name">${escapeHtml(t.name)}</div>
                ${t.title ? `<div class="author-details">${escapeHtml(t.title)}</div>` : ''}
                ${t.company ? `<div class="author-details">${escapeHtml(t.company)}</div>` : ''}
              </footer>
              <div class="quote-mark">"</div>
            </article>`;
        }

        function buildLoop(){
          const A = TESTIMONIALS_DATA.map(renderCard).join("");
          const B = TESTIMONIALS_DATA.map(renderCard).join("");
          const C = TESTIMONIALS_DATA.map(renderCard).join("");
          track.innerHTML = C + A + B;

          requestAnimationFrame(() => {
            track.scrollTop = blockHeight();
          });
        }

        function blockHeight(){
          let h = 0;
          const kids = track.children;
          const itemsPerBlock = TESTIMONIALS_DATA.length;

          for(let i = 0; i < Math.min(itemsPerBlock, kids.length); i++){
            h += kids[i].offsetHeight;
          }
          return h;
        }

        function onScroll(){
          if(isScrolling) return;

          const b = blockHeight();
          const y = track.scrollTop;

          if(y >= b * 2){
            isScrolling = true;
            track.scrollTop = y - b;
            requestAnimationFrame(() => { isScrolling = false; });
          }
          else if(y < b * 0.1){
            isScrolling = true;
            track.scrollTop = y + b;
            requestAnimationFrame(() => { isScrolling = false; });
          }
        }

        let resizeTimeout = null;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            const b = blockHeight();
            const currentOffset = track.scrollTop % b;
            track.scrollTop = b + currentOffset;
          }, 150);
        });

        buildLoop();
        track.addEventListener("scroll", onScroll, {passive: true});
      })();
    </script>



    <!-- Curriculum Section -->
    <section class="curriculum-section theme-light py-5xl">
      <div class="container container-lg mx-auto">

        <!-- Section Header -->
        <header class="curriculum-header">
          <h2>What You'll Master in 4½ Days</h2>
          <p>Master the sophisticated labor relations, discrimination defense, and employment law strategies that set your organization apart. Each block delivers specialized expertise you can immediately apply to your most pressing challenges.</p>
        </header>

        <!-- Block Navigation -->
        <div class="curriculum-nav">

          <!-- Block I Card -->
          <div class="curriculum-nav-card active" data-target="block1" tabindex="0" role="tab" aria-selected="true" aria-controls="block1">
            <div class="block-label">Block I</div>
            <h3>Comprehensive Labor Relations</h3>
            <p>Navigate the complex terrain of organizing risk, employee handbooks, union elections, and collective bargaining with proven strategies that protect your workforce while maintaining compliance.</p>
            <div class="curriculum-price">$1,375</div>
            <div class="curriculum-availability">Available individually</div>
          </div>

          <!-- Block II Card -->
          <div class="curriculum-nav-card" data-target="block2" tabindex="-1" role="tab" aria-selected="false" aria-controls="block2">
            <div class="block-label">Block II</div>
            <h3>Discrimination Prevention & Defense</h3>
            <p>Master discrimination law fundamentals across all protected classes. Learn how to identify workplace practices that expose your company to liability and implement preventive measures that strengthen your defense.</p>
            <div class="curriculum-price">$1,375</div>
            <div class="curriculum-availability">Available individually</div>
          </div>

          <!-- Block III Card -->
          <div class="curriculum-nav-card" data-target="block3" tabindex="-1" role="tab" aria-selected="false" aria-controls="block3">
            <div class="block-label">Block III</div>
            <h3>Special Issues & Advanced Topics</h3>
            <p>Deep dive into complex employment law issues including executive employment agreements, trade secrets, non-competes, and remote work considerations that shape modern HR strategy.</p>
            <div class="curriculum-price">$575</div>
            <div class="curriculum-availability">Available individually</div>
          </div>

        </div>

        <!-- Curriculum Content Blocks -->
        <div class="curriculum-content">

          <!-- BLOCK I: Comprehensive Labor Relations -->
          <div id="block1" class="curriculum-block active" role="tabpanel" aria-labelledby="nav-block1">

            <!-- Competency Group 1 -->
            <div class="competency-group active">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="true">
                <div>
                  <h3>The Current NLRB & Organizing Landscape</h3>
                  <p>Key shifts in elections, handbooks, and joint-employer liability.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Elections & recognition after NLRB Cemex decision</h4>
                      <p>Faster elections; higher risk of bargaining orders for ULPs; what "card-check-adjacent" and new GC guidance mean in practice.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Handbooks after NLRB Stericycle decision</h4>
                      <p>Why neutral rules (civility, confidentiality, social media, devices) can still violate §7; how to rewrite with context-specific justifications.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Joint-employer status (where it stands now)</h4>
                      <p>2023 rule invalidated; prior standard effectively back—implications for franchise/contracting models and vendor oversight.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 2 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Practical Guidance for Non-Union Workplaces</h3>
                  <p>Reduce organizing heat with lawful hiring, onboarding, and training.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Hiring & onboarding practices</h4>
                      <p>Lower ULP risk; orientation scripts that avoid "captive audience" pitfalls.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>The three big sparks for organizing</h4>
                      <p>Scheduling/fairness, safety (including psychological safety), and transparency (wages/career paths)—how HR cools them with credible channels and swift fixes.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Manager training for §7 in non-union settings</h4>
                      <p>Protected concerted activity on Slack/Teams and group chats; where discipline goes wrong under Stericycle.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 3 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Election Readiness & Campaign Law</h3>
                  <p>Operate within accelerated timelines while preserving laboratory conditions.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Campaign playbook: Do / Don't</h4>
                      <p>Practical rules for message discipline under accelerated timelines; maintaining true laboratory conditions.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Access, equal time, and solicitation rules</h4>
                      <p>Apply solicitation/distribution and email/Teams policies—updated for hybrid work.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Post-election objections and reruns</h4>
                      <p>Prevent and defend against objections to avoid costly reruns.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 4 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Collective Bargaining</h3>
                  <p>Proposals that matter, documentation, and aligning handbooks with CBAs.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Setting the table</h4>
                      <p>Management rights, grievance/arbitration, zipper, information requests, technology/data clauses, and safety.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Good-faith bargaining</h4>
                      <p>Information requests, surface bargaining risks, and documenting proposals/counterproposals.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Handbook ↔ CBA alignment</h4>
                      <p>Avoid conflicts and unintended past-practice creation.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 5 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Strikes, Pickets, and Employer Response</h3>
                  <p>Protected vs unprotected actions, lawful responses, and contingency planning.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Types of strikes and lockouts</h4>
                      <p>Intermittent/partial strike pitfalls; replacements and lawful lockout strategy.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Picketing & social media amplification</h4>
                      <p>What changes in a viral era and how to respond lawfully.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Contingency planning</h4>
                      <p>Checklists and communication protocols that minimize disruption.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 6 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Operating Under a CBA</h3>
                  <p>Grievance handling, settlements, records, and change management.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Grievances to arbitration</h4>
                      <p>Intake triage, settlement tools, record-building, arbitrator selection, and "just cause" proofs.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Past practice, side letters, zipper clauses</h4>
                      <p>How to manage change mid-term without creating legal traps.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 7 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Successorship, Acquisitions & Restructuring</h3>
                  <p>When buyers must recognize a union and how to diligence LR risks.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Successor obligations</h4>
                      <p>When a buyer must recognize a union; hiring decisions that trigger duty to bargain.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Alter-ego/single-employer risks</h4>
                      <p>ER/LR due diligence checklists including wage/hour and privacy/data issues.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 8 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Special Watch-Items for LR Professionals</h3>
                  <p>Transparency, privacy/monitoring, and cross-law impacts to watch.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Pay transparency (multi-state)</h4>
                      <p>Job-post salary ranges, internal equity communications, and how transparency interacts with CBA wage grids.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>State privacy & monitoring</h4>
                      <p>CPRA employee data and beyond—impacts on investigations, monitoring, and CBA data requests.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step Tabs Footer Navigation -->
            <nav class="curriculum-step-tabs" role="tablist" aria-label="Curriculum blocks navigation">
              <button
                class="curriculum-step-tab active"
                data-target="block1"
                role="tab"
                aria-selected="true"
                aria-controls="block1"
                tabindex="0">
                <span class="step-number">I</span>
                <span class="step-label">Union Avoidance</span>
              </button>

              <button
                class="curriculum-step-tab"
                data-target="block2"
                role="tab"
                aria-selected="false"
                aria-controls="block2"
                tabindex="-1">
                <span class="step-number">II</span>
                <span class="step-label">Discrimination</span>
              </button>

              <button
                class="curriculum-step-tab"
                data-target="block3"
                role="tab"
                aria-selected="false"
                aria-controls="block3"
                tabindex="-1">
                <span class="step-number">III</span>
                <span class="step-label">Wage & Hour</span>
              </button>
            </nav>

          </div>

          <!-- BLOCK II: Discrimination Prevention & Defense -->
          <div id="block2" class="curriculum-block" role="tabpanel" aria-labelledby="nav-block2">

            <!-- Competency Group 1 -->
            <div class="competency-group active">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="true">
                <div>
                  <h3>Title VII: Discrimination, Harassment & Retaliation (Still #1)</h3>
                  <p>Trends, hybrid risks, LGBTQ+ protections, religion, and compliant DEI.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Charge trends</h4>
                      <p>Higher filings; retaliation remains most prevalent—action items for intake, interim measures, and documentation.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Harassment in hybrid workplaces</h4>
                      <p>Chats/DMs, meeting recordings, and third-party/customer harassment—practical controls.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>LGBTQ+ and sex-based claims post-Bostock; religious conflicts after Groff</h4>
                      <p>Document undue hardship for schedules/duties while ensuring equal treatment.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Reverse-discrimination / DEI backlash</h4>
                      <p>Run compliant DEI—widen access, use merit-based selection, and lawful outreach—amid scrutiny.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 2 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>ADA, PWFA, FMLA: Accommodation & Leave in a Hybrid World</h3>
                  <p>Define essential functions, align performance, and coordinate overlapping laws.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Defining essential functions with remote options</h4>
                      <p>Use defensible analyses and documented rationales.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Mental-health accommodations and performance alignment</h4>
                      <p>Balance supports with expectations and safety.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>PWFA / PUMP intersections</h4>
                      <p>Scheduling and break implications; coordination with other laws.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>FMLA interference/retaliation traps</h4>
                      <p>Coordinate ADA/FMLA/Workers' Comp to avoid compounding liability.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 3 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>ADEA & Equal Pay</h3>
                  <p>RIF documentation and privileged, action-oriented pay audits.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Disparate impact and RIF selection</h4>
                      <p>Build selection files that hold up and avoid age bias.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Pay transparency and equal pay audits</h4>
                      <p>Structure privileged audits and communications.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 4 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Resolving Claims Without Litigation</h3>
                  <p>Internal resolution, arbitration programs, and mediation tactics.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Internal resolution</h4>
                      <p>Prompt, impartial investigations; what to share in outcome letters.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Arbitration & class/collective waivers</h4>
                      <p>Enforceability trends; drafting updates for remote workers and electronic consent.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Pre-charge settlements and mediation</h4>
                      <p>Best practices to resolve early with durable agreements.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 5 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Litigation Playbook (When It Happens)</h3>
                  <p>Administrative responses, ESI preservation, and summary-judgment positioning.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>EEOC process</h4>
                      <p>Position statements that help—and those that haunt.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Preserving ESI</h4>
                      <p>Chat, personal devices, and cloud docs—issue holds that actually cover the risks.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Summary-judgment and retaliation defenses</h4>
                      <p>Build the record early and avoid avoidable admissions.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 6 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Federal Contractors & Affirmative Action (Hot-Button)</h3>
                  <p>EO/OFCCP landscape and DEI posture post-SFFA.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Executive Order / OFCCP shifts</h4>
                      <p>What contractors should—and shouldn't—do while rules are in flux.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Post-SFFA compliance posture</h4>
                      <p>What survives for corporate DEI vs Title VII; where to re-tool.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step Tabs Footer Navigation -->
            <nav class="curriculum-step-tabs" role="tablist" aria-label="Curriculum blocks navigation">
              <button
                class="curriculum-step-tab"
                data-target="block1"
                role="tab"
                aria-selected="false"
                aria-controls="block1"
                tabindex="-1">
                <span class="step-number">I</span>
                <span class="step-label">Union Avoidance</span>
              </button>

              <button
                class="curriculum-step-tab active"
                data-target="block2"
                role="tab"
                aria-selected="true"
                aria-controls="block2"
                tabindex="0">
                <span class="step-number">II</span>
                <span class="step-label">Discrimination</span>
              </button>

              <button
                class="curriculum-step-tab"
                data-target="block3"
                role="tab"
                aria-selected="false"
                aria-controls="block3"
                tabindex="-1">
                <span class="step-number">III</span>
                <span class="step-label">Wage & Hour</span>
              </button>
            </nav>

          </div>

          <!-- BLOCK III: Special Issues & Advanced Topics -->
          <div id="block3" class="curriculum-block" role="tabpanel" aria-labelledby="nav-block3">

            <!-- Competency Group 1 -->
            <div class="competency-group active">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="true">
                <div>
                  <h3>Wage & Hour (FLSA) Under Remote/Hybrid</h3>
                  <p>Off-the-clock time, hybrid travel, and complex pay calculations.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Remote off-the-clock risk</h4>
                      <p>Email/IM, rounding, device sync; travel time for split/hybrid days; audits for "player-coach" roles.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Commission/bonus/draw plans</h4>
                      <p>Overtime calculations without tripping over spiffs and recoveries.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 2 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Wrongful Discharge & Retaliation</h3>
                  <p>Documented timelines and protected-activity analysis that defeat pretext.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>"At-will with evidence"</h4>
                      <p>Build the performance notes → PIP → termination timeline that defeats pretext.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Protected activity lookback</h4>
                      <p>Adverse-action timing; manager speech and political/off-duty conduct.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 3 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Employment-Related Torts</h3>
                  <p>Defamation, IIED, interference, and misrepresentation risks.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>References and internal comms</h4>
                      <p>Avoid defamation; understand privilege boundaries.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>IIED, interference, misrepresentation</h4>
                      <p>How sloppy recruiting or RIF messaging creates exposure.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-expert">Expert</span></div>
                    <div class="competency-text">
                      <h4>Negligent hiring/retention/supervision</h4>
                      <p>Avoid vendor and staffing-agency pitfalls with better controls.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 4 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>ADR: Building a Fair, Defensible System</h3>
                  <p>Design choices, opt-outs, cost-sharing, and remote hearings.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Program design</h4>
                      <p>Pros/cons; opt-out windows; class/collective treatment; record retention.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Annual audit of agreement & intake flows</h4>
                      <p>Onboarding portals, e-sign, and off-cycle hires—keep the chain clean.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 5 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Substance Use & Fitness for Duty</h3>
                  <p>Cannabis, impairment testing, and prescription meds in hybrid contexts.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Cannabis laws & safety-sensitive roles</h4>
                      <p>Impairment vs presence testing; consistent enforcement; accommodation analysis.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Prescription meds and fitness-for-duty</h4>
                      <p>Balancing safety, privacy, and performance in remote/hybrid contexts.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 6 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Workplace Privacy & Monitoring</h3>
                  <p>Employee data privacy and productivity monitoring in practice.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>Employee data privacy</h4>
                      <p>CPRA and state analogs: notices, access requests, retention/deletion, and disciplinary use.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Monitoring productivity and keystrokes</h4>
                      <p>Geolocation, BYOD, and personal-account discovery—practical boundaries.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Competency Group 7 -->
            <div class="competency-group">
              <div class="competency-header" role="button" tabindex="0" aria-expanded="false">
                <div>
                  <h3>Protecting Confidential Information & Mobility</h3>
                  <p>Post-employment restrictions after the FTC rule's vacatur.</p>
                </div>
                <div class="competency-toggle"></div>
              </div>
              <div class="competency-content">
                <div class="competency-list">
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-foundation">Foundation</span></div>
                    <div class="competency-text">
                      <h4>What remains enforceable</h4>
                      <p>NDAs, non-solicits, trade-secret law—how to draft so they stick.</p>
                    </div>
                  </div>
                  <div class="competency-item">
                    <div class="competency-item-badge"><span class="skill-badge badge-advanced">Advanced</span></div>
                    <div class="competency-text">
                      <h4>Garden leave and TRAPs</h4>
                      <p>Training-repayment agreements and choice-of-law strategy across states.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </div>

      </div>
    </section>

    <!-- CTA Section -->
    <section id="transform-cta" class="theme-light py-5xl">
      <div class="container container-lg mx-auto text-center">
        <h2 class="font-body text-display-lg text-primary font-light tracking-tight">
          Ready to Transform Your Workplace?
        </h2>
        <div class="cta-button-group">
          <a href="#register" class="btn btn-register hover-lift">REGISTER NOW</a>
          <a href="#" class="btn btn-primary hover-lift">DOWNLOAD FULL PROGRAM PACKAGE</a>
        </div>
      </div>
    </section>

<style>
    /* CSS Variables */
    :root {
        --font-heading: 'Playfair Display', Georgia, 'Times New Roman', serif;
        --blue-primary: #3B5998;
        --dark-blue: #2E4A8A;
        /* Dark Background Variables */
        --background-black: #000000;
        --surface-dark: #0f1217;
        --surface-darker: #0a0d11;
        --text-primary: #ffffff;
        --text-secondary: #5a6c7d;
        --text-muted: #9ca3af;
    }

    .session-content::before {
        content: "";
        position: absolute;
        width: 1px;
        height: 100%;
        background: #ffffff;
        /* display: flex; */
        /* justify-content: center; */
        /* align-items: center; */
        left: 50%;
        opacity: 0;
    }
    .session-card.expanded .session-content::before {
        opacity: 0.3;
    }
    /* Scope */
    .program-sessions-widget {
        font-family: 'Lato', sans-serif;
        color: #ffffff;
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 0;
    }
    /* Section */
    .program-sessions-widget .program-sessions-section {
        padding: 10rem 0;
        background: var(--background-black);
        min-height: 100vh;
        width: 100%;
        margin: 0;
    }

    /* >>> Centered container */
    .program-sessions-widget .sessions-container {
        display: flex;
        flex-direction: row;
        overflow-x: hidden;
        overflow-y: visible;
        scroll-behavior: smooth;
        gap: 1rem;
        padding: 1rem 4rem 2rem 4rem;
        scrollbar-width: none;
        -ms-overflow-style: none;
        width: 100%;
        justify-content: center;
        position: relative;
        z-index: 2;
    }
    /* keep 1–2 cards centered */
    .program-sessions-widget .sessions-container.single-card,
    .program-sessions-widget .sessions-container.two-cards {
        justify-content: center;
    }

    .program-sessions-widget .sessions-container::-webkit-scrollbar {
        display: none;
    }

    .program-sessions-widget .session-card {
        flex-shrink: 0;
        min-width: 280px;
        max-width: 400px;
        min-height: 350px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        overflow: hidden;
    }

    /* Expanded card: 45% */
    .program-sessions-widget .session-card.expanded {
        transform: scale(1.02);
        width: 50%;
        min-width: 50%;
        max-width: 50%;
        border: 1.5px solid rgba(59, 130, 246, 0.8);
        box-shadow:
            0 0 0 1px rgba(59, 130, 246, 0.25),
            0 0 12px rgba(59, 130, 246, 0.35),
            0 3px 10px rgba(0, 0, 0, 0.25);
        transition: all 0.3s ease;
    }
    .program-sessions-widget .session-card.expanded:hover {
        border-color: #60A5FA;
        box-shadow:
            0 0 0 1px rgba(96, 165, 250, 0.4),
            0 0 16px rgba(96, 165, 250, 0.5),
            0 4px 12px rgba(0, 0, 0, 0.3);
        transform: scale(1.03);
    }

    /* Collapsed share remaining 55% */
    .program-sessions-widget .session-card:not(.expanded) {
        width: calc(50% / 3);
        min-width: calc(50% / 3);
        max-width: calc(50% / 3);
    }

    /* Card visuals */
    .program-sessions-widget .card-background {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 0;
        background-color: #1a1a1a;
    }
    .program-sessions-widget .card-overlay {
        position: absolute;
        inset: 0;
        z-index: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        padding: 1.5rem;
        background: linear-gradient(to bottom, rgba(0, 0, 0, .3) 0%, rgba(0, 0, 0, .4) 40%, rgba(0, 0, 0, .65) 70%, rgba(0, 0, 0, .8) 100%);
        transition: background .3s
    ease;
    }
    .program-sessions-widget .session-card.expanded .card-overlay {
        background: linear-gradient(to bottom, rgba(0,0,0,.4) 0%, rgba(0,0,0,.5) 40%, rgba(0,0,0,.7) 70%, rgba(0,0,0,.85) 100%);
    }

    /* Darker overlay for virtual */
    .program-sessions-widget .session-card[data-format="virtual"] .card-overlay {
        background: linear-gradient(to bottom, rgba(0,0,0,.5) 0%, rgba(0,0,0,.6) 40%, rgba(0,0,0,.75) 70%, rgba(0,0,0,.9) 100%);
    }
    .program-sessions-widget .session-card[data-format="virtual"].expanded .card-overlay {
        background: linear-gradient(to bottom, rgba(0,0,0,.6) 0%, rgba(0,0,0,.7) 40%, rgba(0,0,0,.8) 70%, rgba(0,0,0,.92) 100%);
    }


    .program-sessions-widget .session-card .session-main-info{
    width: auto;
    }
    .program-sessions-widget .session-card .session-faculty{
        width: auto;

    }
    .program-sessions-widget .session-card.expanded .session-main-info{
    width: 50% !important;
    }
    .program-sessions-widget .session-card.expanded .session-faculty{
        width: 50% !important;

    }



    .program-sessions-widget .session-content { position: relative; z-index: 2; color: white; display: flex; gap: 2rem;
        width: 100%;}
    .program-sessions-widget .session-main-info { display: flex; flex-direction: column; gap: .4rem; }
    .program-sessions-widget .session-date { font-family: 'Lato', sans-serif; font-size: 1.1rem; font-weight: 600; color: #fff; margin-bottom: .25rem; line-height: 1.3; text-shadow: 0 2px 4px rgba(0,0,0,.5); }
    .program-sessions-widget .session-location { font-size: .95rem; font-weight: 400; color: #e5e5e5; margin-bottom: 0px; line-height: 1.2; text-shadow: 0 1px 3px rgba(0,0,0,.5); }
    .program-sessions-widget .session-card[data-format="virtual"] .session-location { color: #60A5FA; font-weight: 500; display:none;}
    .program-sessions-widget .session-card[data-format="on-demand"] .session-location { color: #e5e5e5; }

    .program-sessions-widget .session-venue { font-size: .9rem; font-weight: 500; color: #fff; margin-bottom: -8px; line-height: 1.1; text-shadow: 0 2px 4px rgba(0,0,0,.6); letter-spacing: .3px; }
    .program-sessions-widget .session-price { font-size: 1.5rem; font-weight: 700; color: #10B981; margin: .5rem 0; line-height: 1.1; text-shadow: 0 2px 4px rgba(0,0,0,.6); letter-spacing: .5px; }
    .program-sessions-widget .session-card[data-format="on-demand"] .session-price { color: #10B981; font-size: 1.8rem; font-weight: 800; }

    .program-sessions-widget .hotel-details-link { font-size: .85rem; color: #60A5FA; text-decoration: underline; cursor: pointer; transition: color .2s ease; margin-top: 0px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,.5); }
    .program-sessions-widget .hotel-details-link:hover { color: #60A5FA; }

    .program-sessions-widget .reserve-btn {
        display: none; margin-top: 1rem; padding: .75rem 1.5rem;
        background: #e93d3d;
        color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
        transition: all .3s ease; text-transform: uppercase; letter-spacing: .5px; font-size: .9rem;
        box-shadow: 0 4px 6px rgba(0,0,0,.3);
        text-align: center;
        text-decoration: none;
    }
    .program-sessions-widget .reserve-btn:hover { background: #ff4c4c; transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,.4); }

    .program-sessions-widget .session-faculty { display: none; margin-top: 0rem; padding-top: 0rem;}
    .program-sessions-widget .faculty-title { font-size: .85rem; color: #10B981; text-transform: uppercase; letter-spacing: 1px; margin-bottom: .75rem; font-weight: 600; display: none;}
    .program-sessions-widget .faculty-list { display: flex; flex-direction: column; gap: .75rem; }
    .program-sessions-widget .faculty-member { display: flex; flex-direction: column; gap: .25rem; }
    .program-sessions-widget .faculty-name { color: #60A5FA; font-weight: 600; font-size: .95rem; cursor: pointer; transition: color .2s ease; text-decoration: none; }
    .program-sessions-widget .faculty-name:hover { color: #93C5FD; text-decoration: underline; }
    .program-sessions-widget .faculty-title-text { color: #9CA3AF; font-size: .85rem; line-height: 1.4; }

    /* Toggle buttons */
    .program-sessions-widget .format-toggle {
        display: flex; justify-content: center; gap: 1rem; margin: 2rem 0 2rem 0; padding: 0 4rem;
    }
    .program-sessions-widget .toggle-option {
        padding: .75rem 2rem; background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2);
        border-radius: 8px; color: #fff; cursor: pointer; transition: all .3s ease; font-weight: 500; font-size: 1rem;
        text-transform: uppercase; font-family: 'Lato', sans-serif;
    }
    .program-sessions-widget .toggle-option:hover { background: rgba(255,255,255,.15); border-color: rgba(255,255,255,.3); }
    .program-sessions-widget .toggle-option.active { background: linear-gradient(135deg,#3B5998 0%,#2E4A8A 100%); border-color: #4A6BA8; box-shadow: 0 4px 8px rgba(0,0,0,.3); }

    /* Arrows */
    .program-sessions-widget .circular-arrow {
        width: 60px; height: 60px; background: rgba(59,89,152,.9); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all .3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,.4); border: 2px solid rgba(255,255,255,.2); position: relative; z-index: 1001;
    }
    .program-sessions-widget .circular-arrow:hover { background: rgba(74,107,168,1); transform: scale(1.1); box-shadow: 0 6px 16px rgba(0,0,0,.5); }
    .program-sessions-widget .circular-arrow .arrow-icon { width: 24px; height: 24px; color: white; }
    .program-sessions-widget .circular-arrow.disabled { opacity: .3; cursor: not-allowed; pointer-events: none; }

    /* Arrow containers */
    .program-sessions-widget .arrow-container-left,
    .program-sessions-widget .arrow-container {
        position: absolute; top: 0; bottom: 0; width: calc(55% / 3);
        display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 1000;
    }
    .program-sessions-widget .arrow-container-left { left: 4rem; }
    .program-sessions-widget .arrow-container { right: 4rem; }
    .program-sessions-widget .arrow-container-left .circular-arrow,
    .program-sessions-widget .arrow-container .circular-arrow { pointer-events: auto; position: static; transform: none; margin: 0; }


    .session-card .session-main-info .session-venue, .session-card .session-main-info .hotel-details-link {
        display: none;
    }

    .session-card.expanded .session-main-info .session-venue, .session-card.expanded .session-main-info .hotel-details-link {
        display: block;
    }

    /* Show "Virtual Program" text on all Virtual cards, not just expanded ones */
    .session-card[data-format="virtual"] .session-main-info .session-venue {
        display: block;
    }


    /* Paging helper */
    .program-sessions-widget .card-hidden { display: none !important; }

    /* Pagination layout */
    .program-sessions-widget .sessions-container.paginated {
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      min-height: 400px;
    }

    .program-sessions-widget .sessions-container.paginated .session-card {
      width: calc(33.333% - 1rem);
      /* min-width: 280px;
      max-width: 400px; */
      flex-shrink: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .program-sessions-widget .sessions-container.paginated .session-card.expanded {
      width: calc(50% - 1rem);
      min-width: 50%;
      max-width: 50%;
    }

    .program-sessions-widget .sessions-container.paginated .session-card:not(.expanded) {
      width: calc(33.333% - 1rem);
      /* min-width: 280px;
      max-width: 280px; */
    }

    .program-sessions-widget .session-card.hidden-page {
      display: none !important;
    }

    /* Pagination Controls */
    .program-sessions-widget .pagin-wrapper {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      margin-top: 2rem;
      padding: 0 2rem;
      position: relative;
    }
    button#next-btn {
    position: absolute;
    right: 4%;
    top: 60%;
    z-index: 99;
    }
    button#prev-btn{
        position: absolute;
        left: 4%;
        top: 60%;
        z-index: 99;
    }
    .program-sessions-widget .pagination-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      flex: 1;
    }

    .program-sessions-widget .pagination-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
    }

    .program-sessions-widget .pagination-btn {
      width: 50px;
      height: 50px;
      background: rgba(59, 89, 152, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    .program-sessions-widget .pagination-btn:hover {
      background: rgba(74, 107, 168, 1);
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
    }

    .program-sessions-widget .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      pointer-events: none;
    }

    .program-sessions-widget .pagination-info {
      color: #e5e5e5;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      min-width: 200px;
    }

    .program-sessions-widget .pagination-dots {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .program-sessions-widget .pagination-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .program-sessions-widget .pagination-dot.active {
      background: #3B5998;
      transform: scale(1.2);
    }

    .program-sessions-widget .pagination-dot:hover {
      background: rgba(255, 255, 255, 0.6);
    }

    /* pagin-wrapper styling moved to pagination controls section above */

    /* Remove old absolute positioning since we restructured the pagination */
    .pagination-info, #pagination-dots{
        display: none;
    }

    /* Loading */
    .program-sessions-widget .loading-container { display: flex; justify-content: center; align-items: center; min-height: 400px; color: white; font-size: 1.2rem; }
    .program-sessions-widget .loading-spinner { border: 4px solid rgba(255,255,255,.1); border-top: 4px solid #3B5998; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% {transform: rotate(0)} 100% {transform: rotate(360deg)} }

    .section-card.pricing{
        margin: 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: end;
        gap: 0;
        flex-direction: column;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .program-sessions-widget .sessions-container { padding: 1rem 3rem 2rem 3rem; }
        .program-sessions-widget .session-card.expanded { width: 40%; min-width: 40%; max-width: 40%; }
        .program-sessions-widget .session-card:not(.expanded) { width: calc(50%/3); min-width: calc(50%/3); max-width: calc(50%/3); }
        .program-sessions-widget .arrow-container-left { left: 3rem; width: calc(60%/3); }
        .program-sessions-widget .arrow-container { right: 3rem; width: calc(60%/3); }
        .program-sessions-widget .circular-arrow { width: 50px; height: 50px; }
        .program-sessions-widget .circular-arrow .arrow-icon { width: 20px; height: 20px; }

        /* Adjust pagination arrows for tablet */
        button#next-btn {
            right: 2%;
            top: 50%;
        }
        button#prev-btn {
            left: 2%;
            top: 50%;
        }

        /* .program-sessions-widget .sessions-container.paginated .session-card:not(.expanded) {
        width: calc(33.333% - 1rem);
        min-width: 140px;
        max-width: 140px;
        } */
    }

    @media (min-width: 768px) and (max-width: 1024px) {
    .program-sessions-widget .sessions-container.paginated .session-card:not(.expanded) {
        width: calc(33.333% - 1rem);
        min-width: 140px;
        max-width: 140px;
    }
    }
    @media (max-width: 1024px) {
        .program-sessions-widget .sessions-container { padding: 1rem 3rem 2rem 3rem; }
        .program-sessions-widget .sessions-container.paginated .session-card {
            width: calc(50% - 1rem);
            min-width: 280px;
            max-width: 400px;
        }
        .program-sessions-widget .sessions-container.paginated .session-card.expanded {
            width: calc(50% - 1rem);
            min-width: 40%;
            max-width: 40%;
        }
        .program-sessions-widget .session-card.expanded { width: 50%; min-width: 50%; max-width: 50%; }
        .program-sessions-widget .session-card:not(.expanded) { width: calc(50%/2); min-width: calc(50%/2); max-width: calc(50%/2); }
        .program-sessions-widget .arrow-container-left { left: 3rem; width: calc(50%/2); }
        .program-sessions-widget .arrow-container { right: 3rem; width: calc(50%/2); }

        /* Adjust pagination arrows for smaller tablets */
        /* button#next-btn {
    position: absolute;
    right: 25%;
    bottom: -4%;
    top: auto;
}
button#prev-btn {
        position: absolute;
        left: 25%;
        top: auto;
        bottom: -4%;
    }
         */
        .program-sessions-widget .pagin-wrapper {
            padding: 0 1rem;
            flex-direction: column;
        }
    }
    @media (max-width: 767px){
        .program-sessions-widget .sessions-container.paginated .session-card {
            width: 100%;
            min-width: 100% !important;
            max-width: 100% !important;
        }
    }

    @media (max-width: 768px) {
        .program-sessions-widget .sessions-container {
            padding: 1rem 1rem 1.25rem 1rem;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
        }

        .program-sessions-widget .session-card,
        .program-sessions-widget .session-card.expanded,
        .program-sessions-widget .session-card:not(.expanded) {
            width: 100%;
            min-width: 100%;
            max-width: 600px;
        }
        .program-sessions-widget .arrow-container-left,
        .program-sessions-widget .arrow-container {
            display: none;
        }
        .program-sessions-widget .format-toggle { flex-direction: column; align-items: center; padding: 0 1rem; }
        .program-sessions-widget .toggle-option { width: 100%; max-width: 300px; text-align: center; }

        /* Mobile pagination layout - arrows back to inline */
        .program-sessions-widget .pagin-wrapper {
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
            padding: 0 1rem;
        }

        .program-sessions-widget .pagination-wrapper {
            flex-direction: row;
            flex: 1;
        }

        .program-sessions-widget .pagination-container {
            flex-direction: row;
            gap: 1rem;
        }

        .program-sessions-widget .pagination-btn {
            width: 45px;
            height: 45px;
        }

        /* Reset absolute positioning for mobile */
        /* button#next-btn {
            position: static;
            right: auto;
            top: auto;
        }
        button#prev-btn {
            position: static;
            left: auto;
            top: auto;
        } */
     button#next-btn {
    position: absolute;
    right: 25%;
    bottom: -4%;
    top: auto;
}
button#prev-btn {
        position: absolute;
        left: 25%;
        top: auto;
        bottom: -4%;
    }


    }

    /* Empty state */
    .program-sessions-widget .empty-state{
      width:100%; max-width:860px; margin:0 auto; padding:3rem 1rem; text-align:center;
      color:#e5e5e5; border:1px dashed rgba(255,255,255,.15); border-radius:12px; font-size:1.05rem;
    }

    /* Hotel Modal Styles - Enhanced Design */
    .hotel-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .hotel-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(8px);
        animation: overlayFadeIn 0.3s ease-out;
    }

    @keyframes overlayFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .hotel-modal-container {
        position: relative;
        z-index: 1002;
        background: #ffffff;
        border-radius: 20px;
        max-width: 650px;
        width: 90%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow:
            0 25px 80px rgba(0, 0, 0, 0.15),
            0 0 0 1px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.1);
        animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .hotel-modal-header {
        background: linear-gradient(135deg, #3B5998 0%, #2E4A8A 50%, #1e3a5f 100%);
        padding: 2rem 2.5rem;
        color: #ffffff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .hotel-modal-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.05) 100%);
        pointer-events: none;
    }

    .hotel-modal-title {
        font-family: 'Lato', sans-serif;
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
        letter-spacing: 0.5px;
        position: relative;
        z-index: 1;
    }

    .hotel-modal-title::before,
    .hotel-modal-title::after {
        display: none !important;
    }

    .hotel-modal-close {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
        backdrop-filter: blur(10px);
    }

    .hotel-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .hotel-modal-body {
        padding: 2.5rem;
        overflow-y: auto;
        flex: 1;
        color: #333333;
        background: #ffffff;
        font-family: 'Lato', sans-serif;
    }

    /* Custom scrollbar for modal body */
    .hotel-modal-body::-webkit-scrollbar {
        width: 6px;
    }

    .hotel-modal-body::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
    }

    .hotel-modal-body::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #3B5998, #60A5FA);
        border-radius: 3px;
    }

    .hotel-modal-body::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #2E4A8A, #3B5998);
    }

    .hotel-section {
        margin-bottom: 2.5rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .hotel-section:hover {
        background: #f1f3f4;
        border-color: #dee2e6;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .hotel-section-title {
        font-family: 'Lato', sans-serif;
        font-size: 0.9rem;
        font-weight: 700;
        color: #3B5998;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .hotel-section-title::before {
        display: none;
    }

    .hotel-section-content {
        color: #666666;
        line-height: 1.7;
        margin: 0;
        font-size: 1rem;
        font-weight: 400;
        font-family: 'Lato', sans-serif;
    }

    .hotel-cost-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .hotel-cost-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        background: #ffffff;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    /* .hotel-cost-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, #10B981, #34D399);
        opacity: 0.8;
    } */

    .hotel-cost-item:hover {
        background: #f8f9fa;
        border-color: #dee2e6;
        transform: translateX(5px);
    }

    .hotel-cost-label {
        color: #666666;
        font-weight: 500;
        font-size: 0.95rem;
        letter-spacing: 0.3px;
        font-family: 'Lato', sans-serif;
    }

    .hotel-cost-value {
        color: #10B981;
        font-weight: 700;
        font-size: 1.1rem;
        font-family: 'Lato', sans-serif;
    }

    .hotel-booking-section {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 80px;
    }

    .hotel-booking-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #e93d3d 0%, #dc2626 100%);
        color: white;
        text-decoration: none;
        border-radius: 12px;
        font-family: 'Lato', sans-serif;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.95rem;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow:
            0 8px 20px rgba(233, 61, 61, 0.3),
            0 0 0 1px rgba(255, 255, 255, 0.1);
        position: relative;
        overflow: hidden;
        border: none;
        cursor: pointer;
        min-width: 200px;
    }

    .hotel-booking-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .hotel-booking-btn:hover::before {
        left: 100%;
    }

    .hotel-booking-btn:hover {
        background: linear-gradient(135deg, #ff4c4c 0%, #ef4444 100%);
        transform: translateY(-3px) scale(1.02);
        box-shadow:
            0 12px 30px rgba(233, 61, 61, 0.4),
            0 0 0 1px rgba(255, 255, 255, 0.2);
        color: white;
        text-decoration: none;
    }

    .hotel-booking-btn:active {
        transform: translateY(-1px) scale(0.98);
    }

    @media (max-width: 768px) {
        .hotel-modal-container {
            width: 95%;
            max-height: 95vh;
            border-radius: 16px;
        }

        .hotel-modal-header {
            padding: 1.5rem 2rem;
        }

        .hotel-modal-title {
            font-size: 1.4rem;
        }

        .hotel-modal-close {
            width: 35px;
            height: 35px;
            font-size: 1.3rem;
        }

        .hotel-modal-body {
            padding: 2rem 1.5rem;
        }

        .hotel-section {
            padding: 1.25rem;
            margin-bottom: 2rem;
        }

        .hotel-section-title {
            font-size: 0.85rem;
        }

        .hotel-cost-item {
            padding: 0.875rem 1.25rem;
        }

        .hotel-booking-btn {
            padding: 0.875rem 1.5rem;
            font-size: 0.9rem;
            min-width: 180px;
        }
    }


    @media (max-width: 480px) {
    .iaml-modal-overlay .card {
    padding: 6px !important;
    }
    .program-sessions-widget .reserve-btn {
        padding: .75rem;
        font-size: .7rem;
    }
    .program-sessions-widget .session-content {
        flex-direction: column;
    }
    .program-sessions-widget .session-card.expanded .session-main-info {
        width: 100% !important;
    }
    .program-sessions-widget .session-card.expanded .session-faculty {
        width: 100% !important;
    }
    .session-card.expanded .session-content::before {
        opacity: 0;
    }
    .program-sessions-widget .session-card{
        min-height: 395px;
    }

    /* Very small mobile pagination adjustments */
    .program-sessions-widget .pagin-wrapper {
        gap: 0.5rem;
        padding: 0 0.5rem;
        flex-direction: column;
    }

    .program-sessions-widget .pagination-btn {
        width: 40px;
        height: 40px;
    }

    .program-sessions-widget .pagination-info {
        font-size: 0.9rem;
        min-width: 150px;
    }

    }

    /* ========================================== */
    /* REGISTRATION MODAL STYLES */
    /* ========================================== */

    /* Fallback styles if design system not available */
    :root {
      --text: #0f172a;
      --muted: #475569;
      --primary: #2563eb;
      --primary-600: #1d4ed8;
      --surface: #ffffff;
      --border: #e2e8f0;
      --danger: #dc2626;
      --success: #16a34a;
    }

    /* Button fallbacks if DS .btn is not present */
    .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: 14px; padding: 12px 20px; cursor: pointer; font-weight: 700; border: 1px solid transparent; transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease; font-family: 'Lato', sans-serif; text-transform: uppercase; }
    .btn-primary { background: #1d4ed8; color: #fff; border-color: #1d4ed8; box-shadow: 0 16px 32px rgba(29, 78, 216, .32), inset 0 -2px 0 rgba(0,0,0,.08); }
    .btn-primary:hover { background: #1e40af; transform: translateY(-1px); box-shadow: 0 20px 44px rgba(29, 78, 216, .36), inset 0 -2px 0 rgba(0,0,0,.08); }
    .btn-secondary { background: #ffffff; color: #374151; border-color: #6B7280; box-shadow: 0 6px 16px rgba(2, 6, 23, 0.06); }
    .btn-secondary:hover { border-color: #6B7280; transform: translateY(-1px); box-shadow: 0 10px 24px rgba(2, 6, 23, 0.08); }
    .btn[disabled], .btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }
    .hover-lift:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(2, 6, 23, 0.08); }

    .iaml-modal-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(2,6,23,0.45); z-index: 1010; }
    .iaml-modal-overlay[data-open="true"] { display: flex; animation: fadeIn 200ms ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .iaml-modal { width: min(820px, 94vw); max-height: 94vh; overflow: hidden; background: #ffffff; border: 1px solid #e7edf6; border-radius: 20px; box-shadow: 0 30px 70px rgba(2,6,23,0.22); display: grid; grid-template-rows: auto 1fr auto; }
    .iaml-header { padding: 24px 28px; display: flex; align-items: center; justify-content: space-between; border-bottom: 0; background: linear-gradient(180deg, #0f2a66 0%, #3256a6 100%); color: #fff; box-shadow: 0 6px 20px rgba(15, 42, 102, 0.25); }
    .iaml-title { display: flex; gap: 12px; align-items: center; }
    .iaml-title h2 { font-family: 'Playfair Display', Georgia, serif; font-weight: 700; font-size: 28px; line-height: 1.15; color: #fff; }
    #iamlSubTitle { display: none; margin-left: 12px; }
    .iaml-close { background: transparent; border: none; font-size: 22px; line-height: 1; cursor: pointer; color: rgba(255,255,255,0.95); }

    .iaml-modal-overlay .iaml-content { padding: 24px 28px; overflow: auto; font-family: 'Lato', sans-serif; }
    .iaml-modal-overlay .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 800px) { .iaml-modal-overlay .grid-2 { grid-template-columns: 1fr; } }
    .iaml-modal-overlay .card { background: #ffffff; border: 1px solid #e7edf6; border-radius: 16px; padding: 20px; box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06); overflow: hidden; }
    .iaml-modal-overlay h3 { font-family: 'Playfair Display', Georgia, serif; font-weight: 700; font-size: 28px; letter-spacing: -0.01em; margin: 0 0 20px; color: #0f172a; }
    /* Slightly smaller heading on the format step with larger spacing below */
    .iaml-modal-overlay #step1 > h3 { font-size: 26px; margin-bottom: 28px; }
    .iaml-modal-overlay .field { display: flex; flex-direction: column; gap: 6px; }
    .iaml-modal-overlay .field label { font-size: 13px; color: var(--muted); font-family: 'Lato', sans-serif; font-weight: 600; }
    .iaml-modal-overlay .field input, .iaml-modal-overlay .field select { border: 1px solid #cbd5e1; color: black; background: #fff; border-radius: 12px; padding: 12px 14px; font-size: 15px; font-family: 'Lato', sans-serif; }
    .iaml-modal-overlay .field input:focus, .iaml-modal-overlay .field select:focus { outline: 3px solid rgba(37, 99, 235, 0.22); border-color: #2563eb; }

    /* Minimal progress indicator (5 stages) */
    .iaml-modal-overlay .progress { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 24px; }
    .iaml-modal-overlay .progress .node { width: 10px; height: 10px; border-radius: 50%; border: 2px solid #cbd5e1; background: #fff; }
    .iaml-modal-overlay .progress .node.active { border-color: #1d4ed8; background: #1d4ed8; }
    .iaml-modal-overlay .progress .node.current { border-color: #1d4ed8; background: #1d4ed8; border-width: 3px; }
    .iaml-modal-overlay .progress .line { height: 2px; width: 40px; background: #e2e8f0; }
    .iaml-modal-overlay .progress .line.active { background: #93c5fd; }
    /* Step 2 progress spacing */
    .iaml-modal-overlay #progressStep2 { margin-top: 32px; margin-bottom: 44px; }

    /* Format options as accessible radio rows */
    .iaml-modal-overlay .format-options { display: grid; gap: 12px; margin-top: 6px; margin-bottom: 20px; }
    .iaml-modal-overlay .option-row {color:black; display: flex; align-items: center; gap: 12px; padding: 16px 22px; width: 100%; border: 1px solid #e7edf6; border-radius: 12px; background: #fafcff; cursor: pointer; user-select: none; box-sizing: border-box; font-family: 'Lato', sans-serif; font-size: 16px; }
    .iaml-modal-overlay .option-row:hover { border-color: #cfe2ff; background: #f3f8ff; }
    .iaml-modal-overlay .option-row input[type="radio"] { width: 16px; height: 16px; }

    /* Ensure attendance rows don't bleed outside the card */
    .iaml-modal-overlay #step3 .option-row { margin: 8px 12px; border-radius: 12px; width: auto; }
    .iaml-modal-overlay #step3 .option-row:first-child { margin-top: 0; }
    .iaml-modal-overlay #step3 .option-row:last-child { margin-bottom: 0; }

    /* Sessions timeline list for Step 4 */
    .iaml-modal-overlay .sessions-list { display: grid; gap: 14px; max-height: 440px; overflow: auto; padding-right: 6px; }
    .iaml-modal-overlay .session-card { display: grid; grid-template-columns: auto auto 1fr; align-items: center; gap: 16px; padding: 16px; border: 1px solid #e7edf6; border-radius: 12px; background: #fafcff; cursor: pointer; }
    .iaml-modal-overlay .session-card:hover { border-color: #cfe2ff; background: #f3f8ff; }
    .iaml-modal-overlay .session-card[data-selected="true"] { border-color: #1d4ed8; background: #eef2ff; }
    .iaml-modal-overlay .session-radio { width: 18px; height: 18px; }
    .iaml-modal-overlay .session-thumb { width: 120px; height: 80px; border-radius: 8px; object-fit: cover; background: #E5E7EB; border: 1px solid #e5e7eb; display: grid; place-items: center; color: #6b7280; font-size: 20px; }
    .iaml-modal-overlay .session-info { display: grid; gap: 4px; }
    .iaml-modal-overlay .session-loc { font-weight: 600; font-size: 18px; color: #0f172a; }
    .iaml-modal-overlay .session-date { font-size: 16px; color: #475569; }
    .iaml-modal-overlay .session-venue { font-size: 14px; color: #64748b; }
    .iaml-modal-overlay .sessions-empty { text-align: center; color: #475569; padding: 40px 12px; }
    /* Defensive: never show attendance controls within step 5 */
    .iaml-modal-overlay #step5 #attendanceOptions,
    .iaml-modal-overlay #step5 input[name="attendanceTypeFull"],
    .iaml-modal-overlay #step5 input[name="attendanceBlocks"],
    .iaml-modal-overlay #step5 .option-row { display: none !important; }

    .iaml-modal-overlay .steps { display: grid; grid-auto-flow: column; gap: 10px; padding: 14px 24px; background: #fff; border-top: 1px solid #e7edf6; }
    .iaml-modal-overlay .step { font-size: 13px; color: #475569; padding: 10px 12px; border-radius: 12px; border: 1px dashed #e2e8f0; background: #fff; }
    .iaml-modal-overlay .step[data-active="true"] { color: #1d4ed8; border-color: #c7d2fe; background: #eef2ff; }

    .iaml-modal-overlay .iaml-footer { padding: 18px 24px; display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #e7edf6; background: #ffffff; box-shadow: 0 -10px 30px rgba(2, 6, 23, 0.06); }
    .iaml-modal-overlay .text-muted { color: var(--muted); font-size: 13px; }
    .iaml-modal-overlay .text-danger { color: var(--danger); }
    .iaml-modal-overlay .text-success { color: var(--success); }
    .iaml-modal-overlay .inline { display: inline-flex; align-items: center; gap: 8px; }

    .iaml-modal-overlay .spinner { width: 16px; height: 16px; border-radius: 50%; border: 2px solid rgba(2,6,23,0.1); border-top-color: var(--primary); animation: spin 600ms linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .iaml-modal-overlay .hidden { display: none; }
    .iaml-modal-overlay .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    /* URL Builder panel */
    #urlBuilderToggle { position: fixed; bottom: 16px; right: 16px; z-index: 1200; }
    #urlBuilderPanel[hidden] { display: none; }
    #urlBuilderPanel { position: fixed; right: 16px; bottom: 72px; width: min(420px, 94vw); background: #fff; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 16px 48px rgba(2,6,23,0.12); padding: 16px; z-index: 1200; }
    .iaml-modal-overlay .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Overlay preloader demo */
    .iaml-modal-overlay .preload-overlay { position: fixed; inset: 0; background: rgba(2,6,23,0.35); display: none; align-items: center; justify-content: center; z-index: 1200; }
    .iaml-modal-overlay .preload-overlay[data-show="true"] { display: flex; }
    .iaml-modal-overlay .preload-box { background: #fff; border: 1px solid #e7edf6; border-radius: 14px; padding: 18px 22px; box-shadow: 0 20px 60px rgba(2,6,23,0.28); display: grid; gap: 10px; align-items: center; justify-items: center; }
    .iaml-modal-overlay .spinner.lg { width: 28px; height: 28px; border-width: 3px; }
    .iaml-modal-overlay .msg { color: #0f172a; font-weight: 600; }

    /* Skeleton demo */
    .iaml-modal-overlay .skeleton { animation: pulse 1.2s ease-in-out infinite; background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 37%, #f3f4f6 63%); background-size: 400% 100%; }
    @keyframes pulse { 0% { background-position: 100% 0 } 100% { background-position: -100% 0 } }
    .iaml-modal-overlay .session-card.skel { grid-template-columns: 120px 1fr; }
    .iaml-modal-overlay .thumb-skel { width: 120px; height: 80px; border-radius: 8px; }
    .iaml-modal-overlay .line-skel { height: 14px; border-radius: 6px; margin: 6px 0; }

    /* Chip + bar demo */
    .iaml-modal-overlay .topbar { height: 3px; width: 100%; background: linear-gradient(90deg, #2563eb 0%, rgba(37,99,235,0.1) 60%); background-size: 200% 100%; animation: barMove 3s linear infinite; border-radius: 2px; }
    @keyframes barMove { 0% { background-position: 0 0 } 100% { background-position: -200% 0 } }
    .iaml-modal-overlay .chip { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border: 1px solid #e7edf6; border-radius: 12px; background: #fff; color: #0f172a; font-size: 13px; }

    /* Coupon row layout */
    .iaml-modal-overlay .coupon-row { display: flex; gap: 14px; align-items: stretch; }
    .iaml-modal-overlay .coupon-input { flex: 1 1 auto; border: 1px solid #cbd5e1; background: #fff; border-radius: 12px; padding: 12px 14px; font-size: 15px; color: #111827; }
    .iaml-modal-overlay .apply-coupon-btn { flex: 0 0 180px; border: 1px solid #6B7280; background: #ffffff; color: #374151; font-weight: 600; border-radius: 12px; padding: 12px 16px; }
    .iaml-modal-overlay .apply-coupon-btn:hover { background: #F3F4F6; }
    .iaml-modal-overlay .coupon-msg { font-size: 14px; margin-top: 8px; }
    .iaml-modal-overlay .coupon-msg.text-success { color: #059669; }
    .iaml-modal-overlay .coupon-msg.text-danger { color: #EF4444; }
    @media (max-width: 640px) {
      .iaml-modal-overlay .coupon-row { flex-direction: column; }
      .iaml-modal-overlay .apply-coupon-btn { flex: 0 0 auto; width: 100%; }
    }

    /* Small badge for certificate items */
    .iaml-modal-overlay .badge-cert { display: inline-block; margin-left: 10px; padding: 2px 8px; font-size: 12px; line-height: 1; border: 1px solid #dc2626; background: #dc2626; border-radius: 999px; color: #ffffff; }

    /* Step 6 review styles */
    .iaml-modal-overlay #step6 .review-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 16px; }
    @media (max-width: 800px) { .iaml-modal-overlay #step6 .review-grid { grid-template-columns: 1fr; } }
    .iaml-modal-overlay .section-card { background: #f9fafb; border: 1px solid #e7edf6; border-radius: 12px; padding: 18px; }
    .iaml-modal-overlay #step6 .section-title { text-align:left !important; font-weight: 700 !important; color: #0f172a !important; font-size: 18px !important; margin-bottom: 10px !important; font-family: 'Lato', sans-serif !important; }
    .iaml-modal-overlay .kv { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 12px; font-family: 'Lato', sans-serif; }
    .iaml-modal-overlay .kv .label { color: #64748b; font-weight: 600; font-size: 14px; }
    .iaml-modal-overlay .kv .value { color: #0f172a; font-weight: 400; font-size: 15px; }
    .iaml-modal-overlay #step6 .divider { height: 1px; background: #e5e7eb; margin: 16px 0; width: 100%}
    .iaml-modal-overlay .pricing { text-align: left !important;}
    .iaml-modal-overlay .pricing .row { display: flex; justify-content: space-between !important; align-items: center !important; gap: 12px; font-size: 16px; margin-top: 12px; font-family: 'Lato', sans-serif; }
    .iaml-modal-overlay .pricing .row .label { color: #6B7280; font-weight: 400; }
    .iaml-modal-overlay .pricing .row .amount { color: #111827; font-weight: 500; }
    .iaml-modal-overlay .pricing .row.discount .amount { color: #16a34a; }
    .iaml-modal-overlay .pricing .row.success .label { color: #059669; font-weight: 500; }
    .iaml-modal-overlay .pricing .row.success .amount { color: #059669; font-weight: 600; }
    .iaml-modal-overlay .pricing .row.success { margin-top: 16px; margin-bottom: 12px; }
    .iaml-modal-overlay .pricing .row .sublabel { font-size: 14px; color: #6B7280; margin-top: 12px; }
    .iaml-modal-overlay .pricing .row .label { flex: 1; }
    .iaml-modal-overlay .pricing .row .amount { white-space: nowrap; }
    .iaml-modal-overlay .pricing .total { font-size: 30px; font-weight: 700; color: #111827; margin-top: 16px; text-align: left !important; }
    .iaml-modal-overlay .note-success { background: #D1FAE5; color: #065f46; border: 1px solid #6EE7B7; border-radius: 10px; padding: 16px 20px; font-size: 14px; display: none; margin-top: 20px; text-align: center; line-height: 1.55; }
    .iaml-modal-overlay .note-info { background: #EFF6FF; border: 1px solid #BFDBFE; color: #1D4ED8; border-radius: 8px; padding: 8px 10px; font-size: 12px; margin: 6px 0 4px 0; }
    .iaml-modal-overlay div#step5 span {
    color: #000;
}

    /* Confirmation Modal Styles */
    .confirmation-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: flex-start;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
      overflow-y: auto;
    }
    .confirmation-overlay[aria-hidden="false"] {
      display: flex;
      animation: fadeIn 300ms ease-out;
    }

    .confirmation-modal {
      width: 100%;
      max-width: 900px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      animation: slideUp 400ms ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Hero Section */
    .confirmation-overlay .confirmation-hero {
      background: linear-gradient(135deg, #28528c 0%, #1e3f6f 100%);
      color: white;
      text-align: center;
      padding: 60px 40px 40px;
    }

    .confirmation-overlay .checkmark-container {
      margin: 0 auto 20px;
      display: inline-block;
      animation: checkmarkScale 500ms ease-out 200ms both;
    }

    @keyframes checkmarkScale {
      from {
        transform: scale(0);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .confirmation-overlay .confirmation-hero h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 36px;
      font-weight: 700;
      margin: 0 0 10px;
      animation: fadeInUp 500ms ease-out 400ms both;
    }

    .confirmation-overlay .confirmation-subtitle {
      font-size: 18px;
      /* margin: 0; */
      opacity: 0.95;
      animation: fadeInUp 500ms ease-out 500ms both;
      font-family: 'Lato', sans-serif;
    }

    /* Summary Box */
    .confirmation-overlay .summary-box {
      background: white;
      margin: -30px 40px 30px;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      position: relative;
    }

    .confirmation-overlay .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e7edf6;
    }

    .confirmation-overlay .summary-header h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 24px;
      font-weight: 600;
      margin: 0;
      color: #0f172a;
    }

    .confirmation-overlay .format-badge-conf {
      background: #28528c;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: 'Lato', sans-serif;
    }

    .confirmation-overlay .summary-details {
      display: grid;
      gap: 12px;
    }

    .confirmation-overlay .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .confirmation-overlay .detail-row[data-show-if] {
      display: none;
    }

    .confirmation-overlay .detail-row[data-show-if].visible {
      display: flex;
    }

    .confirmation-overlay .detail-label {
      font-weight: 600;
      color: #5a6c7d;
      font-size: 14px;
      font-family: 'Lato', sans-serif;
    }

    .confirmation-overlay .detail-value {
      font-weight: 500;
      color: #0f172a;
      font-size: 15px;
      text-align: right;
      font-family: 'Lato', sans-serif;
    }

    /* What Happens Next Section */
    .confirmation-overlay .what-next-section {
      padding: 40px 40px 20px;
    }

    .confirmation-overlay .what-next-section > h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 30px;
      color: #0f172a;
      text-align: center;
    }

    .confirmation-overlay .step-card {
      display: flex;
      gap: 20px;
      padding: 25px;
      background: #f9fafb;
      border: 1px solid #e7edf6;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .confirmation-overlay .step-card[data-show-if] {
      display: none;
    }

    .confirmation-overlay .step-card[data-show-if].visible {
      display: flex;
    }

    .confirmation-overlay .step-icon {
      display: none;
    }

    .confirmation-overlay .step-content {
      flex: 1;
    }

    .confirmation-overlay .step-content h3 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 12px;
      color: #0f172a;
    }

    .confirmation-overlay .step-content p {
      margin: 0 0 12px;
      color: #2c3e50;
      line-height: 1.6;
      font-family: 'Lato', sans-serif;
    }

    .confirmation-overlay .step-content ul {
      margin: 12px 0;
      padding-left: 20px;
      color: #2c3e50;
      line-height: 1.8;
      font-family: 'Lato', sans-serif;
    }

    .confirmation-overlay .step-content li {
      margin-bottom: 6px;
    }

    .confirmation-overlay .access-benefits {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    /* Urgent action styling */
    .confirmation-overlay .step-card.urgent-action {
      border: 2px solid #10B981;
      background: #f0fdf4;
    }

    .confirmation-overlay .check-email-box {
      background: #FEF3C7;
      padding: 12px 16px;
      margin: 12px 0;
      border-radius: 6px;
      font-size: 15px;
      line-height: 1.6;
      font-family: 'Lato', sans-serif;
      color: #2c3e50;
    }

    .confirmation-overlay .social-proof {
      background: #ECFDF5;
      border: 1px solid #D1FAE5;
      padding: 10px 14px;
      border-radius: 6px;
      margin-top: 12px;
      font-size: 14px;
      font-family: 'Lato', sans-serif;
      color: #065F46;
    }

    .confirmation-overlay .access-benefits strong {
      color: #28528c;
      display: block;
      margin-bottom: 8px;
      font-family: 'Lato', sans-serif;
    }

    .confirmation-overlay .consultation-buttons {
      display: flex;
      gap: 12px;
      margin: 20px 0 15px;
      flex-wrap: wrap;
    }

    .confirmation-overlay .consultation-buttons .btn {
      text-decoration: none;
      padding: 12px 24px;
    }

    .confirmation-overlay .social-proof {
      font-style: italic;
      color: #5a6c7d;
      font-size: 14px;
      margin-top: 15px;
    }

    /* Tips Section */
    .confirmation-overlay .tips-box {
      padding: 30px 40px;
      background: #f1f3f4;
    }

    .confirmation-overlay .tips-box[data-show-if] {
      display: none;
    }

    .confirmation-overlay .tips-box[data-show-if].visible {
      display: block;
    }

    .confirmation-overlay .tips-box h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 25px;
      color: #0f172a;
      text-align: center;
    }

    .confirmation-overlay .tips-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .confirmation-overlay .tip-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .confirmation-overlay .tip-icon {
      display: none;
    }

    .confirmation-overlay .tip-card h4 {
      font-weight: 600;
      color: #0f172a;
      margin: 0 0 8px;
      font-size: 16px;
    }

    .confirmation-overlay .tip-card p {
      margin: 0;
      color: #5a6c7d;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Value Reminder */
    .confirmation-overlay .value-reminder {
      padding: 30px 40px;
      background: white;
    }

    .confirmation-overlay .value-reminder h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 15px;
      color: #0f172a;
      text-align: center;
    }

    .confirmation-overlay .value-reminder p {
      margin: 0;
      color: #2c3e50;
      line-height: 1.7;
      font-size: 16px;
      text-align: center;
      max-width: 700px;
      margin: 0 auto;
      font-family: 'Lato', sans-serif;
    }

    .confirmation-overlay .value-reminder p[data-show-if] {
      display: none;
    }

    .confirmation-overlay .value-reminder p[data-show-if].visible {
      display: block;
    }

    /* Help Section */
    .confirmation-overlay .help-section {
      padding: 25px 40px;
      background: #f9fafb;
      border-top: 1px solid #e7edf6;
      text-align: center;
    }

    .confirmation-overlay .help-section p {
      margin: 5px 0;
      color: #2c3e50;
      font-size: 15px;
      font-family: 'Lato', sans-serif;
    }

    .confirmation-overlay .help-section a {
      color: #28528c;
      text-decoration: none;
      font-weight: 600;
    }

    .confirmation-overlay .help-section a:hover {
      text-decoration: underline;
    }

    /* Footer */
    .confirmation-overlay .confirmation-footer {
      padding: 25px 40px;
      background: white;
      border-top: 1px solid #e7edf6;
      text-align: center;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .confirmation-overlay .confirmation-hero {
        padding: 40px 20px 30px;
      }

      .confirmation-overlay .confirmation-hero h1 {
        font-size: 28px;
      }

      .confirmation-overlay .confirmation-subtitle {
        font-size: 16px;
      }

      .confirmation-overlay .summary-box {
        margin: -20px 20px 20px;
        padding: 20px;
      }

      .confirmation-overlay .summary-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .confirmation-overlay .detail-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .confirmation-overlay .detail-value {
        text-align: left;
      }

      .confirmation-overlay .what-next-section {
        padding: 30px 20px 15px;
      }

      .confirmation-overlay .what-next-section > h2 {
        font-size: 24px;
      }

      .confirmation-overlay .step-card {
        flex-direction: column;
        padding: 20px;
      }

      .confirmation-overlay .tips-box {
        padding: 25px 20px;
      }

      .confirmation-overlay .tips-grid {
        grid-template-columns: 1fr;
      }

      .confirmation-overlay .value-reminder {
        padding: 25px 20px;
      }

      .confirmation-overlay .consultation-buttons {
        flex-direction: column;
      }

      .confirmation-overlay .consultation-buttons .btn {
        width: 100%;
        text-align: center;
      }
    }

    /* ========================================== */
    /* PRE-PROGRAM BENEFITS SECTION */
    /* ========================================== */
    .benefit-steps-section {
      background: #f8f9fa;
    }

    .benefit-steps {
      width: 100%;
      /* max-width: 1200px; */
      margin: 0 auto;
      background: #ffffff;
      border-radius: 24px;
      padding: 48px 40px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .benefit-steps__grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 48px;
      align-items: center;
    }

    .benefit-steps__list {
      position: relative;
      list-style: none;
      padding: 0 0 0 19px;
      margin: 0;
    }

    .benefit-steps__rail {
      position: absolute;
      left: 9px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #d8deeb;
      pointer-events: none;
      overflow: hidden;
    }

    .benefit-steps__rail-progress {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 0;
      background: #3B5998;
      transition: height 0.1s linear;
    }

    .benefit-steps__item {
      position: relative;
      padding: 18px 0 18px 18px;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .benefit-steps__item:not(.benefit-steps__item--active) {
      opacity: 0.6;
    }

    .benefit-steps__item:hover {
      opacity: 1;
    }

    .benefit-steps__dot {
      position: absolute;
      left: -19px;
      top: 24px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid #3B5998;
      box-shadow: 0 4px 12px rgba(59, 90, 152, 0.2);
      transition: all 0.3s ease;
    }

    .benefit-steps__item--active .benefit-steps__dot {
      background: #3B5998;
      border-color: #3B5998;
      box-shadow: 0 6px 16px rgba(59, 90, 152, 0.35);
      transform: scale(1.1);
    }

    .benefit-steps__title {
      font-size: 18px;
      margin: 0 0 8px;
      font-weight: 600;
      color: #1f2c4d;
      font-family: 'Lato', sans-serif;
      transition: color 0.2s ease;
    }

    .benefit-steps__item--active .benefit-steps__title {
      color: #3B5998;
    }

    .benefit-steps__text {
      margin: 0;
      font-size: 14px;
      line-height: 1.7;
      color: #4b5875;
      max-width: 520px;
      font-family: 'Lato', sans-serif;
    }

    .benefit-steps__visual {
      min-height: 320px;
      display: grid;
      place-items: center;
    }

    .benefit-steps__mobile-summary {
      display: none;
      background: linear-gradient(135deg, #f8fafc 0%, #e8f0fe 100%);
      border-radius: 16px;
      padding: 28px 24px;
      text-align: center;
      border: 1px solid rgba(59, 89, 152, 0.1);
    }

    .benefit-steps__mobile-summary h4 {
      font-size: 18px;
      font-weight: 700;
      color: #1f2c4d;
      margin: 0 0 12px;
      font-family: 'Lato', sans-serif;
    }

    .benefit-steps__mobile-summary p {
      font-size: 15px;
      line-height: 1.6;
      color: #4b5875;
      margin: 0;
      font-family: 'Lato', sans-serif;
    }

    .benefit-steps__mobile-summary .highlight {
      color: #3B5998;
      font-weight: 600;
    }

    .benefit-steps__visual-img {
      width: 100%;
      max-width: 800px;
      max-height: 450px;
      height: auto;
      object-fit: contain;
      transition: opacity 0.2s ease;
    }

    .benefit-steps__visual img {
      width: 100%;
      max-width: 800px;
      height: auto;
      object-fit: contain;
    }

    .benefit-steps__included-note {
      font-size: 13px;
      color: #92400e;
      background: #fef3c7;
      padding: 6px 12px;
      border-radius: 6px;
      display: inline-block;
      margin-bottom: 12px;
      font-weight: 500;
      font-family: 'Lato', sans-serif;
    }

    .benefit-steps__placeholder {
      width: 100%;
      max-width: 520px;
      aspect-ratio: 16 / 9;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, #d6e6ff, #bcd5ff);
      display: grid;
      place-items: center;
      color: #23407a;
      font-weight: 600;
      font-size: 16px;
      letter-spacing: 0.04em;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      font-family: 'Lato', sans-serif;
    }

    @media (max-width: 960px) {
      .benefit-steps__grid {
        grid-template-columns: 1fr;
        gap: 32px;
      }

      .benefit-steps {
        padding: 32px 24px;
      }

      .benefit-steps__visual {
        display: none;
      }

      .benefit-steps__mobile-summary {
        display: block;
      }
    }

    @media (max-width: 640px) {
      .benefit-steps {
        padding: 28px 18px;
        border-radius: 16px;
      }

      .benefit-steps__title {
        font-size: 16px;
      }

      .benefit-steps__text {
        font-size: 13px;
      }

      .benefit-steps__mobile-summary {
        padding: 20px 16px;
      }

      .benefit-steps__mobile-summary h4 {
        font-size: 16px;
      }

      .benefit-steps__mobile-summary p {
        font-size: 14px;
      }

      .benefit-steps__included-note {
        font-size: 12px;
        padding: 5px 10px;
      }
    }

    /* ========================================== */
    /* TESTIMONIAL CARD SPACING FIX */
    /* ========================================== */
    /* TESTIMONIAL CARD SPACING FIX */
    /* ========================================== */
    article.testimonial-card,
    .testimonial-card {
      display: flex !important;
      flex-direction: column !important;
      height: 100% !important;
      position: relative;
      gap: 30px !important;
      min-height: 0 !important;
    }

    .testimonial-card .star-wrapper {
      flex-shrink: 0;
      margin-bottom: 0 !important;
      margin-top: 0 !important;
    }

    .testimonial-card blockquote {
      flex: 1 1 auto !important;
      margin: 0 !important;
      padding: 0 !important;
      min-height: 0;
      display: block;
    }

    .testimonial-card footer {
      flex-shrink: 0;
      margin-top: 0 !important;
      padding-top: 0 !important;
      margin-bottom: 0 !important;
    }

    .testimonial-card .author-name {
      margin-bottom: 4px !important;
      margin-top: 0 !important;
    }

    .testimonial-card .author-details {
      margin-bottom: 2px !important;
      margin-top: 0 !important;
    }

    .testimonial-card .author-details:last-child {
      margin-bottom: 0 !important;
    }

    </style>
    <!-- HTML -->
    <div class="program-sessions-widget">
      <section class="program-sessions-section" id="all-programs">
        <div class="container-fuild">
          <h2 style="font-family: var(--font-heading); font-size: 48px; text-align: center; margin-bottom: 1rem; color: #ffffff;">Choose Your Format. Not Your Quality.</h2>
          <p class="section-subtitle" style="text-align: center; color: #e5e5e5; margin-bottom: 1.5rem;">In-person, virtual, or on-demand - every program features the same practicing attorneys, current content, and professional credits you need.</p>

          <div class="pagin-wrapper">
          <!-- Toggle -->
          <div class="format-toggle">
            <button class="toggle-option active" data-format="In-Person">In-Person</button>
            <button class="toggle-option" data-format="Virtual">Virtual</button>
            <button class="toggle-option" data-format="On-Demand">On-Demand</button>
          </div>

          <!-- Sessions -->
          <div id="sessions-container" class="sessions-container">
            <div class="loading-container"><div class="loading-spinner"></div></div>
          </div>

          <!-- Pagination Controls -->
          <button id="prev-btn" class="pagination-btn pagination-btn-left" disabled>
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>

          <div class="pagination-wrapper">
            <div id="pagination-container" class="pagination-container" style="display: none;">
              <div class="pagination-info">
                <span id="page-info">Page 1 of 1</span>
              </div>

              <div id="pagination-dots" class="pagination-dots">
                <!-- Dots will be generated dynamically -->
              </div>
            </div>
          </div>

          <button id="next-btn" class="pagination-btn pagination-btn-right" disabled>
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>


        </div>
      </section>
    </div>

    <!-- Hotel Details Modal -->
    <div id="hotel-modal" class="hotel-modal">
        <div class="hotel-modal-overlay"></div>
        <div class="hotel-modal-container">
            <div class="hotel-modal-header">
                <h2 id="hotel-modal-title" class="hotel-modal-title">Hotel Details</h2>
                <button class="hotel-modal-close" id="hotel-modal-close" aria-label="Close modal">
                    ×
                </button>
            </div>
            <div class="hotel-modal-body" id="hotel-modal-body">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- REGISTRATION MODAL HTML -->
    <!-- ========================================== -->

    <!-- Modal -->
    <div id="iamlModalOverlay" class="iaml-modal-overlay" aria-hidden="true">
      <!-- Loader overlay demo -->
      <div id="preloadOverlay" class="preload-overlay" aria-hidden="true" role="status">
        <div class="preload-box">
          <div class="spinner lg"></div>
          <div class="msg">Fetching sessions…</div>
        </div>
      </div>

      <div class="iaml-modal" role="dialog" aria-modal="true" aria-labelledby="iamlModalTitle">
        <div class="iaml-header">
          <div class="iaml-title">
            <h2 id="iamlModalTitle">Certificate in Employee Relations Law</h2>
            <span class="text-muted" id="iamlSubTitle">In-Person Registration</span>
          </div>
          <button id="closeModalBtn" class="iaml-close" aria-label="Close">✕</button>
        </div>

        <div class="iaml-content">
          <!-- Step containers -->
          <!-- HIDDEN: Format and Program pre-filled -->
          <div id="step1" class="card hidden" style="display: none !important;">
            <div id="progressIndicator" class="progress" aria-hidden="true"></div>
            <h3>Select your program format</h3>
            <div class="format-options" id="formatOptions">
              <label class="option-row"><input type="radio" name="format" value="In-Person" checked> <span>In-Person</span></label>
            </div>
          </div>

          <div id="step2" class="card hidden" style="display: none !important;">
            <div class="progress" aria-hidden="true" id="progressStep2"></div>
            <h3>Select your program</h3>
            <div class="format-options" id="programOptions">
              <label class="option-row"><input type="radio" name="program" value="Certificate in Employee Relations Law" checked> <span>Certificate in Employee Relations Law</span></label>
            </div>
          </div>

          <!-- NEW STEP 1: Select Location -->
          <div id="step3" class="card">
            <div class="progress" aria-hidden="false" id="progressStep3"></div>
            <h3>Select your location & dates</h3>
            <div id="sessionsList" class="sessions-list"></div>
            <div id="sessionsEmpty" class="sessions-empty hidden">No sessions currently available</div>
          </div>

          <!-- NEW STEP 2: Select Blocks -->
          <div id="step4" class="card hidden">
            <div class="progress" aria-hidden="false" id="progressStep4"></div>
            <h3>Select your attendance</h3>
            <div class="format-options" id="attendanceOptions">
              <label class="option-row"><input type="radio" name="attendanceTypeFull" value="Full" id="attFull"> <span>Full Program</span></label>
              <label id="attBlock1" class="option-row"><input type="checkbox" name="attendanceBlocks" value="Block 1"> <span>Block 1</span></label>
              <label id="attBlock2" class="option-row"><input type="checkbox" name="attendanceBlocks" value="Block 2"> <span>Block 2</span></label>
              <label id="attBlock3" class="option-row"><input type="checkbox" name="attendanceBlocks" value="Block 3"> <span>Block 3</span></label>
            </div>

          </div>

          <div id="step5" class="card hidden">
            <div class="progress" aria-hidden="false" id="progressStep5"></div>
            <h3>Complete your registration</h3>
            <div class="grid-2">
              <label class="field"><span>First Name *</span><input id="firstName" autocomplete="given-name" required></label>
              <label class="field"><span>Last Name *</span><input id="lastName" autocomplete="family-name" required></label>
              <label class="field"><span>Title (optional)</span><input id="title" autocomplete="organization-title" placeholder="Your title"></label>
              <label class="field"><span>Company Name (optional)</span><input id="company" autocomplete="organization" placeholder="Company name"></label>
              <label class="field"><span>Phone *</span><input id="phone" autocomplete="tel" required placeholder="(555) 555-5555"></label>
              <label class="field"><span>Email *</span><input id="email" type="email" autocomplete="email" required placeholder="your.email@example.com"></label>
              <label class="field"><span>Coupon Code</span>
                <div class="coupon-row">
                  <input id="couponCode" class="coupon-input" placeholder="Optional">
                  <button id="applyCouponBtn" class="apply-coupon-btn" type="button">Apply Coupon</button>
                </div>
                <div id="couponMsg" class="coupon-msg" aria-live="polite"></div>
                <div id="couponSpinner" class="spinner hidden" aria-hidden="true"></div>
              </label>
            </div>
          </div>

          <div id="step6" class="card hidden">
            <div class="progress" aria-hidden="false" id="progressStep6"></div>
            <h3>Review & Confirm</h3>
            <div class="review-grid">
              <div class="section-card">
                <div class="section-title">Registration Summary</div>
                <div class="kv">
                  <div class="label">Program</div><div class="value" id="revProgram">—</div>
                  <div class="label">Format</div><div class="value" id="revFormat">—</div>
                  <div class="label">Attendance</div><div class="value" id="revAttendance">—</div>
                  <div class="label">Location</div><div class="value" id="revLocation">—</div>
                  <div class="label">Dates</div><div class="value" id="revDates">—</div>
                </div>
                <div class="divider"></div>
                <div class="section-title" style="margin-top: 2px;">Contact Information</div>
                <div class="kv">
                  <div class="label">Name</div><div class="value" id="revName">—</div>
                  <div class="label">Company</div><div class="value" id="revCompany">—</div>
                  <div class="label">Title</div><div class="value" id="revTitle">—</div>
                  <div class="label">Phone</div><div class="value" id="revPhone">—</div>
                  <div class="label">Email</div><div class="value" id="revEmail">—</div>
                </div>
              </div>
              <div class="section-card pricing">
                <div class="section-title">Amount Due</div>
                <div id="revPriceRows">
                  <!-- Dynamic rows inserted here: Program/Block line(s), Subtotal when needed -->
                </div>
                <div id="revDiscountRow" class="row hidden"><div class="label" id="revDiscountLabel">Discount</div><div class="amount" id="revDiscount">-$0</div></div>
                <div class="divider" id="preTotalDivider"></div>
                <div class="total" id="amountDue">$0</div>
                <div id="upgradeNote" class="note-success">✓ Smart Savings: Automatically upgraded to Full Program! You now have access to all sessions at the best price.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step navigation removed in favor of minimal progress indicator -->

        <div class="iaml-footer">
          <div class="inline">
            <button id="backBtn" class="btn btn-secondary">Back</button>
            <div id="globalSpinner" class="spinner hidden" aria-hidden="true"></div>
            <span id="globalMsg" class="text-muted"></span>
          </div>
          <div class="inline">
            <button id="nextBtn" class="btn btn-primary">Next</button>
            <button id="submitBtn" class="btn btn-primary hidden">Submit</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationOverlay" class="confirmation-overlay" aria-hidden="true">
      <div class="confirmation-modal" role="dialog" aria-modal="true" aria-labelledby="confirmationTitle">
        <!-- Hero Section -->
        <div class="confirmation-hero">
          <div class="checkmark-container">
            <svg class="checkmark" width="80" height="80" viewBox="0 0 80 80">
              <circle cx="40" cy="40" r="38" fill="#10b981" stroke="#fff" stroke-width="4"/>
              <path d="M25 40 L35 50 L55 30" stroke="#fff" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h1 id="confirmationTitle">You're Registered!</h1>
          <p class="confirmation-subtitle" id="confirmationSubtitle">Your spot in the IAML Attorney Advisory Program is confirmed.</p>
        </div>

        <!-- Registration Summary Box -->
        <div class="summary-box">
          <div class="summary-header">
            <h2>Registration Summary</h2>
            <span class="format-badge-conf" id="formatBadgeConf">IN-PERSON</span>
          </div>
          <div class="summary-details">
            <div class="detail-row">
              <span class="detail-label">Participant:</span>
              <span class="detail-value" id="confName">—</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Email:</span>
              <span class="detail-value" id="confEmail">—</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Program:</span>
              <span class="detail-value" id="confProgram">IAML Attorney Advisory Program</span>
            </div>
            <div class="detail-row" data-show-if="in-person,virtual">
              <span class="detail-label">Dates:</span>
              <span class="detail-value" id="confDates">—</span>
            </div>
            <div class="detail-row" data-show-if="in-person">
              <span class="detail-label">Location:</span>
              <span class="detail-value" id="confLocation">—</span>
            </div>
            <div class="detail-row" data-show-if="virtual">
              <span class="detail-label">Format:</span>
              <span class="detail-value">Live Virtual (Zoom)</span>
            </div>
            <div class="detail-row" data-show-if="on-demand">
              <span class="detail-label">Format:</span>
              <span class="detail-value">On-Demand (Self-Paced)</span>
            </div>
            <div class="detail-row" data-show-if="on-demand">
              <span class="detail-label">Access Period:</span>
              <span class="detail-value">90 Days from Payment</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Enrollment Fee:</span>
              <span class="detail-value" id="confPrice">—</span>
            </div>
          </div>
        </div>

        <!-- What Happens Next Section -->
        <div class="what-next-section">
          <h2>What Happens Next</h2>

          <!-- Step 1 - Invoice/Payment -->
          <div class="step-card urgent-action" data-show-if="in-person,virtual">
            <div class="step-content">
              <h3>Step 1: Check Your Email Right Now!</h3>
              <p><strong>Your invoice is being sent as you read this.</strong></p>
              <p class="check-email-box">
                <strong>What to do:</strong><br>
                1. Check your email inbox (search for "IAML Invoice")<br>
                2. Can't find it? Check your spam/junk folder<br>
                3. Click "Pay Now" to complete your registration
              </p>
              <p><strong>Why pay today?</strong></p>
              <ul>
                <li><strong>Lock in your seat</strong> – Sessions can fill up</li>
                <li><strong>Schedule your consultation</strong> – Book your complimentary call right away</li>
              </ul>
            </div>
          </div>
          <div class="step-card urgent-action" data-show-if="on-demand">
            <div class="step-content">
              <h3>Step 1: Check Your Email & Start Learning Today!</h3>
              <p><strong>Your invoice is being sent right now.</strong></p>
              <p class="check-email-box">
                <strong>What to do:</strong><br>
                1. Check your email inbox (search for "IAML Invoice")<br>
                2. Can't find it? Check your spam/junk folder<br>
                3. Click "Pay Now" for instant access
              </p>
              <p><strong>Pay now and get:</strong></p>
              <ul>
                <li><strong>Instant access</strong> – Start watching within 5 minutes</li>
                <li><strong>All materials unlocked</strong> – Download everything immediately</li>
                <li><strong>Full 90 days</strong> – Your viewing period starts after payment</li>
              </ul>
            </div>
          </div>

          <!-- Step 2 - Consultation -->
          <div class="step-card" data-show-if="in-person,virtual">
            <div class="step-content">
              <h3>Step 2: Get Ready to Succeed</h3>
              <p>Good news! Once your invoice is paid, you'll be able to book your complimentary 10-15 minute pre-program consultation to ensure you get maximum value from the program.</p>
              <p><strong>In this 10-15 minute call, you'll:</strong></p>
              <ul>
                <li>Discuss your specific workplace challenges</li>
                <li>Get customized guidance on what to focus on during the program</li>
                <li>Ask questions about what to expect</li>
                <li>Meet our team before you arrive</li>
              </ul>
              <p class="social-proof">Most participants who take this call say it doubled the value they got from the program.</p>
            </div>
          </div>
          <div class="step-card" data-show-if="on-demand">
            <div class="step-content">
              <h3>Step 2: Maximize Your Learning (Optional but Recommended)</h3>
              <p>Good news! Once your invoice is paid, you'll be able to book your complimentary 10-15 minute pre-program consultation to ensure you get maximum value from the program.</p>
              <p><strong>During this call, we'll help you:</strong></p>
              <ul>
                <li>Identify which modules to prioritize based on your challenges</li>
                <li>Create a realistic completion schedule</li>
                <li>Learn how to get the most from self-paced learning</li>
                <li>Understand how to apply concepts to your specific situations</li>
              </ul>
            </div>
          </div>

          <!-- Step 3 - Prepare/Access -->
          <div class="step-card" data-show-if="in-person">
            <div class="step-content">
              <h3>Step 3: Prepare for Day 1</h3>
              <p>We'll send pre-program information on <span class="info-date">{{info_send_date}}</span>, a week before your program starts.</p>
            </div>
          </div>
          <div class="step-card" data-show-if="virtual">
            <div class="step-content">
              <h3>Step 3: Prepare for Your Virtual Program</h3>
              <p>We'll send pre-program information on <span class="info-date">{{info_send_date}}</span>, a week before your program starts, including:</p>
              <ul>
                <li>Your Zoom access and meeting links</li>
                <li>Technical setup guide</li>
                <li>Pre-program materials</li>
                <li>Tips for virtual learning success</li>
              </ul>
              <p><strong>Make sure your tech is ready so you can focus on the content, not the connection.</strong></p>
            </div>
          </div>
          <div class="step-card" data-show-if="on-demand">
            <div class="step-content">
              <h3>Step 3: Start Learning (After Payment)</h3>
              <p>Once your payment is received, you'll receive:</p>
              <ul>
                <li>Login credentials for the learning platform</li>
                <li>Complete course outline and navigation guide</li>
                <li>All downloadable resources and templates</li>
                <li>Recommended learning path based on your goals</li>
                <li>Technical support contact information</li>
              </ul>
              <p><strong>Your 90-day access period begins the day you receive your login credentials.</strong></p>
            </div>
          </div>
        </div>

        <!-- Value Reminder -->
        <div class="value-reminder">
          <h2>Quick Reminder: What You're Getting</h2>
          <p data-show-if="in-person">You'll build practical employment law expertise through real workplace scenarios with experienced attorneys. You'll cover hiring, discipline, accommodations, leaves, terminations, and investigations.</p>
          <p data-show-if="virtual">You'll build practical employment law expertise through real workplace scenarios with experienced attorneys, delivered virtually with the same interactive learning you'd get in person.</p>
          <p data-show-if="on-demand">You'll build practical employment law expertise through real workplace scenarios with experienced attorneys. Learn at your own pace, pause to implement, and revisit challenging topics. All on your schedule.</p>
        </div>

        <!-- Help/Contact Section -->
        <div class="help-section">
          <p><strong>Questions about your registration?</strong></p>
          <p>Contact us at <a href="mailto:info@iaml.com">info@iaml.com</a> or call <a href="tel:+19497601700">(949) 760-1700</a></p>
        </div>

        <!-- Close Button -->
        <div class="confirmation-footer">
          <button id="closeConfirmationBtn" class="btn btn-secondary">Close</button>
        </div>
      </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
    (function(){
    'use strict';

    /* ---------- tiny helper to build Airtable URLs safely (ENCODES EVERYTHING) ---------- */
    function buildAirtableUrl(base, paramsObj){
      const params = new URLSearchParams();
      Object.entries(paramsObj).forEach(([k,v])=>{
        if (v === undefined || v === null) return;
        if (Array.isArray(v)) {
          v.forEach(item => params.append(k, item));
        } else {
          params.append(k, v);
        }
      });
      // Check if base already has query parameters
      const separator = base.includes('?') ? '&' : '?';
      return `${base}${separator}${params.toString()}`;
    }

    /* ===========================
       CONFIG
       =========================== */
    const CONFIG = {
      AIRTABLE: {
        PROGRAMS_TABLE: 'tblympiL1p6PmQz9i',
        PROGRAMS_VIEW: 'viwX4En7WerGZSPCO',
        VIRTUAL_VIEW: 'viwG1w68D5qVdMHIa',
        INSTRUCTORS_TABLE: 'Instructors',
        get PROGRAMS_ENDPOINT(){ return `/api/airtable-programs?table=${encodeURIComponent(this.PROGRAMS_TABLE)}&view=${encodeURIComponent(this.PROGRAMS_VIEW)}`; },
        get VIRTUAL_ENDPOINT(){ return `/api/airtable-programs?table=${encodeURIComponent(this.PROGRAMS_TABLE)}&view=${encodeURIComponent(this.VIRTUAL_VIEW)}`; },
        get INSTRUCTORS_ENDPOINT(){ return `/api/airtable-programs?table=${encodeURIComponent(this.INSTRUCTORS_TABLE)}`; }
      },
      PROGRAMS_DATA: [],
      VIRTUAL_COMPONENTS: [],
      INSTRUCTORS_DATA: { byName:{}, byId:{} },
      CURRENT_FORMAT: 'In-Person',
      isLoading: false,
      PAGINATION: {
        cardsPerPage: 3, // 1 row of 3 cards on desktop
        currentPage: 1,
        totalPages: 1
      }
    };
    let currentExpandedCard = null;
    let hotelModal = null;

    /* ===========================
       HOTEL MODAL CONTROLLER
       =========================== */
    class HotelModalController {
        constructor() {
            this.modal = null;
            this.isOpen = false;
        }

        /**
         * Initialize the modal
         */
        init() {
            this.modal = document.getElementById('hotel-modal');
            this.setupEventListeners();
        }

        /**
         * Set up event listeners
         */
        setupEventListeners() {
            // Close button
            const closeBtn = document.getElementById('hotel-modal-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => this.close());
            }

            // Overlay click
            const overlay = this.modal.querySelector('.hotel-modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', () => this.close());
            }

            // Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.isOpen) {
                    this.close();
                }
            });

            // Delegate event listener for venue links
            document.addEventListener('click', (e) => {
                const venueLink = e.target.closest('[data-venue-action="show-modal"]');
                if (venueLink) {
                    e.preventDefault();
                    const sessionId = venueLink.dataset.sessionId;
                    const venueName = venueLink.dataset.venueName;
                    this.show(sessionId, venueName);
                }
            });
        }

        /**
         * Show modal with venue details
         */
        async show(sessionId, venueName) {
            try {
                // Close registration modal if open to prevent conflicts
                const iamlModalOverlay = document.getElementById('iamlModalOverlay');
                if (iamlModalOverlay && iamlModalOverlay.dataset.open === 'true') {
                    if (typeof window.closeModal === 'function') {
                        window.closeModal();
                    } else {
                        iamlModalOverlay.dataset.open = 'false';
                        iamlModalOverlay.setAttribute('aria-hidden', 'true');
                    }
                }

                // Close confirmation modal if open
                const confirmationOverlay = document.getElementById('confirmationOverlay');
                if (confirmationOverlay && confirmationOverlay.getAttribute('aria-hidden') === 'false') {
                    if (typeof window.closeConfirmationModal === 'function') {
                        window.closeConfirmationModal();
                    }
                }

                // Find the program data
                const program = CONFIG.PROGRAMS_DATA.find(p => p.id === sessionId);

                if (!program) {
                    return;
                }


                // Build modal content - Use exact field names from documentation
                const title = program.venueName || 'Venue Details';
                const content = this.buildModalContent(program);

                // Update modal
                document.getElementById('hotel-modal-title').textContent = title;
                document.getElementById('hotel-modal-body').innerHTML = content;

                // Show modal
                this.modal.style.display = 'flex';
                this.isOpen = true;
                document.body.style.overflow = 'hidden'; // Prevent background scrolling

            } catch (error) {
                // Error handling - modal will not show if there's an issue
            }
        }

        /**
         * Build modal content HTML
         */
        buildModalContent(program) {
            const sections = [];


            // Special case for Flamingo Las Vegas - add fallback data if Airtable data is missing
            if (program.venueName && program.venueName.toLowerCase().includes('flamingo')) {
                if (!program.venueDescription) {
                    program.venueDescription = 'Flamingo Las Vegas is a hotel and casino located on the Las Vegas Strip in Paradise, Nevada. It is owned and operated by Caesars Entertainment Corporation. The hotel features a tropical theme with pink flamingos and lush gardens.';
                }
                if (!program.venueAddress) {
                    program.venueAddress = '3555 S Las Vegas Blvd, Las Vegas, NV 89109';
                }
                if (!program.phoneNumber) {
                    program.phoneNumber = '(702) 733-3111';
                }
                if (!program.averageCost) {
                    program.averageCost = 89;
                }
                if (!program.selfParking) {
                    program.selfParking = 15;
                }
                if (program.resortFee === undefined || program.resortFee === null) {
                    program.resortFee = 0;
                }
            }

            // General fallback for any venue missing data
            if (!program.venueDescription && program.venueName) {
                program.venueDescription = `Welcome to ${program.venueName}. This venue provides excellent facilities for our professional development programs.`;
            }
            if (!program.venueAddress && program.city && program.state) {
                program.venueAddress = `${program.city}, ${program.state}`;
            }
            if (!program.phoneNumber) {
                program.phoneNumber = 'Contact venue directly for phone number';
            }
            if (!program.averageCost) {
                program.averageCost = 'Contact venue for pricing';
            }
            if (!program.selfParking) {
                program.selfParking = 'Contact venue for parking information';
            }
            if (program.resortFee === undefined || program.resortFee === null) {
                program.resortFee = 0;
            }

            // Description
            if (program.venueDescription) {
                sections.push(`
                    <div class="hotel-section">
                        <h3 class="hotel-section-title">Description</h3>
                        <p class="hotel-section-content">${this.formatText(program.venueDescription)}</p>
                    </div>
                `);
            }

            // Address - Handle array fields as specified in documentation
            const address = program.venueAddress;
            if (address) {
                const addressValue = Array.isArray(address) ? address[0] : address;
                sections.push(`
                    <div class="hotel-section">
                        <h3 class="hotel-section-title">Address</h3>
                        <p class="hotel-section-content">${addressValue}</p>
                    </div>
                `);
            }

            // Phone - Handle array fields as specified in documentation
            const phone = program.phoneNumber;
            if (phone) {
                const phoneValue = Array.isArray(phone) ? phone[0] : phone;
                sections.push(`
                    <div class="hotel-section">
                        <h3 class="hotel-section-title">Phone</h3>
                        <p class="hotel-section-content">${phoneValue}</p>
                    </div>
                `);
            }

            // Cost Information
            const costItems = [];

            if (program.averageCost) {
                costItems.push(`
                    <div class="hotel-cost-item">
                        <span class="hotel-cost-label">Average Cost per Night</span>
                        <span class="hotel-cost-value">${this.formatCurrency(program.averageCost)}</span>
                    </div>
                `);
            }

            if (program.selfParking) {
                costItems.push(`
                    <div class="hotel-cost-item">
                        <span class="hotel-cost-label">Self Parking</span>
                        <span class="hotel-cost-value">${this.formatCurrency(program.selfParking)}</span>
                    </div>
                `);
            }

            if (program.resortFee !== undefined && program.resortFee !== null) {
                const resortFeeValue = program.resortFee > 0 ? this.formatCurrency(program.resortFee) : 'None';
                costItems.push(`
                    <div class="hotel-cost-item">
                        <span class="hotel-cost-label">Resort Fee</span>
                        <span class="hotel-cost-value">${resortFeeValue}</span>
                    </div>
                `);
            }

            if (costItems.length > 0) {
                sections.push(`
                    <div class="hotel-section">
                        <h3 class="hotel-section-title">Cost Information</h3>
                        <div class="hotel-cost-list">
                            ${costItems.join('')}
                        </div>
                    </div>
                `);
            }

            // Hotel Booking Link
            if (program.hotelBookingLink) {
                sections.push(`
                    <div class="hotel-section hotel-booking-section">
                        <a href="${program.hotelBookingLink}"
                           class="hotel-booking-btn"
                           target="_blank"
                           rel="noopener noreferrer">
                            Book Your Room
                        </a>
                    </div>
                `);
            }

            // If no sections were added, show a default message
            if (sections.length === 0) {
                sections.push(`
                    <div class="hotel-section">
                        <h3 class="hotel-section-title">Venue Information</h3>
                        <p class="hotel-section-content">Venue details are being updated. Please contact the venue directly for the most current information.</p>
                    </div>
                `);
            }

            const finalContent = sections.join('');
            return finalContent;
        }

        /**
         * Format text with line breaks
         */
        formatText(text) {
            if (!text) return '';
            return text.replace(/\n/g, '<br>');
        }

        /**
         * Format currency
         */
        formatCurrency(amount) {
            if (amount === null || amount === undefined) return '$0.00';
            const numAmount = typeof amount === 'string' ? parseFloat(amount.replace(/[^\d.]/g, '')) : amount;
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(numAmount);
        }

        /**
         * Close modal
         */
        close() {
            if (this.modal) {
                this.modal.style.display = 'none';
                this.isOpen = false;
                // Only restore scrolling if no other modals are open
                const iamlModal = document.getElementById('iamlModalOverlay');
                const confirmationModal = document.getElementById('confirmationOverlay');
                if ((!iamlModal || iamlModal.dataset.open !== 'true') &&
                    (!confirmationModal || confirmationModal.getAttribute('aria-hidden') !== 'false')) {
                  document.body.style.overflow = ''; // Restore scrolling
                }
            }
        }
    }

    /* ===========================
       DATA
       =========================== */
    async function fetchProgramsData(){
      let allRecords = [];
      let offset = null;

      do {
        const params = {
          'pageSize': 100 // Maximum records per request
        };

        if (offset) {
          params.offset = offset;
        }

        const url = buildAirtableUrl(CONFIG.AIRTABLE.PROGRAMS_ENDPOINT, params);

      const response = await fetch(url);
      if(!response.ok) {
        console.error('API Response Error:', response.status, response.statusText);
        const errorText = await response.text();
        console.error('Error details:', errorText);
        throw new Error(`Airtable API error: ${response.status}`);
      }
      const data = await response.json();
      console.log('API Response received, records count:', data.records?.length || 0);

        allRecords = allRecords.concat(data.records);
        offset = data.offset; // Airtable provides offset for next page
      } while (offset); // Continue until no more pages


      // Get current date to filter out past programs
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison

      const programs = allRecords
        .map(record=>{
          try {
          const f = record.fields;

          const detectedFormat = determineProgramType(f);

            // Helper function to safely extract string values
            const safeString = (value) => {
              if (!value) return '';
              if (Array.isArray(value)) return value[0] || '';
              return String(value);
            };

          return {
            id: record.id,
              program: (() => {
                // First try explicit program name fields
                if (f.Program) return safeString(f.Program);
                if (f['Program Name']) return safeString(f['Program Name']);

                // Extract from Instance Name (e.g., "HR Law Fundamentals - Jul 2026 Orlando")
                if (f['Instance Name']) {
                  const instanceName = safeString(f['Instance Name']);
                  const dashIndex = instanceName.indexOf(' - ');
                  if (dashIndex > 0) {
                    return instanceName.substring(0, dashIndex).trim();
                  }
                  return instanceName;
                }

                // Fallback to linked record ID (won't match, but better than nothing)
                if (Array.isArray(f.Programs) && f.Programs.length > 0) {
                  return safeString(f.Programs[0]);
                }

                return 'Unknown Program';
              })(),
            format: detectedFormat,
              startDate: safeString(f['Session Start Date'] || f['Start Date'] || f['Date']),
              endDate: safeString(f['Session End Date'] || f['End Date'] || f['End']),
              city: safeString(f.City || f['Location']),
              state: safeString(f['State/Province'] || f.State),
              venueName: safeString(f['Venue Name (1)'] || f['Venue Name Field'] || f['Venue Name'] || f['Venue'] || f['Location Name']),
              venueDescription: safeString(f['Venue Description']),
              venueAddress: safeString(f['Street Address (from Venue Name)'] || f['Venue Address'] || f['Address']),
              phoneNumber: safeString(f['Phone Number (from Venue Name)'] || f['Phone Number'] || f['Phone']),
              averageCost: safeString(f['Avergage Cost per Night'] || f['Average Cost per Night'] || f['Cost']),
              selfParking: safeString(f['Self Parking'] || f['Parking']),
              resortFee: safeString(f['Resort Fee'] || f['Fee']),
              hotelBookingLink: safeString(f['Hotel Booking Link'] || f['Booking Link']),
            heroImageUrl: normalizeImageFromFields(f),
              block1Instructor: f['Block 1 Instructor'] || f['Instructor 1'],
              block2Instructor: f['Block 2 Instructor'] || f['Instructor 2'],
              block3Instructor: f['Block 3 Instructor'] || f['Instructor 3'],
              price: (function(){
                const raw = f.Price || f['Program Price'] || f['Program Pricing'] || f['Enrollment Fee'] || f['Cost'] || f['Fee'] || '';
                if (typeof raw === 'number') return raw;
                if (Array.isArray(raw)) return Number(String(raw[0]).replace(/[^\d.]/g,'')||0) || undefined;
                const num = Number(String(raw).replace(/[^\d.]/g,'')||0);
                return num || undefined;
              })()
            };
          } catch (error) {
            return null; // Skip this record
          }
        })
        .filter(program => program !== null) // Remove any failed records
        .filter(program => {
          // Filter out past programs - only show programs that haven't STARTED yet
          if (!program.startDate) {
            // Keep programs with no start date (e.g., on-demand)
            return true;
          }

          let startDate;
          try {
            // Try parsing as ISO date first
            if (program.startDate.includes('-')) {
              startDate = new Date(program.startDate + 'T00:00:00');
            } else {
              // Handle formats like "October 27, 2025"
              startDate = new Date(program.startDate);
            }
          } catch (e) {
            console.warn('Could not parse start date:', program.startDate);
            return true; // Keep if we can't parse
          }

          // Only show programs that START in the future (start date > today)
          return startDate > today;
        });

      console.log(`fetchProgramsData completed: ${programs.length} total programs fetched`);
      return programs;
    }

    async function fetchVirtualComponents(){
      let allRecords = [];
      let offset = null;

      console.log('Fetching Virtual component programs...');

      do {
        const params = {
          'sort[0][field]': 'Session Start Date',
          'sort[0][direction]': 'asc',
          'pageSize': 100
        };

        if (offset) {
          params.offset = offset;
        }

        const url = buildAirtableUrl(CONFIG.AIRTABLE.VIRTUAL_ENDPOINT, params);

        const response = await fetch(url);
        if(!response.ok) {
          console.error('Virtual components API Error:', response.status, response.statusText);
          const errorText = await response.text();
          console.error('Error details:', errorText);
          throw new Error(`Airtable API error: ${response.status}`);
        }
        const data = await response.json();
        console.log('Virtual components batch received, records count:', data.records?.length || 0);

        allRecords = allRecords.concat(data.records);
        offset = data.offset;
      } while (offset);

      const programs = allRecords
        .map(record => {
          try {
            const f = record.fields;
            const detectedFormat = determineProgramType(f);

            const safeString = (value) => {
              if (!value) return '';
              if (Array.isArray(value)) return value[0] || '';
              return String(value);
            };

            return {
              id: record.id,
              program: safeString(f.Program),
              format: detectedFormat,
              startDate: f['Session Start Date'] || null,
              endDate: f['Session End Date'] || null,
              city: safeString(f.City),
              state: safeString(f.State),
              venueName: safeString(f['Venue Name (1)']),
              heroImageUrl: normalizeImageFromFields(f),
              block1Instructor: safeString(f['Block 1 Instructor (from Instructors)']),
              block2Instructor: safeString(f['Block 2 Instructor (from Instructors)']),
              block3Instructor: safeString(f['Block 3 Instructor (from Instructors)']),
              price: (() => {
                const raw = f['Program Pricing'];
                const num = Number(String(raw).replace(/[^\d.]/g,'')||0);
                return num || undefined;
              })()
            };
          } catch (error) {
            return null;
          }
        })
        .filter(program => program !== null)
        .filter(program => {
          // Filter out past programs - only show programs that haven't STARTED yet
          if (!program.startDate) {
            // Keep programs with no start date
            return true;
          }

          let startDate;
          try {
            if (program.startDate.includes('-')) {
              startDate = new Date(program.startDate + 'T00:00:00');
            } else {
              startDate = new Date(program.startDate);
            }
          } catch (e) {
            console.warn('Could not parse start date:', program.startDate);
            return true;
          }

          // Only show programs that START in the future (start date > today)
          return startDate > today;
        });

      console.log(`fetchVirtualComponents completed: ${programs.length} component programs fetched`);
      return programs;
    }

    function determineProgramType(fields){

      // Helper function to safely convert to string and lowercase
      const safeToLower = (value) => {
        if (!value) return '';
        if (Array.isArray(value)) {
          return value.map(v => String(v || '').toLowerCase()).join(' ');
        }
        return String(value).toLowerCase();
      };

      // Check Format field first (most reliable from CSV)
      if(fields['Format']){
        const fmt = safeToLower(fields['Format']);
        if(fmt === 'virtual' || fmt.includes('virtual') || fmt.includes('online')) return 'Virtual';
        if(fmt === 'in-person' || fmt === 'in person' || fmt.includes('in-person') || fmt.includes('in person')) return 'In-Person';
        if(fmt.includes('on-demand') || fmt.includes('on demand') || fmt.includes('ondemand')) return 'On-Demand';
      }

      // Check Program Type field
      if(fields['Program Type']){
        const type = safeToLower(fields['Program Type']);
        if(type.includes('virtual')||type.includes('online')) return 'Virtual';
        if(type.includes('on-demand')||type.includes('on demand')||type.includes('ondemand')) return 'On-Demand';
      }

      // Check Delivery Method field
      if(fields['Delivery Method']){
        const delivery = safeToLower(fields['Delivery Method']);
        if(delivery.includes('virtual')||delivery.includes('online')) return 'Virtual';
        if(delivery.includes('on-demand')||delivery.includes('on demand')||delivery.includes('ondemand')) return 'On-Demand';
      }

      // Check City field for virtual indicators
      if(fields['City']){
        const city = safeToLower(fields['City']);
        if(city.includes('virtual')||city.includes('online')||city.includes('webinar')) return 'Virtual';
      }

      // Check if no city/location data suggests virtual
      if(!fields['City'] && !fields['State'] && !fields['Venue Name'] && !fields['Venue Name Field']) {
        return 'Virtual';
      }

      // Default to In-Person if no virtual indicators found
      const defaultFormat = safeToLower(fields['Format']) || 'In-Person';
      return defaultFormat === '' ? 'In-Person' : defaultFormat;
    }
    function normalizeImageFromFields(fields){

      // List of possible image field names to check
      const imageFields = [
        'Hero Image Attachment',
        'Hero Image URL',
        'Image',
        'Image URL',
        'Background Image',
        'Program Image',
        'Program Image URL',
        'Thumbnail',
        'Thumbnail URL',
        'Cover Image',
        'Cover Image URL',
        'Banner Image',
        'Banner Image URL',
        'Photo',
        'Photo URL',
        'Picture',
        'Picture URL'
      ];

      // Helper: extract URL from strings like "filename.jpg ( https://... )"
      const extractUrlFromString = (value) => {
        if (typeof value !== 'string') return '';
        const trimmed = value.trim();
        if (/^https?:\/\//i.test(trimmed)) return trimmed; // plain URL
        const match = trimmed.match(/\((https?:\/\/[^\)]+)\)/i); // URL in parentheses
        if (match && match[1]) return match[1].trim();
        return '';
      };

      // Check each possible image field
      for (const fieldName of imageFields) {
        if (fields[fieldName]) {

          // Handle attachment arrays
          if (Array.isArray(fields[fieldName]) && fields[fieldName].length > 0) {
            const attachment = fields[fieldName][0];
            if (attachment && attachment.url) {
              return attachment.url;
            }
            const extractedFromArray = extractUrlFromString(fields[fieldName][0]);
            if (extractedFromArray) return extractedFromArray;
          }

          // Handle URL strings
          if (typeof fields[fieldName] === 'string' && fields[fieldName].trim()) {
            const extracted = extractUrlFromString(fields[fieldName]);
            if (extracted) {
              return extracted;
            }
            return fields[fieldName].trim();
          }
        }
      }

      return '';
    }
    async function fetchInstructorsData(){
      const response = await fetch(CONFIG.AIRTABLE.INSTRUCTORS_ENDPOINT);
      if(!response.ok) throw new Error(`Airtable API error: ${response.status}`);
      const data = await response.json();
      const byName={}, byId={};
      data.records.forEach(r=>{
        const f=r.fields;
        const firstName=f['First Name']||'', lastName=f['Last Name']||'';
        const fullName=f['Full Name'] || `${firstName} ${lastName}`.trim();
        const hasEsq=f['Has Esq']||false;
        const displayName = hasEsq ? `${fullName}, Esq.` : fullName;
        const instructorData={ id:r.id, firstName,lastName, fullName, displayName, title:null, company:f['Title 2 (for grid)']||'', profileUrl:f['Profile URL']||'#', hasEsq };
        byName[displayName.toLowerCase()] = instructorData;
        byId[r.id]=instructorData;
      });
      return {byName,byId};
    }
    async function fetchCompositeVirtualProgram(){
      // This function is no longer needed as we handle virtual program combination
      // in the main filtering logic. Return null to maintain compatibility.
      return null;
    }
    async function fetchOnDemandProgram(){
      const url = buildAirtableUrl(CONFIG.AIRTABLE.PROGRAMS_ENDPOINT, {
        filterByFormula: 'AND({Program}="Certificate in Employee Relations Law", OR(FIND("on-demand", LOWER({Format})), FIND("on demand", LOWER({Format}))))',
        'sort[0][field]': 'Session Start Date',
        'sort[0][direction]': 'asc'
      });
      try{
        const response=await fetch(url);
        if(!response.ok) return null;
        const data=await response.json();
        if(data.records.length>0){
          const record=data.records[0], f=record.fields;
          return {
            id:record.id, program:f.Program, format:'On-Demand',
            startDate:null, endDate:null, city:null, state:null,
            venueName:'Online Learning Platform', heroImageUrl: normalizeImageFromFields(f),
            price:2375,
            block1Instructor:f['Block 1 Instructor'],
            block2Instructor:f['Block 2 Instructor'],
            block3Instructor:f['Block 3 Instructor'],
            isOnDemand:true
          };
        }
        return null;
      }catch(e){ return null; }
    }

    /* ===========================
       SAMPLE DATA (FALLBACK)
       =========================== */
    function getSampleData(){
      return [
        {
          id: 'sample-inperson-1',
          program: 'Certificate in Employee Relations Law',
          format: 'In-Person',
          startDate: '2025-03-15',
          endDate: '2025-03-19',
          city: 'Las Vegas',
          state: 'NV',
          venueName: 'The Venetian Resort',
          heroImageUrl: 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80',
          price: 2375
        },
        {
          id: 'sample-inperson-2',
          program: 'Certificate in Employee Relations Law',
          format: 'In-Person',
          startDate: '2025-04-12',
          endDate: '2025-04-16',
          city: 'Chicago',
          state: 'IL',
          venueName: 'The Palmer House Hilton',
          heroImageUrl: 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80',
          price: 2375
        },
        {
          id: 'sample-virtual-1',
          program: 'Certificate in Employee Relations Law',
          format: 'Virtual',
          startDate: '2025-02-20',
          endDate: '2025-02-24',
          city: 'Virtual',
          state: null,
          venueName: 'Virtual Program',
          heroImageUrl: 'https://images.unsplash.com/photo-1551434678-e076c223a692?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80',
          price: 2375
        },
        {
          id: 'sample-ondemand-1',
          program: 'Certificate in Employee Relations Law',
          format: 'On-Demand',
          startDate: null,
          endDate: null,
          city: null,
          state: null,
          venueName: 'Online Learning Platform',
          heroImageUrl: 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80',
          price: 2375
        }
      ];
    }

    /* ===========================
       INIT
       =========================== */
    async function loadData(){
      if(CONFIG.isLoading) return;
      CONFIG.isLoading=true;
      showLoadingState();
      try{

        // Fetch programs, virtual components, and instructors (these are critical)
        const [programsData, virtualComponents, instructorsData] = await Promise.all([
          fetchProgramsData(),
          fetchVirtualComponents().catch(err => {
            console.error('Virtual components fetch error:', err);
            return [];
          }),
          fetchInstructorsData().catch(err => {
            return { byName: {}, byId: {} };
          })
        ]);

        CONFIG.PROGRAMS_DATA = programsData;
        CONFIG.VIRTUAL_COMPONENTS = virtualComponents;
        CONFIG.INSTRUCTORS_DATA = instructorsData;

        console.log('Programs loaded:', CONFIG.PROGRAMS_DATA.length);
        console.log('Virtual components loaded:', CONFIG.VIRTUAL_COMPONENTS.length);
        console.log('Instructors loaded:', Object.keys(CONFIG.INSTRUCTORS_DATA.byName || {}).length);

        // The new Airtable table already includes all On-Demand programs in the main fetch
        // No need to call fetchOnDemandProgram() - the data is already in programsData
        // The fetchOnDemandProgram() function was using an invalid filter formula that
        // referenced a {Program} field that doesn't exist in the new table structure

        console.log('Data loaded successfully. Total programs:', CONFIG.PROGRAMS_DATA.length);
        generateSessionCards();
        switchFormat(CONFIG.CURRENT_FORMAT);
      }catch(err){
        console.error('Error loading data from Airtable:', err);
        // Fallback: Load sample data if Airtable fails
        CONFIG.PROGRAMS_DATA = getSampleData();
        CONFIG.INSTRUCTORS_DATA = { byName: {}, byId: {} };

        // Using fallback sample data

        generateSessionCards();
        switchFormat(CONFIG.CURRENT_FORMAT);
      }
      CONFIG.isLoading=false;
      hideLoadingState();
    }

    /* ===========================
       UI GENERATION
       =========================== */
    function generateSessionCards(){

      const container=document.querySelector('.program-sessions-widget #sessions-container');

      container.innerHTML='';

      // Add paginated class for pagination layout
      container.classList.add('paginated');

      // normalize helper
      const norm = v => String(v || '').toLowerCase();

      // Generate session cards

        // Case-insensitive grouping
        const programsByFormat = {
          'In-Person': CONFIG.PROGRAMS_DATA.filter(p => {
            const f = norm(p.format);
            const programName = norm(p.program);

            // Only include programs that are in-person format
            const isInPerson = (f === 'in-person' || f === 'in person');
            if (!isInPerson) return false;

            // Only include Certificate in Employee Relations Law programs
            const isEmployeeRelationsCert = programName.includes('certificate in employee relations law') ||
                                           programName.includes('employee relations law') ||
                                           programName.includes('certificate in employee relations');

            if (!isEmployeeRelationsCert) return false;

            // Include in-person program

            return true;
          }).sort((a, b) => {
            // Sort by start date chronologically
            if (a.startDate && b.startDate) {
              return new Date(a.startDate) - new Date(b.startDate);
            }
            return 0;
          }),
        'Virtual': (() => {
          console.log('Generating Virtual composite programs...');

          // Use the dedicated virtual components, not the main programs data
          const allVirtual = CONFIG.VIRTUAL_COMPONENTS || [];
          console.log('Virtual components available:', allVirtual.length);

          // Separate the two component types
          const comprehensivePrograms = allVirtual.filter(p => {
            const programName = norm(p.program);
            const isMatch = programName.includes('comprehensive labor relations');
            if (isMatch) {
              console.log('Found Comprehensive Labor Relations:', p.program, 'starting', p.startDate);
            }
            return isMatch;
          });

          const discriminationPrograms = allVirtual.filter(p => {
            const programName = norm(p.program);
            // Updated to match "Discrimination Prevention and Defense"
            const isMatch = programName.includes('discrimination prevention');
            if (isMatch) {
              console.log('Found Discrimination Prevention:', p.program, 'starting', p.startDate);
            }
            return isMatch;
          });

          console.log(`Found ${comprehensivePrograms.length} Comprehensive Labor Relations programs`);
          console.log(`Found ${discriminationPrograms.length} Discrimination Prevention programs`);

          const compositePrograms = [];
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          // Match programs: Comprehensive must start first, Discrimination within 4 weeks
          comprehensivePrograms.forEach(comp => {
            if (!comp.startDate) {
              console.log('⚠️ Skipping Comprehensive program with no start date:', comp.program);
              return;
            }

            // Check if program is in the future
            const compStartDate = new Date(comp.startDate + 'T00:00:00');
            if (compStartDate <= today) {
              console.log('⚠️ Skipping past Comprehensive program:', comp.program, comp.startDate);
              return;
            }

            console.log('🔍 Trying to match Comprehensive program:', comp.program, 'starting', comp.startDate);

            const matchingDisc = discriminationPrograms.find(disc => {
              if (!disc.startDate) return false;

              const discStartDate = new Date(disc.startDate + 'T00:00:00');

              // Discrimination must also be in the future
              if (discStartDate <= today) return false;

              // Calculate time difference
              const timeDiff = discStartDate.getTime() - compStartDate.getTime();
              const weeksDiff = timeDiff / (1000 * 60 * 60 * 24 * 7);

              const isMatch = weeksDiff >= 0 && weeksDiff <= 4;

              if (isMatch) {
                console.log('  ✅ Matched with:', disc.program, 'starting', disc.startDate, `(${weeksDiff.toFixed(1)} weeks apart)`);
              }

              return isMatch;
            });

            if (matchingDisc) {
              const composite = {
                id: `composite-virtual-${comp.id}-${matchingDisc.id}`,
                program: 'Certificate in Employee Relations Law',
                format: 'Virtual',
                startDate: comp.startDate,
                endDate: matchingDisc.endDate,
                city: 'Virtual',
                state: null,
                venueName: 'Virtual Program',
                heroImageUrl: comp.heroImageUrl || matchingDisc.heroImageUrl,
                isComposite: true,
                componentPrograms: [
                  {
                    name: comp.program,
                    startDate: comp.startDate,
                    endDate: comp.endDate
                  },
                  {
                    name: matchingDisc.program,
                    startDate: matchingDisc.startDate,
                    endDate: matchingDisc.endDate
                  }
                ],
                block1Instructor: comp.block1Instructor,
                block2Instructor: matchingDisc.block1Instructor,
                block3Instructor: matchingDisc.block2Instructor,
                price: 2375
              };
              compositePrograms.push(composite);
              console.log('✅ Created composite program:', composite.id);
            } else {
              console.log('  ❌ No matching Discrimination Prevention program found within 4 weeks');
            }
          });

          console.log(`Successfully created ${compositePrograms.length} Virtual composite programs`);

          return compositePrograms;
        })(),
        'On-Demand': (() => {
          // Get all on-demand programs first
          const allOnDemand = CONFIG.PROGRAMS_DATA.filter(p => {
            const f = norm(p.format);
            const programName = norm(p.program);

            // Only include programs that are on-demand format
            const isOnDemand = f === 'on-demand' || f === 'on demand' || f === 'ondemand';
            if (!isOnDemand) return false;

            // Only include Certificate in Employee Relations Law programs
            const isEmployeeRelationsCert = programName.includes('certificate in employee relations law') ||
                                           programName.includes('employee relations law') ||
                                           programName.includes('certificate in employee relations');

            return isEmployeeRelationsCert;
          });

          // Remove duplicates and only keep the first one
          const uniqueOnDemand = [];
          const seenIds = new Set();

          allOnDemand.forEach(program => {
            if (!seenIds.has(program.id)) {
              seenIds.add(program.id);
              uniqueOnDemand.push(program);

          // Include on-demand program
        }
          });

          // Only return the first program to ensure we have exactly 1
          return uniqueOnDemand.slice(0, 1);
        })()
      };

      // Programs filtered by format

      let cardIndex=0;
      let totalPrograms = 0;

      Object.entries(programsByFormat).forEach(([format,programs])=>{
        totalPrograms += programs.length;
        programs.forEach(program=>{
          const card=createSessionCard(program, cardIndex, format);
          container.appendChild(card);
          cardIndex++;
        });
      });


      // If no programs found, show a message
      if (totalPrograms === 0) {
        showEmptyState('No programs are currently available. Please check back soon or contact us for more information.');
        return;
      }

      // All cards are visible by default - pagination will handle display
      ['In-Person','Virtual','On-Demand'].forEach(format=>{
        const formatKey = format.toLowerCase();
        const formatCards=container.querySelectorAll(`.session-card[data-format="${formatKey}"]`);
        formatCards.forEach((card,idx)=>{
          card.classList.remove('card-hidden');
          card.classList.remove('hidden-page');
        });
      });

      // Arrows removed - showing all cards at once

      setupCardEventListeners();

      // Disable navigation arrows completely
      disableNavigationArrows();

      // Setup pagination
      setupPagination();
    }
    function createSessionCard(program,index,format){
      const card=document.createElement('div');
      const formatKey = (format || '').toLowerCase();

      card.className='session-card';
      card.dataset.index=index;
      card.dataset.format=formatKey;
      card.dataset.programName=program.program;

      // Array of curated professional images for Virtual programs
      const virtualBackgroundImages = [
        'https://images.unsplash.com/photo-1551434678-e076c223a692?w=2070&q=80', // Modern office workspace with laptop
        'https://images.unsplash.com/photo-1497366216548-37526070297c?w=2070&q=80', // Clean desk with computer setup
        'https://images.unsplash.com/photo-1515378960530-7c0da6231fb1?w=2070&q=80', // Professional laptop workspace
        'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=2070&q=80', // Team collaboration workspace
        'https://images.unsplash.com/photo-1542744173-8e7e53415bb0?w=2070&q=80', // Modern office teamwork
        'https://images.unsplash.com/photo-1553877522-43269d4ea984?w=2070&q=80', // Professional meeting space
        'https://images.unsplash.com/photo-1559136555-9303baea8ebd?w=2070&q=80', // Contemporary workspace
        'https://images.unsplash.com/photo-1521791136064-7986c2920216?w=2070&q=80'  // Office collaboration
      ];

      // Get background image with fallbacks
      // For Virtual programs, use rotating images instead of heroImageUrl
      let backgroundImage = '';
      if (formatKey === 'virtual') {
        // Use rotating images for Virtual programs
        backgroundImage = virtualBackgroundImages[index % virtualBackgroundImages.length];
      } else {
        // For other formats, use heroImageUrl
        backgroundImage = program.heroImageUrl || '';
      }

      // Check if this is an Advanced Certificate in Strategic Employment Law program
      const programName = (program.program || '').toLowerCase();
      const isAdvancedStrategic = programName.includes('advanced certificate in strategic employment law') ||
                                 programName.includes('strategic employment law');

      // If it's an Advanced Strategic program, use specific images based on location
      if (isAdvancedStrategic && program.city) {
        const city = program.city.toLowerCase();
        switch(city) {
          case 'las vegas':
            backgroundImage = 'https://v5.airtableusercontent.com/v3/u/46/46/1760716800000/84fs3NYY6QetmYpCpQc_3A/yU6WzFNglOU5eBNWiecCKyGSfgUfRLT1fogdikbQsiKOKLSbe91Q5Ky-xbfWStyutapNrG1HTI93j369i05G53OE-Z5vyXYcuwjOzDYmMX4mTkRKZWzVsMvslpDCBcErfaDWHi_P4wbcewETdD5VZRHTQkziGDAkNJ6PLEEAZNA/I-NYiFKoNQIIRsd32Jk0wU2FcJZxnY8wmh-rZ_zqDRo';
            break;
          case 'chicago':
            backgroundImage = 'https://v5.airtableusercontent.com/v3/u/46/46/1760716800000/68XpisLmy7qgLyvfFiSrvQ/uQrA0kZmWouf1C9dJLzhfIRRRv-BnUlLLh-lx2q1H988astRX4LpSlQVADgA97nebuvLexUamMr4ZpZ9tbxew2Kma0Os3ozzO_sT_X_dwOsz61UCFdKzUXSOH-RSmZH-DhPmp7rWwN_tQaSGhLXLjzKAevHLAUaqLjQgFrtA53w/IElH0ffBcoDWuzyXTWh-W1vxFHvDBqWoD1ojcgY-y1U';
            break;
          case 'scottsdale':
            backgroundImage = 'https://v5.airtableusercontent.com/v3/u/46/46/1760716800000/pssllCn7qvyacfuv5ok9Kg/wvRCyYonRa9GIoiMnDpKZAWubyHSPRzjgC2oidb_Ha7hM7X4kuRUPKUOSfR4v1Vo1yousnwLkYlF9O6DSzZ7sYkek3yjRyO2ZcGVOez5x8PUrTdL676k0iZDuHtuvwOGq0SOvSEEjfy_DnoAcIQu4DMQXOlje0by2OZGQnl5w2w/PFrIS8d6WQPchRY13fQ9q1FM7BK1gjpoRNkQawRlh6A';
            break;
          case 'nashville':
            backgroundImage = 'https://v5.airtableusercontent.com/v3/u/46/46/1760716800000/BuQpQV4_FyPKgp65Xx5F2A/4PPKA4NGg33e6qBIrPQ-rDH60m43f7oUdlfYCpUM6OCmYvC0H-huYAdcmVgFr_sVvz0lrdFfRNIYn5Hr3an5iUXaFINpqLvHjBNeTn9CBXvcZyeKU44Rqq45z8Xe18Nf_z9rbZ3aZwHY-T2IGiuN1DwhPH1LRSVj4DDqZTn3yrY/MCi4d12WwAsA1j-Wjk7JSr7Uts4nf7f0JdIUEf0pP7A';
            break;
          case 'washington':
          case 'washington d.c.':
          case 'washington dc':
            backgroundImage = 'https://v5.airtableusercontent.com/v3/u/46/46/1760716800000/POBDRWGf3Q6Rgm9V7rSMzA/1IFqVeR2zoAJ818MUHlEM6q7_34demOrK8r88xwHO61MswOJgRfgZv5kB_eL1a3eRFdgQ0hA87LK21FNco2nAZaU3tw1TiYa0gS7d05PXrBlabj7NY5qDcSo9t-IkuOe2030m4dtcEg2G53fA3mp42bmwHFRH9wwejPk9NxYGyi94BMI1ylECzHn5XNjZ7LGZ4fFB8fKljCwRc0x3_HSyA/QgvUy28y30_bdCgoPio_E2d_sWyJSgBopiwdL8guyko';
            break;
        }
      }

      // If no image found, use format-specific fallback images
      if (!backgroundImage) {
        switch(formatKey) {
          case 'on-demand':
            backgroundImage = 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80'; // Learning/education background
            break;
          case 'in-person':
          default:
            backgroundImage = 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80'; // Conference room background
            break;
        }
      }

      let dateString;
      if(program.startDate && program.endDate){
        dateString = formatDateRange(program.startDate, program.endDate, program.isComposite, program.componentPrograms, formatKey);
      }else{
        dateString = 'Available Now';
      }

      card.innerHTML=`
        <div class="card-background" style="background-image:url('${backgroundImage}')">
          <div class="card-overlay">
            <div class="session-content">
              <div class="session-main-info">
                <div class="session-date">${dateString}</div>
                <div class="session-location">
                  ${program.city ? `${program.city}, ${program.state||''}` : (formatKey==='on-demand' ? 'Online Learning Platform' : 'Virtual Program')}
                </div>
                ${program.venueName && formatKey!=='on-demand' ? `<div class="session-venue">${program.venueName}</div>` : ''}
                ${program.venueName && formatKey!=='virtual' && formatKey!=='on-demand' ? `<div class="hotel-details-link" data-venue-action="show-modal" data-session-id="${program.id}" data-venue-name="${program.venueName}">(view hotel details)</div>` : ''}
                ${formatKey==='on-demand' && program.price ? `<div class="session-price">$${program.price.toLocaleString()}</div>` : ''}
                <a href="#" class="reserve-btn register-btn"
                   data-section="employee-relations-law"
                   data-format="${format}"
                   data-program="${program.program}"
                   data-session-id="${program.id}"
                   data-city="${program.city || ''}"
                   data-state="${program.state || ''}"
                   data-start-date="${program.startDate || ''}"
                   data-end-date="${program.endDate || ''}"
                   data-tracking="session-card-${formatKey}"
                   onclick="return false;">${formatKey==='on-demand' ? 'START LEARNING IMMEDIATELY' : 'RESERVE YOUR SEAT'}</a>
              </div>
              <div class="session-faculty">
                <div class="faculty-title">Faculty</div>
                <div class="faculty-list">
                  ${getInstructorsForProgram(program).map(instructor=>`
                    <div class="faculty-member">
                      <a href="${instructor.profileUrl}" class="faculty-name" target="_blank" data-instructor-name="${instructor.displayName}">${instructor.displayName}</a>
                      ${instructor.title ? `<div class="faculty-title-text">${instructor.title}</div>` : ''}
                    </div>`).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>`;
      return card;
    }
    function getInstructorsForProgram(program){
      const instructorFields=[program.block1Instructor, program.block2Instructor, program.block3Instructor].filter(Boolean);
      const instructors=[], seen=new Set();
      instructorFields.forEach(field=>{
        if(!field) return;
        const ids=Array.isArray(field)?field:[field];
        ids.forEach(id=>{
          let data=CONFIG.INSTRUCTORS_DATA.byId[id] || CONFIG.INSTRUCTORS_DATA.byName[(id||'').toLowerCase()];
          if(data && !seen.has(data.displayName)){
            let displayTitle=data.company || '';
            if(displayTitle && data.fullName){
              displayTitle = displayTitle.replace(new RegExp(data.fullName,'gi'),'').trim().replace(/^[,\s-]+|[,\s-]+$/g,'');
            }
            instructors.push({ displayName: data.fullName || data.displayName, title: displayTitle || null, profileUrl: data.profileUrl || '#'});
            seen.add(data.displayName);
          }
        });
      });
      return instructors;
    }
    function formatDateRange(startStr,endStr,isComposite=false,componentPrograms=null,format=''){
      if(isComposite && componentPrograms && componentPrograms.length===2){
        const [p1,p2]=componentPrograms;
        const s1=new Date(p1.startDate+'T00:00:00'), e1=new Date(p1.endDate+'T00:00:00');
        const s2=new Date(p2.startDate+'T00:00:00'), e2=new Date(p2.endDate+'T00:00:00');

        // Check if both components are in the same month
        const month1=s1.toLocaleDateString('en-US',{month:'long'});
        const month2=s2.toLocaleDateString('en-US',{month:'long'});
        const year=s1.getFullYear();

        // For Virtual format: always show month with each date set, and use line break
        if(format === 'virtual'){
          const d1=s1.getDate(), de1=e1.getDate();
          const d2=s2.getDate(), de2=e2.getDate();
          return `${month1} ${d1}-${de1}, ${year} &<br>${month2} ${d2}-${de2}, ${year}`;
        }

        // For other formats: use inline formatting
        if(month1 === month2){
          // Same month: "October 27-28, 2025 & 29-30, 2025"
          const d1=s1.getDate(), de1=e1.getDate();
          const d2=s2.getDate(), de2=e2.getDate();
          return `${month1} ${d1}-${de1}, ${year} & ${d2}-${de2}, ${year}`;
        } else {
          // Different months: "October 27-28, 2025 & November 10-11, 2025"
          const d1=s1.getDate(), de1=e1.getDate();
          const d2=s2.getDate(), de2=e2.getDate();
          return `${month1} ${d1}-${de1}, ${year} & ${month2} ${d2}-${de2}, ${year}`;
        }
      }
      const s=new Date(startStr+'T00:00:00'), e=new Date(endStr+'T00:00:00');
      const sm=s.toLocaleDateString('en-US',{month:'long'}), em=e.toLocaleDateString('en-US',{month:'long'});
      const sd=s.getDate(), ed=e.getDate(), y=s.getFullYear();
      return sm===em ? `${sm} ${sd}-${ed}, ${y}` : `${sm} ${sd} - ${em} ${ed}, ${y}`;
    }

    /* ===========================
       EVENTS
       =========================== */
    function setupCardEventListeners(){
      const cards=document.querySelectorAll('.program-sessions-widget .session-card');
      cards.forEach(card=>{
        card.addEventListener('click',(e)=>{
          if(!e.target.classList.contains('hotel-details-link') && !e.target.classList.contains('reserve-btn') && !e.target.classList.contains('faculty-name')){
            toggleCard(parseInt(card.dataset.index,10));
          }
        });
      });

      // Add event listeners for faculty name clicks
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('faculty-name')) {
          e.preventDefault();
          const profileUrl = e.target.getAttribute('href');
          const instructorName = e.target.getAttribute('data-instructor-name');
          handleFacultyClick(profileUrl, instructorName);
        }
      });
    }

    function handleFacultyClick(profileUrl, instructorName) {
      if (!profileUrl || profileUrl === '#') {
        return;
      }

      // Simply open the full URL with hash fragment in a new tab
      // The browser will automatically handle scrolling to the anchor
      const newWindow = window.open(profileUrl, '_blank');

      if (!newWindow) {
        // Popup blocked, fallback to opening in same window
        window.location.href = profileUrl;
      }
    }

    function disableNavigationArrows(){
      // Remove all arrow event listeners and hide arrows
      const left=document.querySelector('.program-sessions-widget #left-arrow');
      const right=document.querySelector('.program-sessions-widget #right-arrow');

      if(left){
        left.style.display = 'none';
        left.removeEventListener('click', scrollToPrevious);
      }
      if(right){
        right.style.display = 'none';
        right.removeEventListener('click', scrollToNext);
      }
    }

    /* ===========================
       PAGINATION
       =========================== */
    function setupPagination(){
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const pageInfo = document.getElementById('page-info');
      const paginationContainer = document.getElementById('pagination-container');

      if(prevBtn) prevBtn.addEventListener('click', goToPreviousPage);
      if(nextBtn) nextBtn.addEventListener('click', goToNextPage);

      updatePagination();
    }

    function updatePagination(){
      const currentCards = cardsForCurrentFormat();
      const totalCards = currentCards.length;
      const cardsPerPage = CONFIG.PAGINATION.cardsPerPage;
      const totalPages = Math.ceil(totalCards / cardsPerPage);

      CONFIG.PAGINATION.totalPages = totalPages;

      // Show/hide pagination based on whether we need it
      const paginationContainer = document.getElementById('pagination-container');
      const paginationWrapper = document.querySelector('.pagination-wrapper');
      const paginWrapper = document.querySelector('.pagin-wrapper');
      if(totalPages <= 1){
        // Don't hide the entire pagin-wrapper, just hide the pagination container
        if(paginationContainer) paginationContainer.style.display = 'none';
        // Show all cards if only one page
        currentCards.forEach(card => {
          card.classList.remove('hidden-page');
        });
        return;
      } else {
        if(paginWrapper) paginWrapper.style.display = 'flex';
        if(paginationWrapper) paginationWrapper.style.display = 'flex';
        if(paginationContainer) paginationContainer.style.display = 'flex';
      }

      // Update page info
      const pageInfo = document.getElementById('page-info');
      pageInfo.textContent = `Page ${CONFIG.PAGINATION.currentPage} of ${totalPages}`;

      // Update pagination dots
      updatePaginationDots();

      // Update button states
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');

      prevBtn.disabled = CONFIG.PAGINATION.currentPage <= 1;
      nextBtn.disabled = CONFIG.PAGINATION.currentPage >= totalPages;

      // Show/hide cards based on current page
      showCurrentPageCards();
    }

    function updatePaginationDots(){
      const dotsContainer = document.getElementById('pagination-dots');
      dotsContainer.innerHTML = '';

      const totalPages = CONFIG.PAGINATION.totalPages;
      const currentPage = CONFIG.PAGINATION.currentPage;

      // Show up to 7 dots (current page + 3 on each side)
      const maxDots = 7;
      let startPage = Math.max(1, currentPage - 3);
      let endPage = Math.min(totalPages, startPage + maxDots - 1);

      // Adjust start if we're near the end
      if(endPage - startPage < maxDots - 1){
        startPage = Math.max(1, endPage - maxDots + 1);
      }

      for(let i = startPage; i <= endPage; i++){
        const dot = document.createElement('div');
        dot.className = `pagination-dot ${i === currentPage ? 'active' : ''}`;
        dot.addEventListener('click', () => goToPage(i));
        dotsContainer.appendChild(dot);
      }
    }

    function showCurrentPageCards(){
      const currentCards = cardsForCurrentFormat();
      const cardsPerPage = CONFIG.PAGINATION.cardsPerPage;
      const currentPage = CONFIG.PAGINATION.currentPage;

      const startIndex = (currentPage - 1) * cardsPerPage;
      const endIndex = startIndex + cardsPerPage;

      currentCards.forEach((card, index) => {
        if(index >= startIndex && index < endIndex){
          card.classList.remove('hidden-page');
        } else {
          card.classList.add('hidden-page');
        }
      });

      // Reset expanded card to first visible card
      const visibleCards = currentCards.filter(card => !card.classList.contains('hidden-page'));
      if(visibleCards.length > 0){
        resetAndExpandFirstVisible(visibleCards);
      }
    }

    function goToPage(page){
      if(page < 1 || page > CONFIG.PAGINATION.totalPages) return;

      CONFIG.PAGINATION.currentPage = page;
      updatePagination();
    }

    function goToPreviousPage(){
      if(CONFIG.PAGINATION.currentPage > 1){
        goToPage(CONFIG.PAGINATION.currentPage - 1);
      }
    }

    function goToNextPage(){
      if(CONFIG.PAGINATION.currentPage < CONFIG.PAGINATION.totalPages){
        goToPage(CONFIG.PAGINATION.currentPage + 1);
      }
    }
    function toggleCard(i){
      if(currentExpandedCard !== i) {
        expandCard(i);
      }
    }
    function expandCard(i){
      const cards=document.querySelectorAll('.program-sessions-widget .session-card');
      cards.forEach(c=>{
        c.classList.remove('expanded'); c.setAttribute('aria-expanded','false');
        const f=c.querySelector('.session-faculty'), b=c.querySelector('.reserve-btn');
        if(f) f.style.display='none'; if(b) b.style.display='none';
      });
      const selected=cards[i]; if(!selected) return;
      selected.classList.add('expanded'); selected.setAttribute('aria-expanded','true');
      const f=selected.querySelector('.session-faculty'), b=selected.querySelector('.reserve-btn');
      if(f) f.style.display='block'; if(b) b.style.display='block';
      currentExpandedCard=i;
    }
    function collapseCard(i){
      const cards=document.querySelectorAll('.program-sessions-widget .session-card');
      const selected=cards[i]; if(!selected) return;
      selected.classList.remove('expanded'); selected.setAttribute('aria-expanded','false');
      const f=selected.querySelector('.session-faculty'), b=selected.querySelector('.reserve-btn');
      if(f) f.style.display='none'; if(b) b.style.display='none';
      currentExpandedCard=null;
    }

    /* ===========================
       NAVIGATION
       =========================== */
    function updateLeftArrowVisibility(){
      const left=document.querySelector('.program-sessions-widget #left-arrow');
      // Hide arrows since we're showing all cards at once
      if(left) left.style.display = 'none';
    }
    function updateRightArrowVisibility(){
      const right=document.querySelector('.program-sessions-widget #right-arrow');
      // Hide arrows since we're showing all cards at once
      if(right) right.style.display = 'none';
    }
      function cardsForCurrentFormat(){
        const current=CONFIG.CURRENT_FORMAT;
        return Array.from(document.querySelectorAll('.program-sessions-widget .session-card')).filter(card=>{
          const f=card.dataset.format;

          // Get the program name from the card's data or content
          const programName = card.dataset.programName ||
                             card.querySelector('.session-date')?.textContent?.toLowerCase() || '';

          // Simple format-based filtering
          if(current==='Virtual' && f==='virtual') return true;
          if(current==='On-Demand' && (f==='on-demand' || f==='on demand')) return true;
          if(current==='In-Person' && (f==='in-person' || f==='in person')) return true;

          return false;
        });
      }
    function scrollToNext(){
      const allCards = cardsForCurrentFormat();

      if(allCards.length<=3) return;

      const visible = allCards.filter(c=>!c.classList.contains('card-hidden'));
      const hidden = allCards.filter(c=>c.classList.contains('card-hidden'));

      if(hidden.length===0) return;

      // Hide all currently visible cards
      visible.forEach(c=>c.classList.add('card-hidden'));

      // Show the next set of cards (up to 3, or all remaining if less than 3)
      const toShow = Math.min(3, hidden.length);
      for(let i=0; i<toShow; i++){
        hidden[i].classList.remove('card-hidden');
        hidden[i].style.display='block';
      }

      resetAndExpandFirstVisible(allCards);
    }
    function scrollToPrevious(){
      const allCards = cardsForCurrentFormat();

      if(allCards.length<=3) return;

      const visible = allCards.filter(c=>!c.classList.contains('card-hidden'));
      const firstVisibleIndex = allCards.indexOf(visible[0]);
      const hiddenBefore = allCards.slice(0, firstVisibleIndex).filter(c=>c.classList.contains('card-hidden'));

      if(hiddenBefore.length===0) return;

      // Hide all currently visible cards
      visible.forEach(c=>c.classList.add('card-hidden'));

      // Show the previous set of cards (up to 3, or all available if less than 3)
      const toShow = Math.min(3, hiddenBefore.length);
      const startIdx = Math.max(0, hiddenBefore.length - toShow);
      for(let i=startIdx; i<hiddenBefore.length; i++){
        hiddenBefore[i].classList.remove('card-hidden');
        hiddenBefore[i].style.display='block';
      }

      resetAndExpandFirstVisible(allCards);
    }
    function resetAndExpandFirstVisible(allCards){
      const nowVisible = allCards.filter(c=>!c.classList.contains('card-hidden'));
      allCards.forEach(c=>{
        c.classList.remove('expanded'); c.setAttribute('aria-expanded','false');
        const f=c.querySelector('.session-faculty'), b=c.querySelector('.reserve-btn');
        if(f) f.style.display='none'; if(b) b.style.display='none';
      });
      if(nowVisible[0]){
        nowVisible[0].classList.add('expanded'); nowVisible[0].setAttribute('aria-expanded','true');
        const f=nowVisible[0].querySelector('.session-faculty'), b=nowVisible[0].querySelector('.reserve-btn');
        if(f) f.style.display='block'; if(b) b.style.display='block';
        currentExpandedCard = parseInt(nowVisible[0].dataset.index,10);
      }
    }

    /* Empty state helpers */
    function showEmptyState(message){
      const container=document.querySelector('.program-sessions-widget #sessions-container');
      removeEmptyState();
      const div=document.createElement('div');
      div.className='empty-state';
      div.textContent = message || 'No sessions found for the selected format.';
      container.appendChild(div);
    }
    function removeEmptyState(){
      const el=document.querySelector('.program-sessions-widget #sessions-container .empty-state');
      if(el) el.remove();
    }

    /* switchFormat (with empty-state) */
    function switchFormat(format){
      CONFIG.CURRENT_FORMAT = format;
      CONFIG.PAGINATION.currentPage = 1; // Reset to first page when switching formats

      document.querySelectorAll('.program-sessions-widget .toggle-option').forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.format===format);
      });

      const container = document.querySelector('.program-sessions-widget #sessions-container');
      const allCards = Array.from(document.querySelectorAll('.program-sessions-widget .session-card'));

        allCards.forEach(card=>{
          const f = card.dataset.format;

          // Simple format-based filtering
          const isCurrent =
            (format==='Virtual'   && f==='virtual') ||
            (format==='On-Demand' && (f==='on-demand' || f==='on demand')) ||
            (format==='In-Person' && (f==='in-person' || f==='in person'));

          if(isCurrent){
            card.style.display='block';
            card.classList.remove('card-hidden');
          }else{
            card.style.display='none';
            card.classList.add('card-hidden');
            card.classList.remove('expanded');
          }
        });

      const currentCards = allCards.filter(c=>c.style.display!=='none');

      // Current cards for selected format

      if(currentCards.length === 0){
        removeEmptyState();
        showEmptyState(`No ${format.toLowerCase()} sessions match the current criteria. Please check back soon.`);
        return;
      } else {
        removeEmptyState();
      }

      currentCards.forEach((card,i)=>{
        card.classList.remove('card-hidden'); // Show ALL cards for the current format
        card.classList.remove('expanded'); card.setAttribute('aria-expanded','false');
        const fac=card.querySelector('.session-faculty'), btn=card.querySelector('.reserve-btn');
        if(fac) fac.style.display='none'; if(btn) btn.style.display='none';
      });

      const visibleCount = currentCards.filter(c=>!c.classList.contains('card-hidden')).length;
      container.classList.toggle('single-card', visibleCount===1);
      container.classList.toggle('two-cards', visibleCount===2);
      if(visibleCount!==1 && visibleCount!==2) container.classList.remove('single-card','two-cards');

      const firstVisible = currentCards.find(c=>!c.classList.contains('card-hidden'));
      if(firstVisible){
        firstVisible.classList.add('expanded'); firstVisible.setAttribute('aria-expanded','true');
        const f=firstVisible.querySelector('.session-faculty'), b=firstVisible.querySelector('.reserve-btn');
        if(f) f.style.display='block'; if(b) b.style.display='block';
        currentExpandedCard = parseInt(firstVisible.dataset.index,10);
      }else{
        currentExpandedCard = null;
      }

      // Update pagination after switching formats
      updatePagination();
    }

    /* ===========================
       LOADING
       =========================== */
    function showLoadingState(){
      const container=document.querySelector('.program-sessions-widget #sessions-container');
      container.innerHTML='<div class="loading-container"><div class="loading-spinner"></div></div>';
    }
    function hideLoadingState(){
      const loading=document.querySelector('.program-sessions-widget .loading-container');
      if(loading) loading.remove();
    }

    /* ===========================
       TEST CONNECTION
       =========================== */
    async function testAirtableConnection(){
      try {
        // Build URL using proper method to avoid double query marks
        const url = buildAirtableUrl(CONFIG.AIRTABLE.PROGRAMS_ENDPOINT, { maxRecords: 1 });
        const response = await fetch(url);

        if (response.ok) {
          const data = await response.json();
          console.log('✅ Airtable connection test successful');
          return true;
        } else {
          console.error('❌ Airtable connection test failed:', response.status);
          return false;
        }
      } catch (error) {
        console.error('❌ Airtable connection test error:', error);
        return false;
      }
    }

    /* ===========================
       UTILITY FUNCTIONS
       =========================== */
    function scrollToAllPrograms() {
      const programsSection = document.getElementById('all-programs');
      if (programsSection) {
        programsSection.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    }

    // Make scrollToAllPrograms globally available
    window.scrollToAllPrograms = scrollToAllPrograms;

    /* ===========================
       START
       =========================== */
    document.addEventListener('DOMContentLoaded', function(){
      // Initialize hotel modal
      hotelModal = new HotelModalController();
      hotelModal.init();

      document.querySelectorAll('.program-sessions-widget .toggle-option').forEach(btn=>{
        btn.addEventListener('click', ()=> switchFormat(btn.dataset.format));
      });

      // Test connection first
      testAirtableConnection().then(connected => {
        if (connected) {
          loadData();
        }
      });
    });

    })();
    </script>

    <!-- EXTRACT MODAL JAVASCRIPT FROM cerl-production.html -->
    <!-- The complete modal JavaScript (lines 3785-6338 from cerl-production.html) needs to be inserted here -->
    <!-- Due to size constraints, this needs to be done manually or via external JS file -->

    <!-- TEMPORARY PLACEHOLDER: Copy lines 3785-6338 from cerl-production.html here -->
    <script>
    (function() {
      const state = {
        step: 3, // Start at location selection (was step 4, now step 1)
        format: 'In-Person', // PRE-FILLED
        program: 'Certificate in Employee Relations Law', // PRE-FILLED
        attendanceType: 'Full', // Label for review (Full or joined blocks)
        attendanceBlocks: [],   // Array of selected blocks for block-based programs
        sessionId: '',
        sessionRecord: null,
        basePrice: 0,
        coupon: null, // coupon record data
        couponDiscount: 0,
        amountDue: 0,
        derivedStart: null,
        derivedEnd: null,
        showFieldErrors: false,
        // For Virtual: computed certificate date pairs by program label
        virtualCertificatePairs: {},
      };

      // Program configuration: blocks, days, and date ranges
      const blockProgramMap = {
        'Certificate in Employee Relations Law': { code: 'A', blocks: ['Block 1','Block 2','Block 3'], days: { 'Block 1': 2, 'Block 2': 2, 'Block 3': 1 }, ranges: { 'Block 1': [0,1], 'Block 2': [2,3], 'Block 3': [4,4] } },
        'Certificate in Employee Benefits Law': { code: 'E', blocks: ['Block 1','Block 2','Block 3'], days: { 'Block 1': 2, 'Block 2': 1, 'Block 3': 2 }, ranges: { 'Block 1': [0,1], 'Block 2': [2,2], 'Block 3': [3,4] } },
        'Certificate in Strategic HR Management': { code: 'B', blocks: ['Block 1','Block 2'], days: { 'Block 1': 2, 'Block 2': 3 }, ranges: { 'Block 1': [0,1], 'Block 2': [2,4] } },
      };

      // Hardcoded program pricing (full and per-block)
      const PRICING = {
        'Certificate in Employee Relations Law': {
          full: 2375,
          blocks: { 'Block 1': 1375, 'Block 2': 1375, 'Block 3': 575 }
        },
        'Certificate in Strategic HR Management': {
          full: 2375,
          blocks: { 'Block 1': 1375, 'Block 2': 1575 }
        },
        'Certificate in Employee Benefits Law': {
          full: 2375,
          blocks: { 'Block 1': 1375, 'Block 2': 575, 'Block 3': 975 }
        },
        'Advanced Certificate in Strategic Employment Law': { full: 1575 },
        'Advanced Certificate in Employee Benefits Law': { full: 1575 },
        'Certificate in Workplace Investigations': { full: 1575 },
      };
      function getProgramPricing(program) { return PRICING[program] || null; }

      // Virtual derived certificate labels for display/logic
      const VIRTUAL_CERT_PROGRAMS = new Set([
        'Certificate in Employee Relations Law',
        'Certificate in Strategic HR Management'
      ]);

      // Format and program code mappings
      const formatCodeMap = { 'In-Person': 'IP', 'Virtual': 'V', 'On-Demand': 'OD' };
      const ALLOWED_PROGRAMS = [
        'IAML Attorney Advisory Program',
        'Certificate in Employee Relations Law',
        'Certificate in Strategic HR Management',
        'Certificate in Employee Benefits Law',
        'Advanced Certificate in Strategic Employment Law',
        'Advanced Certificate in Employee Benefits Law',
        'Certificate in Workplace Investigations',
      ];

      // API Configuration (API calls now use serverless proxies)
      const TABLE_SESSIONS = 'Program Sessions';
      const TABLE_COUPONS = 'tblBaUQKmYuIMsVQm'; // Coupon Codes (table id)
      // const GHL_WEBHOOK_URL = ENV_CONFIG.GHL_REGISTRATION_WEBHOOK; // Moved to backend APIs

      // DOM elements
      const qs = (sel) => document.querySelector(sel);
      const qsa = (sel) => Array.from(document.querySelectorAll(sel));
      // Show/hide a key-value row (value selector points to the value node; its label is previous sibling)
      function toggleKvRow(valueSel, shouldShow) {
        const val = qs(valueSel);
        if (!val) return;
        const label = val.previousElementSibling && val.previousElementSibling.classList?.contains('label')
          ? val.previousElementSibling
          : null;
        const show = !!shouldShow;
        val.style.display = show ? '' : 'none';
        if (label) label.style.display = show ? '' : 'none';
      }
      function showPreload(show) {
        const o = qs('#preloadOverlay');
        if (o) { o.dataset.show = show ? 'true' : 'false'; o.setAttribute('aria-hidden', show ? 'false' : 'true'); }
      }
      function showRedirectOverlay(show) {
        const o = qs('#redirectOverlay');
        if (o) { o.dataset.show = show ? 'true' : 'false'; o.setAttribute('aria-hidden', show ? 'false' : 'true'); }
      }
      const delay = (ms) => new Promise(r => setTimeout(r, ms));

      async function preloadSessionsThenAdvance(nextStep) {
        const mode = (window.demoLoaderMode || '').toLowerCase();
        if (mode === 'overlay') showPreload(true);
        try {
          const load = loadSessions(state.program, state.format, { silent: true });
          await Promise.race([load, delay(2000)]);
        } catch {}
        finally {
          if (mode === 'overlay') showPreload(false);
          setStep(nextStep);
        }
      }
      const modalOverlay = qs('#iamlModalOverlay');
      const openModalBtn = qs('#openModalBtn');
      const closeModalBtn = qs('#closeModalBtn');
      const nextBtn = qs('#nextBtn');
      const backBtn = qs('#backBtn');
      const submitBtn = qs('#submitBtn');
      const globalSpinner = qs('#globalSpinner');
      const globalMsg = qs('#globalMsg');
      const steps = qsa('.step');
      const subTitle = qs('#iamlSubTitle');

      const formatSelect = qs('#formatSelect');
      const getFormatRadios = () => Array.from(document.querySelectorAll('input[name="format"]'));
      const programSelect = qs('#programSelect');
      const getProgramRadios = () => Array.from(document.querySelectorAll('input[name="program"]'));
      const sessionCount = qs('#sessionCount');
      const block1Option = qs('#attBlock1');
      const block2Option = qs('#attBlock2');
      const block3Option = qs('#attBlock3');
      const sessionSelect = qs('#sessionSelect');
      const sessionDetails = qs('#sessionDetails');
      const firstName = qs('#iamlModalOverlay #firstName');
      const lastName = qs('#iamlModalOverlay #lastName');
      const title = qs('#iamlModalOverlay #title');
      const company = qs('#iamlModalOverlay #company');
      const phone = qs('#iamlModalOverlay #phone');
      const email = qs('#iamlModalOverlay #email');
      // Try multiple selectors to find coupon elements (may be in modal overlay)
      const couponCode = qs('#iamlModalOverlay #couponCode') || qs('#couponCode');
      const applyCouponBtn = qs('#iamlModalOverlay #applyCouponBtn') || qs('#applyCouponBtn');
      const couponMsg = qs('#iamlModalOverlay #couponMsg') || qs('#couponMsg');
      const couponSpinner = qs('#iamlModalOverlay #couponSpinner') || qs('#couponSpinner');
      const reviewSummary = qs('#reviewSummary');
      const amountDueEl = qs('#amountDue');
      const discountLine = qs('#discountLine');

      const urlBuilderToggle = qs('#urlBuilderToggle');
      const urlBuilderPanel = qs('#urlBuilderPanel');
      const builderFormat = qs('#builderFormat');
      const builderProgram = qs('#builderProgram');
      const builderBlock = qs('#builderBlock');
      const builderSession = qs('#builderSession');
      const builderUrl = qs('#builderUrl');
      const copyBuilderUrl = qs('#copyBuilderUrl');
      const builderMsg = qs('#builderMsg');
      // Code Builder refs
      const codeFmt = qs('#codeFmt');
      const codeProg = qs('#codeProg');
      const codeCity = qs('#codeCity');
      const codeState = qs('#codeState');
      const codeStyle = qs('#codeStyle');
      const codeSelector = qs('#codeSelector');
      const codeOutput = qs('#codeOutput');
      const copyCode = qs('#copyCode');

      function populateProgramOptions(selectEl) {
        if (!selectEl) return;
        selectEl.innerHTML = '<option value="" disabled selected>Select a program</option>';
        ALLOWED_PROGRAMS.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          selectEl.appendChild(opt);
        });
      }

      function stepToProgress(n) { return n <= 1 ? 1 : (n === 2 ? 2 : (n === 3 ? 3 : (n === 4 ? 4 : 5))); }
      function renderProgress() {
        const container = qs('#progressIndicator');
        if (!container) return;
        container.innerHTML = '';
        const active = stepToProgress(state.step);
        for (let i = 1; i <= 5; i++) {
          const node = document.createElement('span');
          node.className = 'node' + (i <= active ? ' active' : '');
          container.appendChild(node);
          if (i < 5) {
            const line = document.createElement('span');
            line.className = 'line' + (i < active ? ' active' : '');
            container.appendChild(line);
          }
        }
      }
      function renderProgressForStep2() {
        const container = qs('#progressStep2');
        if (!container) return;
        container.innerHTML = '';
        // Step 2 should show step 1 complete, step 2 current
        for (let i = 1; i <= 5; i++) {
          const node = document.createElement('span');
          let cls = 'node';
          if (i === 1) cls += ' active';
          if (i === 2) cls += ' current';
          node.className = cls;
          container.appendChild(node);
          if (i < 5) {
            const line = document.createElement('span');
            let lcls = 'line';
            if (i === 1) lcls += ' active';
            line.className = lcls;
            container.appendChild(line);
          }
        }
      }
      function renderProgressForStep3() {
        // Step 3 = Location selection (Position 1 of 4)
        const container = qs('#progressStep3');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 4; i++) {
          const node = document.createElement('span');
          let cls = 'node';
          if (i === 1) cls += ' current';
          node.className = cls;
          container.appendChild(node);
          if (i < 4) {
            const line = document.createElement('span');
            line.className = 'line';
            container.appendChild(line);
          }
        }
      }

      function renderProgressForStep4() {
        // Step 4 = Block selection (Position 2 of 4)
        const container = qs('#progressStep4');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 4; i++) {
          const node = document.createElement('span');
          let cls = 'node';
          if (i === 1) cls += ' active';
          if (i === 2) cls += ' current';
          node.className = cls;
          container.appendChild(node);
          if (i < 4) {
            const line = document.createElement('span');
            let lcls = 'line';
            if (i === 1) lcls += ' active';
            line.className = lcls;
            container.appendChild(line);
          }
        }
      }

      function renderProgressForStep5() {
        // Step 5 = Contact info (Position 3 of 4)
        const container = qs('#progressStep5');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 4; i++) {
          const node = document.createElement('span');
          let cls = 'node';
          if (i === 1 || i === 2) cls += ' active';
          if (i === 3) cls += ' current';
          node.className = cls;
          container.appendChild(node);
          if (i < 4) {
            const line = document.createElement('span');
            let lcls = 'line';
            if (i === 1 || i === 2) lcls += ' active';
            line.className = lcls;
            container.appendChild(line);
          }
        }
      }

      function renderProgressForStep6() {
        // Step 6 = Confirmation (Position 4 of 4)
        const container = qs('#progressStep6');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 4; i++) {
          const node = document.createElement('span');
          node.className = 'node active';
          container.appendChild(node);
          if (i < 4) {
            const line = document.createElement('span');
            line.className = 'line active';
            container.appendChild(line);
          }
        }
      }

      // Ensure Step 5 never shows attendance options
      function cleanupStep5() {
        const step5 = qs('#step5');
        if (!step5) return;
        // Remove any leftover attendance UI accidentally injected
        step5.querySelectorAll('input[name="attendanceTypeFull"], input[name="attendanceBlocks"]').forEach(el => {
          const row = el.closest('.option-row'); if (row) row.remove(); else el.remove();
        });
        step5.querySelectorAll('#attendanceOptions, .attendance-section').forEach(el => el.remove());
        step5.querySelectorAll('h1,h2,h3,h4').forEach(h => {
          if ((h.textContent || '').toLowerCase().includes('attendance')) h.remove();
        });
      }

      // Stronger purge for Step 5 content only
      function purgeAttendanceFromStep5() {
        const s5 = qs('#step5');
        if (!s5) return;

        // Remove all attendance-related inputs and their containers
        s5.querySelectorAll('input[name="attendanceTypeFull"], input[name="attendanceBlocks"]').forEach(el => {
          const row = el.closest('.option-row');
          if (row) row.remove(); else el.remove();
        });

        // Remove attendance containers and sections
        s5.querySelectorAll('#attendanceOptions, .attendance-section, #step3, .option-row').forEach(el => el.remove());

        // Remove any headings related to attendance
        s5.querySelectorAll('h1,h2,h3,h4').forEach(h => {
          const t = (h.textContent || '').trim().toLowerCase();
          if (t.includes('select your attendance') || t.includes('attendance') || t.includes('block')) h.remove();
        });

        // Remove any labels that contain attendance options
        s5.querySelectorAll('label').forEach(label => {
          const hasAttendanceInput = label.querySelector('input[name="attendanceTypeFull"], input[name="attendanceBlocks"]');
          if (hasAttendanceInput) {
            label.remove();
          }
        });

        // Remove any divs that contain attendance options
        s5.querySelectorAll('div').forEach(div => {
          const hasAttendanceInputs = div.querySelector('input[name="attendanceTypeFull"], input[name="attendanceBlocks"]');
          if (hasAttendanceInputs && !div.closest('#step5 > .progress')) {
            div.remove();
          }
        });
      }

      function hardResetStep5() {
        const s5 = qs('#step5');
        if (!s5) return;

        // Remove ALL attendance-related elements from Step 5
        const attendanceSelectors = [
          'input[name="attendanceTypeFull"]',
          'input[name="attendanceBlocks"]',
          '#attendanceOptions',
          '.attendance-section',
          '.option-row',
          '#step3',
          'label[for*="att"]',
          'label:has(input[name="attendanceTypeFull"])',
          'label:has(input[name="attendanceBlocks"])'
        ];

        attendanceSelectors.forEach(selector => {
          s5.querySelectorAll(selector).forEach(el => {
            if (el.id === 'step3') {
              el.remove();
            } else {
              const row = el.closest('.option-row');
              if (row) {
                row.remove();
              } else {
                el.remove();
              }
            }
          });
        });

        // Remove any headings that contain attendance-related text
        s5.querySelectorAll('h1,h2,h3,h4').forEach(h => {
          const text = (h.textContent || '').toLowerCase();
          if (text.includes('attendance') || text.includes('select your attendance') || text.includes('block')) {
            h.remove();
          }
        });

        // Remove any divs that contain attendance options
        s5.querySelectorAll('div').forEach(div => {
          const hasAttendanceInputs = div.querySelector('input[name="attendanceTypeFull"], input[name="attendanceBlocks"]');
          if (hasAttendanceInputs) {
            div.remove();
          }
        });
      }

      function prepareStep4() {
        // Populate timeline list
        const list = qs('#sessionsList');
        const empty = qs('#sessionsEmpty');
        if (list) list.innerHTML = '';
        if (empty) empty.classList.add('hidden');
        // Render virtual certificate synthesized pairs, if present
        if (state.format === 'Virtual' && state.virtualCertificatePairs && state.virtualCertificatePairs[state.program]) {
          const pairs = state.virtualCertificatePairs[state.program];
          if (list && Array.isArray(pairs)) {
            pairs.forEach((pair, index) => {
              const card = document.createElement('div');
              card.className = 'session-card';
              card.setAttribute('role','radio'); card.setAttribute('tabindex','0');

              const radio = document.createElement('input'); radio.type = 'radio'; radio.name = 'sessionRadio'; radio.className = 'session-radio';
              const img = document.createElement('img'); img.className = 'session-thumb'; img.src = 'https://i.imgur.com/AnabbC7.jpeg'; img.alt = 'Session image';

              const info = document.createElement('div'); info.className = 'session-info';
              const loc = document.createElement('div'); loc.className = 'session-loc'; loc.textContent = 'Virtual Classroom';

              const comp1Name = pair.components?.[0]?.program || 'Session 1';
              const comp2Name = pair.components?.[1]?.program || 'Session 2';

              const note = document.createElement('div');
              note.className = 'note-info';
              note.textContent = `This virtual certificate includes two sessions: ${comp1Name} and ${comp2Name}.`;

              const d1 = document.createElement('div'); d1.className = 'session-date';
              d1.textContent = `Session 1 — ${formatHumanRange(pair.components?.[0]?.start, pair.components?.[0]?.end)}`;
              d1.title = comp1Name;
              const d2 = document.createElement('div'); d2.className = 'session-date';
              d2.textContent = `Session 2 — ${formatHumanRange(pair.components?.[1]?.start, pair.components?.[1]?.end)}`;
              d2.title = comp2Name;

              info.appendChild(loc); info.appendChild(note); info.appendChild(d1); info.appendChild(d2);
              card.appendChild(radio); card.appendChild(img); card.appendChild(info);

              function selectThis() {
                const programKey = state.program.replace(/[^a-zA-Z0-9]/g, '');
                state.sessionId = `virtualcert:${programKey}:${index}:${pair.overallStart ? formatYMDLocal(pair.overallStart) : ''}`;
                state.sessionRecord = { id: state.sessionId, fields: {
                  Program: state.program, Format: 'Virtual', 'Program Pricing': getProgramPricing(state.program)?.full || 2375,
                  City: 'Online', State: '',
                  'Session Start Date': pair.overallStart ? formatYMDLocal(pair.overallStart) : '',
                  'Session End Date': pair.overallEnd ? formatYMDLocal(pair.overallEnd) : ''
                } };
                state.attendanceType = 'Full';
                card.dataset.selected = 'true'; radio.checked = true; updateNextEnabled();
              }
              card.addEventListener('click', selectThis);
              card.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); selectThis(); }});
              list.appendChild(card);
            });
          }
          return; // do not load Airtable sessions for synthesized cert
        }
        const mode = (window.demoLoaderMode || '').toLowerCase();
        if (mode === 'skeleton' && list) {
          for (let i = 0; i < 4; i++) {
            const sk = document.createElement('div'); sk.className = 'session-card skel';
            const t = document.createElement('div'); t.className = 'thumb-skel skeleton';
            const b = document.createElement('div'); b.style.display='grid'; b.style.gap='6px';
            const l1 = document.createElement('div'); l1.className = 'line-skel skeleton'; l1.style.width='60%';
            const l2 = document.createElement('div'); l2.className = 'line-skel skeleton'; l2.style.width='40%';
            b.appendChild(l1); b.appendChild(l2);
            sk.appendChild(t); sk.appendChild(b); list.appendChild(sk);
          }
        }
        if (state.program && state.format) {
          // HARDCODED SESSIONS for Certificate in Employee Relations Law
          const records = [
            {
              id: 'atlanta-2026',
              fields: {
                'City': 'Atlanta',
                'State': 'Georgia',
                'Session Start Date': '2026-04-20',
                'Session End Date': '2026-04-24',
                'Venue Name (1)': 'TBD',
                'Has Blocks': true,
                'Blocks Offered': ['Block 1', 'Block 2', 'Block 3'],
                'Block 1 Start': '2026-04-20',
                'Block 1 End': '2026-04-21',
                'Block 2 Start': '2026-04-22',
                'Block 2 End': '2026-04-23',
                'Block 3 Start': '2026-04-24',
                'Block 3 End': '2026-04-24',
                'Full Price': 2995,
                'Block Price': 1095
              }
            },
            {
              id: 'scottsdale-2026',
              fields: {
                'City': 'Scottsdale',
                'State': 'Arizona',
                'Session Start Date': '2026-06-01',
                'Session End Date': '2026-06-05',
                'Venue Name (1)': 'TBD',
                'Has Blocks': true,
                'Blocks Offered': ['Block 1', 'Block 2', 'Block 3'],
                'Block 1 Start': '2026-06-01',
                'Block 1 End': '2026-06-02',
                'Block 2 Start': '2026-06-03',
                'Block 2 End': '2026-06-04',
                'Block 3 Start': '2026-06-05',
                'Block 3 End': '2026-06-05',
                'Full Price': 2995,
                'Block Price': 1095
              }
            },
            {
              id: 'austin-2026',
              fields: {
                'City': 'Austin',
                'State': 'Texas',
                'Session Start Date': '2026-06-08',
                'Session End Date': '2026-06-12',
                'Venue Name (1)': 'TBD',
                'Has Blocks': true,
                'Blocks Offered': ['Block 1', 'Block 2', 'Block 3'],
                'Block 1 Start': '2026-06-08',
                'Block 1 End': '2026-06-09',
                'Block 2 Start': '2026-06-10',
                'Block 2 End': '2026-06-11',
                'Block 3 Start': '2026-06-12',
                'Block 3 End': '2026-06-12',
                'Full Price': 2995,
                'Block Price': 1095
              }
            },
            {
              id: 'nashville-2026',
              fields: {
                'City': 'Nashville',
                'State': 'Tennessee',
                'Session Start Date': '2026-08-10',
                'Session End Date': '2026-08-14',
                'Venue Name (1)': 'TBD',
                'Has Blocks': true,
                'Blocks Offered': ['Block 1', 'Block 2', 'Block 3'],
                'Block 1 Start': '2026-08-10',
                'Block 1 End': '2026-08-11',
                'Block 2 Start': '2026-08-12',
                'Block 2 End': '2026-08-13',
                'Block 3 Start': '2026-08-14',
                'Block 3 End': '2026-08-14',
                'Full Price': 2995,
                'Block Price': 1095
              }
            },
            {
              id: 'las-vegas-2026',
              fields: {
                'City': 'Las Vegas',
                'State': 'Nevada',
                'Session Start Date': '2026-10-05',
                'Session End Date': '2026-10-09',
                'Venue Name (1)': 'TBD',
                'Has Blocks': true,
                'Blocks Offered': ['Block 1', 'Block 2', 'Block 3'],
                'Block 1 Start': '2026-10-05',
                'Block 1 End': '2026-10-06',
                'Block 2 Start': '2026-10-07',
                'Block 2 End': '2026-10-08',
                'Block 3 Start': '2026-10-09',
                'Block 3 End': '2026-10-09',
                'Full Price': 2995,
                'Block Price': 1095
              }
            }
          ];

          // Render sessions immediately (no async needed)
          (() => {
              if (!list) return;
              if (records.length === 0) { if (empty) empty.classList.remove('hidden'); return; }

              const attNow = computeAttendanceFromUI();
              const isFullSel = attNow.kind === 'full';
              const selBlocks = Array.isArray(attNow.blocks) ? attNow.blocks : [];
              const hasBlocks = !!blockProgramMap[state.program];

              records.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'session-card';
                card.setAttribute('role','radio');
                card.setAttribute('tabindex','0');
                card.dataset.sessionId = rec.id;

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'sessionRadio';
                radio.className = 'session-radio';

                const img = document.createElement('img');
                img.className = 'session-thumb';
                const attachments = rec.fields?.['Hero Image Attachment'];
                if (Array.isArray(attachments) && attachments.length) {
                  const pick = attachments[Math.floor(Math.random() * attachments.length)];
                  img.src = pick?.url || '';
                } else {
                  img.src = '';
                }
                img.alt = 'Session image';
                img.onerror = () => { img.src=''; img.textContent='📍'; };

                const info = document.createElement('div');
                info.className = 'session-info';
                const loc = document.createElement('div');
                const city = rec.fields?.['City'] || ''; const st = rec.fields?.['State'] || '';
                loc.className = 'session-loc';
                loc.textContent = city && st ? `${city}, ${st}` : (city || st || 'Virtual Classroom');
                const dateEl = document.createElement('div');
                dateEl.className = 'session-date';
                if (hasBlocks && !isFullSel && selBlocks.length > 0) {
                  const d = computeDerivedDates(rec, state.program, false, selBlocks);
                  dateEl.textContent = formatHumanRange(d.start, d.end);
                } else {
                  const start = rec.fields?.['Session Start Date'] ? parseAirtableLocal(rec.fields['Session Start Date']) : null;
                  const end = rec.fields?.['Session End Date'] ? parseAirtableLocal(rec.fields['Session End Date']) : null;
                  dateEl.textContent = formatHumanRange(start, end);
                }
                const venueEl = document.createElement('div');
                venueEl.className = 'session-venue';
                venueEl.textContent = rec.fields?.['Venue Name (1)'] || '';

                info.appendChild(loc);
                info.appendChild(dateEl);
                if (venueEl.textContent) info.appendChild(venueEl);

                card.appendChild(radio);
                card.appendChild(img);
                card.appendChild(info);

                // Selection behavior
                function selectThis() {
                  const all = Array.from(document.querySelectorAll('.session-card'));
                  all.forEach(el => { el.dataset.selected = 'false'; const r = el.querySelector('input[type="radio"]'); if (r) r.checked = false; });
                  card.dataset.selected = 'true'; radio.checked = true;
                  state.sessionId = rec.id;
                  // Have record immediately for review/pricing
                  state.sessionRecord = rec;
                  updateReview();
                  updateNextEnabled();
                  // Auto-advance to Step 5 after the standard delay
                  advanceAfterDelay(5);
                  // Ensure full hydration shortly after advancing
                  const delay = (typeof AUTO_ADVANCE_DELAY_MS === 'number' ? AUTO_ADVANCE_DELAY_MS : 300) + 25;
                  setTimeout(() => { try { hydrateSelectedSession(); } catch (e) {} }, delay);
                }
                card.addEventListener('click', selectThis);
                card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectThis(); } });

                list.appendChild(card);
              });
          })(); // End of immediate function
        }
      }
      function setStep(n) {
        state.step = n;
        // Hide/show ALL step cards (covers any duplicates accidentally injected)
        document.querySelectorAll('[id^="step"]').forEach(node => {
          const shouldHide = node.id !== ('step' + n);
          node.classList.toggle('hidden', shouldHide);
          // Force hide with style if class doesn't work
          if (shouldHide) {
            node.style.display = 'none';
          } else {
            node.style.display = '';
          }
        });
        steps.forEach(st => st.dataset.active = st.getAttribute('data-step') === String(n));
        backBtn.classList.toggle('hidden', n === 3); // Start at step 3, so hide back on step 3
        nextBtn.classList.toggle('hidden', n === 6);
        submitBtn.classList.toggle('hidden', n !== 6);
        renderProgress();
        if (n === 2) renderProgressForStep2();
        if (n === 3) { renderProgressForStep3(); syncFullRadio(); }
        if (n === 4) { renderProgressForStep4(); showGlobalMessage(''); prepareStep4(); updateNextEnabled(); }
        if (n === 5) {
          renderProgressForStep5();
          showGlobalMessage('');
          hardResetStep5();
          purgeAttendanceFromStep5();
          clearAllFieldErrors();
          state.showFieldErrors = false;
          updateNextEnabled();
          // Additional cleanup to ensure no attendance elements remain
          setTimeout(() => {
            const s5 = qs('#step5');
            if (s5) {
              s5.querySelectorAll('input[name="attendanceTypeFull"], input[name="attendanceBlocks"], .option-row, #attendanceOptions').forEach(el => el.remove());
            }
          }, 10);
        }
        if (n === 6) {
          renderProgressForStep6();

          // CRITICAL: Ensure step 6 is visible before trying to update
          const step6 = qs('#iamlModalOverlay #step6') || qs('#step6');
          if (step6) {
            step6.classList.remove('hidden');
            step6.style.display = '';
            // Force a reflow to ensure DOM is updated
            void step6.offsetHeight;
          }

          // Wait for DOM to be ready, then update review
            // Use requestAnimationFrame to ensure DOM is painted
          requestAnimationFrame(() => {
            // Double-check step6 is visible
            const step6Check = qs('#iamlModalOverlay #step6') || qs('#step6');
            if (step6Check && !step6Check.classList.contains('hidden')) {
              updateReview();
            }

            // Also retry after a short delay with validation
            setTimeout(() => {
              const step6Retry = qs('#iamlModalOverlay #step6') || qs('#step6');
              const revNameCheck = step6Retry ? step6Retry.querySelector('#revName') : null;

              if (step6Retry && !step6Retry.classList.contains('hidden') && revNameCheck) {
                updateReview();
              }
            }, 200);
          });
        }
        // Always reset scroll to top after switching steps
        scrollContentTop(false);
      }

      function openModal() {
        // Close other modals to prevent conflicts
        const hotelModal = document.getElementById('hotel-modal');
        if (hotelModal && hotelModal.style.display === 'flex') {
          hotelModal.style.display = 'none';
          if (window.hotelModalInstance) {
            window.hotelModalInstance.isOpen = false;
          }
          document.body.style.overflow = ''; // Restore scrolling
        }

        const confirmationOverlay = document.getElementById('confirmationOverlay');
        if (confirmationOverlay && confirmationOverlay.getAttribute('aria-hidden') === 'false') {
          closeConfirmationModal();
        }

        // Preserve form field values before opening modal
        const preservedValues = {
          firstName: firstName?.value || '',
          lastName: lastName?.value || '',
          phone: phone?.value || '',
          email: email?.value || '',
          title: title?.value || '',
          company: company?.value || ''
        };

        modalOverlay.dataset.open = 'true';
        modalOverlay.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        scrollContentTop(false);

        // Load sessions immediately since format and program are pre-filled
        prepareStep4();

        // Restore form field values after modal opens
        setTimeout(() => {
          const s5 = qs('#step5');
          if (s5) {
            s5.querySelectorAll('input[name="attendanceTypeFull"], input[name="attendanceBlocks"], .option-row, #attendanceOptions').forEach(el => el.remove());
          }

          // Restore preserved values using specific modal selectors
          const modalFirstName = qs('#iamlModalOverlay #firstName');
          const modalLastName = qs('#iamlModalOverlay #lastName');
          const modalPhone = qs('#iamlModalOverlay #phone');
          const modalEmail = qs('#iamlModalOverlay #email');
          const modalTitle = qs('#iamlModalOverlay #title');
          const modalCompany = qs('#iamlModalOverlay #company');

          if (modalFirstName && preservedValues.firstName) modalFirstName.value = preservedValues.firstName;
          if (modalLastName && preservedValues.lastName) modalLastName.value = preservedValues.lastName;
          if (modalPhone && preservedValues.phone) modalPhone.value = preservedValues.phone;
          if (modalEmail && preservedValues.email) modalEmail.value = preservedValues.email;
          if (modalTitle && preservedValues.title) modalTitle.value = preservedValues.title;
          if (modalCompany && preservedValues.company) modalCompany.value = preservedValues.company;

        }, 10);
      }

      function clearAllFieldErrors() {
        document.querySelectorAll('#step5 .field-error').forEach(el => el.remove());
      }
      function closeModal() {
        modalOverlay.dataset.open = 'false';
        modalOverlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = ''; // Restore scrolling when modal closes
      }

      function showGlobalMessage(msg, isError = false) {
        globalMsg.textContent = msg || '';
        globalMsg.classList.toggle('text-danger', !!isError);
      }

      // Scroll the modal content to the top whenever steps change/open
      function scrollContentTop(smooth = false) {
        const el = document.querySelector('.iaml-content');
        if (el) el.scrollTo({ top: 0, behavior: smooth ? 'smooth' : 'auto' });
      }

      const AUTO_ADVANCE_DELAY_MS = 300;
      function advanceAfterDelay(stepNumber) {
        window.setTimeout(() => setStep(stepNumber), AUTO_ADVANCE_DELAY_MS);
      }

      function formatCurrency(n) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(n || 0);
      }

      // Utility: does a program support blocks?
      function programHasBlocks(name) {
        // Never allow block selection for On-Demand format
        if (state.format === 'On-Demand') return false;
        return !!blockProgramMap[name];
      }

      // Parse Airtable date strings (YYYY-MM-DD) as local dates (no UTC shift)
      function parseAirtableLocal(s) {
        if (!s) return null;
        const [y, m, d] = String(s).split('-').map(Number);
        return new Date(y, (m || 1) - 1, d || 1);
      }

      // Format a Date to YYYY-MM-DD without timezone side effects
      function formatYMDLocal(date) {
        if (!date) return '';
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      // Format a range; collapse to single date if start==end
      function formatRangeOrSingle(d1, d2) {
        if (!d1 && !d2) return '';
        const sameDay = d1 && d2 && d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        const mmdd = (dt) => `${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')}`;
        if (sameDay) return mmdd(d1);
        if (d1 && d2) return `${mmdd(d1)}–${mmdd(d2)}`;
        return d1 ? mmdd(d1) : mmdd(d2);
      }

      // Human-friendly Month D, YYYY range, collapsing month/year where appropriate
      const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      function formatHumanRange(d1, d2) {
        if (!d1 && !d2) return '';
        const f = (dt, withMonth = true, withYear = true) => {
          const m = MONTHS[dt.getMonth()];
          const d = dt.getDate();
          const y = dt.getFullYear();
          if (withMonth && withYear) return `${m} ${d}, ${y}`;
          if (withMonth && !withYear) return `${m} ${d}`;
          if (!withMonth && withYear) return `${d}, ${y}`;
          return String(d);
        };
        const sameDay = d1 && d2 && d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        if (sameDay) return f(d1, true, true);
        if (d1 && d2) {
          const sameMonth = d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth();
          const sameYear = d1.getFullYear() === d2.getFullYear();
          if (sameMonth) return `${MONTHS[d1.getMonth()]} ${d1.getDate()}–${d2.getDate()}, ${d1.getFullYear()}`;
          if (sameYear) return `${f(d1, true, false)} – ${f(d2, true, true)}`;
          return `${f(d1, true, true)} – ${f(d2, true, true)}`;
        }
        return f(d1 || d2, true, true);
      }

      function formatSessionLabel(rec) {
        const f = rec.fields || {};
        const start = f['Session Start Date'] ? parseAirtableLocal(f['Session Start Date']) : null;
        const end = f['Session End Date'] ? parseAirtableLocal(f['Session End Date']) : null;
        const city = f['City'] || '';
        const state = f['State'] || '';
        const startStr = start ? `${(start.getMonth()+1).toString().padStart(2,'0')}/${start.getDate().toString().padStart(2,'0')}` : '';
        const endStr = end ? `${(end.getMonth()+1).toString().padStart(2,'0')}/${end.getDate().toString().padStart(2,'0')}` : '';
        const range = startStr && endStr ? `${startStr}–${endStr}` : startStr || '';
        const cityState = city && state ? `${city}, ${state}` : (city || state || 'Online');
        return `${range} — ${cityState}`;
      }

      // Return first upcoming session matching City/State (case-insensitive), earliest by start date
      function findUpcomingSessionByCityState(records, city, state) {
        const wantCity = String(city || '').trim().toLowerCase();
        const wantState = String(state || '').trim().toLowerCase();
        if (!wantCity && !wantState) return null;
        const filtered = (records || []).filter(r => {
          const f = r?.fields || {};
          const rc = String(f['City'] || '').trim().toLowerCase();
          const rs = String(f['State'] || '').trim().toLowerCase();
          const end = f['Session End Date'] ? parseAirtableLocal(f['Session End Date']) : null;
          const today = new Date(); today.setHours(0,0,0,0);
          const notEnded = !end || end >= today;
          const cityOk = wantCity ? rc === wantCity : true;
          const stateOk = wantState ? rs === wantState : true;
          return notEnded && cityOk && stateOk;
        }).sort((a,b) => {
          const fa = a?.fields || {}; const fb = b?.fields || {};
          const sa = fa['Session Start Date'] ? parseAirtableLocal(fa['Session Start Date']) : null;
          const sb = fb['Session Start Date'] ? parseAirtableLocal(fb['Session Start Date']) : null;
          if (sa && sb) return sa - sb;
          if (sa && !sb) return -1;
          if (!sa && sb) return 1;
          return 0;
        });
        return filtered[0] || null;
      }

      async function airtableList(tableName, opts = {}) {
        const { filterByFormula, sort = [], maxRecords } = opts;
        const url = new URL(`/api/airtable-programs`);
        url.searchParams.set('table', tableName);
        if (filterByFormula) url.searchParams.set('filterByFormula', filterByFormula);
        if (maxRecords) url.searchParams.set('maxRecords', String(maxRecords));
        (Array.isArray(sort) ? sort : []).forEach((s, i) => {
          if (!s) return;
          if (s.field) url.searchParams.set(`sort[${i}][field]`, s.field);
          if (s.direction) url.searchParams.set(`sort[${i}][direction]`, s.direction);
        });
        const res = await fetch(url.toString());
        if (!res.ok) {
          let detail = '';
          try { detail = await res.text(); } catch {}
          throw new Error(`Airtable error ${res.status}`);
        }
        return res.json();
      }

      // List unique City/State for a given Program + Format (future sessions only)
      async function fetchCitiesForSelection(program, format) {
        if (!program || !format) return [];
        const patt = formatToRegex(format);
        const atProgram = PROGRAM_MAP[program] ?? program;
        const futureFilter = `OR(IS_AFTER({Session End Date}, TODAY()), IS_SAME({Session End Date}, TODAY()))`;
        const filter = `AND({Program}='${atProgram.replace(/'/g, "\\'")}', REGEX_MATCH(LOWER({Format}), '^${patt}$'), ${futureFilter})`;
        const data = await airtableList(TABLE_SESSIONS, {
          filterByFormula: filter,
          maxRecords: 200,
          sort: [{ field: 'Session Start Date', direction: 'asc' }, { field: 'City', direction: 'asc' }]
        });
        const uniq = new Map();
        (data.records || []).forEach(r => {
          const f = r.fields || {};
          const city = String(f['City'] || '').trim();
          const state = String(f['State'] || '').trim();
          if (!city && !state) return;
          const key = `${city.toLowerCase()}||${state.toLowerCase()}`;
          if (!uniq.has(key)) uniq.set(key, { city, state });
        });
        return Array.from(uniq.values());
      }

      // Public API: allow external scripts/buttons to open the modal with preselection
      // window.IAMLRegistration.open({ format, program, city, state })
      function ensureLoaded() {
        return Promise.resolve(true);
      }

      async function apiOpen(opts = {}) {
        try {
          const fmt = String(opts.format || '').trim();
          const prog = String(opts.program || '').trim();
          const city = opts.city || '';
          const state = opts.state || '';

          // Open overlay first so user sees progress
          if (modalOverlay?.dataset.open !== 'true') openModal();

          // Set format UI state
          if (fmt) {
            const r = getFormatRadios().find(x => String(x.value).toLowerCase() === fmt.toLowerCase());
            if (r) { r.checked = true; }
            state.format = fmt;
          }

          // If no program, land on format step
          if (!prog) { setStep(2); return; }

          // Pick program and advance (handles On-Demand/Virtual special cases)
          setStep(2);
          await handleProgramChosen(prog);

          // If City/State provided, try to preselect earliest matching upcoming session
          if (city || state) {
            const patt = formatToRegex(state.format);
            const atProgram = PROGRAM_MAP[prog] ?? prog;
            const futureFilter = `OR(IS_AFTER({Session End Date}, TODAY()), IS_SAME({Session End Date}, TODAY()))`;
            const filter = `AND({Program}='${atProgram.replace(/'/g, "\\'")}', REGEX_MATCH(LOWER({Format}), '^${patt}$'), ${futureFilter})`;
            try {
              const data = await airtableList(TABLE_SESSIONS, {
                filterByFormula: filter,
                maxRecords: 100,
                sort: [{ field: 'Session Start Date', direction: 'asc' }]
              });
              const match = findUpcomingSessionByCityState(data.records || [], city, state);
              if (match) {
                state.sessionId = match.id;
                state.sessionRecord = match;
                state.attendanceType = 'Full'; // ensure Full by default for block programs
                updateReview();
                setStep(5);
                return;
              }
            } catch (e) {}
          }

          // Fallback: show sessions list
          setStep(4);
          // Warm the session dropdown silently so the list populates promptly
          try { await loadSessions(state.program, state.format, { silent: true }); } catch {}
        } catch (e) {
          try { showGlobalMessage('Unable to open registration. Please try again.', true); } catch {}
          // Keep modal open so the user can proceed manually
          if (modalOverlay?.dataset.open !== 'true') {
            try { openModal(); } catch {}
          }
        }
      }

      // Confirmation Modal Functions

      function showContentByFormat(format) {
        // Normalize format
        const normalizedFormat = String(format || 'in-person').toLowerCase().replace(/\s+/g, '-');

        // Get all elements with data-show-if attribute
        const conditionalElements = document.querySelectorAll('[data-show-if]');

        conditionalElements.forEach(element => {
          const showFor = element.getAttribute('data-show-if').split(',').map(f => f.trim().toLowerCase());

          if (showFor.includes(normalizedFormat)) {
            element.classList.add('visible');
            // Set display based on element type
            if (element.classList.contains('detail-row') || element.classList.contains('step-card')) {
              element.style.display = 'flex';
            } else {
              element.style.display = 'block';
            }
          } else {
            element.classList.remove('visible');
            element.style.display = 'none';
          }
        });
      }

      function updateConfirmationFormatBadge(format) {
        const badge = document.getElementById('formatBadgeConf');
        if (!badge) return;

        const formatMap = {
          'in-person': 'IN-PERSON',
          'virtual': 'VIRTUAL',
          'on-demand': 'ON-DEMAND'
        };

        const normalizedFormat = String(format || 'in-person').toLowerCase().replace(/\s+/g, '-');
        badge.textContent = formatMap[normalizedFormat] || 'IN-PERSON';
      }

      function calculateConfirmationInfoSendDate(programStartDate) {
        if (!programStartDate) return 'soon';

        try {
          // Use parseAirtableLocal to avoid timezone issues
          const start = parseAirtableLocal(programStartDate);
          if (!start || isNaN(start.getTime())) return 'soon';

          // Calculate 7 days before
          const infoDate = new Date(start);
          infoDate.setDate(infoDate.getDate() - 7);

          // Format as "Month Day, Year"
          const options = { year: 'numeric', month: 'long', day: 'numeric' };
          return infoDate.toLocaleDateString('en-US', options);
        } catch (e) {
          return 'soon';
        }
      }

      function replaceConfirmationInfoSendDates(format) {
        const normalizedFormat = String(format || 'in-person').toLowerCase().replace(/\s+/g, '-');

        // Only for in-person and virtual
        if (normalizedFormat !== 'in-person' && normalizedFormat !== 'virtual') return;

        // Get start date from state
        const startDate = state.derivedStart ? formatYMDLocal(state.derivedStart) :
                         (state.sessionRecord?.fields?.['Session Start Date'] || null);

        if (!startDate) return;

        const calculatedDate = calculateConfirmationInfoSendDate(startDate);

        // Replace all {{info_send_date}} placeholders
        document.querySelectorAll('.info-date').forEach(el => {
          el.textContent = calculatedDate;
        });
      }

      function populateConfirmationData() {
        // Get form values
        const fn = firstName?.value || '';
        const ln = lastName?.value || '';
        const em = email?.value || '';
        const prog = state.program || 'IAML Attorney Advisory Program';
        const price = formatCurrency(state.amountDue || 0);

        // Populate participant info
        const nameEl = document.getElementById('confName');
        const emailEl = document.getElementById('confEmail');
        const programEl = document.getElementById('confProgram');
        const priceEl = document.getElementById('confPrice');

        if (nameEl) nameEl.textContent = `${fn} ${ln}`.trim() || '—';
        if (emailEl) emailEl.textContent = em || '—';
        if (programEl) programEl.textContent = prog;
        if (priceEl) priceEl.textContent = price;

        // Update subtitle with program name
        const subtitleEl = document.getElementById('confirmationSubtitle');
        if (subtitleEl) {
          subtitleEl.innerHTML = `Your spot in the ${prog} is almost confirmed.<br>See below for next steps to finalize your enrollment.`;
        }

        // Populate dates (for in-person and virtual)
        const datesEl = document.getElementById('confDates');
        if (datesEl && (state.derivedStart || state.derivedEnd)) {
          datesEl.textContent = formatHumanRange(state.derivedStart, state.derivedEnd);
        }

        // Populate location
        const locationEl = document.getElementById('confLocation');
        if (locationEl) {
          if (state.format === 'Virtual') {
            locationEl.textContent = 'Live Virtual Classroom';
          } else if (state.sessionRecord?.fields) {
            const city = state.sessionRecord.fields['City'] || '';
            const stateValue = state.sessionRecord.fields['State'] || '';
            if (city || stateValue) {
              locationEl.textContent = `${city}${city && stateValue ? ', ' : ''}${stateValue}`;
            }
          }
        }
      }

      function showConfirmationModal() {
        try {
          // Close other modals to prevent conflicts
          const iamlModalOverlay = document.getElementById('iamlModalOverlay');
          if (iamlModalOverlay && iamlModalOverlay.dataset.open === 'true') {
            if (typeof window.closeModal === 'function') {
              window.closeModal();
            } else {
              iamlModalOverlay.dataset.open = 'false';
              iamlModalOverlay.setAttribute('aria-hidden', 'true');
            }
          }

          const hotelModal = document.getElementById('hotel-modal');
          if (hotelModal && hotelModal.style.display === 'flex') {
            hotelModal.style.display = 'none';
            if (window.hotelModalInstance) {
              window.hotelModalInstance.isOpen = false;
            }
          }

          // Populate data
          populateConfirmationData();

          // Update format badge
          updateConfirmationFormatBadge(state.format);

          // Show/hide content based on format
          showContentByFormat(state.format);

          // Replace info send dates
          replaceConfirmationInfoSendDates(state.format);

          // Scroll everything to top FIRST (before showing modal)
          window.scrollTo({ top: 0, behavior: 'instant' });
          document.body.style.overflow = 'hidden';

          // Show the overlay
          const overlay = document.getElementById('confirmationOverlay');
          if (overlay) {
            // Reset scroll positions before showing
            overlay.scrollTop = 0;

            // Show the modal
            overlay.setAttribute('aria-hidden', 'false');
            overlay.style.display = 'flex';

            // Force scroll reset after display (double-check)
            requestAnimationFrame(() => {
              window.scrollTo({ top: 0, behavior: 'instant' });
              overlay.scrollTop = 0;

              // Scroll modal content to top
              const modal = overlay.querySelector('.confirmation-modal');
              if (modal) {
                modal.scrollTop = 0;
              }
            });
          }
        } catch (error) {
          // Fallback to old redirect behavior
          const dest = REDIRECTS_BY_FORMAT[state.format] || 'https://www.iaml.com/thank-you';
          window.location.href = dest;
        }
      }

      function closeConfirmationModal() {
        const overlay = document.getElementById('confirmationOverlay');
        if (overlay) {
          overlay.setAttribute('aria-hidden', 'true');
          overlay.style.display = 'none';
        }
        // Only restore scrolling if no other modals are open
        const iamlModal = document.getElementById('iamlModalOverlay');
        const hotelModal = document.getElementById('hotel-modal');
        if ((!iamlModal || iamlModal.dataset.open !== 'true') &&
            (!hotelModal || hotelModal.style.display !== 'flex')) {
          document.body.style.overflow = ''; // Restore scrolling
        }
      }

      // Expose API globally
      try {
        window.IAMLRegistration = window.IAMLRegistration || {};
        window.IAMLRegistration.ensureLoaded = ensureLoaded;
        window.IAMLRegistration.open = apiOpen;
        // Also expose direct access for button integration
        window.openModal = openModal;
        window.state = state;
        window.setStep = setStep;
        window.updateReview = updateReview;
        window.showConfirmationModal = showConfirmationModal;
        window.closeConfirmationModal = closeConfirmationModal;
      } catch {}

      async function airtablePatch(tableName, recordId, fields) {
        const url = `/api/airtable-quiz?table=${encodeURIComponent(tableName)}&recordId=${encodeURIComponent(recordId)}`;
        const res = await fetch(url, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fields }) });
        if (!res.ok) {
          throw new Error(`Airtable PATCH error ${res.status}`);
        }
        return res.json();
      }

      async function findCouponRecordByCode(code) {
        if (!code) return null;
        const safe = code.toLowerCase().replace(/'/g, "\\'");
        const candidates = ['{Coupon Code}', '{Code}'];
        for (const col of candidates) {
          const filter = `LOWER(${col})='${safe}'`;
          try {
            const data = await airtableList(TABLE_COUPONS, { filterByFormula: filter, maxRecords: 1 });
            const rec = (data.records || [])[0];
            if (rec) return rec;
          } catch (e) { /* Error finding coupon record */ }
        }
        return null;
      }

      async function loadSessions(program, format, opts = {}) {
        const { silent = false } = opts;
        if (!silent) {
          if (sessionSelect) sessionSelect.innerHTML = '<option value="" disabled selected>Loading sessions...</option>';
          if (sessionDetails) sessionDetails.textContent = '';
          showGlobalMessage('Loading sessions...');
          globalSpinner.classList.remove('hidden');
        }
        try {
          // Normalize format labels if Airtable uses slightly different labels
          const patt = formatToRegex(format);
          const atProgram = PROGRAM_MAP[program] ?? program;
          // Only sessions that have not ended yet (include those ending today)
          const futureFilter = `OR(IS_AFTER({Session End Date}, TODAY()), IS_SAME({Session End Date}, TODAY()))`;
          const filter = `AND({Program}='${atProgram.replace(/'/g, "\\'")}', REGEX_MATCH(LOWER({Format}), '^${patt}$'), ${futureFilter})`;

          const data = await airtableList(TABLE_SESSIONS, { filterByFormula: filter, maxRecords: 100, sort: [{ field: 'Session Start Date', direction: 'asc' }, { field: 'City', direction: 'asc' }] });
          const records = data.records || [];

          if (!silent) {
            if (sessionCount) sessionCount.textContent = `${records.length} session${records.length===1?'':'s'} available`;
            if (sessionSelect) sessionSelect.innerHTML = '<option value="" disabled selected>Select a session</option>';
          }
          records.forEach(rec => {
            const opt = document.createElement('option');
            opt.value = rec.id;

            const baseLabel = formatSessionLabel(rec);
            const hasBlocks = !!blockProgramMap[state.program];
            const isFullSel = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
            const selBlocks = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];

            if (!silent && hasBlocks && !isFullSel && selBlocks.length > 0) {
              const d = computeDerivedDates(rec, state.program, false, selBlocks);
              const range = formatRangeOrSingle(d.start, d.end);
              const city = rec.fields?.['City'] || '';
              const st = rec.fields?.['State'] || '';
              const cityState = city && st ? `${city}, ${st}` : (city || st || 'Online');
              opt.textContent = range ? `${formatHumanRange(d.start, d.end)} — ${cityState}` : baseLabel;
            } else {
              opt.textContent = baseLabel;
            }

            if (!silent && sessionSelect) sessionSelect.appendChild(opt);
          });
          if (!silent) {
            if (records.length === 0) {
              showGlobalMessage('No upcoming sessions found for this selection.', true);
            } else {
              showGlobalMessage('');
            }
          }
        } catch (err) {
          if (!silent) {
            showGlobalMessage('Unable to load sessions. Please try again.', true);
            if (sessionSelect) sessionSelect.innerHTML = '<option value="" disabled selected>Error loading sessions</option>';
          }
        } finally {
          if (!silent) globalSpinner.classList.add('hidden');
        }
      }

      function configureBlocksForProgram(program, sessionRecord) {
        // Force Full and hide Step 3 entirely for On-Demand
        if (state.format === 'On-Demand') {
          state.attendanceType = 'Full';
          const fr = document.querySelector('input[name="attendanceTypeFull"]');
          if (fr) fr.checked = true;
          qs('#step3')?.classList.add('hidden');
          return;
        }
        const hasBlocksField = sessionRecord?.fields?.['Has Blocks'] === true || sessionRecord?.fields?.['Has Blocks'] === 1;
        const bp = blockProgramMap[program];
        const hasBlocks = !!bp || hasBlocksField;
        block1Option.classList.add('hidden');
        block2Option.classList.add('hidden');
        block3Option.classList.add('hidden');
        if (hasBlocks) {
          const offered = new Set((sessionRecord?.fields?.['Blocks Offered'] || (bp?.blocks || [])).map(String));
          if (offered.has('Block 1')) block1Option.classList.remove('hidden');
          if (offered.has('Block 2')) block2Option.classList.remove('hidden');
          if (offered.has('Block 3')) block3Option.classList.remove('hidden');
          qs('#step3').classList.remove('hidden');
        } else {
          qs('#step3').classList.add('hidden');
          // Force Full if no blocks
          state.attendanceType = 'Full';
          const fullRadio = document.querySelector('input[name="attendanceType"][value="Full"]');
          if (fullRadio) fullRadio.checked = true;
        }
      }

      // Build Step 2 program list based on chosen format.
      async function loadProgramsForFormat(format) {
        const list = qs('#programOptions');
        if (!list) return;
        list.innerHTML = '';
        let programs = [];
        if (format && format !== 'In-Person') {
          try {
            const data = await airtableList(TABLE_SESSIONS, {
              // Accepts hyphen/space variants via regex match
              filterByFormula: `REGEX_MATCH(LOWER({Format}), '^${formatToRegex(format)}$')`,
              maxRecords: 300,
              sort: [{ field: 'Program', direction: 'asc' }]
            });
            const set = new Set(
              (data.records || [])
                .map(r => r?.fields?.['Program'] || r?.fields?.['Program Name'] || r?.fields?.['Program Title'])
                .filter(Boolean)
            );
            programs = Array.from(set);
            // Inject virtual certificate options so users can see and pick them
            if (format === 'Virtual') {
              const inject = [
                'Certificate in Employee Relations Law',
                'Certificate in Strategic HR Management',
                'Certificate in Workplace Investigations'
              ];
              // Compose derived certificate pairs from component sessions (28-day window)
              const sessions = (data.records || []).map(r => ({
                program: r.fields?.['Program'] || r.fields?.['Program Name'] || r.fields?.['Program Title'],
                start: r.fields?.['Session Start Date'] ? parseAirtableLocal(r.fields['Session Start Date']) : null,
                end: r.fields?.['Session End Date'] ? parseAirtableLocal(r.fields['Session End Date']) : null,
              })).filter(s => s.program && s.start);

              function findPairs(p1, p2) {
                const a = sessions.filter(s => s.program === p1).sort((x,y)=>x.start-y.start);
                const b = sessions.filter(s => s.program === p2).sort((x,y)=>x.start-y.start);
                const pairs = [];
                for (const s1 of a) {
                  const matchingS2 = b.filter(t => t.start && (t.start - s1.start) >= 0 && (t.start - s1.start) <= 28*24*60*60*1000);
                  for (const s2 of matchingS2) {
                    pairs.push({
                      components: [
                        { program: p1, start: s1.start, end: s1.end || s1.start },
                        { program: p2, start: s2.start, end: s2.end || s2.start },
                      ],
                      overallStart: s1.start,
                      overallEnd: s2.end || s2.start,
                    });
                  }
                }
                return pairs;
              }

              const pairs = {};
              const cerlPairs = findPairs('Comprehensive Labor Relations', 'Discrimination Prevention & Risk');
              if (cerlPairs.length > 0) {
                pairs['Certificate in Employee Relations Law'] = cerlPairs;
              }
              const shrmPairs = findPairs('HR Law Fundamentals', 'Strategic HR Leadership');
              if (shrmPairs.length > 0) {
                pairs['Certificate in Strategic HR Management'] = shrmPairs;
              }
              // Workplace Investigations is standalone virtual; no pairing required

              state.virtualCertificatePairs = pairs;
              Object.keys(pairs).forEach(name => { if (!programs.includes(name)) programs.push(name); });
              // Reorder: Certificates first, then prioritized topics, then extras
              const secondaries = [
                'Comprehensive Labor Relations',
                'Discrimination Prevention & Risk',
                'HR Law Fundamentals',
                'Strategic HR Leadership',
                'Employment Law Update'
              ];
              const pinned = inject.filter(n => programs.includes(n));
              const remaining = programs.filter(n => !inject.includes(n));
              const orderedSec = secondaries.filter(n => remaining.includes(n));
              const extras = remaining.filter(n => !secondaries.includes(n));
              programs = Array.from(new Set([...pinned, ...orderedSec, ...extras].map(p => (p||'').trim())));
            }
          } catch (e) {
            // Failed to load programs for format
          }
        } else {
          programs = ALLOWED_PROGRAMS.slice();
        }
        // Build radios
        programs = Array.isArray(programs) ? programs : [];
        programs.forEach(name => {
          const label = document.createElement('label'); label.className = 'option-row';
          const input = document.createElement('input'); input.type = 'radio'; input.name = 'program'; input.value = name;
          let span = document.createElement('span'); span.textContent = name;
          // Add badge for certificates (first three)
          if (format === 'Virtual' && (
            name === 'Certificate in Employee Relations Law' ||
            name === 'Certificate in Strategic HR Management' ||
            name === 'Certificate in Workplace Investigations'
          )) {
            const badge = document.createElement('span'); badge.className = 'badge-cert'; badge.textContent = 'Certificate';
            const wrap = document.createElement('span'); wrap.style.display='inline-flex'; wrap.style.alignItems='center'; wrap.appendChild(span); wrap.appendChild(badge);
            span = wrap; // replace
          }
          label.appendChild(input); label.appendChild(span);
          const onPick = async () => await handleProgramChosen(name);
          label.addEventListener('change', onPick); input.addEventListener('change', onPick);
          list.appendChild(label);
        });
      }

      async function generateVirtualCertificatePairs() {
        if (state.format !== 'Virtual') return;

        try {
          const data = await airtableList(TABLE_SESSIONS, {
            filterByFormula: `REGEX_MATCH(LOWER({Format}), '^virtual$')`,
            maxRecords: 300,
            sort: [{ field: 'Program', direction: 'asc' }]
          });

          const sessions = (data.records || []).map(r => ({
            program: r.fields?.['Program'] || r.fields?.['Program Name'] || r.fields?.['Program Title'],
            start: r.fields?.['Session Start Date'] ? parseAirtableLocal(r.fields['Session Start Date']) : null,
            end: r.fields?.['Session End Date'] ? parseAirtableLocal(r.fields['Session End Date']) : null,
          })).filter(s => s.program && s.start);

          function findPairs(p1, p2) {
            const a = sessions.filter(s => s.program === p1).sort((x,y)=>x.start-y.start);
            const b = sessions.filter(s => s.program === p2).sort((x,y)=>x.start-y.start);
            const pairs = [];
            for (const s1 of a) {
              const matchingS2 = b.filter(t => t.start && (t.start - s1.start) >= 0 && (t.start - s1.start) <= 28*24*60*60*1000);
              for (const s2 of matchingS2) {
                pairs.push({
                  components: [
                    { program: p1, start: s1.start, end: s1.end || s1.start },
                    { program: p2, start: s2.start, end: s2.end || s2.start },
                  ],
                  overallStart: s1.start,
                  overallEnd: s2.end || s2.start,
                });
              }
            }
            return pairs;
          }

          const pairs = {};
          const cerlPairs = findPairs('Comprehensive Labor Relations', 'Discrimination Prevention & Risk');
          if (cerlPairs.length > 0) {
            pairs['Certificate in Employee Relations Law'] = cerlPairs;
          }
          const shrmPairs = findPairs('HR Law Fundamentals', 'Strategic HR Leadership');
          if (shrmPairs.length > 0) {
            pairs['Certificate in Strategic HR Management'] = shrmPairs;
          }

          state.virtualCertificatePairs = pairs;
        } catch (e) {
          // Failed to generate virtual certificate pairs
        }
      }

      async function handleProgramChosen(programName) {
        state.program = programName; state.sessionRecord = null;
        const details = document.querySelector('#sessionDetails'); if (details) details.textContent = '';
        configureBlocksForProgram(state.program, null);
        // Skip sessions entirely for On-Demand: go straight to contact (step 5)
        if (state.format === 'On-Demand') {
          state.sessionRecord = {
            id: 'ondemand-' + (PROGRAM_MAP[state.program] || state.program),
            fields: {
              'Program': PROGRAM_MAP[state.program] || state.program,
              'Format': 'On Demand',
              'Program Pricing': getProgramPricing(state.program)?.full || state.basePrice || 0,
              'City': 'Virtual Classroom', 'State': ''
            }
          };
          updateReview();
          setStep(5);
          return;
        }
        // If a virtual certificate is selected, show synthesized pairs on Step 4 (do not skip)
        if (state.format === 'Virtual' && VIRTUAL_CERT_PROGRAMS.has(state.program)) {
          let pairs = state.virtualCertificatePairs?.[state.program];
          if (!pairs || pairs.length === 0) {
            // Generate pairs if not already available
            await generateVirtualCertificatePairs();
            pairs = state.virtualCertificatePairs?.[state.program];
          }
          if (pairs && pairs.length > 0) {
            setStep(4);
            return;
          }
        }
        const hasBlocks = programHasBlocks(state.program);
        const mode = (window.demoLoaderMode || '').toLowerCase();
        if (mode === 'overlay') { preloadSessionsThenAdvance(hasBlocks ? 3 : 4); }
        else { loadSessions(state.program, state.format, { silent: true }); advanceAfterDelay(hasBlocks ? 3 : 4); }
      }

      function computeDerivedDates(sessionRecord, program, isFull, selectedBlocks) {
        const fields = sessionRecord?.fields || {};
        const start = fields['Session Start Date'] ? parseAirtableLocal(fields['Session Start Date']) : null;
        const end = fields['Session End Date'] ? parseAirtableLocal(fields['Session End Date']) : null;
        if (!start || !end) return { start, end };
        const bp = blockProgramMap[program];
        if (!bp || isFull || !Array.isArray(selectedBlocks) || selectedBlocks.length === 0) return { start, end };
        const ranges = selectedBlocks.map(b => bp.ranges?.[b]).filter(Boolean);
        if (ranges.length === 0) return { start, end };
        const minStartOffset = Math.min(...ranges.map(r => r[0]));
        const maxEndOffset = Math.max(...ranges.map(r => r[1]));
        const d1 = new Date(start); d1.setDate(d1.getDate() + minStartOffset);
        const d2 = new Date(start); d2.setDate(d2.getDate() + maxEndOffset);
        return { start: d1, end: d2 };
      }

      function computeAmountDue(basePrice, program, isFull, selectedBlocks) {
        const pricing = getProgramPricing(program);
        const hasBlocks = !!blockProgramMap[program];
        if (pricing) {
          if (!hasBlocks || isFull) return Number(pricing.full || 0);
          const blocks = Array.isArray(selectedBlocks) ? selectedBlocks : [];
          if (pricing.blocks) {
            const sum = blocks.reduce((acc, b) => acc + (Number(pricing.blocks[b]) || 0), 0);
            if (sum > 0) return Math.round(sum * 100) / 100;
          }
        }
        // Fallback to proration if no explicit prices are provided
        const bp = blockProgramMap[program];
        if (!bp || isFull) return basePrice;
        const totalDays = (selectedBlocks || []).map(b => bp.days?.[b] || 0).reduce((a,b)=>a+b,0);
        if (totalDays <= 0) return 0;
        const prorated = basePrice * (totalDays / 5);
        return Math.round(prorated * 100) / 100;
      }

      function updateReview() {
        // For On-Demand format, we might not have a session record, so create a minimal one
        if (!state.sessionRecord && state.format === 'On-Demand') {
          state.sessionRecord = {
            id: 'ondemand-' + (PROGRAM_MAP[state.program] || state.program),
            fields: {
              'Program': PROGRAM_MAP[state.program] || state.program,
              'Format': 'On Demand',
              'Program Pricing': getProgramPricing(state.program)?.full || 0,
              'City': 'Virtual Classroom',
              'State': ''
            }
          };
        }

        if (!state.sessionRecord) {
          // Still try to populate what we can
        }

        const setText = (sel, text) => {
          // Remove # from selector for querySelector if present
          const cleanSel = sel.replace(/^#/, '');

          // Try multiple strategies to find the element
          // Strategy 1: Query within step6 in the modal overlay (most reliable)
          const modalOverlay = qs('#iamlModalOverlay');
          const step6 = modalOverlay ? modalOverlay.querySelector('#step6') : qs('#step6');
          let el = step6 ? step6.querySelector(`#${cleanSel}`) : null;

          // Strategy 2: If not found, try direct query within modal overlay
          if (!el && modalOverlay) {
            el = modalOverlay.querySelector(`#${cleanSel}`);
          }

          // Strategy 3: Fallback to global query
          if (!el) {
            el = qs(sel);
          }

          if (el) {
            // Only set text if it's not empty/null/undefined
            const displayText = (text && String(text).trim()) || '—';

            // Use innerText instead of textContent for better compatibility
            el.innerText = displayText;
            // Also set textContent as backup
            el.textContent = displayText;

            // Force a style recalculation to ensure rendering
            void el.offsetHeight;
          }
        };

        // Always populate contact information - try multiple sources
        // 1. First try state (stored when transitioning from step 5)
        // 2. Then try querying form fields directly
        // 3. Fallback to constants defined at top level
        const modalOverlayForQuery = qs('#iamlModalOverlay');
        const firstNameEl = modalOverlayForQuery?.querySelector('#firstName') || qs('#firstName') || firstName;
        const lastNameEl = modalOverlayForQuery?.querySelector('#lastName') || qs('#lastName') || lastName;
        const titleEl = modalOverlayForQuery?.querySelector('#title') || qs('#title') || title;
        const companyEl = modalOverlayForQuery?.querySelector('#company') || qs('#company') || company;
        const phoneEl = modalOverlayForQuery?.querySelector('#phone') || qs('#phone') || phone;
        const emailEl = modalOverlayForQuery?.querySelector('#email') || qs('#email') || email;

        // Get values: prefer state (stored), then current field value, then empty
        const firstNameVal = state.contactFirstName || firstNameEl?.value || '';
        const lastNameVal = state.contactLastName || lastNameEl?.value || '';
        const titleVal = state.contactTitle || titleEl?.value || '';
        const companyVal = state.contactCompany || companyEl?.value || '';
        const phoneVal = state.contactPhone || phoneEl?.value || '';
        const emailVal = state.contactEmail || emailEl?.value || '';

        const fullName = `${firstNameVal} ${lastNameVal}`.trim();
        setText('#revName', fullName || '—');
        setText('#revCompany', companyVal || '—');
        setText('#revTitle', titleVal || '—');
        // Simple phone formatting (US)
        const phoneDigits = phoneVal.replace(/\D/g,'');
        const phoneFmt = phoneDigits.length === 10 ? `(${phoneDigits.slice(0,3)}) ${phoneDigits.slice(3,6)}-${phoneDigits.slice(6)}` : (phoneVal || '—');
        setText('#revPhone', phoneFmt);
        setText('#revEmail', emailVal || '—');

        // Populate program and format (always available in state)
        setText('#revProgram', state.program);
        setText('#revFormat', state.format);

        // If no sessionRecord, populate what we can and return
        if (!state.sessionRecord) {
          // Still show basic info we have
          const isFull = state.attendanceType === 'Full';
          const attText = isFull ? 'Full Program' : (Array.isArray(state.attendanceBlocks) && state.attendanceBlocks.length ? state.attendanceBlocks.join(', ') : 'TBD');
          setText('#revAttendance', attText);

          // Location and dates - use state values if available
          if (state.city || state.state) {
            const loc = state.city && state.state ? `${state.city}, ${state.state}` : (state.city || state.state || '—');
            setText('#revLocation', loc);
          } else if (state.format === 'Virtual') {
            setText('#revLocation', 'Live Virtual Classroom');
          } else if (state.format === 'On-Demand') {
            setText('#revLocation', 'Online Learning Platform');
          } else {
            setText('#revLocation', '—');
          }

          if (state.format === 'On-Demand') {
            setText('#revDates', 'Available Anytime');
          } else if (state.startDate || state.endDate) {
            // Use dates from state if available
            const start = state.startDate ? (typeof state.startDate === 'string' ? new Date(state.startDate) : state.startDate) : null;
            const end = state.endDate ? (typeof state.endDate === 'string' ? new Date(state.endDate) : state.endDate) : null;
            const human = formatHumanRange(start, end);
            setText('#revDates', human || '—');
          } else {
            setText('#revDates', '—');
          }

          // Calculate pricing with what we have
          const pPricing = getProgramPricing(state.program);
          const base = Number((pPricing && pPricing.full) != null ? pPricing.full : (state.basePrice || 0));
          state.basePrice = base;
          const isFullForCalc = state.attendanceType === 'Full';
          const blocksForCalc = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
          let subtotal = computeAmountDue(base, state.program, isFullForCalc, blocksForCalc);
          const discount = state.couponDiscount || 0;
          const due = Math.max(0, Math.round((subtotal - discount) * 100) / 100);
          state.amountDue = due;

          // Update amount due using scoped query within modal overlay
          const modalOverlayForAmount = qs('#iamlModalOverlay');
          const step6ForAmount = modalOverlayForAmount ? modalOverlayForAmount.querySelector('#step6') : qs('#step6');
          let amountDueElForReview = step6ForAmount ? step6ForAmount.querySelector('#amountDue') : null;
          if (!amountDueElForReview && modalOverlayForAmount) {
            amountDueElForReview = modalOverlayForAmount.querySelector('#amountDue');
          }
          if (!amountDueElForReview) {
            amountDueElForReview = qs('#amountDue');
          }

          if (amountDueElForReview) {
            const formattedAmount = formatCurrency(due);
            amountDueElForReview.textContent = formattedAmount;
            amountDueElForReview.innerText = formattedAmount;
          }

          // Show basic pricing row - use scoped query
          const modalOverlayForRows2 = qs('#iamlModalOverlay');
          const step6ForRows2 = modalOverlayForRows2 ? modalOverlayForRows2.querySelector('#step6') : qs('#step6');
          let rowsHost = step6ForRows2 ? step6ForRows2.querySelector('#revPriceRows') : null;
          if (!rowsHost && modalOverlayForRows2) {
            rowsHost = modalOverlayForRows2.querySelector('#revPriceRows');
          }
          if (!rowsHost) {
            rowsHost = qs('#revPriceRows');
          }

          if (rowsHost) {
            rowsHost.innerHTML = '';
            if (isFullForCalc) {
              if (discount > 0) {
                const row = document.createElement('div');
                row.className = 'row';
                const l = document.createElement('div'); l.className = 'label'; l.textContent = 'Program Price';
                const a = document.createElement('div'); a.className = 'amount'; a.textContent = formatCurrency(base);
                row.appendChild(l); row.appendChild(a); rowsHost.appendChild(row);
              }
            } else if (blocksForCalc.length > 0) {
              const p = getProgramPricing(state.program)?.blocks || {};
              blocksForCalc.forEach(b => {
                const v = Number(p[b] || 0);
                if (v > 0) {
                  const row = document.createElement('div');
                  row.className = 'row';
                  const l = document.createElement('div'); l.className = 'label'; l.textContent = `${b} Price`;
                  const a = document.createElement('div'); a.className = 'amount'; a.textContent = formatCurrency(v);
                  row.appendChild(l); row.appendChild(a); rowsHost.appendChild(row);
                }
              });
            }
          }

          // Discount row - use scoped query like setText does
          const modalOverlayEarly = qs('#iamlModalOverlay');
          const step6Early = modalOverlayEarly ? modalOverlayEarly.querySelector('#step6') : qs('#step6');
          let discountRowEarly = step6Early ? step6Early.querySelector('#revDiscountRow') : null;
          if (!discountRowEarly && modalOverlayEarly) {
            discountRowEarly = modalOverlayEarly.querySelector('#revDiscountRow');
          }
          if (!discountRowEarly) {
            discountRowEarly = qs('#revDiscountRow');
          }

          let discountLabelEarly = step6Early ? step6Early.querySelector('#revDiscountLabel') : null;
          if (!discountLabelEarly && modalOverlayEarly) {
            discountLabelEarly = modalOverlayEarly.querySelector('#revDiscountLabel');
          }
          if (!discountLabelEarly) {
            discountLabelEarly = qs('#revDiscountLabel');
          }

          let discountAmountElEarly = step6Early ? step6Early.querySelector('#revDiscount') : null;
          if (!discountAmountElEarly && modalOverlayEarly) {
            discountAmountElEarly = modalOverlayEarly.querySelector('#revDiscount');
          }
          if (!discountAmountElEarly) {
            discountAmountElEarly = qs('#revDiscount');
          }

          if (discountRowEarly && discountLabelEarly && discountAmountElEarly) {
            if (discount > 0) {
              const couponCodeEl = qs('#iamlModalOverlay #couponCode') || qs('#couponCode');
              const codeTxt = (state.coupon?.fields?.['Coupon Code'] || couponCodeEl?.value?.trim() || '').toUpperCase();
              discountLabelEarly.textContent = codeTxt ? `Discount (${codeTxt})` : 'Discount';
              discountAmountElEarly.textContent = `-${formatCurrency(discount)}`;
              discountRowEarly.classList.remove('hidden');
              discountRowEarly.classList.add('discount');
            } else {
              discountRowEarly.classList.add('hidden');
              discountRowEarly.classList.remove('discount');
              discountLabelEarly.textContent = 'Discount';
              discountAmountElEarly.textContent = '-$0.00';
            }
          }

          return;
        }

        // Full processing with sessionRecord
        const f = state.sessionRecord.fields || {};
        const isFull = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
        const blocks = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
        const derived = computeDerivedDates(state.sessionRecord, state.program, isFull, blocks);
        state.derivedStart = derived.start;
        state.derivedEnd = derived.end;
        const pPricing = getProgramPricing(state.program);
        const base = Number((pPricing && pPricing.full) != null ? pPricing.full : (f['Program Pricing'] || 0));
        state.basePrice = base;
        let subtotal = computeAmountDue(base, state.program, isFull, blocks);
        let upgradeSavings = 0;
        let autoUpgraded = false;
        // Auto-upgrade logic for multiple blocks
        if (!isFull && blocks.length > 1) {
          const prices = (getProgramPricing(state.program)?.blocks) || {};
          const blocksTotal = blocks.reduce((acc, b) => acc + Number(prices[b] || 0), 0);
          if (blocksTotal >= base) {
            autoUpgraded = true;
            upgradeSavings = Math.max(0, blocksTotal - base);
            subtotal = base;
          }
        }
        const discount = state.couponDiscount || 0;
        const due = Math.max(0, Math.round((subtotal - discount) * 100) / 100);
        state.amountDue = due;
        // Populate new review UI
        const loc = f['City'] && f['State'] ? `${f['City']}, ${f['State']}` : (f['City'] || f['State'] || 'Online');
        const human = formatHumanRange(derived.start, derived.end);
        const sessionLabel = formatSessionLabel(state.sessionRecord);
        const attText = isFull ? 'Full Program' : (blocks.join(', ') || 'TBD');

        // Update attendance to reflect auto-upgrade in the summary
        if (autoUpgraded) {
          setText('#revAttendance', 'Full Program (auto-upgraded)');
        } else {
          setText('#revAttendance', attText);
        }
        // Use "Live Virtual Classroom" for Virtual format, otherwise show actual location
        const displayLocation = state.format === 'Virtual' ? 'Live Virtual Classroom' : (state.format === 'On-Demand' ? 'Online Learning Platform' : loc);
        setText('#revLocation', displayLocation);
        // Handle dates display - On-Demand doesn't have specific dates
        if (state.format === 'On-Demand') {
          setText('#revDates', 'Available Anytime');
        } else {
          setText('#revDates', human || '—');
        }

        // Dynamic pricing rows per selection - use scoped query
        const modalOverlayForRows = qs('#iamlModalOverlay');
        const step6ForRows = modalOverlayForRows ? modalOverlayForRows.querySelector('#step6') : qs('#step6');
        let rowsHost = step6ForRows ? step6ForRows.querySelector('#revPriceRows') : null;
        if (!rowsHost && modalOverlayForRows) {
          rowsHost = modalOverlayForRows.querySelector('#revPriceRows');
        }
        if (!rowsHost) {
          rowsHost = qs('#revPriceRows');
        }

        if (rowsHost) {
          rowsHost.innerHTML = '';
          const addRow = (label, amount) => {
            const row = document.createElement('div');
            row.className = 'row';
            const l = document.createElement('div'); l.className = 'label'; l.textContent = label;
            const a = document.createElement('div'); a.className = 'amount'; a.textContent = formatCurrency(amount);
            row.appendChild(l); row.appendChild(a); rowsHost.appendChild(row);
          };
          if (isFull) {
            // Show Program Price only when a discount/coupon applies
            if (discount > 0) addRow('Program Price', base);
          } else if (blocks.length === 1) {
            const blk = blocks[0];
            const blkPrice = Number(getProgramPricing(state.program)?.blocks?.[blk] || 0);
            addRow(`${blk} Price`, blkPrice);
          } else if (blocks.length > 1) {
            const p = getProgramPricing(state.program)?.blocks || {};
            let sum = 0;
            blocks.forEach(b => { const v = Number(p[b] || 0); sum += v; addRow(b, v); });
            addRow('Subtotal', sum);
            if (autoUpgraded) {
              const upRow = document.createElement('div');
              upRow.className = 'row success';
              const l = document.createElement('div'); l.className = 'label'; l.textContent = 'Full Program Upgrade';
              const a = document.createElement('div'); a.className = 'amount'; a.textContent = `-${formatCurrency(upgradeSavings)}`;
              upRow.appendChild(l); upRow.appendChild(a); rowsHost.appendChild(upRow);
              const sub = document.createElement('div'); sub.className = 'sublabel';
              // If we can infer remaining blocks, show them specifically
              const bp = getProgramPricing(state.program)?.blocks || {};
              const allBlocks = Object.keys(bp);
              const remaining = allBlocks.filter(b => !blocks.includes(b));
              const remText = remaining.length ? `✓ Includes ${remaining.join(', ')} at no extra cost` : '✓ Includes remaining blocks at no extra cost';
              sub.textContent = remText;
              rowsHost.appendChild(sub);
            }
          } else {
            addRow('Program Price', base);
          }
        }

        // Discount line - use scoped query like setText does
        const modalOverlay = qs('#iamlModalOverlay');
        const step6 = modalOverlay ? modalOverlay.querySelector('#step6') : qs('#step6');
        let discountRow = step6 ? step6.querySelector('#revDiscountRow') : null;
        if (!discountRow && modalOverlay) {
          discountRow = modalOverlay.querySelector('#revDiscountRow');
        }
        if (!discountRow) {
          discountRow = qs('#revDiscountRow');
        }

        let discountLabel = step6 ? step6.querySelector('#revDiscountLabel') : null;
        if (!discountLabel && modalOverlay) {
          discountLabel = modalOverlay.querySelector('#revDiscountLabel');
        }
        if (!discountLabel) {
          discountLabel = qs('#revDiscountLabel');
        }

        let discountAmountEl = step6 ? step6.querySelector('#revDiscount') : null;
        if (!discountAmountEl && modalOverlay) {
          discountAmountEl = modalOverlay.querySelector('#revDiscount');
        }
        if (!discountAmountEl) {
          discountAmountEl = qs('#revDiscount');
        }

        if (discountRow && discountLabel && discountAmountEl) {
          if (discount > 0) {
            const codeTxt = (state.coupon?.fields?.['Coupon Code'] || couponCode?.value?.trim() || '').toUpperCase();
            discountLabel.textContent = codeTxt ? `Discount (${codeTxt})` : 'Discount';
            discountAmountEl.textContent = `-${formatCurrency(discount)}`;
            discountRow.classList.remove('hidden');
            discountRow.classList.add('discount');
          } else {
            discountRow.classList.add('hidden');
            discountRow.classList.remove('discount');
            discountLabel.textContent = 'Discount';
            discountAmountEl.textContent = '-$0.00';
          }
        }

        // Divider before total always visible
        const preTotal = qs('#preTotalDivider');
        if (preTotal) preTotal.style.display = 'block';

        // Update amount due using scoped query within modal overlay (same strategy as setText)
        const modalOverlayForAmount = qs('#iamlModalOverlay');
        const step6ForAmount = modalOverlayForAmount ? modalOverlayForAmount.querySelector('#step6') : qs('#step6');
        let amountDueElForReview = step6ForAmount ? step6ForAmount.querySelector('#amountDue') : null;
        if (!amountDueElForReview && modalOverlayForAmount) {
          amountDueElForReview = modalOverlayForAmount.querySelector('#amountDue');
        }
        if (!amountDueElForReview) {
          amountDueElForReview = qs('#amountDue');
        }

        if (amountDueElForReview) {
          const formattedAmount = formatCurrency(due);
          amountDueElForReview.textContent = formattedAmount;
          amountDueElForReview.innerText = formattedAmount;
          // Force reflow
          void amountDueElForReview.offsetHeight;
        } else {
          // Retry after a short delay
          setTimeout(() => {
            const modalRetry = qs('#iamlModalOverlay');
            const step6Retry = modalRetry ? modalRetry.querySelector('#step6') : qs('#step6');
            let retryEl = step6Retry ? step6Retry.querySelector('#amountDue') : null;
            if (!retryEl && modalRetry) {
              retryEl = modalRetry.querySelector('#amountDue');
            }
            if (!retryEl) {
              retryEl = qs('#amountDue');
            }
            if (retryEl) {
              const formattedAmount = formatCurrency(due);
              retryEl.textContent = formattedAmount;
              retryEl.innerText = formattedAmount;
            }
          }, 200);
        }

        // Smart savings note visibility
        const upgradeNote = qs('#upgradeNote');
        if (upgradeNote) upgradeNote.style.display = autoUpgraded ? 'block' : 'none';

        // Hide empty KV rows in the Review Summary
        toggleKvRow('#revProgram', !!state.program);
        toggleKvRow('#revFormat', !!state.format);
        toggleKvRow('#revAttendance', !!state.attendanceType);
        const showLoc = !!(f['City'] || f['State'] || state.format === 'On-Demand');
        toggleKvRow('#revLocation', showLoc);
        toggleKvRow('#revDates', !!(state.derivedStart || state.derivedEnd));

        // Always show contact information rows on Step 6, even if empty (matching reference pattern)
        toggleKvRow('#revName', !!(firstNameEl?.value || lastNameEl?.value));
        toggleKvRow('#revCompany', !!companyEl?.value);
        toggleKvRow('#revTitle', !!titleEl?.value);
        toggleKvRow('#revPhone', !!phoneEl?.value);
        toggleKvRow('#revEmail', !!emailEl?.value);
      }

      function validateContact(renderErrors = false) {
        const errs = {};

        const fn = firstName.value.trim();
        const ln = lastName.value.trim();
        const ph = phone.value.replace(/\D/g,'');
        const em = email.value.trim();

        if (fn.length < 2) errs.firstName = '⚠ First name is required';
        if (ln.length < 2) errs.lastName = '⚠ Last name is required';
        if (ph.length !== 10) errs.phone = '⚠ Please enter a valid phone number';
        if (!em || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em)) errs.email = '⚠ Please enter a valid email';

        // Render inline errors only when requested
        if (renderErrors) {
          renderFieldError('#firstName', errs.firstName);
          renderFieldError('#lastName', errs.lastName);
          renderFieldError('#phone', errs.phone);
          renderFieldError('#email', errs.email);
        }
        return Object.keys(errs).length ? 'Invalid form' : '';
      }

      function renderFieldError(selector, msg) {
        const input = qs(selector);
        if (!input) return;
        let err = input.nextElementSibling && input.nextElementSibling.classList?.contains('field-error') ? input.nextElementSibling : null;
        if (!err) {
          err = document.createElement('div');
          err.className = 'field-error';
          input.parentElement.appendChild(err);
        }
        err.textContent = msg || '';
        err.style.display = msg ? 'block' : 'none';
        if (msg) err.style.color = '#EF4444';
        err.style.fontSize = '14px';
        err.style.marginTop = '6px';
      }

      function cityCode(city) { return (city || '').replace(/[^A-Za-z]/g,'').substring(0,2).toUpperCase() || 'XX'; }
      function monthYY(date) { if (!date) return '0000'; const mm = (date.getMonth()+1).toString().padStart(2,'0'); const yy = date.getFullYear().toString().slice(-2); return `${mm}${yy}`; }

      function buildRegistrationCode() {
        const fCode = formatCodeMap[state.format] || 'NA';
        const pInfo = blockProgramMap[state.program];
        const pCode = pInfo?.code || programCodeFallback(state.program);
        const fields = state.sessionRecord?.fields || {};

        // City: only for In-Person
        const cCode = (state.format === 'In-Person')
          ? cityCode(fields['City'] || 'Online')
          : '';

        // Date: only for In-Person and Virtual (not On-Demand)
        const mmyy = (state.format !== 'On-Demand')
          ? monthYY(state.derivedStart || (fields['Session Start Date'] ? parseAirtableLocal(fields['Session Start Date']) : null))
          : '';

        // Attendance: only matters for In-Person (Virtual and On-Demand are always Full)
        const isFull = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
        const blocks = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
        const blockDigits = blocks.map(b => (b.match(/\d+/) || [''])[0]).filter(Boolean).sort().join('');
        const blockCode = isFull ? 'F' : (blockDigits || 'X');

        return `${fCode}-${pCode}${cCode}${mmyy}-${blockCode}`;
      }

      function applyCouponRules(code, program, isFull, blockCount) {
        const upperCode = code.toUpperCase();

        // PP500: $500 off, only valid for full program of specific certificates
        if (upperCode === 'PP500') {
          const allowedPrograms = [
            'Certificate in Employee Relations Law',
            'Certificate in Employee Benefits Law',
            'Certificate in Strategic HR Management'
          ];

          if (!isFull) {
            return { valid: false, reason: 'PP500 is only valid for Full Program registration.' };
          }

          if (!allowedPrograms.includes(program)) {
            return { valid: false, reason: 'PP500 is only valid for Certificate in Employee Relations Law, Employee Benefits Law, or Strategic HR Management.' };
          }

          return { valid: true, code: 'PP500', amount: 500, type: 'Flat' };
        }

        // PP300: $300 off, valid for any full certificate program
        if (upperCode === 'PP300') {
          if (!isFull) {
            return { valid: false, reason: 'PP300 is only valid for Full Program registration.' };
          }

          // Check if program is a certificate program (contains "Certificate")
          if (!program.toLowerCase().includes('certificate')) {
            return { valid: false, reason: 'PP300 is only valid for Certificate programs.' };
          }

          return { valid: true, code: 'PP300', amount: 300, type: 'Flat' };
        }

        // PP100: $100 off, valid for any registration (full or blocks)
        if (upperCode === 'PP100') {
          return { valid: true, code: 'PP100', amount: 100, type: 'Flat' };
        }

        // No special rule matched
        return null;
      }

      async function applyCoupon() {
        // If a coupon is already applied, clicking the button removes it
        if (state.coupon) {
          state.coupon = null;
          state.couponDiscount = 0;
          if (couponMsg) {
            couponMsg.textContent = '';
            couponMsg.classList.remove('text-success', 'text-danger');
          }
          updateCouponUI();
          updateReview();
          return;
        }

        const code = (couponCode?.value || '').trim().slice(0, 20);
        if (!code) {
          if (couponMsg) couponMsg.textContent = 'Enter a coupon code';
          return;
        }

        if (!couponMsg || !couponSpinner || !applyCouponBtn) {
          return;
        }

        couponMsg.textContent = '';
        couponSpinner.classList.remove('hidden');
        applyCouponBtn.disabled = true;
        const prevLabel = applyCouponBtn.textContent;
        applyCouponBtn.textContent = 'Applying...';

        // Check rule-based coupons FIRST (PP500, PP300, PP100) before checking Airtable
        // This ensures they work even if Airtable API is down
        // Check multiple ways to determine if Full Program is selected
        const fullRadio = document.querySelector('input[name="attendanceTypeFull"]');
        const isFullChecked = fullRadio?.checked === true;
        const isFullFromState = state.attendanceType === 'Full' || state.attendanceType === 'F';
        const hasBlocks = Array.isArray(state.attendanceBlocks) && state.attendanceBlocks.length > 0;
        // If no attendance selection UI is visible (e.g., on step 5), default to Full Program
        const noAttendanceUI = !fullRadio && !hasBlocks;
        const isFullNow = isFullChecked || (isFullFromState && !hasBlocks) || noAttendanceUI;

        const blocksNow = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
        const baseForCalc = Number((getProgramPricing(state.program)?.full) ?? (state.basePrice || Number(state.sessionRecord?.fields?.['Program Pricing'] || 0)));
        const subtotal = computeAmountDue(baseForCalc, state.program, isFullNow, blocksNow);
        const ruleCheck = applyCouponRules(code, state.program, isFullNow, blocksNow.length);

        // If it's a rule-based code (PP500, PP300, PP100), handle it immediately
        if (ruleCheck) {
          if (ruleCheck.valid) {
            const amount = Number(ruleCheck.amount || 0);
            const dtype = String(ruleCheck.type || 'Flat');
            const discount = dtype.toLowerCase() === 'percent' ? Math.round(subtotal * (amount/100) * 100)/100 : amount;
            state.coupon = { id: null, fields: { 'Coupon Code': ruleCheck.code } };
            state.couponDiscount = Math.min(discount, subtotal);
            couponMsg.textContent = `✓ Coupon applied! You'll see your discount on the next page.`;
            couponMsg.classList.remove('text-danger'); couponMsg.classList.add('text-success');
            updateCouponUI();
            updateReview();
            couponSpinner.classList.add('hidden');
            applyCouponBtn.disabled = false; applyCouponBtn.textContent = state.coupon ? 'Remove' : prevLabel;
            return;
          } else {
            // Rule-based code but invalid
            couponMsg.textContent = ruleCheck.reason || 'Invalid coupon.';
            couponMsg.classList.remove('text-success');
            couponMsg.classList.add('text-danger');
            state.coupon = null;
            state.couponDiscount = 0;
            updateReview();
            couponSpinner.classList.add('hidden');
            applyCouponBtn.disabled = false; applyCouponBtn.textContent = state.coupon ? 'Remove' : prevLabel;
            return;
          }
        }

        // Not a rule-based code, check Airtable
        try {
          const filter = `LOWER({Coupon Code})='${code.toLowerCase().replace(/'/g, "\\'")}'`;
          const data = await airtableList(TABLE_COUPONS, { filterByFormula: filter, maxRecords: 1 });
          const rec = (data.records || [])[0];
          if (!rec) {
            couponMsg.textContent = 'Invalid coupon.'; couponMsg.classList.remove('text-success'); couponMsg.classList.add('text-danger'); state.coupon = null; state.couponDiscount = 0; updateReview(); return;
          }
          const fields = rec.fields || {};
          // Robust Active flag handling: checkbox, single select, or alt field names
          const activeField =
            fields['Active?'] ??
            fields['Active'] ??
            fields['Is Active'] ??
            fields['active'] ??
            fields['is_active'];
          const activeText = (activeField && typeof activeField === 'object')
            ? (activeField.name ?? activeField.value ?? activeField.label ?? '')
            : activeField;
          const truthy = new Set(['true','yes','active','1','y','enabled','on']);
          const isActive = (activeText === true) || truthy.has(String(activeText).trim().toLowerCase());
          const exp = fields['Expiration Date'] ? new Date(fields['Expiration Date']) : null;
          const today = new Date(); today.setHours(0,0,0,0);
          if (!isActive) { couponMsg.textContent = 'Coupon inactive.'; couponMsg.classList.add('text-danger'); state.coupon = null; state.couponDiscount = 0; updateReview(); return; }
          if (exp && exp < today) { couponMsg.textContent = 'Coupon expired.'; couponMsg.classList.add('text-danger'); state.coupon = null; state.couponDiscount = 0; updateReview(); return; }
          // Validate program applicability if possible
          const applies = couponAppliesToProgram(rec, state.program);
          if (!applies) { couponMsg.textContent = 'Coupon not valid for selected program.'; couponMsg.classList.add('text-danger'); state.coupon = null; state.couponDiscount = 0; updateReview(); return; }
          // Enforce rule overrides (PP500/PP300/PP100)
          const isFullNow = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
          const blocksNow = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
          const baseForCalc = Number((getProgramPricing(state.program)?.full) ?? (state.basePrice || Number(state.sessionRecord?.fields?.['Program Pricing'] || 0)));
          const subtotal = computeAmountDue(baseForCalc, state.program, isFullNow, blocksNow);
          const ruleCheck = applyCouponRules(code, state.program, isFullNow, blocksNow.length);
          let amount = Number(fields['Discount Amount'] || 0);
          let dtype = String(fields['Discount Type'] || 'Flat');
          if (ruleCheck) {
            if (!ruleCheck.valid) { couponMsg.textContent = ruleCheck.reason || 'Coupon not applicable for this selection.'; couponMsg.classList.add('text-danger'); state.coupon = null; state.couponDiscount = 0; updateReview(); return; }
            amount = Number(ruleCheck.amount || amount);
            dtype = String(ruleCheck.type || dtype);
          }
          const discount = dtype.toLowerCase() === 'percent' ? Math.round(subtotal * (amount/100) * 100)/100 : amount;
          state.coupon = rec;
          state.couponDiscount = Math.min(discount, subtotal);
          couponMsg.textContent = `✓ Coupon applied! You'll see your discount on the next page.`;
          couponMsg.classList.remove('text-danger'); couponMsg.classList.add('text-success');
          updateCouponUI();
          updateReview();
        } catch (err) {
          couponMsg.textContent = 'Error validating coupon. Please try again.';
          couponMsg.classList.remove('text-success'); couponMsg.classList.add('text-danger');
          state.coupon = null;
          state.couponDiscount = 0;
          updateCouponUI();
          updateReview();
        } finally {
          couponSpinner.classList.add('hidden');
          applyCouponBtn.disabled = false; applyCouponBtn.textContent = state.coupon ? 'Remove' : prevLabel;
        }
      }

      function updateCouponUI() {
        const applied = !!state.coupon;
        couponCode.disabled = applied;
        applyCouponBtn.textContent = applied ? 'Remove' : 'Apply Coupon';
      }

      function couponAppliesToProgram(couponRecord, programName) {
        const f = couponRecord?.fields || {};
        // Attempt direct check via a possible text/lookup field of program names
        const possibleFields = Object.keys(f).filter(k => /valid program/i.test(k));
        for (const key of possibleFields) {
          const val = f[key];
          if (Array.isArray(val)) {
            // Can be array of names or linked IDs; try names
            if (val.some(v => String(v).toLowerCase().includes(programName.toLowerCase()))) return true;
          } else if (typeof val === 'string') {
            if (val.toLowerCase().includes(programName.toLowerCase())) return true;
          }
        }
        // If we cannot determine, default to true to avoid blocking valid coupons
        return true;
      }

      async function submitRegistration() {
        state.showFieldErrors = true;
        const contactErr = validateContact(true);
        if (contactErr) { showGlobalMessage(contactErr, true); return; }
        showGlobalMessage('Submitting registration...');
        globalSpinner.classList.remove('hidden');
        submitBtn.disabled = true;
        const f = state.sessionRecord?.fields || {};
        const isFullForSubmit = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
        const blocksForSubmit = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
        const derived = computeDerivedDates(state.sessionRecord, state.program, isFullForSubmit, blocksForSubmit);
        const due = state.amountDue;
        const registrationCode = buildRegistrationCode();
        const payload = {
          unique_identifier: crypto.randomUUID(),
          first_name: firstName.value.trim(),
          last_name: lastName.value.trim(),
          title: title.value.trim(),
          company_name: company.value.trim(),
          phone: phone.value.trim(),
          email: email.value.trim(),
          selected_program: state.program,
          program_format: state.format,
          selected_location: (f['City'] && f['State']) ? `${f['City']}, ${f['State']}` : (f['City'] || f['State'] || 'Online'),
          program_start_date: derived.start ? formatYMDLocal(derived.start) : (f['Session Start Date'] || ''),
          program_end_date: derived.end ? formatYMDLocal(derived.end) : (f['Session End Date'] || ''),
          attendance_type__3_block_programs: state.attendanceType === 'F' ? 'Full' : state.attendanceType,
          coupon_code_used: state.coupon ? (state.coupon.fields?.['Coupon Code'] || couponCode.value.trim()) : '',
          discount_amount: Number(state.couponDiscount || 0),
          registration_code: registrationCode,
          amount_due: Number(due || 0),
          tags: ['new_registration'],
        };
        try {
          const res = await fetch('/api/ghl-webhook', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: 'registration', data: payload }) });

          // Get the response text to see what GHL sends back
          const responseText = await res.text();

          if (!res.ok) {
            throw new Error(`Webhook error ${res.status}: ${responseText}`);
          }
          // Increment coupon usage if applicable
          if (state.coupon) {
            try {
              if (state.coupon.id) {
                const currentTimes = Number(state.coupon.fields?.['Times Used'] || 0);
                await airtablePatch(TABLE_COUPONS, state.coupon.id, { 'Times Used': currentTimes + 1 });
              } else {
                // Attempt to find the record by code and increment
                const codeToInc = (state.coupon.fields?.['Coupon Code'] || couponCode.value || '').trim();
                if (codeToInc) {
                  const filter = `LOWER({Coupon Code})='${codeToInc.toLowerCase().replace(/'/g, "\\'")}'`;
                  const data = await airtableList(TABLE_COUPONS, { filterByFormula: filter, maxRecords: 1 });
                  const rec = (data.records || [])[0];
                  if (rec && rec.id) {
                    const currentTimes = Number(rec.fields?.['Times Used'] || 0);
                    await airtablePatch(TABLE_COUPONS, rec.id, { 'Times Used': currentTimes + 1 });
                  }
                }
              }
            } catch (e) { /* Failed to increment coupon usage */ }
          }
          showGlobalMessage('');
          // Close registration modal
          closeModal();
          // Show confirmation modal with delay for smooth transition
          setTimeout(() => {
            showConfirmationModal();
          }, 300);
        } catch (err) {
          // Check if it's a network/CORS error
          if (err.message.includes('Failed to fetch') || err.name === 'TypeError') {
            showGlobalMessage('Network error. Please check your connection and try again.', true);
          } else {
            showGlobalMessage('Submission failed. Please try again.', true);
          }
        } finally {
          globalSpinner.classList.add('hidden');
          submitBtn.disabled = false;
        }
      }

      function onSessionChange(id) {
        state.sessionId = id;
        state.sessionRecord = null;
        state.basePrice = 0;
        // Don't reset coupon discount when session changes - preserve it
        // state.couponDiscount = 0;
        if (discountLine) discountLine.classList.add('hidden');
        if (couponMsg) couponMsg.textContent = '';
      }

      async function hydrateSelectedSession() {
        if (!state.sessionId) return;
        // Bypass Airtable fetch for synthesized sessions (e.g., virtual certificates / on-demand)
        try {
          const sid = String(state.sessionId || '');
          const isSynthetic = sid.startsWith('virtualcert:') || sid.startsWith('ondemand:') || !/^rec/.test(sid);
          if (isSynthetic) {
            const rec = state.sessionRecord || { id: sid, fields: {
              Program: state.program,
              Format: state.format,
              'Program Pricing': getProgramPricing(state.program)?.full || 0,
              City: state.format === 'Virtual' ? 'Online' : (state.sessionRecord?.fields?.City || ''),
              State: state.sessionRecord?.fields?.State || '',
              'Session Start Date': state.sessionRecord?.fields?.['Session Start Date'] || '',
              'Session End Date': state.sessionRecord?.fields?.['Session End Date'] || ''
            } };
            state.sessionRecord = rec;
            const hardBase = getProgramPricing(state.program)?.full;
            const price = Number(hardBase != null ? hardBase : (rec.fields?.['Program Pricing'] || 0));
            state.basePrice = price;
            const detailsEl = qs('#sessionDetails');
            if (detailsEl) {
              const label = formatSessionLabel(rec);
              detailsEl.textContent = `${label} • Base Price ${formatCurrency(price)}`;
            }
            showGlobalMessage('');
            updateReview();
            return;
          }
        } catch (_) { /* fall through to normal fetch */ }
        try {
          showGlobalMessage('Loading session details...');
          globalSpinner.classList.remove('hidden');
          // Use serverless proxy to fetch session details
          const params = new URLSearchParams();
          params.set('table', TABLE_SESSIONS);
          params.set('recordId', state.sessionId);
          const url = `/api/airtable-quiz?${params.toString()}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('Failed to load session details');
          const rec = await res.json();
          state.sessionRecord = rec;
          configureBlocksForProgram(state.program, state.sessionRecord);
          const label = formatSessionLabel(rec);
          const hardBase = getProgramPricing(state.program)?.full;
          const price = Number(hardBase != null ? hardBase : (rec.fields?.['Program Pricing'] || 0));
          state.basePrice = price;
          // Derived date display when blocks are selected (guard for missing details element)
          const isFull = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
          const blocks = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
          const derivedDates = computeDerivedDates(rec, state.program, isFull, blocks);
          const rangeDetails = formatRangeOrSingle(derivedDates.start, derivedDates.end);
          const city = rec.fields?.['City'] || '';
          const st = rec.fields?.['State'] || '';
          const cityState = city && st ? `${city}, ${st}` : (city || st || 'Online');

          const detailsEl = qs('#sessionDetails');
          if (detailsEl) {
            if (!isFull && blocks.length > 0 && rangeDetails) {
              detailsEl.textContent = `${formatHumanRange(derivedDates.start, derivedDates.end)} — ${cityState} • Base Price ${formatCurrency(price)}`;
            } else {
              detailsEl.textContent = `${label} • Base Price ${formatCurrency(price)}`;
            }
          }
          showGlobalMessage('');
          updateReview();
        } catch (err) {
          // Only show error if we're past step 4 (user is actively selecting)
          if (state.step >= 4) {
            showGlobalMessage('Could not load session details.', true);
          }
        } finally {
          globalSpinner.classList.add('hidden');
        }
      }

      function advance() {
        if (state.step === 1) {
          const selectedFormat = (document.querySelector('input[name="format"]:checked')?.value) || (formatSelect ? formatSelect.value : '');
          if (!selectedFormat) { showGlobalMessage('Please select a format.', true); return; }
          state.format = selectedFormat;
          subTitle.textContent = `${state.format} registration`;
          setStep(2);
        } else if (state.step === 2) {
          const selectedProgram = (document.querySelector('input[name="program"]:checked')?.value) || (programSelect ? programSelect.value : '');
          if (!selectedProgram) { showGlobalMessage('Please select a program.', true); return; }
          state.program = selectedProgram;
          showGlobalMessage('');

          // For Virtual and On-Demand formats, skip attendance and session selection, go directly to contact info
          if (state.format === 'Virtual' || state.format === 'On-Demand') {
            // Set attendance to Full automatically
            state.attendanceType = 'Full';
            state.attendanceBlocks = [];

            // Create a synthetic session record
            const pricing = getProgramPricing(state.program);
            state.basePrice = pricing?.full || 2375;
            state.sessionId = `${state.format.toLowerCase().replace('-', '')}:${state.program.replace(/[^a-zA-Z0-9]/g, '')}:${Date.now()}`;
            state.sessionRecord = {
              id: state.sessionId,
              fields: {
                Program: state.program,
                Format: state.format,
                'Program Pricing': state.basePrice,
                City: state.format === 'On-Demand' ? 'Online Learning Platform' : 'Online',
                State: '',
                'Session Start Date': '',
                'Session End Date': ''
              }
            };

            // Skip to Step 5 (contact info)
            setStep(5);
            // Load sessions in background for data purposes
            loadSessions(state.program, state.format, { silent: true });
          } else {
            // Normal flow for In-Person only
            setStep(3);
            configureBlocksForProgram(state.program, null);
            loadSessions(state.program, state.format, { silent: true });
          }
        } else if (state.step === 3) {
          const hasSelection = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || Array.from(document.querySelectorAll('input[name="attendanceBlocks"]')).some(c => c.checked);
          if (!hasSelection) { showGlobalMessage('Please select your attendance preference', true); return; }
          showGlobalMessage('');
          setStep(4);
        } else if (state.step === 4) {
          // Timeline selection: require a selected session card
          if (!state.sessionId) { showGlobalMessage('Please select a session.', true); return; }
          showGlobalMessage('');
          setStep(5);
          // Final cleanup to ensure Step 5 is completely clean
          setTimeout(() => {
            const s5 = qs('#step5');
            if (s5) {
              s5.querySelectorAll('input[name="attendanceTypeFull"], input[name="attendanceBlocks"], .option-row, #attendanceOptions').forEach(el => el.remove());
            }
          }, 50);
          hydrateSelectedSession();
        } else if (state.step === 5) {
          const err = validateContact();
          if (err) { showGlobalMessage(err, true); return; }
          showGlobalMessage('');
          // Store form values in state BEFORE transitioning to step 6
          // This ensures we have the data even if DOM query fails
          const modalOverlayForState = qs('#iamlModalOverlay');
          const firstNameForState = modalOverlayForState?.querySelector('#firstName');
          const lastNameForState = modalOverlayForState?.querySelector('#lastName');
          const titleForState = modalOverlayForState?.querySelector('#title');
          const companyForState = modalOverlayForState?.querySelector('#company');
          const phoneForState = modalOverlayForState?.querySelector('#phone');
          const emailForState = modalOverlayForState?.querySelector('#email');

          // Store in state object for use in updateReview
          if (firstNameForState) state.contactFirstName = firstNameForState.value || '';
          if (lastNameForState) state.contactLastName = lastNameForState.value || '';
          if (titleForState) state.contactTitle = titleForState.value || '';
          if (companyForState) state.contactCompany = companyForState.value || '';
          if (phoneForState) state.contactPhone = phoneForState.value || '';
          if (emailForState) state.contactEmail = emailForState.value || '';

          // Now transition to step 6 - updateReview will be called by setStep(6)
          setStep(6);
        }
      }

      function back() {
        if (state.step > 1) {
          // Special handling: Skip Step 3 and 4 when going back from Step 5 for Virtual and On-Demand
          if (state.step === 5 && (state.format === 'Virtual' || state.format === 'On-Demand')) {
            setStep(2); // Go back to program selection
          } else {
            setStep(state.step - 1);
          }
        }
      }

      // Event listeners

      // Handle all registration buttons using data attributes (new flexible approach)
      document.querySelectorAll('.register-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault(); // Prevent default link behavior

          // Read data attributes from the clicked button
          const section = e.target.dataset.section || 'general';
          const program = e.target.dataset.program || null;
          const format = e.target.dataset.format || null;
          const tracking = e.target.dataset.tracking || 'unknown';
          const sessionId = e.target.dataset.sessionId || null;
          const autoAdvance = e.target.dataset.autoAdvance === 'true';

          // Store in state for tracking and pre-filling
          state.sourceSection = section;
          state.sourceTracking = tracking;

          // Pre-fill format if provided
          if (format) {
            state.format = format;
            subTitle.textContent = `${format} registration`;
            // If autoAdvance is true, we'll skip format selection step
            if (autoAdvance) {
              state.skipFormatStep = true;
            }
          }

          // Pre-select program if provided
          if (program) {
            state.program = program;
          }

          // Pre-select session if provided
          if (sessionId) {
            state.selectedSession = sessionId;
          }

          // Open the modal
          openModal();
        });
      });

      // Backward compatibility: keep support for old #openModalBtn ID
      if (openModalBtn) {
        openModalBtn.addEventListener('click', openModal);
      }

      closeModalBtn.addEventListener('click', closeModal);
      nextBtn.addEventListener('click', advance);
      backBtn.addEventListener('click', back);
      submitBtn.addEventListener('click', submitRegistration);

      // Confirmation modal close button
      const closeConfirmationBtn = document.getElementById('closeConfirmationBtn');
      if (closeConfirmationBtn) {
        closeConfirmationBtn.addEventListener('click', closeConfirmationModal);
      }
      if (formatSelect) formatSelect.addEventListener('change', async () => {
        state.format = formatSelect.value; subTitle.textContent = `${state.format} registration`;
        await loadProgramsForFormat(state.format);
        advanceAfterDelay(2);
      });
      getFormatRadios().forEach(r => r.addEventListener('change', async (e) => {
        state.format = e.target.value; subTitle.textContent = `${state.format} registration`;
        await loadProgramsForFormat(state.format);
        advanceAfterDelay(2);
      }));
      programSelect && programSelect.addEventListener('change', async () => await handleProgramChosen(programSelect.value));
      getProgramRadios().forEach(r => r.addEventListener('change', async () => await handleProgramChosen(r.value)));
      if (sessionSelect) {
        sessionSelect.addEventListener('change', () => { onSessionChange(sessionSelect.value); hydrateSelectedSession(); advanceAfterDelay(5); });
      }
      // Attendance selection logic (Full vs blocks)
      function fullRadio() { return document.querySelector('input[name="attendanceTypeFull"]'); }
      function blockChecks() { return Array.from(document.querySelectorAll('input[name="attendanceBlocks"]')); }
      function computeAttendanceFromUI() {
        if (fullRadio() && fullRadio().checked) return { kind: 'full', blocks: [] };
        const chosen = blockChecks().filter(c => c.checked).map(c => c.value);
        return { kind: chosen.length ? 'blocks' : 'none', blocks: chosen };
      }
      function updateNextEnabled() {
        if (state.step === 3) {
          const hasAttendance = (fullRadio()?.checked) || blockChecks().some(c => c.checked);
          nextBtn.disabled = !hasAttendance;
          return;
        }
        if (state.step === 4) {
          nextBtn.disabled = !state.sessionId;
          return;
        }
        if (state.step === 5) {
          // Only validate if we're actually on step 5 and form is visible
          const step5 = qs('#step5');
          if (step5 && !step5.classList.contains('hidden')) {
            // Disable until contact form is valid (silent check)
            const err = validateContact(false);
            nextBtn.disabled = !!err;
          } else {
            // If step 5 is hidden, don't validate
            nextBtn.disabled = false;
          }
          return;
        }
        nextBtn.disabled = false;
      }
      function onAttendanceChange() {
        const att = computeAttendanceFromUI();
        state.attendanceBlocks = att.blocks;
        state.attendanceType = att.kind === 'full' ? 'Full' : (att.blocks.join(', ') || state.attendanceType);
        syncFullRadio();
        updateReview();
        updateNextEnabled();
      }
      function anyBlockChecked() { return blockChecks().some(c => c.checked); }
      function syncFullRadio() {
        const fr = fullRadio();
        if (!fr) return;
        // Keep full option always enabled; just reflect current checked state
        fr.disabled = false;
        fr.setAttribute('aria-checked', String(!!fr.checked));
      }
      if (fullRadio()) fullRadio().addEventListener('change', (e) => {
        const checked = !!e.target.checked;
        if (checked) {
          // Selecting Full clears any selected blocks but keeps them enabled
          blockChecks().forEach(c => { c.checked = false; c.disabled = false; });
          state.attendanceBlocks = [];
          state.attendanceType = 'Full';
          // Auto-advance to Step 4 (session selection)
          advanceAfterDelay(4);
        }
        syncFullRadio();
        updateReview();
        updateNextEnabled();
        if (state.step === 4) prepareStep4();
      });
      blockChecks().forEach(c => c.addEventListener('change', () => {
        // Selecting any block unchecks Full immediately, but does not disable it
        if (fullRadio()) {
          fullRadio().checked = false;
          fullRadio().removeAttribute('checked');
        }
        const chosen = blockChecks().filter(x => x.checked).map(x => x.value);
        state.attendanceBlocks = chosen;
        state.attendanceType = (chosen.length ? chosen.join(', ') : state.attendanceType);
        syncFullRadio();
        updateReview();
        updateNextEnabled();
        if (state.step === 4) prepareStep4();
      }));
      [firstName, lastName, title, company, phone, email].forEach(el => {
        if (el) {
          el.addEventListener('input', () => {
            // Auto-format phone number
            if (el === phone) {
              const digits = phone.value.replace(/\D/g,'').slice(0,10);
              let out = digits;
              if (digits.length > 6) out = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
              else if (digits.length > 3) out = `(${digits.slice(0,3)}) ${digits.slice(3)}`;
              phone.value = out;
            }
            // Update review in real-time when on step 6, or when preparing for step 6
            if (state.step === 6 || state.step === 5) {
              updateReview();
            }
            if (state.step === 5) updateNextEnabled();
          });
        }
      });
      [firstName, lastName, phone, email].forEach(el => {
        if (el) {
          el.addEventListener('blur', () => {
            if (state.step === 5 && state.showFieldErrors) validateContact(true);
          });
        }
      });
      if (applyCouponBtn) {
        applyCouponBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          applyCoupon();
        });
      }

      // URL Builder interactions
      function toggleBuilder(active) {
        if (urlBuilderPanel) {
          urlBuilderPanel.hidden = !active;
          urlBuilderPanel.dataset.builderActive = String(!!active);
        }
        if (urlBuilderToggle) {
          urlBuilderToggle.classList.toggle('hidden', active);
        }
      }
      if (urlBuilderToggle) {
        urlBuilderToggle.addEventListener('click', () => toggleBuilder(true));
      }

      function ensureModalOpen() {
        if (modalOverlay.dataset.open !== 'true') openModal();
      }

      // Observe step 5 for any unintended attendance injections and purge
      (function observeStep5() {
        const s5 = qs('#step5');
        if (!s5 || !window.MutationObserver) return;
        const mo = new MutationObserver((mutations) => {
          let dirty = false;
          mutations.forEach(m => {
            if ([...m.addedNodes].some(node => node.nodeType === 1 && (
              node.matches?.('#attendanceOptions, .attendance-section, .option-row, #step3, input[name="attendanceTypeFull"], input[name="attendanceBlocks"]') ||
              node.querySelector?.('#attendanceOptions, .attendance-section, .option-row, #step3, input[name="attendanceTypeFull"], input[name="attendanceBlocks"]')
            ))) dirty = true;
          });
          if (dirty) hardResetStep5();
        });
        mo.observe(s5, { childList: true, subtree: true });
      })();

      // Global observer: if any duplicate step nodes are injected, re-apply visibility rules
      (function observeSteps() {
        const root = document.querySelector('.iaml-content');
        if (!root || !window.MutationObserver) return;
        const mo = new MutationObserver((mutations) => {
          let dirty = false;
          mutations.forEach(m => {
            [...m.addedNodes].forEach(node => {
              if (node.nodeType !== 1) return;
              if (/^step[1-6]$/.test(node.id)) dirty = true;
              if (node.querySelector?.('[id^="step"]')) dirty = true;
            });
          });
          if (dirty) {
            document.querySelectorAll('[id^="step"]').forEach(el => {
              el.classList.toggle('hidden', el.id !== ('step' + state.step));
            });
            if (state.step === 5) purgeAttendanceFromStep5?.();
          }
        });
        mo.observe(root, { childList: true, subtree: true });
      })();

      async function syncFormatFromBuilder() {
        const fmt = builderFormat.value;
        builderGenerateUrl();
        if (!fmt) return;
        ensureModalOpen();
        formatSelect.value = fmt;
        state.format = fmt;
        // If program is selected too, load sessions
        if (programSelect.value) {
          await loadSessions(state.program || programSelect.value, fmt);
        }
        setStep(2);
      }

      async function syncProgramFromBuilder() {
        const prog = builderProgram.value;
        builderGenerateUrl();
        if (!prog) return;
        ensureModalOpen();
        programSelect.value = prog;
        state.program = prog;
        // Load sessions for selected format+program
        if (state.format) await loadSessions(prog, state.format);
        setStep(3);
      }

      function syncBlockFromBuilder() {
        const blk = builderBlock.value; // '' | Block 1 | Block 2 | Block 3
        builderGenerateUrl();
        if (!blk) {
          const full = document.querySelector('input[name="attendanceType"][value="Full"]');
          if (full) full.checked = true;
          state.attendanceType = 'Full';
          return;
        }
        const radio = Array.from(document.querySelectorAll('input[name="attendanceType"]')).find(r => r.value.toLowerCase() === blk.toLowerCase());
        if (radio) { radio.checked = true; state.attendanceType = radio.value; }
      }

      async function syncSessionFromBuilder() {
        const sess = builderSession.value;
        builderGenerateUrl();
        if (!sess) return;
        ensureModalOpen();
        // Try to set the session dropdown if option is present
        const opt = Array.from(sessionSelect.options).find(o => o.value === sess);
        if (opt) sessionSelect.value = sess;
        state.sessionId = sess;
        await hydrateSelectedSession();
        setStep(5);
      }

      if (builderFormat) {
        builderFormat.addEventListener('change', () => { builderRefreshSessions(); syncFormatFromBuilder(); });
      }
      if (builderProgram) {
        builderProgram.addEventListener('change', () => { builderRefreshSessions(); syncProgramFromBuilder(); });
      }
      if (builderBlock) {
        builderBlock.addEventListener('change', () => { syncBlockFromBuilder(); });
      }
      if (builderSession) {
        builderSession.addEventListener('change', () => { syncSessionFromBuilder(); });
      }
      if (copyBuilderUrl) {
        copyBuilderUrl.addEventListener('click', async () => {
          try { await navigator.clipboard.writeText(builderUrl.value); builderMsg.textContent = 'Copied!'; } catch { builderMsg.textContent = 'Copy failed'; }
          setTimeout(() => builderMsg.textContent = '', 1200);
        });
      }

      async function builderRefreshSessions() {
        const fmt = builderFormat.value; const prog = builderProgram.value;
        builderSession.innerHTML = '<option value="" disabled selected>Select program + format</option>';
        builderGenerateUrl();
        if (!fmt || !prog) return;
        try {
          const filter = `AND({Program}='${prog.replace(/'/g, "\\'")}', {Format}='${fmt.replace(/'/g, "\\'")}')`;
          const data = await airtableList(TABLE_SESSIONS, { filterByFormula: filter, maxRecords: 100, sort: [{ field: 'Session Start Date', direction: 'asc' }] });
          (data.records || []).forEach(rec => {
            const opt = document.createElement('option');
            opt.value = rec.id;
            opt.textContent = formatSessionLabel(rec);
            builderSession.appendChild(opt);
          });
        } catch (e) { /* Builder sessions load failed */ }
      }

      function builderGenerateUrl() {
        const base = 'https://www.iaml.com/register?register=1';
        const params = new URLSearchParams();
        const fmt = builderFormat.value; const prog = builderProgram.value; const blk = builderBlock.value; const sess = builderSession.value;
        if (prog) params.set('program', prog);
        if (fmt) params.set('format', fmt);
        if (sess) params.set('sessionId', sess);
        if (blk) { params.set('source', 'subprogram'); params.set('subTitle', blk); }
        builderUrl.value = `${base}${params.toString() ? '&' + params.toString() : ''}`;
      }

      // Prefill and auto-advance via query params
      function getQueryParams() {
        const p = new URLSearchParams(window.location.search);
        return {
          register: p.get('register'),
          program: p.get('program'),
          format: p.get('format'),
          sessionId: p.get('sessionId'),
          source: p.get('source'),
          subTitle: p.get('subTitle'),
          builder: p.get('builder'),
          loader: p.get('loader'), // overlay | skeleton | chip
        };
      }
      async function applyPrefill() {
        const qp = getQueryParams();
        // demo loader mode: default to overlay unless overridden via query
        window.demoLoaderMode = qp.loader || 'overlay';
        if (qp.builder === '1') { urlBuilderToggle.classList.remove('hidden'); toggleBuilder(true); }
        else {
          // Remove builder completely unless explicitly requested
          try { urlBuilderPanel?.remove(); } catch {}
          try { urlBuilderToggle?.remove(); } catch {}
        }
        if (qp.register === '1') openModal();
        if (qp.format) {
          if (formatSelect) { formatSelect.value = qp.format; }
          const r = getFormatRadios().find(x => x.value === qp.format);
          if (r) r.checked = true;
          state.format = qp.format;
        }
        if (qp.program && ALLOWED_PROGRAMS.includes(qp.program)) {
          if (programSelect) programSelect.value = qp.program;
          const pr = getProgramRadios().find(x => x.value === qp.program);
          if (pr) pr.checked = true;
          state.program = qp.program;
        }
        if (state.format && state.program) {
          await loadSessions(state.program, state.format);
        }
        if (qp.sessionId) {
          state.sessionId = qp.sessionId;
          // Try to select if present in dropdown; else leave selected but still hydrate
          const opt = Array.from(sessionSelect.options).find(o => o.value === qp.sessionId);
          if (opt) sessionSelect.value = qp.sessionId;
          await hydrateSelectedSession();
        }
        // Respect source/subTitle for blocks
        if (qp.source === 'subprogram' && qp.subTitle && /Block\s+[123]/i.test(qp.subTitle)) {
          const blk = qp.subTitle.match(/Block\s+[123]/i)[0];
          const radio = Array.from(document.querySelectorAll('input[name="attendanceType"]')).find(r => r.value.toLowerCase() === blk.toLowerCase());
          if (radio) { radio.checked = true; state.attendanceType = radio.value; }
        }
        // Auto-advance steps: if we have format+program, go to step 3; if sessionId as well, go to contact step
        if (state.format) setStep(2);
        if (state.format && state.program) setStep(3);
        if (state.sessionId) setStep(5);
        // One-time cleanup: ensure Step 5 doesn't show attendance UI if pre-rendered
        purgeAttendanceFromStep5();
      }

      // Initialize
      setStep(1);
      // Populate allowed programs for modal and (if present) builder
      populateProgramOptions(qs('#programSelect'));
      populateProgramOptions(qs('#builderProgram'));
      populateProgramOptions(codeProg);
      // Initialize virtual certificate pairs for Virtual format
      setTimeout(() => { try { generateVirtualCertificatePairs(); } catch {} }, 0);
      // Initialize Code Builder city list once selections are ready (only if code builder exists)
      setTimeout(() => {
        try {
          if (qs('#codeOutput')) {
            codeBuilderPopulateCities().then(genCodeSnippet);
          }
        } catch {}
      }, 0);

      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
      async function codeBuilderPopulateCities() {
        if (!codeFmt || !codeProg || !codeCity) return;
        const fmt = codeFmt.value;
        const prog = codeProg.value;
        codeCity.innerHTML = '<option value="" disabled selected>Loading…</option>';
        if (!fmt || !prog) { codeCity.innerHTML = '<option value="" disabled selected>Select format and program first</option>'; return; }
        try {
          const list = await fetchCitiesForSelection(prog, fmt);
          if (!list.length) { codeCity.innerHTML = '<option value="" disabled selected>No upcoming locations found</option>'; return; }
          codeCity.innerHTML = '<option value="" disabled selected>Select city/state</option>';
          list.forEach(({ city, state }) => {
            const opt = document.createElement('option');
            opt.value = JSON.stringify({ city, state });
            opt.textContent = city && state ? `${city}, ${state}` : (city || state || 'Online');
            codeCity.appendChild(opt);
          });
        } catch (e) { codeCity.innerHTML = '<option value="" disabled selected>Failed to load locations</option>'; }
      }

      function genCodeSnippet() {
        // Safety check: only run if code builder elements exist
        const codeOutputEl = qs('#codeOutput');
        if (!codeOutputEl) return; // Exit early if code builder not on page

        const fmt = codeFmt?.value || '';
        const prog = codeProg?.value || '';
        let city = codeCity?.value || '';
        let st = codeState?.value || '';
        try { if (city && city.startsWith('{')) { const obj = JSON.parse(city); city = obj.city || ''; st = obj.state || ''; } } catch {}
        const style = codeStyle?.value || 'data';
        const selector = codeSelector?.value || '';
        const modalUrl = 'https://www.iaml.com/assets/iaml-registration-modal.html';
        const loaderUrl = 'https://www.iaml.com/assets/js/iaml-loader.js';
        const scOpen = '<scr' + 'ipt';
        const scClose = '</scr' + 'ipt>';
        if (style === 'data') {
          const attrs = [
            'data-iaml-register',
            fmt ? `data-iaml-format="${escapeHtml(fmt)}"` : '',
            prog ? `data-iaml-program="${escapeHtml(prog)}"` : '',
            city ? `data-iaml-city="${escapeHtml(city)}"` : '',
            st ? `data-iaml-state="${escapeHtml(st)}"` : '',
          ].filter(Boolean).join(' ');
          codeOutputEl.value = `${scOpen} src="${loaderUrl}" data-iaml-modal-url="${modalUrl}" data-iaml-autobind="true">${scClose}\n<!-- Add these attributes to your existing <button> -->\n<!-- ${attrs} -->`;
        } else if (style === 'onclick') {
          const call = `window.IAMLRegistration && IAMLRegistration.open({format:'${escapeHtml(fmt)}',program:'${escapeHtml(prog)}',city:'${escapeHtml(city)}',state:'${escapeHtml(st)}'}); return false;`;
          codeOutputEl.value = `${scOpen} src="${loaderUrl}" data-iaml-modal-url="${modalUrl}">${scClose}\n<!-- Add this onclick to your existing <button> -->\nonclick="${call}"`;
        } else {
          const sel = selector || '#myButtonId';
          const call = `IAMLRegistration.open({format:'${escapeHtml(fmt)}',program:'${escapeHtml(prog)}',city:'${escapeHtml(city)}',state:'${escapeHtml(st)}'});`;
          codeOutputEl.value = `${scOpen} src="${loaderUrl}" data-iaml-modal-url="${modalUrl}">${scClose}\n${scOpen}>\ndocument.querySelector('${escapeHtml(sel)}')?.addEventListener('click', async function(e){ e.preventDefault(); if(window.IAMLLoader){ await IAMLLoader.ensureModalInjected(); } ${call} });\n${scClose}`;
        }
      }

      // Only add event listeners if code builder elements exist
      if (qs('#codeOutput')) {
        [codeFmt, codeProg, codeCity, codeState, codeStyle, codeSelector].forEach(el => el && el.addEventListener('change', genCodeSnippet));
        if (codeFmt) codeFmt.addEventListener('change', () => { codeBuilderPopulateCities().then(genCodeSnippet); });
        if (codeProg) codeProg.addEventListener('change', () => { codeBuilderPopulateCities().then(genCodeSnippet); });
        if (codeCity) codeCity.addEventListener('change', genCodeSnippet);
        if (copyCode) copyCode.addEventListener('click', async () => {
          const codeOutputEl = qs('#codeOutput');
          if (codeOutputEl) {
            try { await navigator.clipboard.writeText(codeOutputEl.value || ''); qs('#codeMsg').textContent = 'Copied!'; } catch { qs('#codeMsg').textContent = 'Copy failed'; }
            setTimeout(() => { const m = qs('#codeMsg'); if (m) m.textContent = ''; }, 1200);
          }
        });
      }
      // Add event listeners to form fields for real-time validation
      [firstName, lastName, phone, email].forEach(field => {
        if (field) {
          field.addEventListener('input', () => {
            // Add a small delay to ensure the value is updated
            setTimeout(updateNextEnabled, 10);
          });
          field.addEventListener('blur', () => {
            setTimeout(updateNextEnabled, 10);
          });
          field.addEventListener('change', () => {
            setTimeout(updateNextEnabled, 10);
          });
        }
      });

      applyPrefill();
      // One-time safety cleanup in case DOM was pre-rendered with attendance under step 5
      hardResetStep5();
      // Render step 2 progress on initial load (hidden until step 2 shows)
      renderProgressForStep2();
      renderProgressForStep3();
    })();
  </script>

    <!-- Faculty Section Styles -->
    <style>
        /* Hero Headline Section Styles */
        .hero-headline-section-attroneys {
            background: #f8fafc;
            padding: 135px 20px 40px;
            text-align: center;
            width: 100vw;
            margin: 0;
            margin-left: calc(-50vw + 50%);
            margin-right: calc(-50vw + 50%);
            box-sizing: border-box;
        }

        .headline-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 48px;
            font-weight: 600;
            color: #1E293B;
            line-height: 1.2;
            text-align: center;
            margin-bottom: 24px;
        }

        .section-subtitle {
            font-family: 'Lato', sans-serif;
            font-size: 19px;
            color: #64748B;
            max-width: 850px;
            line-height: 1.6;
            text-align: center;
            margin: 0 auto;
        }

        /* Faculty Section Styles */
        .faculty-section {
            background: #f8fafc;
            padding: 36px 40px 80px;
            width: 100vw;
            margin: 0;
            margin-left: calc(-50vw + 50%);
            margin-right: calc(-50vw + 50%);
            box-sizing: border-box;
        }

        .faculty-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .faculty-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
            margin-top: 29px;
        }

        /* Faculty Card Styles */
        .faculty-card {
            background: transparent;
            border: none;
            border-radius: 16px;
            box-shadow: none;
            transition: all 0.3s ease;
            overflow: visible;
        }

        .faculty-card:hover {
            transform: translateY(-4px);
        }

        .faculty-card-inner {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Faculty Image Container */
        .faculty-image {
            aspect-ratio: 3 / 2;
            border: none;
            border-radius: 12px;
            background: #f5f5f5;
            overflow: hidden;
            margin: 20px 20px 0 20px;
            box-shadow:
                0 2px 4px rgba(0, 0, 0, 0.04),
                0 8px 16px rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }

        .faculty-card:hover .faculty-image {
            box-shadow:
                0 4px 8px rgba(0, 0, 0, 0.08),
                0 12px 24px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .faculty-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Faculty Content Area */
        .faculty-content {
            padding: 20px 28px 28px 28px;
            display: flex;
            flex-direction: column;
            flex: 1;
            text-align: left;
        }

        .faculty-name {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .faculty-title {
            font-family: 'Lato', sans-serif;
            font-size: 16px;
            font-weight: 500;
            color: #7c3aed;
            margin-bottom: 16px;
        }

        .faculty-bio {
            font-family: 'Lato', sans-serif;
            font-size: 15px;
            color: #374151;
            line-height: 1.6;
            flex: 1;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: calc(1.6em * 3);
        }

        .faculty-link {
            font-family: 'Lato', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #188bf6;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .faculty-link:hover {
            color: #0c5ca8;
        }

        /* Responsive Breakpoints */
        @media (max-width: 1024px) {
            .faculty-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 32px;
            }

            .section-title {
                font-size: 42px;
            }
        }

        @media (max-width: 768px) {
            .faculty-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .section-title {
                font-size: 36px;
            }

            .section-subtitle {
                font-size: 17px;
            }

            .faculty-content {
                padding: 16px 24px 24px 24px;
            }

            .faculty-image {
                margin: 16px 16px 0 16px;
            }

            .hero-headline-section-attroneys {
                padding: 115px 20px 30px;
                width: 100vw;
                margin-left: calc(-50vw + 50%);
                margin-right: calc(-50vw + 50%);
            }

            .faculty-section {
                padding: 24px 20px 60px;
                width: 100vw;
                margin-left: calc(-50vw + 50%);
                margin-right: calc(-50vw + 50%);
            }
        }
    </style>

    <!-- Hero Headline Section -->
    <section class="hero-headline-section-attroneys">
        <div class="headline-content">
            <h1 class="section-title">Practicing Attorneys, Not Academics</h1>
            <p class="section-subtitle">Learn from employment law attorneys who practice what they teach. Your instructors actively handle union campaigns, defend discrimination charges, and win employment law cases - then share exactly what works in real courtrooms and workplaces.</p>
        </div>
    </section>

    <!-- Faculty Section -->
    <section class="faculty-section">
        <div class="faculty-container">
            <div class="faculty-grid">
                <!-- Card 1 - Ray Deeny, Esq. -->
                <article class="faculty-card">
                    <div class="faculty-card-inner">
                        <div class="faculty-image">
                            <img src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/690667eb6947d86fd7edcc6f.svg" alt="Ray Deeny, Esq.">
                        </div>
                        <div class="faculty-content">
                            <h3 class="faculty-name">Ray Deeny, Esq.</h3>
                            <p class="faculty-title">Partner at Taft Stettinius & Hollister LLP</p>
                            <p class="faculty-bio">Ray is widely regarded as a dean of labor and employment law, known for his encyclopedic knowledge and unmatched command of workplace regulations. For over 40 years, he has represented management nationwide, blending a powerhouse advisory practice with a formidable litigation record.</p>
                            <a href="https://crm.re-vitalized.com/v2/preview/tsCH77tyXdISzhZMCnT5?notrack=true#ray-deeny-esq" class="faculty-link">Read Ray's full bio →</a>
                        </div>
                    </div>
                </article>

                <!-- Card 2 - John F. Wymer, III, Esq. -->
                <article class="faculty-card">
                    <div class="faculty-card-inner">
                        <div class="faculty-image">
                            <img src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/690667ebba45f28666768ce6.svg" alt="John F. Wymer, III, Esq.">
                        </div>
                        <div class="faculty-content">
                            <h3 class="faculty-name">John F. Wymer, III, Esq.</h3>
                            <p class="faculty-title">Partner, Labor & Employment at Thompson Hine LLP</p>
                            <p class="faculty-bio">John F. Wymer is a nationally recognized labor and employment attorney and partner in Thompson Hine LLP's Labor & Employment group. With decades of experience, he represents public and private sector employers nationwide in employment discrimination, wage-and-hour, labor negotiations, union matters, ERISA claims, and more.</p>
                            <a href="https://crm.re-vitalized.com/v2/preview/tsCH77tyXdISzhZMCnT5?notrack=true#john-f-wymer-iii-esq" class="faculty-link">Read John's full bio →</a>
                        </div>
                    </div>
                </article>

                <!-- Card 3 - Wayne W. Williams, Esq. -->
                <article class="faculty-card">
                    <div class="faculty-card-inner">
                        <div class="faculty-image">
                            <img src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/690667ebe98d66054ecb05fb.svg" alt="Wayne W. Williams, Esq.">
                        </div>
                        <div class="faculty-content">
                            <h3 class="faculty-name">Wayne W. Williams, Esq.</h3>
                            <p class="faculty-title">Founder, Law Offices of Wayne W. Williams</p>
                            <p class="faculty-bio">Wayne Williams is a distinguished employment and labor law attorney based in Colorado Springs. As the founder of his own firm, he advises and represents employers on a wide range of issues including employment discrimination, harassment, wrongful discharge, wage and hour compliance, and traditional labor law.</p>
                            <a href="https://crm.re-vitalized.com/v2/preview/tsCH77tyXdISzhZMCnT5?notrack=true#wayne-w-williams-esq" class="faculty-link">Read Wayne's full bio →</a>
                        </div>
                    </div>
                </article>

                <!-- Card 4 - Dawn R. Kubik, Esq. -->
                <article class="faculty-card">
                    <div class="faculty-card-inner">
                        <div class="faculty-image">
                            <img src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/690667ebe98d665980cb05f7.svg" alt="Dawn R. Kubik, Esq.">
                        </div>
                        <div class="faculty-content">
                            <h3 class="faculty-name">Dawn R. Kubik, Esq.</h3>
                            <p class="faculty-title">Of Counsel, Kubik Workplace & Investigative Services</p>
                            <p class="faculty-bio">Dawn Kubik is an employment attorney and founder of Kubik Workplace and Investigative Services and Dawn R. Kubik, P.C. With a legal career spanning since 1997, she has represented both plaintiffs and defendants in employment, personal injury, contract, and insurance disputes, earning a reputation as a strategic, well-prepared, and highly communicative advocate.</p>
                            <a href="https://crm.re-vitalized.com/v2/preview/tsCH77tyXdISzhZMCnT5?notrack=true#dawn-r-kubik-esq" class="faculty-link">Read Dawn's full bio →</a>
                        </div>
                    </div>
                </article>

                <!-- Card 5 - Patrick Scully -->
                <article class="faculty-card">
                    <div class="faculty-card-inner">
                        <div class="faculty-image">
                            <img src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/690667ebd086b27752e18e31.svg" alt="Patrick Scully">
                        </div>
                        <div class="faculty-content">
                            <h3 class="faculty-name">Patrick Scully, Esq.</h3>
                            <p class="faculty-title">Partner at Foley Hoag</p>
                            <p class="faculty-bio">Patrick Scully primarily focuses on labor law issues and helps clients successfully navigate complex and persistent claims from international and local labor unions. Patrick's work includes unfair labor practice charges and representation cases as well as federal and state court litigation. He frequently advises employers in collective bargaining negotiations and handles labor arbitration.</p>
                            <a href="https://crm.re-vitalized.com/v2/preview/tsCH77tyXdISzhZMCnT5?notrack=true#patrick-scully" class="faculty-link">Read Patrick's full bio →</a>
                        </div>
                    </div>
                </article>

                <!-- Card 6 - Rudi S. Turner, Esq. -->
                <article class="faculty-card">
                    <div class="faculty-card-inner">
                        <div class="faculty-image">
                            <img src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/690e22920269a38b86c905cb.svg" alt="Rudi S. Turner, Esq.">
                        </div>
                        <div class="faculty-content">
                            <h3 class="faculty-name">Rudi S. Turner, Esq.</h3>
                            <p class="faculty-title">Senior Corporate Counsel, White Cap</p>
                            <p class="faculty-bio">Rudi is Senior In-House Counsel at White Cap, where she counsels and defends the organization as it responds to administrative agency complaints, potential litigation, and employee lawsuits. Drawing on extensive experience in labor and employment law, she supports leaders and HR professionals in navigating complex workplace issues.</p>
                            <a href="#" class="faculty-link">Read Rudi's full bio →</a>
                        </div>
                    </div>
                </article>

                <!-- Card 7 - Jacqueline E. Kalk, Esq. -->
                <article class="faculty-card">
                    <div class="faculty-card-inner">
                        <div class="faculty-image">
                            <img src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/690e254f27678e7871e709c4.svg" alt="Jacqueline E. Kalk, Esq.">
                        </div>
                        <div class="faculty-content">
                            <h3 class="faculty-name">Jacqueline E. Kalk, Esq.</h3>
                            <p class="faculty-title">Shareholder at Littler Mendelson P.C.</p>
                            <p class="faculty-bio">Jacqueline E. Kalk represents and advises management across industries including manufacturing, construction, crowd-sourcing, and virtual companies. She focuses on independent contractor classification, wage-and-hour compliance, equal pay, and employment litigation, defending clients in state and federal courts.</p>
                            <a href="#" class="faculty-link">Read Jacqueline's full bio →</a>
                        </div>
                    </div>
                </article>

                <!-- Card 8 - Grant S. Gibeau -->
                <article class="faculty-card">
                    <div class="faculty-card-inner">
                        <div class="faculty-image">
                            <img src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/690e229c43570019cba3b51f.svg" alt="Grant S. Gibeau">
                        </div>
                        <div class="faculty-content">
                            <h3 class="faculty-name">Grant S. Gibeau</h3>
                            <p class="faculty-title">Partner at Taft Stettinius & Hollister LLP</p>
                            <p class="faculty-bio">Grant Gibeau is a partner in Taft's Minneapolis Employment and Labor Relations practice group. Grant's practice primarily focuses on helping employers navigate all aspects of the employment relationship, from identifying workplace best practices and policies, drafting employee handbooks, and vigorously defending against claims.</p>
                            <a href="#" class="faculty-link">Read Grant's full bio →</a>
                        </div>
                    </div>
                </article>

                <!-- Card 9 - Amy J. Zdravecky, Esq. -->
                <article class="faculty-card">
                    <div class="faculty-card-inner">
                        <div class="faculty-image">
                            <img src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/690e22acc87c0f45146d61fd.svg" alt="Amy J. Zdravecky, Esq.">
                        </div>
                        <div class="faculty-content">
                            <h3 class="faculty-name">Amy J. Zdravecky, Esq.</h3>
                            <p class="faculty-title">Partner at Barnes & Thornburg LLP</p>
                            <p class="faculty-bio">Amy represents employers across industries including retail, hospitality, manufacturing, transportation, and healthcare. She advises on employee relations, union avoidance, collective bargaining, harassment prevention, and compliance with key employment laws like Title VII, ADA, ADEA, FMLA, and FCRA.</p>
                            <a href="#" class="faculty-link">Read Amy's full bio →</a>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </section>

    <!-- Support Continuum Section -->

       <!-- Pre-Program Benefits Section -->
       <section class="benefit-steps-section theme-light py-5xl" style="padding-top: 112px; padding-bottom: 112px;">
        <div class="container mx-auto">
          <section class="benefit-steps" id="benefitSteps">
            <p class="benefit-steps__included-note">
              ✨ Exclusive Attendee Benefits
            </p>
            <div class="benefit-steps__grid">
              <ul class="benefit-steps__list">
                <div class="benefit-steps__rail">
                  <div class="benefit-steps__rail-progress"></div>
                </div>
                <li class="benefit-steps__item benefit-steps__item--active">
                  <span class="benefit-steps__dot" aria-hidden="true"></span>
                  <h3 class="benefit-steps__title">Pre-Program Consultation</h3>
                  <p class="benefit-steps__text">
                    Identify your priorities and customize your learning focus before day one.
                  </p>
                </li>
                <li class="benefit-steps__item">
                  <span class="benefit-steps__dot" aria-hidden="true"></span>
                  <h3 class="benefit-steps__title">Professional Credits</h3>
                  <p class="benefit-steps__text">
                    Earn 35.75 SHRM/HRCI/CLE credits—more than most HR professionals earn in two years.
                  </p>
                </li>
                <li class="benefit-steps__item">
                  <span class="benefit-steps__dot" aria-hidden="true"></span>
                  <h3 class="benefit-steps__title">Ongoing Development</h3>
                  <p class="benefit-steps__text">
                    12 months of quarterly employment law updates keep you current as regulations change.
                  </p>
                </li>
                <li class="benefit-steps__item">
                  <span class="benefit-steps__dot" aria-hidden="true"></span>
                  <h3 class="benefit-steps__title">Alumni Advantages</h3>
                  <p class="benefit-steps__text">
                    $300-$500 off all future programs—for you and every colleague you refer.
                  </p>
                </li>
              </ul>

              <div class="benefit-steps__visual" aria-hidden="true">
                <img class="benefit-steps__visual-img" src="https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/6939b7fef6cae945d6e4077d.svg" alt="Program visual">
              </div>

              <div class="benefit-steps__mobile-summary">
                <h4>Pre-Program Consultation</h4>
                <p>Identify your priorities and customize your learning focus before day one.</p>
              </div>
            </div>
          </section>
        </div>
      </section>

    <!-- Load Support Continuum JavaScript -->
    <script src="../js/supportContinuum.js"></script>

    <!-- FAQ Section -->
    <section class="faq-section full-width-section">
      <div class="faq-container">
        <div class="faq-grid">
          <div class="faq-header">
            <h2 class="faq-title">Quick Answers</h2>
            <p class="faq-subtitle">We know you're busy. Here's what you actually need to know.</p>
          </div>

          <div class="faq-list">
                <!-- FAQ 1 -->
                <div class="faq-item active">
                    <button class="faq-question">
                        Can I attend just one or two blocks instead of the full program?
                        <svg class="faq-chevron" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Yes. While most participants get the best value from the complete 4½-day program, you can register for individual blocks based on your immediate needs. Block I (Labor Relations) and Block II (Discrimination Law) are each $1,375 individually, while Block III (Special Issues) is $575. The full program at $2,375 saves you $1,000 versus purchasing all blocks separately.
                        </div>
                    </div>
                </div>

                <!-- FAQ 2 -->
                <div class="faq-item">
                    <button class="faq-question">
                        What's the difference between in-person, virtual, and on-demand formats?
                        <svg class="faq-chevron" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            All three formats feature the same practicing attorney instructors, current content, and professional credits. In-person provides face-to-face networking and immediate interaction. Virtual delivers the same live instruction via Zoom with full Q&A capability. On-demand lets you learn at your own pace over 90 days with the ability to pause and revisit complex topics. Choose the format that fits your schedule and learning style—the quality and content remain identical.
                        </div>
                    </div>
                </div>

                <!-- FAQ 3 -->
                <div class="faq-item">
                    <button class="faq-question">
                        What happens after I register?
                        <svg class="faq-chevron" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Within minutes, you'll receive an invoice email. Once payment is processed, you can schedule your complimentary pre-program consultation (10-15 minutes) to discuss your specific workplace challenges and identify which program content will have the biggest impact for you. Pre-program materials arrive one week before your session starts.
                        </div>
                    </div>
                </div>

                <!-- FAQ 4 -->
                <div class="faq-item">
                    <button class="faq-question">
                        What continuing education credits will I earn?
                        <svg class="faq-chevron" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            The complete program provides 29.75 SHRM/HRCI/CLE credits. Plus, your enrollment includes 12 months of quarterly employment law updates (4 sessions × 1.5 credits each = 6 additional credits), bringing your total to 35.75 credits—typically more than HR professionals earn in two years.
                        </div>
                    </div>
                </div>

                <!-- FAQ 5 -->
                <div class="faq-item">
                    <button class="faq-question">
                        How do I claim my credits with SHRM or HRCI?
                        <svg class="faq-chevron" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            IAML is an approved provider for both SHRM and HRCI. We provide you with documentation at the end of your program that includes all information needed to self-report your credits. For SHRM, you'll receive a completion certificate with our provider ID. For HRCI, you'll get the documentation to submit credits directly to HRCI. We walk you through the process during the program.
                        </div>
                    </div>
                </div>

                <!-- FAQ 6 -->
                <div class="faq-item">
                    <button class="faq-question">
                        How current is the content? When was it last updated?
                        <svg class="faq-chevron" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Your materials are living resources that update continuously as employment law changes. Unlike static textbooks that become outdated immediately after publication, our content reflects current court decisions, regulatory changes, and compliance requirements. Recent updates include the NLRB's Cemex decision on organizing, the Stericycle handbook standards, post-Bostock LGBTQ+ protections, and state-specific AI hiring regulations.
                        </div>
                    </div>
                </div>

                <!-- FAQ 8 -->
                <div class="faq-item">
                    <button class="faq-question">
                        Why do you emphasize "practicing attorneys, not academics"?
                        <svg class="faq-chevron" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Your instructors handle employment law cases, defend discrimination charges, and advise employers on these exact issues daily. They're not teaching from textbooks—they're sharing strategies that work in actual courtrooms and real workplaces. When you ask "what do I do about [specific situation]," they answer from direct experience, not theory.
                        </div>
                    </div>
                </div>
                <!-- FAQ 10 -->
                <div class="faq-item">
                    <button class="faq-question">
                        What are the quarterly employment law updates, and how long do I have access?
                        <svg class="faq-chevron" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Every program enrollment includes FREE access to all four quarterly 90-minute update sessions for 12 months (valued at $1,588). These instructor-led sessions cover new regulations, court decisions, and compliance changes—delivered mid-January, April, July, and October. Each session is recorded and available within 24 hours. After your first year, you can continue receiving updates at alumni pricing.
                        </div>
                    </div>
                </div>

                <!-- FAQ 11 (Final) -->
                <div class="faq-item">
                    <button class="faq-question">
                        Does the $2,375 program fee include everything?
                        <svg class="faq-chevron" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Yes. Your enrollment includes all live instruction, complete program materials, 29.75 continuing education credits, pre-program consultation, 12 months of quarterly employment law updates (4 sessions, $1,588 value), permanent access to living resources, and alumni benefits for all future programs. There are no hidden fees or additional charges.
                        </div>
                    </div>
                </div>

          </div>
        </div>
      </div>
    </section>

    <!-- Load FAQ JavaScript -->
    <script src="../js/faq.js"></script>

    <!-- Final CTA Section -->
    <section id="iaml-cta" class="theme-light py-5xl">
      <div class="container container-lg mx-auto text-center">
        <div class="mx-auto">
          <h2 class="font-body text-display-lg text-primary font-light tracking-tight">
            Experience the
            <span class="cta-cascade font-display text-hero text-brand">Professional's Choice in Training</span>
          </h2>

          <p class="font-body text-large text-secondary my-lg">
            Real-world expertise. Guaranteed results. Trusted since 1979.
          </p>

          <div class="cta-button-group">
            <button class="btn btn-primary hover-lift" onclick="connectPopup_open()">
              LET'S TALK
            </button>
            <a href="#all-programs" class="btn btn-register hover-lift">
              REGISTER NOW
            </a>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- ===== FOOTER ===== -->
  <!-- Footer placeholder (loaded by components.js) -->
  <div id="footer-placeholder"></div>

  <!-- ===== MODALS ===== -->

  <!-- Connect Modal -->
  <div class="connectPopup-overlay" id="connectPopup_Modal" onclick="connectPopup_closeOnOverlay(event)">
    <div class="connectPopup-modal" onclick="event.stopPropagation();">
      <div class="connectPopup-header">
        <h3>Connect with Us in 20 Seconds or Less</h3>
        <button class="connectPopup-closeBtn" onclick="connectPopup_close()" aria-label="Close">&times;</button>
      </div>
      <div class="connectPopup-body" id="connectPopup_Content">
        <!-- Dynamic content -->
      </div>
    </div>
  </div>

  <!-- ===== JAVASCRIPT ===== -->

  <!-- Dynamic Component Loading -->
  <script src="../js/components.js" defer></script>
  <script src="../js/headerBehavior.js" defer></script>
  <script src="../js/mobileMenu.js" defer></script>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js" defer></script>

  <!-- Your JavaScript Files -->
  <script src="../js/modals.js" defer></script>
  <script src="../js/main.js" defer></script>

  <!-- Next Program Card Component -->
  <script>
    // Next Program Card Component JavaScript

    // Configuration
    const NEXT_PROGRAM_CONFIG = {
      tableId: 'tblympiL1p6PmQz9i',
      viewId: 'viwX4En7WerGZSPCO'
    };

    // Timezone-neutral date parsing to avoid date shifting issues
    function parseTimezoneNeutralDate(dateString) {
      if (!dateString) return null;

      // Parse date as YYYY-MM-DD and create date in local timezone at noon
      // This prevents timezone shifts from changing the date
      const [year, month, day] = dateString.split('-').map(Number);
      const date = new Date(year, month - 1, day, 12, 0, 0, 0);

      // Set to midnight for comparison purposes
      date.setHours(0, 0, 0, 0);
      return date;
    }

    // Fetch next program from Airtable via proxy
    async function fetchNextProgram() {
      try {
        const url = `/api/airtable-programs?table=${encodeURIComponent(NEXT_PROGRAM_CONFIG.tableId)}&view=${encodeURIComponent(NEXT_PROGRAM_CONFIG.viewId)}&maxRecords=1`;

        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          console.error('API Response Error:', response.status, response.statusText);
          throw new Error(`Failed to fetch data: ${response.status}`);
        }

        const data = await response.json();
        console.log('Fetched data:', data); // Debug log
        console.log('Full API response:', data);  // Log entire response
        console.log('Is data.records an array?', Array.isArray(data.records));
        console.log('data.records value:', data.records);

        // Ensure records is an array
        const records = data.records || data || [];
        const nextProgram = findNextProgram(Array.isArray(records) ? records : []);

        if (nextProgram) {
          console.log('Found next program:', nextProgram); // Debug log
          generateNextProgramCard(nextProgram);
        } else {
          console.log('No upcoming programs found'); // Debug log
          console.warn('⚠️ Check Airtable view viwX4En7WerGZSPCO contains "Certificate in Employee Relations Law" programs');

          // Show friendly message instead of hiding
          document.getElementById('nextProgramCard').innerHTML = `
            <div style="padding: 40px; text-align: center; color: #666; background: #f5f5f5; border-radius: 8px;">
              <p style="margin: 0; font-size: 16px;">Next program dates coming soon!</p>
              <p style="margin: 10px 0 0 0; font-size: 14px;">Check back shortly for upcoming sessions.</p>
            </div>
          `;
        }

      } catch (error) {
        console.error('Error fetching next program:', error);
        console.error('Error details:', error.message);

        // Show error message instead of hiding
        document.getElementById('nextProgramCard').innerHTML = `
          <div style="padding: 40px; text-align: center; color: #999; background: #f5f5f5; border-radius: 8px;">
            <p style="margin: 0; font-size: 16px;">Unable to load programs</p>
            <p style="margin: 10px 0 0 0; font-size: 14px;">Please try refreshing the page.</p>
          </div>
        `;
      }
    }

    // Find the next upcoming Certificate in Employee Relations Law program
    function findNextProgram(records) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      console.log(`Evaluating ${records.length} records from Airtable...`);

      const upcomingPrograms = records
        .filter(record => {
          const fields = record.fields;

          // Log the program name for debugging
          // Programs field is an array of linked records
          const programNames = Array.isArray(fields.Programs)
            ? fields.Programs.map(p => typeof p === 'string' ? p : p).join(', ')
            : fields.Programs;
          console.log('Checking program:', programNames, 'at', fields.City, fields.State);

          // Filter for Certificate in Employee Relations Law - Programs field is an array of linked records
          if (!fields.Programs || !Array.isArray(fields.Programs) || fields.Programs.length === 0) {
            console.log(`❌ Filtered out: no Programs field`);
            return false;
          }

          // Must have required fields
          if (!fields['Start Date'] || !fields.City || !fields.State) {
            console.log('❌ Missing required fields:', {
              hasStartDate: !!fields['Start Date'],
              hasCity: !!fields.City,
              hasState: !!fields.State
            });
            return false;
          }

          // Remove programs that have started (on start date)
          const startDate = parseTimezoneNeutralDate(fields['Start Date']);
          const isUpcoming = startDate > today;

          if (!isUpcoming) {
            console.log(`❌ Program has already started: ${fields['Start Date']}`);
            return false;
          }

          console.log('✅ Valid program found:', fields.City, fields['Start Date']);
          return true;
        })
        .sort((a, b) => {
          // Sort by start date (soonest first)
          const dateA = parseTimezoneNeutralDate(a.fields['Start Date']);
          const dateB = parseTimezoneNeutralDate(b.fields['Start Date']);
          return dateA - dateB;
        });

      console.log(`Found ${upcomingPrograms.length} upcoming programs`);
      return upcomingPrograms.length > 0 ? upcomingPrograms[0] : null;
    }

    // Generate the next program card
    function generateNextProgramCard(program) {
      const cardContainer = document.getElementById('nextProgramCard');
      const fields = program.fields;

      const startDate = parseTimezoneNeutralDate(fields['Start Date']);
      const endDate = parseTimezoneNeutralDate(fields['End Date']);
      const dateRange = formatDateRange(startDate, endDate);

      // Use image URL from field (can be Google Cloud Storage URL or Airtable attachment)
      const imageUrl = fields['Hero Image URL'] || '';

      cardContainer.innerHTML = `
        <div class="hero-program-card">
          <div class="card-image-container">
            <img src="${imageUrl}" alt="${fields.City}" class="hero-background-image" loading="lazy">
            <div class="card-overlay">
              <div class="next-program-badge">Next Program</div>

              <div class="program-info">
                <div class="program-location">${fields.City}, ${fields.State}</div>
                <div class="program-dates">${dateRange}</div>
              </div>

              <div class="program-link-container">
                <a href="#all-programs" class="view-all-programs-link">
                  View All Upcoming Programs
                </a>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Format date range for display
    function formatDateRange(startDate, endDate) {
      if (startDate.getMonth() === endDate.getMonth() && startDate.getFullYear() === endDate.getFullYear()) {
        // Same month: "October 6-10, 2025"
        return `${startDate.toLocaleDateString('en-US', { month: 'long' })} ${startDate.getDate()}-${endDate.getDate()}, ${startDate.getFullYear()}`;
      } else {
        // Different months: "March 30 - April 3, 2025"
        const startMonth = startDate.toLocaleDateString('en-US', { month: 'long' });
        const startDay = startDate.getDate();
        const endMonth = endDate.toLocaleDateString('en-US', { month: 'long' });
        const endDay = endDate.getDate();
        const year = endDate.getFullYear();

        if (startDate.getFullYear() === endDate.getFullYear()) {
          return `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${year}`;
        } else {
          return `${startMonth} ${startDay}, ${startDate.getFullYear()} - ${endMonth} ${endDay}, ${year}`;
        }
      }
    }

    // Initialize component when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      fetchNextProgram();
    });

    // Optional: Refresh data every 5 minutes
    setInterval(fetchNextProgram, 5 * 60 * 1000);
  </script>

  <!-- Header Scroll Behavior -->
  <script>
    // ============================================================================
    // OPTIMIZED HEADER SCROLL BEHAVIOR
    // ============================================================================
    //
    // State Machine:
    // 1. AT_TOP (0-50px): Visible, transparent background
    // 2. SCROLLING_UP (>50px, moving up): Visible, glass effect
    // 3. SCROLLING_DOWN (>70px, moving down): Hidden
    //
    // Key Improvements:
    // - INSTANT response to scroll-up (no threshold)
    // - Asymmetric thresholds for better UX
    // - Debounced scroll direction detection
    // - Handles rapid direction changes
    // - Accounts for bounce scrolling
    // ============================================================================

    const header = document.getElementById('header');

    // Scroll state tracking
    let lastScrollTop = 0;
    let scrollDirection = 'none'; // 'up', 'down', 'none'
    let ticking = false;

    // Thresholds
    const GLASS_EFFECT_THRESHOLD = 50;  // When to apply glass morphism
    const HIDE_THRESHOLD = 70;           // When to hide header on scroll-down
    const SCROLL_DELTA_MIN = 1;          // Minimum scroll delta to register (handles jitter)

    // Direction change detection (prevents bounce scroll issues)
    let scrollDeltaAccumulator = 0;
    const DIRECTION_CHANGE_THRESHOLD = 5; // Pixels needed to confirm direction change

    /**
     * Main header update function - handles all state transitions
     * @param {number} scrollTop - Current scroll position
     */
    function updateHeaderState(scrollTop) {
      const scrollDelta = scrollTop - lastScrollTop;

      // Direction detection with accumulation (prevents jitter)
      if (Math.abs(scrollDelta) >= SCROLL_DELTA_MIN) {
        scrollDeltaAccumulator += scrollDelta;
        lastScrollTop = scrollTop;
      }

      const isDeltaSignificant = Math.abs(scrollDeltaAccumulator) >= DIRECTION_CHANGE_THRESHOLD;
      const isMovingUp = scrollDeltaAccumulator < 0;
      const isMovingDown = scrollDeltaAccumulator > 0;

      // State: AT_TOP (0-50px) - transparent, no glass effect
      if (scrollTop < GLASS_EFFECT_THRESHOLD) {
        header.classList.remove('scrolled', 'hidden');
        scrollDeltaAccumulator = 0;
      }
      // State: Moving up at any scroll position
      else if (isDeltaSignificant && isMovingUp) {
        header.classList.remove('hidden');
        header.classList.add('scrolled');
        scrollDeltaAccumulator = 0;
      }
      // State: Moving down and past HIDE_THRESHOLD
      else if (isDeltaSignificant && isMovingDown && scrollTop > HIDE_THRESHOLD) {
        header.classList.add('hidden');
        scrollDeltaAccumulator = 0;
      }
    }

    // Debounced scroll handler
    function onScroll() {
      const scrollTop = window.scrollY || document.documentElement.scrollTop;

      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateHeaderState(scrollTop);
          ticking = false;
        });
        ticking = true;
      }
    }

    // Event listener
    window.addEventListener('scroll', onScroll, { passive: true });
  </script>

  <!-- Benefit Steps Interactive Functionality -->
  <script>
    (function() {
      const FRAME_MS = 40; // ~25fps
      const DURATION = 24000; // ms for full vertical sweep (6 seconds per tab)

      function initBenefitSteps() {
        const benefitStepsSection = document.getElementById("benefitSteps");
        if (!benefitStepsSection) {
          return;
        }

        const list = benefitStepsSection.querySelector(".benefit-steps__list");
        const rail = benefitStepsSection.querySelector(".benefit-steps__rail");
        const railProgress = benefitStepsSection.querySelector(".benefit-steps__rail-progress");
        const items = Array.from(benefitStepsSection.querySelectorAll(".benefit-steps__item"));
      const visualImg = benefitStepsSection.querySelector(".benefit-steps__visual-img");

        if (items.length === 0 || !rail || !railProgress) {
          return;
        }

      // Image set for each tab
      const visualImages = [
        "https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/6939b7fef6cae945d6e4077d.svg",
        "https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/6939b89d169a423f0821325c.svg",
        "https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/6939b85d751b349ca140d632.svg",
        "https://storage.googleapis.com/msgsndr/MjGEy0pobNT9su2YJqFI/media/6939b8e0acebf7da5c056dd7.svg"
      ];

      // Mobile summary content for each tab
      const mobileSummaries = [
        { title: "Pre-Program Consultation", text: "Identify your priorities and customize your learning focus before day one." },
        { title: "Professional Credits", text: "Earn 35.75 <span class=\"highlight\">SHRM/HRCI/CLE credits</span>—more than most HR professionals earn in two years." },
        { title: "Ongoing Development", text: "12 months of quarterly employment law updates keep you current as regulations change." },
        { title: "Alumni Advantages", text: "$300-$500 off all future programs—for you and every colleague you refer." }
      ];

      const mobileSummary = benefitStepsSection.querySelector(".benefit-steps__mobile-summary");

        let currentActiveIndex = 0;
        let isPaused = false;
        let railHeight = 0;
        let bulletCenters = [];
        let desktopStep = 0;
        const desktopStepsTotal = Math.round(DURATION / FRAME_MS);
        let lastPassedIndex = 0;

        function measureRail() {
          if (!list) return;

          const listRect = list.getBoundingClientRect();

          // Get center Y of each item's dot relative to list top
          const centersAbs = items.map((item) => {
            const dot = item.querySelector(".benefit-steps__dot");
            if (!dot) return 0;
            const dotRect = dot.getBoundingClientRect();
            return dotRect.top + dotRect.height / 2 - listRect.top;
          });

          if (!centersAbs.length) return;

          const firstCenter = centersAbs[0];
          const lastCenter = centersAbs[centersAbs.length - 1];

          railHeight = lastCenter - firstCenter;
          bulletCenters = centersAbs.map((c) => c - firstCenter);

          if (rail) {
            rail.style.top = firstCenter + "px";
            rail.style.height = railHeight + "px";
          }

          if (railProgress) {
            railProgress.style.height = "0px";
          }

          desktopStep = 0;
          lastPassedIndex = 0;
        }

        function setActiveItem(index, updateProgress = true) {
          // Remove active class from all items
          items.forEach((item, i) => {
            if (i === index) {
              item.classList.add("benefit-steps__item--active");
            } else {
              item.classList.remove("benefit-steps__item--active");
            }
          });

          currentActiveIndex = index;

        // Update visual image
        if (visualImg && visualImages[index]) {
          visualImg.style.opacity = "0";
          requestAnimationFrame(() => {
            visualImg.src = visualImages[index];
            visualImg.onload = () => (visualImg.style.opacity = "1");
          });
        }

        // Update mobile summary
        if (mobileSummary && mobileSummaries[index]) {
          const h4 = mobileSummary.querySelector("h4");
          const p = mobileSummary.querySelector("p");
          if (h4) h4.textContent = mobileSummaries[index].title;
          if (p) p.innerHTML = mobileSummaries[index].text;
        }

          // Update progress bar
          if (updateProgress && railProgress && bulletCenters.length && railHeight > 0) {
            const h = bulletCenters[index] || 0;
            railProgress.style.height = h + "px";
            desktopStep = Math.round((h / railHeight) * desktopStepsTotal);
            lastPassedIndex = index;
          }
        }

        function resetAnimation() {
          desktopStep = 0;
          lastPassedIndex = 0;
          if (railProgress) railProgress.style.height = "0px";
        }

        function desktopTick() {
          if (!railProgress || railHeight <= 0 || isPaused) return;

          desktopStep++;

          if (desktopStep > desktopStepsTotal) {
            // Stop at the last item instead of looping
            isPaused = true;
            setActiveItem(items.length - 1, false);
            return;
          }

          const progress = desktopStep / desktopStepsTotal;
          const height = progress * railHeight;

          railProgress.style.height = height + "px";

          for (let i = lastPassedIndex + 1; i < bulletCenters.length; i++) {
            if (height >= bulletCenters[i]) {
              setActiveItem(i, false);
              lastPassedIndex = i;
            }
          }
        }

        // Add click handlers to each item - pauses indefinitely on click
        items.forEach((item, index) => {
          item.addEventListener("click", () => {
            isPaused = true;
            setActiveItem(index, true);
          });

          // Add keyboard support
          item.setAttribute("tabindex", "0");
          item.setAttribute("role", "button");
          item.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              isPaused = true;
              setActiveItem(index, true);
            }
          });
        });

        // Animation timer
        const animationInterval = setInterval(() => {
          desktopTick();
        }, FRAME_MS);

        // Measure rail on init and resize
        measureRail();
        setActiveItem(0, true);
        resetAnimation();

        // Handle window resize
        let resizeTimeout;
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            measureRail();
            resetAnimation();
            setActiveItem(currentActiveIndex, true);
          }, 250);
        });

      }

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBenefitSteps);
      } else {
        initBenefitSteps();
      }
    })();
  </script>

  <!-- Curriculum Section JavaScript -->
  <script src="../js/curriculum.js" defer></script>

  <!-- Testimonial Card Override Styles (loads after external CSS) -->
  <!-- Testimonial Card Override Styles (loads after external CSS) -->
  <style>
    article.testimonial-card,
    .testimonial-card {
      gap: 30px !important;
      min-height: 0 !important;
    }
  </style>

</body>
</html>

<link rel="stylesheet" href="./design-system.css" />
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Fallback styles if design system not available */
    :root {
      --text: #0f172a;
      --muted: #475569;
      --primary: #2563eb;
      --primary-600: #1d4ed8;
      --surface: #ffffff;
      --border: #e2e8f0;
      --danger: #dc2626;
      --success: #16a34a;
    }
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--text); margin: 0; background: #eef2f7; }
    h1, h2, h3 { font-family: 'Playfair Display', Georgia, 'Times New Roman', serif; margin: 0 0 8px; }
    /* Button fallbacks if DS .btn is not present */
    .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: 14px; padding: 12px 20px; cursor: pointer; font-weight: 700; border: 1px solid transparent; transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease; }
    .btn-primary { background: #1d4ed8; color: #fff; border-color: #1d4ed8; box-shadow: 0 16px 32px rgba(29, 78, 216, .32), inset 0 -2px 0 rgba(0,0,0,.08); }
    .btn-primary:hover { background: #1e40af; transform: translateY(-1px); box-shadow: 0 20px 44px rgba(29, 78, 216, .36), inset 0 -2px 0 rgba(0,0,0,.08); }
    .btn-secondary { background: #ffffff; color: #374151; border-color: #6B7280; box-shadow: 0 6px 16px rgba(2, 6, 23, 0.06); }
    .btn-secondary:hover { border-color: #6B7280; transform: translateY(-1px); box-shadow: 0 10px 24px rgba(2, 6, 23, 0.08); }
    .btn[disabled], .btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }
    .hover-lift:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(2, 6, 23, 0.08); }

    .iaml-modal-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(2,6,23,0.45); z-index: 1000; }
    .iaml-modal-overlay[data-open="true"] { display: flex; animation: fadeIn 200ms ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .iaml-modal { width: min(820px, 94vw); max-height: 94vh; overflow: hidden; background: #ffffff; border: 1px solid #e7edf6; border-radius: 20px; box-shadow: 0 30px 70px rgba(2,6,23,0.22); display: grid; grid-template-rows: auto 1fr auto; }
    .iaml-header { padding: 24px 28px; display: flex; align-items: center; justify-content: space-between; border-bottom: 0; background: linear-gradient(180deg, #0f2a66 0%, #3256a6 100%); color: #fff; box-shadow: 0 6px 20px rgba(15, 42, 102, 0.25); }
    .iaml-title { display: flex; gap: 12px; align-items: center; }
    .iaml-title h2 { font-family: 'Playfair Display', Georgia, serif; font-weight: 700; font-size: 28px; line-height: 1.15; color: #fff; }
    #iamlSubTitle { display: none; }
    .iaml-close { background: transparent; border: none; font-size: 22px; line-height: 1; cursor: pointer; color: rgba(255,255,255,0.95); }

    .iaml-content { padding: 24px 28px; overflow: auto; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 800px) { .grid-2 { grid-template-columns: 1fr; } }
    .card { background: #ffffff; border: 1px solid #e7edf6; border-radius: 16px; padding: 6px; box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06); overflow: hidden; }
    h3 { font-family: 'Playfair Display', Georgia, serif; font-weight: 700; font-size: 28px; letter-spacing: -0.01em; margin: 0 0 20px; color: #0f172a; }
    /* Slightly smaller heading on the format step with larger spacing below */
    #step1 > h3 { font-size: 26px; margin-bottom: 28px; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: 13px; color: var(--muted); }
    .field input, .field select { border: 1px solid #cbd5e1; color: black; background: #fff; border-radius: 12px; padding: 12px 14px; font-size: 15px; }
    .field input:focus, .field select:focus { outline: 3px solid rgba(37, 99, 235, 0.22); border-color: #2563eb; }
    /* Minimal progress indicator (5 stages) */
    .progress { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 24px; }
    .progress .node { width: 10px; height: 10px; border-radius: 50%; border: 2px solid #cbd5e1; background: #fff; }
    .progress .node.active { border-color: #1d4ed8; background: #1d4ed8; }
    .progress .node.current { border-color: #1d4ed8; background: #1d4ed8; border-width: 3px; }
    .progress .line { height: 2px; width: 40px; background: #e2e8f0; }
    .progress .line.active { background: #93c5fd; }
    /* Step 2 progress spacing */
    #progressStep2 { margin-top: 32px; margin-bottom: 44px; }

    /* Format options as accessible radio rows */
    .format-options { display: grid; gap: 12px; margin-top: 6px; margin-bottom: 20px; }
    .option-row {color:black; display: flex; align-items: center; gap: 12px; padding: 16px 22px; width: 100%; border: 1px solid #e7edf6; border-radius: 12px; background: #fafcff; cursor: pointer; user-select: none; box-sizing: border-box; }
    .option-row:hover { border-color: #cfe2ff; background: #f3f8ff; }
    .option-row input[type="radio"] { width: 16px; height: 16px; }

    /* Ensure attendance rows don't bleed outside the card */
    #step3 .option-row { margin: 8px 12px; border-radius: 12px; width: auto; }
    #step3 .option-row:first-child { margin-top: 0; }
    #step3 .option-row:last-child { margin-bottom: 0; }

    /* Sessions timeline list for Step 4 */
    .sessions-list { display: grid; gap: 14px; max-height: 440px; overflow: auto; padding-right: 6px; }
    .session-card { display: grid; grid-template-columns: auto auto 1fr; align-items: center; gap: 16px; padding: 16px; border: 1px solid #e7edf6; border-radius: 12px; background: #fafcff; cursor: pointer; }
    .session-card:hover { border-color: #cfe2ff; background: #f3f8ff; }
    .session-card[data-selected="true"] { border-color: #1d4ed8; background: #eef2ff; }
    .session-radio { width: 18px; height: 18px; }
    .session-thumb { width: 120px; height: 80px; border-radius: 8px; object-fit: cover; background: #E5E7EB; border: 1px solid #e5e7eb; display: grid; place-items: center; color: #6b7280; font-size: 20px; }
    .session-info { display: grid; gap: 4px; }
    .session-loc { font-weight: 600; font-size: 18px; color: #0f172a; }
    .session-date { font-size: 16px; color: #475569; }
    .session-venue { font-size: 14px; color: #64748b; }
    .sessions-empty { text-align: center; color: #475569; padding: 40px 12px; }
    /* Defensive: never show attendance controls within step 5 */
    #step5 #attendanceOptions,
    #step5 input[name="attendanceTypeFull"],
    #step5 input[name="attendanceBlocks"],
    #step5 .option-row { display: none !important; }

    .steps { display: grid; grid-auto-flow: column; gap: 10px; padding: 14px 24px; background: #fff; border-top: 1px solid #e7edf6; }
    .step { font-size: 13px; color: #475569; padding: 10px 12px; border-radius: 12px; border: 1px dashed #e2e8f0; background: #fff; }
    .step[data-active="true"] { color: #1d4ed8; border-color: #c7d2fe; background: #eef2ff; }

    .iaml-footer { padding: 18px 24px; display: flex; align-items: center; justify-content: space-between; border-top: 1px solid #e7edf6; background: #ffffff; box-shadow: 0 -10px 30px rgba(2, 6, 23, 0.06); }
    .text-muted { color: var(--muted); font-size: 13px; }
    .text-danger { color: var(--danger); }
    .text-success { color: var(--success); }
    .inline { display: inline-flex; align-items: center; gap: 8px; }

    .spinner { width: 16px; height: 16px; border-radius: 50%; border: 2px solid rgba(2,6,23,0.1); border-top-color: var(--primary); animation: spin 600ms linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    /* Confirmation Modal Overlay Styles */
    .confirmation-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: none;
      align-items: flex-start;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
      overflow-y: auto;
    }
    .confirmation-overlay[aria-hidden="false"] {
      display: flex;
      animation: fadeIn 300ms ease-out;
    }
    
    .confirmation-modal {
      width: 100%;
      max-width: 900px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      animation: slideUp 400ms ease-out;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Hero Section */
    .confirmation-hero {
      background: linear-gradient(135deg, #28528c 0%, #1e3f6f 100%);
      color: white;
      text-align: center;
      padding: 60px 40px 40px;
    }
    
    .checkmark-container {
      margin: 0 auto 20px;
      display: inline-block;
      animation: checkmarkScale 500ms ease-out 200ms both;
    }
    
    @keyframes checkmarkScale {
      from {
        transform: scale(0);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .confirmation-hero h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 36px;
      font-weight: 700;
      margin: 0 0 10px;
      animation: fadeInUp 500ms ease-out 400ms both;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .confirmation-subtitle {
      font-size: 18px;
      margin: 0;
      opacity: 0.95;
      animation: fadeInUp 500ms ease-out 500ms both;
      font-family: Inter, system-ui, sans-serif;
    }
    
    /* Summary Box */
    .summary-box {
      background: white;
      margin: -30px 40px 30px;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      position: relative;
    }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e7edf6;
    }
    
    .summary-header h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 24px;
      font-weight: 600;
      margin: 0;
      color: #0f172a;
    }
    
    .format-badge-conf {
      background: #28528c;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: Inter, system-ui, sans-serif;
    }
    
    .summary-details {
      display: grid;
      gap: 12px;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }
    
    .detail-row[data-show-if] {
      display: none;
    }
    
    .detail-row[data-show-if].visible {
      display: flex;
    }
    
    .detail-label {
      font-weight: 600;
      color: #5a6c7d;
      font-size: 14px;
      font-family: Inter, system-ui, sans-serif;
    }
    
    .detail-value {
      font-weight: 500;
      color: #0f172a;
      font-size: 15px;
      text-align: right;
      font-family: Inter, system-ui, sans-serif;
    }
    
    /* What Happens Next Section */
    .what-next-section {
      padding: 40px 40px 20px;
    }
    
    .what-next-section > h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 30px;
      color: #0f172a;
      text-align: center;
    }
    
    .step-card {
      display: flex;
      gap: 20px;
      padding: 25px;
      background: #f9fafb;
      border: 1px solid #e7edf6;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .step-card[data-show-if] {
      display: none;
    }
    
    .step-card[data-show-if].visible {
      display: flex;
    }
    
    .step-card.urgent-action {
      border: 2px solid #10B981;
      background: #f0fdf4;
    }
    
    .step-content {
      flex: 1;
    }
    
    .step-content h3 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 12px;
      color: #0f172a;
    }
    
    .step-content p {
      margin: 0 0 12px;
      color: #2c3e50;
      line-height: 1.6;
      font-family: Inter, system-ui, sans-serif;
    }
    
    .step-content ul {
      margin: 12px 0;
      padding-left: 20px;
      color: #2c3e50;
      line-height: 1.8;
      font-family: Inter, system-ui, sans-serif;
    }
    
    .step-content li {
      margin-bottom: 6px;
    }
    
    .check-email-box {
      background: #FEF3C7;
      padding: 12px 16px;
      margin: 12px 0;
      border-radius: 6px;
      font-size: 15px;
      line-height: 1.6;
      font-family: Inter, system-ui, sans-serif;
      color: #2c3e50;
    }
    
    .social-proof {
      background: #ECFDF5;
      border: 1px solid #D1FAE5;
      padding: 10px 14px;
      border-radius: 6px;
      margin-top: 12px;
      font-size: 14px;
      font-family: Inter, system-ui, sans-serif;
      color: #065F46;
      font-style: italic;
    }
    
    /* Value Reminder */
    .value-reminder {
      padding: 30px 40px;
      background: white;
    }
    
    .value-reminder h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 15px;
      color: #0f172a;
      text-align: center;
    }
    
    .value-reminder p {
      margin: 0;
      color: #2c3e50;
      line-height: 1.7;
      font-size: 16px;
      text-align: center;
      max-width: 700px;
      margin: 0 auto;
      font-family: Inter, system-ui, sans-serif;
    }
    
    .value-reminder p[data-show-if] {
      display: none;
    }
    
    .value-reminder p[data-show-if].visible {
      display: block;
    }
    
    /* Help Section */
    .help-section {
      padding: 25px 40px;
      background: #f9fafb;
      border-top: 1px solid #e7edf6;
      text-align: center;
    }
    
    .help-section p {
      margin: 5px 0;
      color: #2c3e50;
      font-size: 15px;
      font-family: Inter, system-ui, sans-serif;
    }
    
    .help-section a {
      color: #28528c;
      text-decoration: none;
      font-weight: 600;
    }
    
    .help-section a:hover {
      text-decoration: underline;
    }
    
    /* Footer */
    .confirmation-footer {
      padding: 25px 40px;
      background: white;
      border-top: 1px solid #e7edf6;
      text-align: center;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .confirmation-overlay {
        padding: 10px;
      }
      
      .confirmation-hero {
        padding: 40px 20px 30px;
      }
      
      .confirmation-hero h1 {
        font-size: 28px;
      }
      
      .confirmation-subtitle {
        font-size: 16px;
      }
      
      .summary-box {
        margin: -20px 20px 20px;
        padding: 20px;
      }
      
      .summary-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .detail-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
      
      .detail-value {
        text-align: left;
      }
      
      .what-next-section {
        padding: 30px 20px 15px;
      }
      
      .what-next-section > h2 {
        font-size: 24px;
      }
      
      .step-card {
        flex-direction: column;
        padding: 20px;
      }
      
      .value-reminder {
        padding: 25px 20px;
      }
      
      .help-section {
        padding: 20px;
      }
    }

    /* URL Builder panel */
    #urlBuilderToggle { position: fixed; bottom: 16px; right: 16px; z-index: 1200; }
    #urlBuilderPanel[hidden] { display: none; }
    #urlBuilderPanel { position: fixed; right: 16px; bottom: 72px; width: min(420px, 94vw); background: #fff; border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 16px 48px rgba(2,6,23,0.12); padding: 16px; z-index: 1200; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Overlay preloader demo */
    .preload-overlay { position: fixed; inset: 0; background: rgba(2,6,23,0.35); display: none; align-items: center; justify-content: center; z-index: 1200; }
    .preload-overlay[data-show="true"] { display: flex; }
    .preload-box { background: #fff; border: 1px solid #e7edf6; border-radius: 14px; padding: 18px 22px; box-shadow: 0 20px 60px rgba(2,6,23,0.28); display: grid; gap: 10px; align-items: center; justify-items: center; }
    .spinner.lg { width: 28px; height: 28px; border-width: 3px; }
    .msg { color: #0f172a; font-weight: 600; }

    /* Skeleton demo */
    .skeleton { animation: pulse 1.2s ease-in-out infinite; background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 37%, #f3f4f6 63%); background-size: 400% 100%; }
    @keyframes pulse { 0% { background-position: 100% 0 } 100% { background-position: -100% 0 } }
    .session-card.skel { grid-template-columns: 120px 1fr; }
    .thumb-skel { width: 120px; height: 80px; border-radius: 8px; }
    .line-skel { height: 14px; border-radius: 6px; margin: 6px 0; }

    /* Chip + bar demo */
    .topbar { height: 3px; width: 100%; background: linear-gradient(90deg, #2563eb 0%, rgba(37,99,235,0.1) 60%); background-size: 200% 100%; animation: barMove 3s linear infinite; border-radius: 2px; }
    @keyframes barMove { 0% { background-position: 0 0 } 100% { background-position: -200% 0 } }
    .chip { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border: 1px solid #e7edf6; border-radius: 12px; background: #fff; color: #0f172a; font-size: 13px; }

    /* Coupon row layout */
    .coupon-row { display: flex; gap: 14px; align-items: stretch; }
    .coupon-input { flex: 1 1 auto; border: 1px solid #cbd5e1; background: #fff; border-radius: 12px; padding: 12px 14px; font-size: 15px; color: #111827; }
    .apply-coupon-btn { flex: 0 0 180px; border: 1px solid #6B7280; background: #ffffff; color: #374151; font-weight: 600; border-radius: 12px; padding: 12px 16px; }
    .apply-coupon-btn:hover { background: #F3F4F6; }
    .coupon-msg { font-size: 14px; margin-top: 8px; }
    .coupon-msg.text-success { color: #059669; }
    .coupon-msg.text-danger { color: #EF4444; }
    @media (max-width: 640px) {
      .coupon-row { flex-direction: column; }
      .apply-coupon-btn { flex: 0 0 auto; width: 100%; }
    }

    /* Small badge for certificate items */
    .badge-cert { display: inline-block; margin-left: 10px; padding: 2px 8px; font-size: 12px; line-height: 1; border: 1px solid #dc2626; background: #dc2626; border-radius: 999px; color: #ffffff; }

    /* Step 6 review styles */
    .iaml-modal-overlay #step6 .review-grid { display: grid; grid-template-columns: 3fr 2fr; gap: 16px; }
    @media (max-width: 800px) { .iaml-modal-overlay #step6 .review-grid { grid-template-columns: 1fr; } }
    .iaml-modal-overlay .section-card { background: #f9fafb; border: 1px solid #e7edf6; border-radius: 12px; padding: 18px; }
    .iaml-modal-overlay #step6 .section-title { text-align:left !important; font-weight: 700 !important; color: #0f172a !important; font-size: 18px !important; margin-bottom: 10px !important; font-family: 'Lato', sans-serif !important; }
    .iaml-modal-overlay .kv { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 12px; font-family: 'Lato', sans-serif; }
    .iaml-modal-overlay .kv .label { color: #64748b; font-weight: 600; font-size: 14px; }
    .iaml-modal-overlay .kv .value { color: #0f172a; font-weight: 400; font-size: 15px; }
    .iaml-modal-overlay #step6 .divider { height: 1px; background: #e5e7eb; margin: 16px 0; width: 100%}
    .iaml-modal-overlay .pricing { text-align: left !important;}
    .iaml-modal-overlay .pricing .row { display: flex !important; justify-content: space-between !important; align-items: center !important; gap: 12px; font-size: 16px; margin-top: 12px; font-family: 'Lato', sans-serif; }
    .iaml-modal-overlay .pricing .row .label { color: #6B7280; font-weight: 400; }
    .iaml-modal-overlay .pricing .row .amount { color: #111827; font-weight: 500; }
    .iaml-modal-overlay .pricing .row.discount .amount { color: #16a34a; }
    .iaml-modal-overlay .pricing .row.success .label { color: #059669; font-weight: 500; }
    .iaml-modal-overlay .pricing .row.success .amount { color: #059669; font-weight: 600; }
    .iaml-modal-overlay .pricing .row.success { margin-top: 16px; margin-bottom: 12px; }
    .iaml-modal-overlay .pricing .row .sublabel { font-size: 14px; color: #6B7280; margin-top: 12px; }
    .iaml-modal-overlay .pricing .row .label { flex: 1; }
    .iaml-modal-overlay .pricing .row .amount { white-space: nowrap; }
    .iaml-modal-overlay .pricing .total { font-size: 30px; font-weight: 700; color: #111827; margin-top: 16px; text-align: left !important; }
    .iaml-modal-overlay .note-success { background: #D1FAE5; color: #065f46; border: 1px solid #6EE7B7; border-radius: 10px; padding: 16px 20px; font-size: 14px; display: none; margin-top: 20px; text-align: center; line-height: 1.55; }
    .iaml-modal-overlay .note-info { background: #EFF6FF; border: 1px solid #BFDBFE; color: #1D4ED8; border-radius: 8px; padding: 8px 10px; font-size: 12px; margin: 6px 0 4px 0; }
    div#step5 span {
    color: #000;
}

    /* Confirmation page (step7) styles */
    #step7 { padding: 0; background: transparent; border: none; box-shadow: none; margin: -24px -28px 0; width: calc(100% + 56px); position: relative; }
    .confirmation-header { background: linear-gradient(180deg, #0f2a66 0%, #3256a6 100%); color: #fff; padding: 50px 28px 40px; text-align: center; border-radius: 20px 20px 0 0; }
    .confirmation-icon { width: 80px; height: 80px; border-radius: 50%; background: #16a34a; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3); }
    .confirmation-icon svg { width: 48px; height: 48px; color: #fff; }
    .confirmation-title { font-family: 'Playfair Display', Georgia, serif; font-size: 38px; font-weight: 700; color: #fff; margin: 0 0 20px; line-height: 1.2; }
    .confirmation-subtitle { font-size: 16px; color: rgba(255,255,255,0.95); margin: 0; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto; }
    .confirmation-body {background: #fff;padding: 28px 28px 32px;margin: 20px;border-radius: 20px;margin-top: -30px;box-shadow: 0px 0px 10px rgb(0 0 0 / 15%);
    }
    .confirmation-summary-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .confirmation-summary-title { font-weight: 700; color: #0f172a; font-size: 18px; margin: 0; font-family: Inter, system-ui, sans-serif; }
    .format-badge { display: inline-block; padding: 5px 14px; background: #0f2a66; color: #fff; border-radius: 8px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .confirmation-summary { background: #fff; padding: 0; }
    .confirmation-kv { display: flex; flex-direction: column; gap: 0; font-family: Inter, system-ui, sans-serif; }
    .confirmation-kv-row { display: flex; justify-content: space-between; align-items: flex-start; padding: 14px 0; border-bottom: 1px solid #e5e7eb; }
    .confirmation-kv-row:last-child { border-bottom: none; }
    .confirmation-kv .label { color: #64748b; font-weight: 600; font-size: 14px; min-width: 140px; }
    .confirmation-kv .value { color: #0f172a; font-weight: 600; font-size: 15px; text-align: right; flex: 1; }
    .confirmation-divider { height: 1px; background: #e5e7eb; margin: 20px 0; }
    /* Top close button (X in header) - only for step7 if needed */
    #closeConfirmationBtnTop { position: absolute; top: 24px; right: 24px; z-index: 10; background: transparent; border: none; font-size: 22px; line-height: 1; cursor: pointer; color: rgba(255,255,255,0.95); padding: 4px; }
    #closeConfirmationBtnTop:hover { color: rgba(255,255,255,1); }
    
    /* Bottom close button in footer */
    .confirmation-footer { 
      padding: 24px 40px; 
      text-align: center; 
      border-top: 1px solid #e5e7eb; 
      margin-top: 32px;
      background: white;
    }
    #closeConfirmationBtn { 
      min-width: 120px;
      padding: 12px 32px;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      border: 2px solid #dc2626;
      background: #ffffff;
      color: #1f2937;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-block;
    }
    #closeConfirmationBtn:hover { 
      background: #f9fafb;
      border-color: #b91c1c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
    }
    #closeConfirmationBtn:active { 
      transform: translateY(0);
    }
    #confirmationOverlay .step-content h3, .step-content p {opacity: 1 !important;}
  </style>
  <!-- Launcher (hide this on production site; modal can be auto-opened via query) -->
  <!--div style="padding: 20px;">
    <button id="openModalBtn" class="btn btn-primary hover-lift">Open Registration Modal</button>
    <button id="registerModalBtn" class="btn btn-primary hover-lift">Register Now</button>
  </div-->

  <!-- Modal -->
  <div id="iamlModalOverlay" class="iaml-modal-overlay" aria-hidden="true">
    <!-- Loader overlay demo -->
    <div id="preloadOverlay" class="preload-overlay" aria-hidden="true" role="status">
      <div class="preload-box">
        <div class="spinner lg"></div>
        <div class="msg">Fetching sessions…</div>
      </div>
    </div>
    <!-- Redirect overlay (post-submit thinking effect) -->
    <div id="redirectOverlay" class="preload-overlay" aria-hidden="true" role="status">
      <div class="preload-box">
        <div class="spinner lg"></div>
        <div class="msg">Finishing up…</div>
      </div>
    </div>

    <div class="iaml-modal" role="dialog" aria-modal="true" aria-labelledby="iamlModalTitle">
      <div class="iaml-header">
        <div class="iaml-title">
          <h2 id="iamlModalTitle">Reserve Your Spot</h2>
          <span class="text-muted" id="iamlSubTitle"></span>
        </div>
        <button id="closeModalBtn" class="iaml-close" aria-label="Close">✕</button>
      </div>

      <div class="iaml-content">
        <!-- Step containers -->
        <div id="step1" class="card">
          <div id="progressIndicator" class="progress" aria-hidden="false"></div>
          <h3>Select your program format</h3>
          <div class="format-options" id="formatOptions">
            <label class="option-row"><input type="radio" name="format" value="In-Person"> <span>In-Person</span></label>
            <label class="option-row"><input type="radio" name="format" value="Virtual"> <span>Virtual</span></label>
            <label class="option-row"><input type="radio" name="format" value="On-Demand"> <span>On-Demand</span></label>
          </div>
        </div>

        <div id="step2" class="card hidden">
          <div class="progress" aria-hidden="false" id="progressStep2"></div>
          <h3>Select your program</h3>
          <div class="format-options" id="programOptions" style="max-height: 420px; overflow: auto; position: relative;">
            <label class="option-row"><input type="radio" name="program" value="Certificate in Employee Relations Law"> <span>Certificate in Employee Relations Law</span></label>
            <label class="option-row"><input type="radio" name="program" value="Advanced Certificate in Strategic Employment Law"> <span>Advanced Certificate in Strategic Employment Law</span></label>
            <label class="option-row"><input type="radio" name="program" value="Certificate in Strategic HR Management"> <span>Certificate in Strategic HR Management</span></label>
            <label class="option-row"><input type="radio" name="program" value="Certificate in Workplace Investigations"> <span>Certificate in Workplace Investigations</span></label>
            <label class="option-row"><input type="radio" name="program" value="Certificate in Employee Benefits Law"> <span>Certificate in Employee Benefits Law</span></label>
            <label class="option-row"><input type="radio" name="program" value="Advanced Certificate in Employee Benefits Law"> <span>Advanced Certificate in Employee Benefits Law</span></label>
          </div>
        </div>

        <div id="step3" class="card hidden">
          <div class="progress" aria-hidden="false" id="progressStep3"></div>
          <h3>Select your attendance</h3>
          <div class="format-options" id="attendanceOptions">
            <label class="option-row"><input type="radio" name="attendanceTypeFull" value="Full" id="attFull"> <span>Full Program</span></label>
            <label id="attBlock1" class="option-row hidden"><input type="checkbox" name="attendanceBlocks" value="Block 1"> <span>Block 1</span></label>
            <label id="attBlock2" class="option-row hidden"><input type="checkbox" name="attendanceBlocks" value="Block 2"> <span>Block 2</span></label>
            <label id="attBlock3" class="option-row hidden"><input type="checkbox" name="attendanceBlocks" value="Block 3"> <span>Block 3</span></label>
          </div>
          
        </div>

        <div id="step4" class="card hidden">
          <div class="progress" aria-hidden="false" id="progressStep4"></div>
          <h3>Select your session</h3>
          <div id="sessionsList" class="sessions-list"></div>
          <div id="sessionsEmpty" class="sessions-empty hidden">No sessions currently available for this program and format</div>
        </div>

        <div id="step5" class="card hidden">
          <div class="progress" aria-hidden="false" id="progressStep5"></div>
          <h3>Complete your registration</h3>
          <div class="grid-2">
            <label class="field"><span>First Name *</span><input id="firstName" autocomplete="given-name" required></label>
            <label class="field"><span>Last Name *</span><input id="lastName" autocomplete="family-name" required></label>
            <label class="field"><span>Title (optional)</span><input id="title" autocomplete="organization-title" placeholder="Your title"></label>
            <label class="field"><span>Company Name (optional)</span><input id="company" autocomplete="organization" placeholder="Company name"></label>
            <label class="field"><span>Phone *</span><input id="phone" autocomplete="tel" required placeholder="(555) 555-5555"></label>
            <label class="field"><span>Email *</span><input id="email" type="email" autocomplete="email" required placeholder="your.email@example.com"></label>
            <label class="field"><span>Coupon Code</span>
              <div class="coupon-row">
                <input id="couponCode" class="coupon-input" placeholder="Optional">
                <button id="applyCouponBtn" class="apply-coupon-btn" type="button">Apply Coupon</button>
              </div>
              <div id="couponMsg" class="coupon-msg" aria-live="polite"></div>
              <div id="couponSpinner" class="spinner hidden" aria-hidden="true"></div>
            </label>
          </div>
        </div>

        <div id="step6" class="card hidden">
          <div class="progress" aria-hidden="false" id="progressStep6"></div>
          <h3>Review & Confirm</h3>
          <div class="review-grid">
            <div class="section-card">
              <div class="section-title">Registration Summary</div>
              <div class="kv">
                <div class="label">Program</div><div class="value" id="revProgram">—</div>
                <div class="label">Format</div><div class="value" id="revFormat">—</div>
                <div class="label">Attendance</div><div class="value" id="revAttendance">—</div>
                <div class="label">Location</div><div class="value" id="revLocation">—</div>
                <div class="label">Dates</div><div class="value" id="revDates">—</div>
              </div>
              <div class="divider"></div>
              <div class="section-title" style="margin-top: 2px;">Contact Information</div>
              <div class="kv">
                <div class="label">Name</div><div class="value" id="revName">—</div>
                <div class="label">Company</div><div class="value" id="revCompany">—</div>
                <div class="label">Title</div><div class="value" id="revTitle">—</div>
                <div class="label">Phone</div><div class="value" id="revPhone">—</div>
                <div class="label">Email</div><div class="value" id="revEmail">—</div>
              </div>
            </div>
            <div class="section-card pricing">
              <div class="section-title">Amount Due</div>
              <div id="revPriceRows">
                <!-- Dynamic rows inserted here: Program/Block line(s), Subtotal when needed -->
              </div>
              <div id="revDiscountRow" class="row hidden"><div class="label" id="revDiscountLabel">Discount</div><div class="amount" id="revDiscount">-$0</div></div>
              <div class="divider" id="preTotalDivider"></div>
              <div class="total" id="amountDue">$0</div>
              <div id="upgradeNote" class="note-success">✓ Smart Savings: Automatically upgraded to Full Program! You now have access to all sessions at the best price.</div>
            </div>
          </div>
        </div>

        <div id="step7" class="card hidden">
          <button id="closeConfirmationBtnTop" class="iaml-close" aria-label="Close">✕</button>
          <div class="confirmation-header">
            <div class="confirmation-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h2 class="confirmation-title">You're Registered!</h2>
            <p class="confirmation-subtitle">Your spot in the <span id="confProgram">program</span> is almost confirmed. See below for next steps to finalize your enrollment.</p>
          </div>
          <div class="confirmation-body">
            <div class="confirmation-summary-header">
              <h3 class="confirmation-summary-title">Registration Summary</h3>
              <span id="confFormatBadge" class="format-badge">IN-PERSON</span>
            </div>
            <div class="confirmation-summary">
              <div class="confirmation-kv">
                <div class="confirmation-kv-row">
                  <div class="label">Participant:</div>
                  <div class="value" id="confParticipant">—</div>
                </div>
                <div class="confirmation-kv-row">
                  <div class="label">Email:</div>
                  <div class="value" id="confEmail">—</div>
                </div>
                <div class="confirmation-kv-row">
                  <div class="label">Program:</div>
                  <div class="value" id="confProgramName">—</div>
                </div>
                <div class="confirmation-kv-row">
                  <div class="label">Dates:</div>
                  <div class="value" id="confDates">—</div>
                </div>
                <div class="confirmation-kv-row">
                  <div class="label">Location:</div>
                  <div class="value" id="confLocation">—</div>
                </div>
                <div class="confirmation-kv-row">
                  <div class="label">Enrollment Fee:</div>
                  <div class="value" id="confEnrollmentFee">—</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step navigation removed in favor of minimal progress indicator -->

      <div class="iaml-footer">
        <div class="inline">
          <button id="backBtn" class="btn btn-secondary">Back</button>
          <div id="globalSpinner" class="spinner hidden" aria-hidden="true"></div>
          <span id="globalMsg" class="text-muted"></span>
        </div>
        <div class="inline">
          <button id="nextBtn" class="btn btn-primary">Next</button>
          <button id="submitBtn" class="btn btn-primary hidden">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationOverlay" class="confirmation-overlay" aria-hidden="true" style="display: none !important;">
    <div class="confirmation-modal" role="dialog" aria-modal="true" aria-labelledby="confirmationTitle">
      <!-- Hero Section -->
      <div class="confirmation-hero">
        <div class="checkmark-container">
          <svg class="checkmark" width="80" height="80" viewBox="0 0 80 80">
            <circle cx="40" cy="40" r="38" fill="#10b981" stroke="#fff" stroke-width="4"/>
            <path d="M25 40 L35 50 L55 30" stroke="#fff" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h1 id="confirmationTitle">You're Registered!</h1>
        <p class="confirmation-subtitle" id="confirmationSubtitle">Your spot in the Certificate in Employee Relations Law is almost confirmed.<br>See below for next steps to finalize your enrollment.</p>
      </div>

      <!-- Registration Summary Box -->
      <div class="summary-box">
        <div class="summary-header">
          <h2>Registration Summary</h2>
          <span class="format-badge-conf" id="formatBadgeConf">IN-PERSON</span>
        </div>
        <div class="summary-details">
          <div class="detail-row">
            <span class="detail-label">Participant:</span>
            <span class="detail-value" id="confName">—</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Email:</span>
            <span class="detail-value" id="confEmail">—</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Program:</span>
            <span class="detail-value" id="confProgram">Certificate in Employee Relations Law</span>
          </div>
          <div class="detail-row" data-show-if="in-person,virtual">
            <span class="detail-label">Dates:</span>
            <span class="detail-value" id="confDates">—</span>
          </div>
          <div class="detail-row" data-show-if="in-person">
            <span class="detail-label">Location:</span>
            <span class="detail-value" id="confLocation">—</span>
          </div>
          <div class="detail-row" data-show-if="virtual">
            <span class="detail-label">Format:</span>
            <span class="detail-value">Live Virtual (Zoom)</span>
          </div>
          <div class="detail-row" data-show-if="on-demand">
            <span class="detail-label">Format:</span>
            <span class="detail-value">On-Demand (Self-Paced)</span>
          </div>
          <div class="detail-row" data-show-if="on-demand">
            <span class="detail-label">Access Period:</span>
            <span class="detail-value">90 Days from Payment</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Enrollment Fee:</span>
            <span class="detail-value" id="confPrice">—</span>
          </div>
        </div>
      </div>

      <!-- What Happens Next Section -->
      <div class="what-next-section">
        <h2>What Happens Next</h2>

        <!-- Step 1 - Invoice/Payment -->
        <div class="step-card urgent-action" data-show-if="in-person,virtual">
          <div class="step-content">
            <h3>Step 1: Check Your Email Right Now!</h3>
            <p><strong>Your invoice is being sent as you read this.</strong></p>
            <div class="check-email-box">
              <strong>What to do:</strong><br>
              1. Check your email inbox (search for "IAML Invoice")<br>
              2. Can't find it? Check your spam/junk folder<br>
              3. Click "Pay Now" to complete your registration
            </div>
            <p><strong>Why pay today?</strong></p>
            <ul>
              <li><strong>Lock in your seat</strong> – Sessions can fill up</li>
              <li><strong>Schedule your consultation</strong> – Book your complimentary call right away</li>
            </ul>
          </div>
        </div>
        <div class="step-card urgent-action" data-show-if="on-demand">
          <div class="step-content">
            <h3>Step 1: Check Your Email & Start Learning Today!</h3>
            <p><strong>Your invoice is being sent right now.</strong></p>
            <div class="check-email-box">
              <strong>What to do:</strong><br>
              1. Check your email inbox (search for "IAML Invoice")<br>
              2. Can't find it? Check your spam/junk folder<br>
              3. Click "Pay Now" for instant access
            </div>
            <p><strong>Pay now and get:</strong></p>
            <ul>
              <li><strong>Instant access</strong> – Start watching within 5 minutes</li>
              <li><strong>All materials unlocked</strong> – Download everything immediately</li>
              <li><strong>Full 90 days</strong> – Your viewing period starts after payment</li>
            </ul>
          </div>
        </div>

        <!-- Step 2 - Consultation -->
        <div class="step-card" data-show-if="in-person,virtual">
          <div class="step-content">
            <h3>Step 2: Get Ready to Succeed</h3>
            <p>Good news! Once your invoice is paid, you'll be able to book your complimentary 10-15 minute pre-program consultation to ensure you get maximum value from the program.</p>
            <p><strong>In this 10-15 minute call, you'll:</strong></p>
            <ul>
              <li>Discuss your specific workplace challenges</li>
              <li>Get customized guidance on what to focus on during the program</li>
              <li>Ask questions about what to expect</li>
              <li>Meet our team before you arrive</li>
            </ul>
            <p class="social-proof">Most participants who take this call say it doubled the value they got from the program.</p>
          </div>
        </div>
        <div class="step-card" data-show-if="on-demand">
          <div class="step-content">
            <h3>Step 2: Maximize Your Learning (Optional but Recommended)</h3>
            <p>Good news! Once your invoice is paid, you'll be able to book your complimentary 10-15 minute pre-program consultation to ensure you get maximum value from the program.</p>
            <p><strong>During this call, we'll help you:</strong></p>
            <ul>
              <li>Identify which modules to prioritize based on your challenges</li>
              <li>Create a realistic completion schedule</li>
              <li>Learn how to get the most from self-paced learning</li>
              <li>Understand how to apply concepts to your specific situations</li>
            </ul>
          </div>
        </div>

        <!-- Step 3 - Prepare/Access -->
        <div class="step-card" data-show-if="in-person">
          <div class="step-content">
            <h3>Step 3: Prepare for Day 1</h3>
            <p>We'll send pre-program information on <span class="info-date">{{info_send_date}}</span>, a week before your program starts.</p>
          </div>
        </div>
        <div class="step-card" data-show-if="virtual">
          <div class="step-content">
            <h3>Step 3: Prepare for Your Virtual Program</h3>
            <p>We'll send pre-program information on <span class="info-date">{{info_send_date}}</span>, a week before your program starts, including:</p>
            <ul>
              <li>Your Zoom access and meeting links</li>
              <li>Technical setup guide</li>
              <li>Pre-program materials</li>
              <li>Tips for virtual learning success</li>
            </ul>
            <p><strong>Make sure your tech is ready so you can focus on the content, not the connection.</strong></p>
          </div>
        </div>
        <div class="step-card" data-show-if="on-demand">
          <div class="step-content">
            <h3>Step 3: Start Learning (After Payment)</h3>
            <p>Once your payment is received, you'll receive:</p>
            <ul>
              <li>Login credentials for the learning platform</li>
              <li>Complete course outline and navigation guide</li>
              <li>All downloadable resources and templates</li>
              <li>Recommended learning path based on your goals</li>
              <li>Technical support contact information</li>
            </ul>
            <p><strong>Your 90-day access period begins the day you receive your login credentials.</strong></p>
          </div>
        </div>
      </div>

      <!-- Value Reminder -->
      <div class="value-reminder">
        <h2>Quick Reminder: What You're Getting</h2>
        <p data-show-if="in-person">You'll build practical employment law expertise through real workplace scenarios with experienced attorneys. You'll cover hiring, discipline, accommodations, leaves, terminations, and investigations.</p>
        <p data-show-if="virtual">You'll build practical employment law expertise through real workplace scenarios with experienced attorneys, delivered virtually with the same interactive learning you'd get in person.</p>
        <p data-show-if="on-demand">You'll build practical employment law expertise through real workplace scenarios with experienced attorneys. Learn at your own pace, pause to implement, and revisit challenging topics. All on your schedule.</p>
      </div>

      <!-- Help/Contact Section -->
      <div class="help-section">
        <p><strong>Questions about your registration?</strong></p>
        <p>Contact us at <a href="mailto:info@iaml.com">info@iaml.com</a> or call <a href="tel:+19497601700">(949) 760-1700</a></p>
      </div>

      <!-- Close Button -->
      <div class="confirmation-footer">
        <button id="closeConfirmationBtn" class="btn btn-secondary" type="button">CLOSE</button>
      </div>
    </div>
  </div>

  <!-- URL Builder (admin) -->
  <button id="urlBuilderToggle" class="btn btn-secondary hidden">Open URL Builder</button>
  <div id="urlBuilderPanel" hidden data-builder-active="false">
    <div class="card" style="margin-bottom: 10px;">
      <h3 style="margin-bottom: 8px;">Registration URL Builder</h3>
      <div class="text-muted" style="margin-bottom: 8px;">Generate prefilled registration links using live Airtable data.</div>
      <div class="grid-2">
        <label class="field">
          <span>Format</span>
          <select id="builderFormat">
            <option value="" disabled selected>Select</option>
            <option>In-Person</option>
            <option>Virtual</option>
            <option>On-Demand</option>
          </select>
        </label>
        <label class="field">
          <span>Program</span>
          <select id="builderProgram">
            <option value="" disabled selected>Select</option>
            <option>Certificate in Employee Relations Law</option>
            <option>Certificate in Employee Benefits Law</option>
            <option>Certificate in Strategic HR Management</option>
            <option>Certificate in Workplace Investigations</option>
            <option>Certificate in Labor Relations</option>
            <option>Certificate in FMLA and ADA Compliance</option>
          </select>
        </label>
        <label class="field">
          <span>Block (optional)</span>
          <select id="builderBlock">
            <option value="">None (Full)</option>
            <option>Block 1</option>
            <option>Block 2</option>
            <option>Block 3</option>
          </select>
        </label>
        <label class="field">
          <span>Session</span>
          <select id="builderSession">
            <option value="" disabled selected>Select program + format</option>
          </select>
        </label>
      </div>
    </div>
    <div class="card">
      <div class="field">
        <span>Generated URL</span>
        <input id="builderUrl" class="mono" readonly>
      </div>
      <div class="inline" style="margin-top: 8px;">
        <button id="copyBuilderUrl" class="btn btn-primary">Copy URL</button>
        <span id="builderMsg" class="text-muted"></span>
      </div>
    </div>
    <div class="card" style="margin-top: 10px;">
      <h3 style="margin-bottom: 8px;">Code Builder (attach to existing button)</h3>
      <div class="grid-2">
        <label class="field">
          <span>Format</span>
          <select id="codeFmt">
            <option value="" disabled selected>Select</option>
            <option>In-Person</option>
            <option>Virtual</option>
            <option>On-Demand</option>
          </select>
        </label>
        <label class="field">
          <span>Program</span>
          <select id="codeProg">
            <option value="" disabled selected>Select</option>
          </select>
        </label>
        <label class="field">
          <span>City</span>
          <select id="codeCity">
            <option value="" disabled selected>Select city/state</option>
          </select>
        </label>
        <label class="field">
          <span>State</span>
          <select id="codeState" aria-hidden="true" style="display:none"></select>
        </label>
        <label class="field">
          <span>Attach Style</span>
          <select id="codeStyle">
            <option value="data" selected>Data-attributes + autobind</option>
            <option value="onclick">Inline onclick</option>
            <option value="selector">JS selector binding snippet</option>
          </select>
        </label>
        <label class="field">
          <span>Button Selector (for selector mode)</span>
          <input id="codeSelector" placeholder="#myButton or .cta">
        </label>
      </div>
      <div class="field" style="margin-top: 8px;">
        <span>Paste into your page</span>
        <textarea id="codeOutput" class="mono" rows="8" readonly></textarea>
      </div>
      <div class="inline" style="margin-top: 8px;">
        <button id="copyCode" class="btn btn-primary">Copy Code</button>
        <span id="codeMsg" class="text-muted"></span>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const AIRTABLE_BASE_ID = ENV_CONFIG.AIRTABLE_REGISTRATION_BASE_ID;
      const AIRTABLE_API_KEY = ENV_CONFIG.AIRTABLE_REGISTRATION_API_KEY;
      const TABLE_SESSIONS = 'Program Sessions';
      const TABLE_COUPONS = 'tblBaUQKmYuIMsVQm'; // Coupon Codes (table id)
      const GHL_WEBHOOK_URL = ENV_CONFIG.GHL_WEBHOOK_URL;

      // Known block-based programs and code mappings
      const blockProgramMap = {
        'Certificate in Employee Relations Law': { code: 'A', blocks: ['Block 1','Block 2','Block 3'], days: { 'Block 1': 2, 'Block 2': 2, 'Block 3': 1 }, ranges: { 'Block 1': [0,1], 'Block 2': [2,3], 'Block 3': [4,4] } },
        'Certificate in Employee Benefits Law': { code: 'E', blocks: ['Block 1','Block 2','Block 3'], days: { 'Block 1': 2, 'Block 2': 1, 'Block 3': 2 }, ranges: { 'Block 1': [0,1], 'Block 2': [2,2], 'Block 3': [3,4] } },
        'Certificate in Strategic HR Management': { code: 'B', blocks: ['Block 1','Block 2'], days: { 'Block 1': 2, 'Block 2': 3 }, ranges: { 'Block 1': [0,1], 'Block 2': [2,4] } },
      };

      // Hardcoded program pricing (full and per-block)
      const PRICING = {
        'Certificate in Employee Relations Law': {
          full: 2375,
          blocks: { 'Block 1': 1375, 'Block 2': 1375, 'Block 3': 575 }
        },
        'Certificate in Strategic HR Management': {
          full: 2375,
          blocks: { 'Block 1': 1375, 'Block 2': 1575 }
        },
        'Certificate in Employee Benefits Law': {
          full: 2375,
          blocks: { 'Block 1': 1375, 'Block 2': 575, 'Block 3': 975 }
        },
        'Advanced Certificate in Strategic Employment Law': { full: 1575 },
        'Advanced Certificate in Employee Benefits Law': { full: 1575 },
        'Certificate in Workplace Investigations': { full: 1575 },
      };
      function getProgramPricing(program) { return PRICING[program] || null; }

      // Virtual derived certificate labels for display/logic
      const VIRTUAL_CERT_PROGRAMS = new Set([
        'Certificate in Employee Relations Law',
        'Certificate in Strategic HR Management'
      ]);

      // Definitions for virtual certificates: component program names and order
      const VIRTUAL_CERT_DEFS = {
        'Certificate in Employee Relations Law': {
          components: ['Comprehensive Labor Relations', 'Discrimination Prevention & Risk'],
          price: 2375,
        },
        'Certificate in Strategic HR Management': {
          components: ['HR Law Fundamentals', 'Strategic HR Leadership'],
          price: 2375,
        },
      };

      const programCodeFallback = (programName) => {
        if (!programName) return 'P';
        // Prefer first letter of key words
        const letters = programName.split(/\s+/).map(w => w[0]).join('');
        return letters ? letters.substring(0,2).toUpperCase() : 'P';
      };

      const formatCodeMap = { 'In-Person': 'IP', 'Virtual': 'VI', 'On-Demand': 'OD' };
      // Format-specific post-submit redirects (replace with your final URLs)
      const REDIRECTS_BY_FORMAT = {
        'In-Person': 'https://www.iaml.com/thank-you-in-person',
        'Virtual': 'https://www.iaml.com/thank-you-virtual',
        'On-Demand': 'https://www.iaml.com/thank-you-on-demand',
      };

      // Build tolerant regex for Format values (accepts hyphen or space)
      function formatToRegex(format) {
        const f = String(format || '').toLowerCase();
        if (f === 'on-demand' || f === 'on demand') return 'on[\\s-]?demand';
        if (f === 'in-person' || f === 'in person') return 'in[\\s-]?person';
        if (f === 'virtual') return 'virtual';
        // escape any other strings
        return f.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&');
      }

      // Canonical list of programs to display in Step 2 (and builder)
      const ALLOWED_PROGRAMS = [
        'Certificate in Employee Relations Law',
        'Advanced Certificate in Strategic Employment Law',
        'Certificate in Strategic HR Management',
        'Certificate in Workplace Investigations',
        'Certificate in Employee Benefits Law',
        'Advanced Certificate in Employee Benefits Law',
      ];

      // Map UI labels to Airtable {Program} values (adjust if Airtable differs)
      const PROGRAM_MAP = {
        'Certificate in Employee Relations Law': 'Certificate in Employee Relations Law',
        'Advanced Certificate in Strategic Employment Law': 'Advanced Certificate in Strategic Employment Law',
        'Certificate in Strategic HR Management': 'Certificate in Strategic HR Management',
        'Certificate in Workplace Investigations': 'Certificate in Workplace Investigations',
        'Certificate in Employee Benefits Law': 'Certificate in Employee Benefits Law',
        'Advanced Certificate in Employee Benefits Law': 'Advanced Certificate in Employee Benefits Law',
      };

      // Hard-coded coupon rules
      const COUPON_RULES = {
        PP500: {
          amount: 500,
          type: 'Flat',
          programs: [
            'Certificate in Employee Relations Law',
            'Certificate in Strategic HR Management',
            'Certificate in Employee Benefits Law',
          ],
          allowed: (isFull, blocksCount) => isFull === true,
        },
        PP300: {
          amount: 300,
          type: 'Flat',
          programs: [
            'Advanced Certificate in Strategic Employment Law',
            'Certificate in Conducting Workplace Investigations',
            'Advanced Certificate in Employee Benefits Law',
            'Certificate in Employee Relations Law',
            'Certificate in Strategic HR Management',
            'Certificate in Employee Benefits Law',
          ],
          allowed: (_isFull, _blocksCount) => true,
        },
        PP100: {
          amount: 100,
          type: 'Flat',
          programs: [],
          allowed: (isFull, blocksCount) => (!isFull && blocksCount >= 1),
        },
      };

      function applyCouponRules(rawCode, programName, isFull, selectedBlocksCount) {
        const code = String(rawCode || '').toUpperCase();
        const rule = COUPON_RULES[code];
        if (!rule) return null;
        if (Array.isArray(rule.programs) && rule.programs.length) {
          const ok = rule.programs.some(p => p.toLowerCase() === String(programName || '').toLowerCase());
          if (!ok) return { valid: false, reason: 'Coupon not valid for this program.' };
        }
        if (typeof rule.allowed === 'function' && !rule.allowed(!!isFull, Number(selectedBlocksCount || 0))) {
          return { valid: false, reason: isFull ? 'Coupon valid only for block registrations.' : 'Coupon valid only for full program.' };
        }
        return { valid: true, amount: Number(rule.amount || 0), type: rule.type || 'Flat', code };
      }

      const state = {
        step: 1,
        format: '',
        program: '',
        attendanceType: 'Full', // Label for review (Full or joined blocks)
        attendanceBlocks: [],   // Array of selected blocks for block-based programs
        sessionId: '',
        sessionRecord: null,
        basePrice: 0,
        coupon: null, // coupon record data
        couponDiscount: 0,
        amountDue: 0,
        derivedStart: null,
        derivedEnd: null,
        showFieldErrors: false,
        // For Virtual: computed certificate date pairs by program label
        virtualCertificatePairs: {},
      };

      // DOM elements
      const qs = (sel) => document.querySelector(sel);
      const qsa = (sel) => Array.from(document.querySelectorAll(sel));
      // Show/hide a key-value row (value selector points to the value node; its label is previous sibling)
      function toggleKvRow(valueSel, shouldShow) {
        const val = qs(valueSel);
        if (!val) return;
        const label = val.previousElementSibling && val.previousElementSibling.classList?.contains('label')
          ? val.previousElementSibling
          : null;
        const show = !!shouldShow;
        val.style.display = show ? '' : 'none';
        if (label) label.style.display = show ? '' : 'none';
      }
      function showPreload(show) {
        const o = qs('#preloadOverlay');
        if (o) { o.dataset.show = show ? 'true' : 'false'; o.setAttribute('aria-hidden', show ? 'false' : 'true'); }
      }
      function showRedirectOverlay(show) {
        const o = qs('#redirectOverlay');
        if (o) { o.dataset.show = show ? 'true' : 'false'; o.setAttribute('aria-hidden', show ? 'false' : 'true'); }
      }
      const delay = (ms) => new Promise(r => setTimeout(r, ms));

      async function preloadSessionsThenAdvance(nextStep) {
        const mode = (window.demoLoaderMode || '').toLowerCase();
        if (mode === 'overlay') showPreload(true);
        try {
          const load = loadSessions(state.program, state.format, { silent: true });
          await Promise.race([load, delay(2000)]);
        } catch {}
        finally {
          if (mode === 'overlay') showPreload(false);
          setStep(nextStep);
        }
      }
      const modalOverlay = qs('#iamlModalOverlay');
      const openModalBtn = qs('#openModalBtn');
      const registerModalBtn = qs('#registerModalBtn');
      const closeModalBtn = qs('#closeModalBtn');
      const nextBtn = qs('#nextBtn');
      const backBtn = qs('#backBtn');
      const submitBtn = qs('#submitBtn');
      const globalSpinner = qs('#globalSpinner');
      const globalMsg = qs('#globalMsg');
      const steps = qsa('.step');
      const subTitle = qs('#iamlSubTitle');

      const formatSelect = qs('#formatSelect');
      const getFormatRadios = () => Array.from(document.querySelectorAll('input[name="format"]'));
      const programSelect = qs('#programSelect');
      const getProgramRadios = () => Array.from(document.querySelectorAll('input[name="program"]'));
      const sessionCount = qs('#sessionCount');
      const block1Option = qs('#attBlock1');
      const block2Option = qs('#attBlock2');
      const block3Option = qs('#attBlock3');
      const sessionSelect = qs('#sessionSelect');
      const sessionDetails = qs('#sessionDetails');
      const firstName = qs('#iamlModalOverlay #firstName');
      const lastName = qs('#iamlModalOverlay #lastName');
      const title = qs('#iamlModalOverlay #title');
      const company = qs('#iamlModalOverlay #company');
      const phone = qs('#iamlModalOverlay #phone');
      const email = qs('#iamlModalOverlay #email');
      const couponCode = qs('#couponCode');
      const applyCouponBtn = qs('#applyCouponBtn');
      const couponMsg = qs('#couponMsg');
      const couponSpinner = qs('#couponSpinner');
      const reviewSummary = qs('#reviewSummary');
      const amountDueEl = qs('#amountDue');
      const discountLine = qs('#discountLine');

      const urlBuilderToggle = qs('#urlBuilderToggle');
      const urlBuilderPanel = qs('#urlBuilderPanel');
      const builderFormat = qs('#builderFormat');
      const builderProgram = qs('#builderProgram');
      const builderBlock = qs('#builderBlock');
      const builderSession = qs('#builderSession');
      const builderUrl = qs('#builderUrl');
      const copyBuilderUrl = qs('#copyBuilderUrl');
      const builderMsg = qs('#builderMsg');
      // Code Builder refs
      const codeFmt = qs('#codeFmt');
      const codeProg = qs('#codeProg');
      const codeCity = qs('#codeCity');
      const codeState = qs('#codeState');
      const codeStyle = qs('#codeStyle');
      const codeSelector = qs('#codeSelector');
      const codeOutput = qs('#codeOutput');
      const copyCode = qs('#copyCode');

      function populateProgramOptions(selectEl) {
        if (!selectEl) return;
        selectEl.innerHTML = '<option value="" disabled selected>Select a program</option>';
        ALLOWED_PROGRAMS.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          selectEl.appendChild(opt);
        });
      }

      function stepToProgress(n) { return n <= 1 ? 1 : (n === 2 ? 2 : (n === 3 ? 3 : (n === 4 ? 4 : 5))); }
      function renderProgress() {
        const container = qs('#progressIndicator');
        if (!container) return;
        container.innerHTML = '';
        const active = stepToProgress(state.step);
        for (let i = 1; i <= 5; i++) {
          const node = document.createElement('span');
          node.className = 'node' + (i <= active ? ' active' : '');
          container.appendChild(node);
          if (i < 5) {
            const line = document.createElement('span');
            line.className = 'line' + (i < active ? ' active' : '');
            container.appendChild(line);
          }
        }
      }
      function renderProgressForStep2() {
        const container = qs('#progressStep2');
        if (!container) return;
        container.innerHTML = '';
        // Step 2 should show step 1 complete, step 2 current
        for (let i = 1; i <= 5; i++) {
          const node = document.createElement('span');
          let cls = 'node';
          if (i === 1) cls += ' active';
          if (i === 2) cls += ' current';
          node.className = cls;
          container.appendChild(node);
          if (i < 5) {
            const line = document.createElement('span');
            let lcls = 'line';
            if (i === 1) lcls += ' active';
            line.className = lcls;
            container.appendChild(line);
          }
        }
      }
      function renderProgressForStep3() {
        const container = qs('#progressStep3');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
          const node = document.createElement('span');
          let cls = 'node';
          if (i === 1 || i === 2) cls += ' active';
          if (i === 3) cls += ' current';
          node.className = cls;
          container.appendChild(node);
          if (i < 5) {
            const line = document.createElement('span');
            let lcls = 'line';
            if (i === 1 || i === 2) lcls += ' active';
            line.className = lcls;
            container.appendChild(line);
          }
        }
      }

      function renderProgressForStep4() {
        const container = qs('#progressStep4');
        if (!container) return;
        container.innerHTML = '';
        const mode = (window.demoLoaderMode || '').toLowerCase();
        if (mode === 'chip') {
          const bar = document.createElement('div'); bar.className = 'topbar'; bar.style.marginBottom = '10px';
          container.appendChild(bar);
          const chip = document.createElement('div'); chip.className = 'chip'; chip.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px"></div><span>Fetching sessions…</span>';
          container.appendChild(chip);
        }
        for (let i = 1; i <= 5; i++) {
          const node = document.createElement('span');
          let cls = 'node';
          if (i === 1 || i === 2 || i === 3) cls += ' active';
          if (i === 4) cls += ' current';
          node.className = cls;
          container.appendChild(node);
          if (i < 5) {
            const line = document.createElement('span');
            let lcls = 'line';
            if (i === 1 || i === 2 || i === 3) lcls += ' active';
            line.className = lcls;
            container.appendChild(line);
          }
        }
      }

      function renderProgressForStep5() {
        const container = qs('#progressStep5');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
          const node = document.createElement('span');
          let cls = 'node';
          if (i <= 4) cls += ' active';
          if (i === 5) cls += ' current';
          node.className = cls;
          container.appendChild(node);
          if (i < 5) {
            const line = document.createElement('span');
            let lcls = 'line';
            if (i <= 4) lcls += ' active';
            line.className = lcls;
            container.appendChild(line);
          }
        }
      }

      function renderProgressForStep6() {
        const container = qs('#progressStep6');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
          const node = document.createElement('span');
          node.className = 'node active';
          container.appendChild(node);
          if (i < 5) {
            const line = document.createElement('span');
            line.className = 'line active';
            container.appendChild(line);
          }
        }
      }

      // Ensure Step 5 never shows attendance options
      function cleanupStep5() {
        const step5 = qs('#step5');
        if (!step5) return;
        // Remove any leftover attendance UI accidentally injected
        step5.querySelectorAll('input[name="attendanceTypeFull"], input[name="attendanceBlocks"]').forEach(el => {
          const row = el.closest('.option-row'); if (row) row.remove(); else el.remove();
        });
        step5.querySelectorAll('#attendanceOptions, .attendance-section').forEach(el => el.remove());
        step5.querySelectorAll('h1,h2,h3,h4').forEach(h => {
          if ((h.textContent || '').toLowerCase().includes('attendance')) h.remove();
        });
      }

      // Stronger purge for Step 5 content only
      function purgeAttendanceFromStep5() {
        const s5 = qs('#step5');
        if (!s5) return;
        
        // Remove all attendance-related inputs and their containers
        s5.querySelectorAll('input[name="attendanceTypeFull"], input[name="attendanceBlocks"]').forEach(el => {
          const row = el.closest('.option-row');
          if (row) row.remove(); else el.remove();
        });
        
        // Remove attendance containers and sections
        s5.querySelectorAll('#attendanceOptions, .attendance-section, #step3, .option-row').forEach(el => el.remove());
        
        // Remove any headings related to attendance
        s5.querySelectorAll('h1,h2,h3,h4').forEach(h => {
          const t = (h.textContent || '').trim().toLowerCase();
          if (t.includes('select your attendance') || t.includes('attendance') || t.includes('block')) h.remove();
        });
        
        // Remove any labels that contain attendance options
        s5.querySelectorAll('label').forEach(label => {
          const hasAttendanceInput = label.querySelector('input[name="attendanceTypeFull"], input[name="attendanceBlocks"]');
          if (hasAttendanceInput) {
            label.remove();
          }
        });
        
        // Remove any divs that contain attendance options
        s5.querySelectorAll('div').forEach(div => {
          const hasAttendanceInputs = div.querySelector('input[name="attendanceTypeFull"], input[name="attendanceBlocks"]');
          if (hasAttendanceInputs && !div.closest('#step5 > .progress')) {
            div.remove();
          }
        });
      }

      function hardResetStep5() {
        const s5 = qs('#step5');
        if (!s5) return;
        
        // Remove ALL attendance-related elements from Step 5
        const attendanceSelectors = [
          'input[name="attendanceTypeFull"]',
          'input[name="attendanceBlocks"]',
          '#attendanceOptions',
          '.attendance-section',
          '.option-row',
          '#step3',
          'label[for*="att"]',
          'label:has(input[name="attendanceTypeFull"])',
          'label:has(input[name="attendanceBlocks"])'
        ];
        
        attendanceSelectors.forEach(selector => {
          s5.querySelectorAll(selector).forEach(el => {
            if (el.id === 'step3') {
              el.remove();
            } else {
              const row = el.closest('.option-row');
              if (row) {
                row.remove();
              } else {
                el.remove();
              }
            }
          });
        });
        
        // Remove any headings that contain attendance-related text
        s5.querySelectorAll('h1,h2,h3,h4').forEach(h => {
          const text = (h.textContent || '').toLowerCase();
          if (text.includes('attendance') || text.includes('select your attendance') || text.includes('block')) {
            h.remove();
          }
        });
        
        // Remove any divs that contain attendance options
        s5.querySelectorAll('div').forEach(div => {
          const hasAttendanceInputs = div.querySelector('input[name="attendanceTypeFull"], input[name="attendanceBlocks"]');
          if (hasAttendanceInputs) {
            div.remove();
          }
        });
      }

      function prepareStep4() {
        // Populate timeline list
        const list = qs('#sessionsList');
        const empty = qs('#sessionsEmpty');
        if (list) list.innerHTML = '';
        if (empty) empty.classList.add('hidden');
        // Render virtual certificate synthesized pairs, if present
        if (state.format === 'Virtual' && state.virtualCertificatePairs && state.virtualCertificatePairs[state.program]) {
          const pairs = state.virtualCertificatePairs[state.program];
          if (list && Array.isArray(pairs)) {
            pairs.forEach((pair, index) => {
              const card = document.createElement('div');
              card.className = 'session-card';
              card.setAttribute('role','radio'); card.setAttribute('tabindex','0');

              const radio = document.createElement('input'); radio.type = 'radio'; radio.name = 'sessionRadio'; radio.className = 'session-radio';
              const img = document.createElement('img'); img.className = 'session-thumb'; img.src = 'https://i.imgur.com/AnabbC7.jpeg'; img.alt = 'Session image';

              const info = document.createElement('div'); info.className = 'session-info';
              const loc = document.createElement('div'); loc.className = 'session-loc'; loc.textContent = 'Virtual Classroom';

              const comp1Name = pair.components?.[0]?.program || 'Session 1';
              const comp2Name = pair.components?.[1]?.program || 'Session 2';

              const note = document.createElement('div');
              note.className = 'note-info';
              note.textContent = `This virtual certificate includes two sessions: ${comp1Name} and ${comp2Name}.`;

              const d1 = document.createElement('div'); d1.className = 'session-date';
              d1.textContent = `Session 1 — ${formatHumanRange(pair.components?.[0]?.start, pair.components?.[0]?.end)}`;
              d1.title = comp1Name;
              const d2 = document.createElement('div'); d2.className = 'session-date';
              d2.textContent = `Session 2 — ${formatHumanRange(pair.components?.[1]?.start, pair.components?.[1]?.end)}`;
              d2.title = comp2Name;

              info.appendChild(loc); info.appendChild(note); info.appendChild(d1); info.appendChild(d2);
              card.appendChild(radio); card.appendChild(img); card.appendChild(info);

              function selectThis() {
                const programKey = state.program.replace(/[^a-zA-Z0-9]/g, '');
                state.sessionId = `virtualcert:${programKey}:${index}:${pair.overallStart ? formatYMDLocal(pair.overallStart) : ''}`;
                state.sessionRecord = { id: state.sessionId, fields: {
                  Program: state.program, Format: 'Virtual', 'Program Pricing': getProgramPricing(state.program)?.full || 2375,
                  City: 'Online', State: '',
                  'Session Start Date': pair.overallStart ? formatYMDLocal(pair.overallStart) : '',
                  'Session End Date': pair.overallEnd ? formatYMDLocal(pair.overallEnd) : ''
                } };
                state.attendanceType = 'Full';
                card.dataset.selected = 'true'; radio.checked = true; updateNextEnabled();
              }
              card.addEventListener('click', selectThis);
              card.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); selectThis(); }});
              list.appendChild(card);
            });
          }
          return; // do not load Airtable sessions for synthesized cert
        }
        const mode = (window.demoLoaderMode || '').toLowerCase();
        if (mode === 'skeleton' && list) {
          for (let i = 0; i < 4; i++) {
            const sk = document.createElement('div'); sk.className = 'session-card skel';
            const t = document.createElement('div'); t.className = 'thumb-skel skeleton';
            const b = document.createElement('div'); b.style.display='grid'; b.style.gap='6px';
            const l1 = document.createElement('div'); l1.className = 'line-skel skeleton'; l1.style.width='60%';
            const l2 = document.createElement('div'); l2.className = 'line-skel skeleton'; l2.style.width='40%';
            b.appendChild(l1); b.appendChild(l2);
            sk.appendChild(t); sk.appendChild(b); list.appendChild(sk);
          }
        }
        if (state.program && state.format) {
          // Fetch sessions once and render as cards
          const patt = formatToRegex(state.format);
          const atProgram = PROGRAM_MAP[state.program] ?? state.program;
          const futureFilter = `OR(IS_AFTER({Session End Date}, TODAY()), IS_SAME({Session End Date}, TODAY()))`;
          const filter = `AND({Program}='${atProgram.replace(/'/g, "\\'")}', REGEX_MATCH(LOWER({Format}), '^${patt}$'), ${futureFilter})`;
          
          airtableList(TABLE_SESSIONS, {
            filterByFormula: filter,
            maxRecords: 100,
            sort: [{ field: 'Session Start Date', direction: 'asc' }, { field: 'City', direction: 'asc' }]
          })
            .then(data => {
              const records = data.records || [];
              if (!list) return;
              if (records.length === 0) { if (empty) empty.classList.remove('hidden'); return; }

              const attNow = computeAttendanceFromUI();
              const isFullSel = attNow.kind === 'full';
              const selBlocks = Array.isArray(attNow.blocks) ? attNow.blocks : [];
              const hasBlocks = !!blockProgramMap[state.program];

              records.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'session-card';
                card.setAttribute('role','radio');
                card.setAttribute('tabindex','0');
                card.dataset.sessionId = rec.id;

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'sessionRadio';
                radio.className = 'session-radio';

                const img = document.createElement('img');
                img.className = 'session-thumb';
                const attachments = rec.fields?.['Hero Image Attachment'];
                if (Array.isArray(attachments) && attachments.length) {
                  const pick = attachments[Math.floor(Math.random() * attachments.length)];
                  img.src = pick?.url || '';
                } else {
                  img.src = '';
                }
                img.alt = 'Session image';
                img.onerror = () => { img.src=''; img.textContent='📍'; };

                const info = document.createElement('div');
                info.className = 'session-info';
                const loc = document.createElement('div');
                const city = rec.fields?.['City'] || ''; const st = rec.fields?.['State'] || '';
                loc.className = 'session-loc';
                loc.textContent = city && st ? `${city}, ${st}` : (city || st || 'Virtual Classroom');
                const dateEl = document.createElement('div');
                dateEl.className = 'session-date';
                if (hasBlocks && !isFullSel && selBlocks.length > 0) {
                  const d = computeDerivedDates(rec, state.program, false, selBlocks);
                  dateEl.textContent = formatHumanRange(d.start, d.end);
                } else {
                  const start = rec.fields?.['Session Start Date'] ? parseAirtableLocal(rec.fields['Session Start Date']) : null;
                  const end = rec.fields?.['Session End Date'] ? parseAirtableLocal(rec.fields['Session End Date']) : null;
                  dateEl.textContent = formatHumanRange(start, end);
                }
                const venueEl = document.createElement('div');
                venueEl.className = 'session-venue';
                venueEl.textContent = rec.fields?.['Venue Name (1)'] || '';

                info.appendChild(loc);
                info.appendChild(dateEl);
                if (venueEl.textContent) info.appendChild(venueEl);

                card.appendChild(radio);
                card.appendChild(img);
                card.appendChild(info);

                // Selection behavior
                function selectThis() {
                  const all = Array.from(document.querySelectorAll('.session-card'));
                  all.forEach(el => { el.dataset.selected = 'false'; const r = el.querySelector('input[type="radio"]'); if (r) r.checked = false; });
                  card.dataset.selected = 'true'; radio.checked = true;
                  state.sessionId = rec.id;
                  // Have record immediately for review/pricing
                  state.sessionRecord = rec;
                  updateReview();
                  updateNextEnabled();
                  // Auto-advance to Step 5 after the standard delay
                  advanceAfterDelay(5);
                  // Ensure full hydration shortly after advancing
                  const delay = (typeof AUTO_ADVANCE_DELAY_MS === 'number' ? AUTO_ADVANCE_DELAY_MS : 300) + 25;
                  setTimeout(() => { try { hydrateSelectedSession(); } catch (e) {} }, delay);
                }
                card.addEventListener('click', selectThis);
                card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectThis(); } });

                list.appendChild(card);
              });
            })
            .catch(() => { if (empty) empty.classList.remove('hidden'); });
        }
      }
      function setStep(n) {
        state.step = n;
        // Hide/show ALL step cards (covers any duplicates accidentally injected)
        document.querySelectorAll('[id^="step"]').forEach(node => {
          const shouldHide = node.id !== ('step' + n);
          node.classList.toggle('hidden', shouldHide);
          // Force hide with style if class doesn't work
          if (shouldHide) {
            node.style.display = 'none';
          } else {
            node.style.display = '';
          }
        });
        steps.forEach(st => st.dataset.active = st.getAttribute('data-step') === String(n));
        backBtn.classList.toggle('hidden', n === 1 || n === 7);
        nextBtn.classList.toggle('hidden', n === 6 || n === 7);
        submitBtn.classList.toggle('hidden', n !== 6);
        // Hide footer and header on confirmation page (has its own header)
        if (n === 7) {
          qs('.iaml-footer')?.classList.add('hidden');
          qs('.iaml-header')?.classList.add('hidden');
        } else {
          qs('.iaml-footer')?.classList.remove('hidden');
          qs('.iaml-header')?.classList.remove('hidden');
        }
        renderProgress();
        if (n === 2) renderProgressForStep2();
        if (n === 3) { renderProgressForStep3(); syncFullRadio(); }
        if (n === 4) { renderProgressForStep4(); showGlobalMessage(''); prepareStep4(); updateNextEnabled(); }
        if (n === 5) { 
          renderProgressForStep5(); 
          showGlobalMessage(''); 
          hardResetStep5(); 
          purgeAttendanceFromStep5(); 
          clearAllFieldErrors(); 
          state.showFieldErrors = false; 
          updateNextEnabled();
          // Additional cleanup to ensure no attendance elements remain
          setTimeout(() => {
            const s5 = qs('#step5');
            if (s5) {
              s5.querySelectorAll('input[name="attendanceTypeFull"], input[name="attendanceBlocks"], .option-row, #attendanceOptions').forEach(el => el.remove());
            }
          }, 10);
        }
        if (n === 6) { renderProgressForStep6(); }
        if (n === 7) { populateConfirmationPage(); }
        // Always reset scroll to top after switching steps
        scrollContentTop(false);
      }

      function openModal() {
        // Preserve form field values before opening modal
        const preservedValues = {
          firstName: firstName?.value || '',
          lastName: lastName?.value || '',
          phone: phone?.value || '',
          email: email?.value || '',
          title: title?.value || '',
          company: company?.value || ''
        };
        
        modalOverlay.dataset.open = 'true';
        modalOverlay.setAttribute('aria-hidden', 'false');
        scrollContentTop(false);
        
        // Restore form field values after modal opens
        setTimeout(() => {
          const s5 = qs('#step5');
          if (s5) {
            s5.querySelectorAll('input[name="attendanceTypeFull"], input[name="attendanceBlocks"], .option-row, #attendanceOptions').forEach(el => el.remove());
          }
          
          // Restore preserved values using specific modal selectors
          const modalFirstName = qs('#iamlModalOverlay #firstName');
          const modalLastName = qs('#iamlModalOverlay #lastName');
          const modalPhone = qs('#iamlModalOverlay #phone');
          const modalEmail = qs('#iamlModalOverlay #email');
          const modalTitle = qs('#iamlModalOverlay #title');
          const modalCompany = qs('#iamlModalOverlay #company');
          
          if (modalFirstName && preservedValues.firstName) modalFirstName.value = preservedValues.firstName;
          if (modalLastName && preservedValues.lastName) modalLastName.value = preservedValues.lastName;
          if (modalPhone && preservedValues.phone) modalPhone.value = preservedValues.phone;
          if (modalEmail && preservedValues.email) modalEmail.value = preservedValues.email;
          if (modalTitle && preservedValues.title) modalTitle.value = preservedValues.title;
          if (modalCompany && preservedValues.company) modalCompany.value = preservedValues.company;
          
        }, 10);
      }

      function clearAllFieldErrors() {
        document.querySelectorAll('#step5 .field-error').forEach(el => el.remove());
      }
      function closeModal() {
        modalOverlay.dataset.open = 'false';
        modalOverlay.setAttribute('aria-hidden', 'true');
      }

      function showGlobalMessage(msg, isError = false) {
        globalMsg.textContent = msg || '';
        globalMsg.classList.toggle('text-danger', !!isError);
      }

      // Scroll the modal content to the top whenever steps change/open
      function scrollContentTop(smooth = false) {
        const el = document.querySelector('.iaml-content');
        if (el) el.scrollTo({ top: 0, behavior: smooth ? 'smooth' : 'auto' });
      }

      const AUTO_ADVANCE_DELAY_MS = 300;
      function advanceAfterDelay(stepNumber) {
        window.setTimeout(() => setStep(stepNumber), AUTO_ADVANCE_DELAY_MS);
      }

      function formatCurrency(n) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n || 0);
      }

      // Utility: does a program support blocks?
      function programHasBlocks(name) {
        // Never allow block selection for On-Demand format
        if (state.format === 'On-Demand') return false;
        return !!blockProgramMap[name];
      }

      // Parse Airtable date strings (YYYY-MM-DD) as local dates (no UTC shift)
      function parseAirtableLocal(s) {
        if (!s) return null;
        const [y, m, d] = String(s).split('-').map(Number);
        return new Date(y, (m || 1) - 1, d || 1);
      }

      // Format a Date to YYYY-MM-DD without timezone side effects
      function formatYMDLocal(date) {
        if (!date) return '';
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      // Format a range; collapse to single date if start==end
      function formatRangeOrSingle(d1, d2) {
        if (!d1 && !d2) return '';
        const sameDay = d1 && d2 && d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        const mmdd = (dt) => `${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')}`;
        if (sameDay) return mmdd(d1);
        if (d1 && d2) return `${mmdd(d1)}–${mmdd(d2)}`;
        return d1 ? mmdd(d1) : mmdd(d2);
      }

      // Human-friendly Month D, YYYY range, collapsing month/year where appropriate
      const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      function formatHumanRange(d1, d2) {
        if (!d1 && !d2) return '';
        const f = (dt, withMonth = true, withYear = true) => {
          const m = MONTHS[dt.getMonth()];
          const d = dt.getDate();
          const y = dt.getFullYear();
          if (withMonth && withYear) return `${m} ${d}, ${y}`;
          if (withMonth && !withYear) return `${m} ${d}`;
          if (!withMonth && withYear) return `${d}, ${y}`;
          return String(d);
        };
        const sameDay = d1 && d2 && d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        if (sameDay) return f(d1, true, true);
        if (d1 && d2) {
          const sameMonth = d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth();
          const sameYear = d1.getFullYear() === d2.getFullYear();
          if (sameMonth) return `${MONTHS[d1.getMonth()]} ${d1.getDate()}–${d2.getDate()}, ${d1.getFullYear()}`;
          if (sameYear) return `${f(d1, true, false)} – ${f(d2, true, true)}`;
          return `${f(d1, true, true)} – ${f(d2, true, true)}`;
        }
        return f(d1 || d2, true, true);
      }

      function formatSessionLabel(rec) {
        const f = rec.fields || {};
        const start = f['Session Start Date'] ? parseAirtableLocal(f['Session Start Date']) : null;
        const end = f['Session End Date'] ? parseAirtableLocal(f['Session End Date']) : null;
        const city = f['City'] || '';
        const state = f['State'] || '';
        const startStr = start ? `${(start.getMonth()+1).toString().padStart(2,'0')}/${start.getDate().toString().padStart(2,'0')}` : '';
        const endStr = end ? `${(end.getMonth()+1).toString().padStart(2,'0')}/${end.getDate().toString().padStart(2,'0')}` : '';
        const range = startStr && endStr ? `${startStr}–${endStr}` : startStr || '';
        const cityState = city && state ? `${city}, ${state}` : (city || state || 'Online');
        return `${range} — ${cityState}`;
      }

      // Return first upcoming session matching City/State (case-insensitive), earliest by start date
      function findUpcomingSessionByCityState(records, city, state) {
        const wantCity = String(city || '').trim().toLowerCase();
        const wantState = String(state || '').trim().toLowerCase();
        if (!wantCity && !wantState) return null;
        const filtered = (records || []).filter(r => {
          const f = r?.fields || {};
          const rc = String(f['City'] || '').trim().toLowerCase();
          const rs = String(f['State'] || '').trim().toLowerCase();
          const end = f['Session End Date'] ? parseAirtableLocal(f['Session End Date']) : null;
          const today = new Date(); today.setHours(0,0,0,0);
          const notEnded = !end || end >= today;
          const cityOk = wantCity ? rc === wantCity : true;
          const stateOk = wantState ? rs === wantState : true;
          return notEnded && cityOk && stateOk;
        }).sort((a,b) => {
          const fa = a?.fields || {}; const fb = b?.fields || {};
          const sa = fa['Session Start Date'] ? parseAirtableLocal(fa['Session Start Date']) : null;
          const sb = fb['Session Start Date'] ? parseAirtableLocal(fb['Session Start Date']) : null;
          if (sa && sb) return sa - sb;
          if (sa && !sb) return -1;
          if (!sa && sb) return 1;
          return 0;
        });
        return filtered[0] || null;
      }

      async function airtableList(tableName, opts = {}) {
        const { filterByFormula, sort = [], maxRecords } = opts;
        const url = new URL(`https://api.airtable.com/v0/${encodeURIComponent(AIRTABLE_BASE_ID)}/${encodeURIComponent(tableName)}`);
        if (filterByFormula) url.searchParams.set('filterByFormula', filterByFormula);
        if (maxRecords) url.searchParams.set('maxRecords', String(maxRecords));
        (Array.isArray(sort) ? sort : []).forEach((s, i) => {
          if (!s) return;
          if (s.field) url.searchParams.set(`sort[${i}][field]`, s.field);
          if (s.direction) url.searchParams.set(`sort[${i}][direction]`, s.direction);
        });
        const res = await fetch(url.toString(), { headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` }});
        if (!res.ok) {
          let detail = '';
          try { detail = await res.text(); } catch {}
          console.error('Airtable error detail:', detail);
          throw new Error(`Airtable error ${res.status}`);
        }
        return res.json();
      }

      // List unique City/State for a given Program + Format (future sessions only)
      async function fetchCitiesForSelection(program, format) {
        if (!program || !format) return [];
        const patt = formatToRegex(format);
        const atProgram = PROGRAM_MAP[program] ?? program;
        const futureFilter = `OR(IS_AFTER({Session End Date}, TODAY()), IS_SAME({Session End Date}, TODAY()))`;
        const filter = `AND({Program}='${atProgram.replace(/'/g, "\\'")}', REGEX_MATCH(LOWER({Format}), '^${patt}$'), ${futureFilter})`;
        const data = await airtableList(TABLE_SESSIONS, {
          filterByFormula: filter,
          maxRecords: 200,
          sort: [{ field: 'Session Start Date', direction: 'asc' }, { field: 'City', direction: 'asc' }]
        });
        const uniq = new Map();
        (data.records || []).forEach(r => {
          const f = r.fields || {};
          const city = String(f['City'] || '').trim();
          const state = String(f['State'] || '').trim();
          if (!city && !state) return;
          const key = `${city.toLowerCase()}||${state.toLowerCase()}`;
          if (!uniq.has(key)) uniq.set(key, { city, state });
        });
        return Array.from(uniq.values());
      }

      // Public API: allow external scripts/buttons to open the modal with preselection
      // window.IAMLRegistration.open({ format, program, city, state })
      function ensureLoaded() {
        return Promise.resolve(true);
      }

      async function apiOpen(opts = {}) {
        try {
          const fmt = String(opts.format || '').trim();
          const prog = String(opts.program || '').trim();
          const city = opts.city || '';
          const state = opts.state || '';

          // Open overlay first so user sees progress
          if (modalOverlay?.dataset.open !== 'true') openModal();

          // Set format UI state
          if (fmt) {
            const r = getFormatRadios().find(x => String(x.value).toLowerCase() === fmt.toLowerCase());
            if (r) { r.checked = true; }
            state.format = fmt;
          }

          // If no program, land on format step
          if (!prog) { setStep(2); return; }

          // Pick program and advance (handles On-Demand/Virtual special cases)
          setStep(2);
          await handleProgramChosen(prog);

          // If City/State provided, try to preselect earliest matching upcoming session
          if (city || state) {
            const patt = formatToRegex(state.format);
            const atProgram = PROGRAM_MAP[prog] ?? prog;
            const futureFilter = `OR(IS_AFTER({Session End Date}, TODAY()), IS_SAME({Session End Date}, TODAY()))`;
            const filter = `AND({Program}='${atProgram.replace(/'/g, "\\'")}', REGEX_MATCH(LOWER({Format}), '^${patt}$'), ${futureFilter})`;
            try {
              const data = await airtableList(TABLE_SESSIONS, {
                filterByFormula: filter,
                maxRecords: 100,
                sort: [{ field: 'Session Start Date', direction: 'asc' }]
              });
              const match = findUpcomingSessionByCityState(data.records || [], city, state);
              if (match) {
                state.sessionId = match.id;
                state.sessionRecord = match;
                state.attendanceType = 'Full'; // ensure Full by default for block programs
                updateReview();
                setStep(5);
                return;
              }
            } catch (e) {}
          }

          // Fallback: show sessions list
          setStep(4);
          // Warm the session dropdown silently so the list populates promptly
          try { await loadSessions(state.program, state.format, { silent: true }); } catch {}
        } catch (e) {
          try { showGlobalMessage('Unable to open registration. Please try again.', true); } catch {}
          // Keep modal open so the user can proceed manually
          if (modalOverlay?.dataset.open !== 'true') {
            try { openModal(); } catch {}
          }
        }
      }


      // Expose API globally
      try {
        window.IAMLRegistration = window.IAMLRegistration || {};
        window.IAMLRegistration.ensureLoaded = ensureLoaded;
        window.IAMLRegistration.open = apiOpen;
      } catch {}

      async function airtablePatch(tableName, recordId, fields) {
        const url = `https://api.airtable.com/v0/${encodeURIComponent(AIRTABLE_BASE_ID)}/${encodeURIComponent(tableName)}/${encodeURIComponent(recordId)}`;
        const res = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ fields }) });
        if (!res.ok) {
          throw new Error(`Airtable PATCH error ${res.status}`);
        }
        return res.json();
      }

      async function findCouponRecordByCode(code) {
        if (!code) return null;
        const safe = code.toLowerCase().replace(/'/g, "\\'");
        const candidates = ['{Coupon Code}', '{Code}'];
        for (const col of candidates) {
          const filter = `LOWER(${col})='${safe}'`;
          try {
            const data = await airtableList(TABLE_COUPONS, { filterByFormula: filter, maxRecords: 1 });
            const rec = (data.records || [])[0];
            if (rec) return rec;
          } catch (e) { /* Error finding coupon record */ }
        }
        return null;
      }

      async function loadSessions(program, format, opts = {}) {
        const { silent = false } = opts;
        if (!silent) {
          if (sessionSelect) sessionSelect.innerHTML = '<option value="" disabled selected>Loading sessions...</option>';
          if (sessionDetails) sessionDetails.textContent = '';
          showGlobalMessage('Loading sessions...');
          globalSpinner.classList.remove('hidden');
        }
        try {
          // Normalize format labels if Airtable uses slightly different labels
          const patt = formatToRegex(format);
          const atProgram = PROGRAM_MAP[program] ?? program;
          // Only sessions that have not ended yet (include those ending today)
          const futureFilter = `OR(IS_AFTER({Session End Date}, TODAY()), IS_SAME({Session End Date}, TODAY()))`;
          const filter = `AND({Program}='${atProgram.replace(/'/g, "\\'")}', REGEX_MATCH(LOWER({Format}), '^${patt}$'), ${futureFilter})`;
          
          const data = await airtableList(TABLE_SESSIONS, { filterByFormula: filter, maxRecords: 100, sort: [{ field: 'Session Start Date', direction: 'asc' }, { field: 'City', direction: 'asc' }] });
          const records = data.records || [];
          
          if (!silent) {
            if (sessionCount) sessionCount.textContent = `${records.length} session${records.length===1?'':'s'} available`;
            if (sessionSelect) sessionSelect.innerHTML = '<option value="" disabled selected>Select a session</option>';
          }
          records.forEach(rec => {
            const opt = document.createElement('option');
            opt.value = rec.id;

            const baseLabel = formatSessionLabel(rec);
            const hasBlocks = !!blockProgramMap[state.program];
            const isFullSel = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
            const selBlocks = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];

            if (!silent && hasBlocks && !isFullSel && selBlocks.length > 0) {
              const d = computeDerivedDates(rec, state.program, false, selBlocks);
              const range = formatRangeOrSingle(d.start, d.end);
              const city = rec.fields?.['City'] || '';
              const st = rec.fields?.['State'] || '';
              const cityState = city && st ? `${city}, ${st}` : (city || st || 'Online');
              opt.textContent = range ? `${formatHumanRange(d.start, d.end)} — ${cityState}` : baseLabel;
            } else {
              opt.textContent = baseLabel;
            }

            if (!silent && sessionSelect) sessionSelect.appendChild(opt);
          });
          if (!silent) {
            if (records.length === 0) {
              showGlobalMessage('No upcoming sessions found for this selection.', true);
            } else {
              showGlobalMessage('');
            }
          }
        } catch (err) {
          if (!silent) {
            showGlobalMessage('Unable to load sessions. Please try again.', true);
            if (sessionSelect) sessionSelect.innerHTML = '<option value="" disabled selected>Error loading sessions</option>';
          }
        } finally {
          if (!silent) globalSpinner.classList.add('hidden');
        }
      }

      function configureBlocksForProgram(program, sessionRecord) {
        // Force Full and hide Step 3 entirely for On-Demand
        if (state.format === 'On-Demand') {
          state.attendanceType = 'Full';
          const fr = document.querySelector('input[name="attendanceTypeFull"]');
          if (fr) fr.checked = true;
          qs('#step3')?.classList.add('hidden');
          return;
        }
        const hasBlocksField = sessionRecord?.fields?.['Has Blocks'] === true || sessionRecord?.fields?.['Has Blocks'] === 1;
        const bp = blockProgramMap[program];
        const hasBlocks = !!bp || hasBlocksField;
        block1Option.classList.add('hidden');
        block2Option.classList.add('hidden');
        block3Option.classList.add('hidden');
        if (hasBlocks) {
          const offered = new Set((sessionRecord?.fields?.['Blocks Offered'] || (bp?.blocks || [])).map(String));
          if (offered.has('Block 1')) block1Option.classList.remove('hidden');
          if (offered.has('Block 2')) block2Option.classList.remove('hidden');
          if (offered.has('Block 3')) block3Option.classList.remove('hidden');
          qs('#step3').classList.remove('hidden');
        } else {
          qs('#step3').classList.add('hidden');
          // Force Full if no blocks
          state.attendanceType = 'Full';
          const fullRadio = document.querySelector('input[name="attendanceType"][value="Full"]');
          if (fullRadio) fullRadio.checked = true;
        }
      }

      // Build Step 2 program list based on chosen format.
      async function loadProgramsForFormat(format) {
        const list = qs('#programOptions');
        if (!list) return;
        list.innerHTML = '';
        let programs = [];
        if (format && format !== 'In-Person') {
          try {
            const data = await airtableList(TABLE_SESSIONS, {
              // Accepts hyphen/space variants via regex match
              filterByFormula: `REGEX_MATCH(LOWER({Format}), '^${formatToRegex(format)}$')`,
              maxRecords: 300,
              sort: [{ field: 'Program', direction: 'asc' }]
            });
            const set = new Set(
              (data.records || [])
                .map(r => r?.fields?.['Program'] || r?.fields?.['Program Name'] || r?.fields?.['Program Title'])
                .filter(Boolean)
            );
            programs = Array.from(set);
            // Inject virtual certificate options so users can see and pick them
            if (format === 'Virtual') {
              const inject = [
                'Certificate in Employee Relations Law',
                'Certificate in Strategic HR Management',
                'Certificate in Workplace Investigations'
              ];
              // Compose derived certificate pairs from component sessions (28-day window)
              const sessions = (data.records || []).map(r => ({
                program: r.fields?.['Program'] || r.fields?.['Program Name'] || r.fields?.['Program Title'],
                start: r.fields?.['Session Start Date'] ? parseAirtableLocal(r.fields['Session Start Date']) : null,
                end: r.fields?.['Session End Date'] ? parseAirtableLocal(r.fields['Session End Date']) : null,
              })).filter(s => s.program && s.start);

              function findPairs(p1, p2) {
                const a = sessions.filter(s => s.program === p1).sort((x,y)=>x.start-y.start);
                const b = sessions.filter(s => s.program === p2).sort((x,y)=>x.start-y.start);
                const pairs = [];
                for (const s1 of a) {
                  const matchingS2 = b.filter(t => t.start && (t.start - s1.start) >= 0 && (t.start - s1.start) <= 28*24*60*60*1000);
                  for (const s2 of matchingS2) {
                    pairs.push({
                      components: [
                        { program: p1, start: s1.start, end: s1.end || s1.start },
                        { program: p2, start: s2.start, end: s2.end || s2.start },
                      ],
                      overallStart: s1.start,
                      overallEnd: s2.end || s2.start,
                    });
                  }
                }
                return pairs;
              }

              const pairs = {};
              const cerlPairs = findPairs('Comprehensive Labor Relations', 'Discrimination Prevention & Risk');
              if (cerlPairs.length > 0) {
                pairs['Certificate in Employee Relations Law'] = cerlPairs;
              }
              const shrmPairs = findPairs('HR Law Fundamentals', 'Strategic HR Leadership');
              if (shrmPairs.length > 0) {
                pairs['Certificate in Strategic HR Management'] = shrmPairs;
              }
              // Workplace Investigations is standalone virtual; no pairing required

              state.virtualCertificatePairs = pairs;
              Object.keys(pairs).forEach(name => { if (!programs.includes(name)) programs.push(name); });
              // Reorder: Certificates first, then prioritized topics, then extras
              const secondaries = [
                'Comprehensive Labor Relations',
                'Discrimination Prevention & Risk',
                'HR Law Fundamentals',
                'Strategic HR Leadership',
                'Employment Law Update'
              ];
              const pinned = inject.filter(n => programs.includes(n));
              const remaining = programs.filter(n => !inject.includes(n));
              const orderedSec = secondaries.filter(n => remaining.includes(n));
              const extras = remaining.filter(n => !secondaries.includes(n));
              programs = Array.from(new Set([...pinned, ...orderedSec, ...extras].map(p => (p||'').trim())));
            }
          } catch (e) {
            console.warn('Failed to load programs for format', format, e);
          }
        } else {
          programs = ALLOWED_PROGRAMS.slice();
        }
        // Build radios
        programs = Array.isArray(programs) ? programs : [];
        programs.forEach(name => {
          const label = document.createElement('label'); label.className = 'option-row';
          const input = document.createElement('input'); input.type = 'radio'; input.name = 'program'; input.value = name;
          let span = document.createElement('span'); span.textContent = name;
          // Add badge for certificates (first three)
          if (format === 'Virtual' && (
            name === 'Certificate in Employee Relations Law' ||
            name === 'Certificate in Strategic HR Management' ||
            name === 'Certificate in Workplace Investigations'
          )) {
            const badge = document.createElement('span'); badge.className = 'badge-cert'; badge.textContent = 'Certificate';
            const wrap = document.createElement('span'); wrap.style.display='inline-flex'; wrap.style.alignItems='center'; wrap.appendChild(span); wrap.appendChild(badge);
            span = wrap; // replace
          }
          label.appendChild(input); label.appendChild(span);
          const onPick = async () => await handleProgramChosen(name);
          label.addEventListener('change', onPick); input.addEventListener('change', onPick);
          list.appendChild(label);
        });
      }

      async function generateVirtualCertificatePairs() {
        if (state.format !== 'Virtual') return;
        
        try {
          const data = await airtableList(TABLE_SESSIONS, {
            filterByFormula: `REGEX_MATCH(LOWER({Format}), '^virtual$')`,
            maxRecords: 300,
            sort: [{ field: 'Program', direction: 'asc' }]
          });
          
          const sessions = (data.records || []).map(r => ({
            program: r.fields?.['Program'] || r.fields?.['Program Name'] || r.fields?.['Program Title'],
            start: r.fields?.['Session Start Date'] ? parseAirtableLocal(r.fields['Session Start Date']) : null,
            end: r.fields?.['Session End Date'] ? parseAirtableLocal(r.fields['Session End Date']) : null,
          })).filter(s => s.program && s.start);

          function findPairs(p1, p2) {
            const a = sessions.filter(s => s.program === p1).sort((x,y)=>x.start-y.start);
            const b = sessions.filter(s => s.program === p2).sort((x,y)=>x.start-y.start);
            const pairs = [];
            for (const s1 of a) {
              const matchingS2 = b.filter(t => t.start && (t.start - s1.start) >= 0 && (t.start - s1.start) <= 28*24*60*60*1000);
              for (const s2 of matchingS2) {
                pairs.push({
                  components: [
                    { program: p1, start: s1.start, end: s1.end || s1.start },
                    { program: p2, start: s2.start, end: s2.end || s2.start },
                  ],
                  overallStart: s1.start,
                  overallEnd: s2.end || s2.start,
                });
              }
            }
            return pairs;
          }

          const pairs = {};
          const cerlPairs = findPairs('Comprehensive Labor Relations', 'Discrimination Prevention & Risk');
          if (cerlPairs.length > 0) {
            pairs['Certificate in Employee Relations Law'] = cerlPairs;
          }
          const shrmPairs = findPairs('HR Law Fundamentals', 'Strategic HR Leadership');
          if (shrmPairs.length > 0) {
            pairs['Certificate in Strategic HR Management'] = shrmPairs;
          }

          state.virtualCertificatePairs = pairs;
        } catch (e) {
          // Failed to generate virtual certificate pairs
        }
      }

      async function handleProgramChosen(programName) {
        state.program = programName; state.sessionRecord = null;
        const details = document.querySelector('#sessionDetails'); if (details) details.textContent = '';
        configureBlocksForProgram(state.program, null);
        // Skip sessions entirely for On-Demand: go straight to contact (step 5)
        if (state.format === 'On-Demand') {
          state.sessionRecord = {
            id: 'ondemand-' + (PROGRAM_MAP[state.program] || state.program),
            fields: {
              'Program': PROGRAM_MAP[state.program] || state.program,
              'Format': 'On Demand',
              'Program Pricing': getProgramPricing(state.program)?.full || state.basePrice || 0,
              'City': 'Virtual Classroom', 'State': ''
            }
          };
          updateReview();
          setStep(5);
          return;
        }
        // If a virtual certificate is selected, show synthesized pairs on Step 4 (do not skip)
        if (state.format === 'Virtual' && VIRTUAL_CERT_PROGRAMS.has(state.program)) {
          let pairs = state.virtualCertificatePairs?.[state.program];
          if (!pairs || pairs.length === 0) {
            // Generate pairs if not already available
            await generateVirtualCertificatePairs();
            pairs = state.virtualCertificatePairs?.[state.program];
          }
          if (pairs && pairs.length > 0) {
            setStep(4);
            return;
          }
        }
        const hasBlocks = programHasBlocks(state.program);
        const mode = (window.demoLoaderMode || '').toLowerCase();
        if (mode === 'overlay') { preloadSessionsThenAdvance(hasBlocks ? 3 : 4); }
        else { loadSessions(state.program, state.format, { silent: true }); advanceAfterDelay(hasBlocks ? 3 : 4); }
      }

      function computeDerivedDates(sessionRecord, program, isFull, selectedBlocks) {
        const fields = sessionRecord?.fields || {};
        const start = fields['Session Start Date'] ? parseAirtableLocal(fields['Session Start Date']) : null;
        const end = fields['Session End Date'] ? parseAirtableLocal(fields['Session End Date']) : null;
        if (!start || !end) return { start, end };
        const bp = blockProgramMap[program];
        if (!bp || isFull || !Array.isArray(selectedBlocks) || selectedBlocks.length === 0) return { start, end };
        const ranges = selectedBlocks.map(b => bp.ranges?.[b]).filter(Boolean);
        if (ranges.length === 0) return { start, end };
        const minStartOffset = Math.min(...ranges.map(r => r[0]));
        const maxEndOffset = Math.max(...ranges.map(r => r[1]));
        const d1 = new Date(start); d1.setDate(d1.getDate() + minStartOffset);
        const d2 = new Date(start); d2.setDate(d2.getDate() + maxEndOffset);
        return { start: d1, end: d2 };
      }

      function computeAmountDue(basePrice, program, isFull, selectedBlocks) {
        const pricing = getProgramPricing(program);
        const hasBlocks = !!blockProgramMap[program];
        if (pricing) {
          if (!hasBlocks || isFull) return Number(pricing.full || 0);
          const blocks = Array.isArray(selectedBlocks) ? selectedBlocks : [];
          if (pricing.blocks) {
            const sum = blocks.reduce((acc, b) => acc + (Number(pricing.blocks[b]) || 0), 0);
            if (sum > 0) return Math.round(sum * 100) / 100;
          }
        }
        // Fallback to proration if no explicit prices are provided
        const bp = blockProgramMap[program];
        if (!bp || isFull) return basePrice;
        const totalDays = (selectedBlocks || []).map(b => bp.days?.[b] || 0).reduce((a,b)=>a+b,0);
        if (totalDays <= 0) return 0;
        const prorated = basePrice * (totalDays / 5);
        return Math.round(prorated * 100) / 100;
      }

      function updateReview() {
        // Handle cases where sessionRecord might be minimal (e.g., On-Demand)
        const f = state.sessionRecord?.fields || {};
        const isFull = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
        const blocks = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
        
        // Compute derived dates if we have a session record, otherwise use state values
        let derived = { start: null, end: null };
        if (state.sessionRecord) {
          derived = computeDerivedDates(state.sessionRecord, state.program, isFull, blocks);
        } else if (state.derivedStart || state.derivedEnd) {
          derived = { start: state.derivedStart, end: state.derivedEnd };
        }
        state.derivedStart = derived.start;
        state.derivedEnd = derived.end;
        
        const pPricing = getProgramPricing(state.program);
        const base = Number((pPricing && pPricing.full) != null ? pPricing.full : (f['Program Pricing'] || state.basePrice || 0));
        state.basePrice = base;
        let subtotal = computeAmountDue(base, state.program, isFull, blocks);
        let upgradeSavings = 0;
        let autoUpgraded = false;
        // Auto-upgrade logic for multiple blocks
        if (!isFull && blocks.length > 1) {
          const prices = (getProgramPricing(state.program)?.blocks) || {};
          const blocksTotal = blocks.reduce((acc, b) => acc + Number(prices[b] || 0), 0);
          if (blocksTotal >= base) {
            autoUpgraded = true;
            upgradeSavings = Math.max(0, blocksTotal - base);
            subtotal = base;
          }
        }
        const discount = state.couponDiscount || 0;
        const due = Math.max(0, Math.round((subtotal - discount) * 100) / 100);
        state.amountDue = due;
        // Populate new review UI
        const loc = f['City'] && f['State'] ? `${f['City']}, ${f['State']}` : (f['City'] || f['State'] || state.format === 'Virtual' ? 'Online' : 'Online Learning Platform');
        const human = formatHumanRange(derived.start, derived.end);
        const attText = isFull ? 'Full Program' : (blocks.join(', ') || 'TBD');

        const setText = (sel, text) => { const el = qs(sel); if (el) el.textContent = text || '—'; };
        
        // Populate registration summary fields
        setText('#revProgram', state.program || '—');
        setText('#revFormat', state.format || '—');
        
        // Update attendance to reflect auto-upgrade in the summary
        if (autoUpgraded) {
          setText('#revAttendance', 'Full Program (auto-upgraded)');
        } else {
          setText('#revAttendance', attText);
        }
        
        // Handle location - show for In-Person, Virtual, and On-Demand appropriately
        if (state.format === 'In-Person') {
          setText('#revLocation', loc || '—');
        } else if (state.format === 'Virtual') {
          setText('#revLocation', 'Live Virtual Classroom');
        } else if (state.format === 'On-Demand') {
          setText('#revLocation', 'Online Learning Platform');
        } else {
          setText('#revLocation', loc || '—');
        }
        
        // Handle dates - show for in-person and virtual
        if (state.format === 'On-Demand') {
          setText('#revDates', 'Available Anytime');
        } else {
          setText('#revDates', human || '—');
        }
        
        // Populate contact information
        const firstNameVal = firstName?.value || state.contactFirstName || '';
        const lastNameVal = lastName?.value || state.contactLastName || '';
        const fullName = `${firstNameVal} ${lastNameVal}`.trim();
        setText('#revName', fullName || '—');
        setText('#revCompany', (company?.value || state.contactCompany || '') || '—');
        setText('#revTitle', (title?.value || state.contactTitle || '') || '—');
        // Simple phone formatting (US)
        const phoneDigits = (phone?.value || state.contactPhone || '').replace(/\D/g,'');
        const phoneFmt = phoneDigits.length === 10 ? `(${phoneDigits.slice(0,3)}) ${phoneDigits.slice(3,6)}-${phoneDigits.slice(6)}` : ((phone?.value || state.contactPhone || '') || '—');
        setText('#revPhone', phoneFmt);
        setText('#revEmail', (email?.value || state.contactEmail || '') || '—');

        // Dynamic pricing rows per selection
        const rowsHost = qs('#revPriceRows');
        if (rowsHost) {
          rowsHost.innerHTML = '';
          const addRow = (label, amount) => {
            const row = document.createElement('div');
            row.className = 'row';
            const l = document.createElement('div'); l.className = 'label'; l.textContent = label;
            const a = document.createElement('div'); a.className = 'amount'; a.textContent = formatCurrency(amount);
            row.appendChild(l); row.appendChild(a); rowsHost.appendChild(row);
          };
          if (isFull) {
            // Show Program Price only when a discount/coupon applies
            if (discount > 0) addRow('Program Price', base);
          } else if (blocks.length === 1) {
            const blk = blocks[0];
            const blkPrice = Number(getProgramPricing(state.program)?.blocks?.[blk] || 0);
            addRow(`${blk} Price`, blkPrice);
          } else if (blocks.length > 1) {
            const p = getProgramPricing(state.program)?.blocks || {};
            let sum = 0;
            blocks.forEach(b => { const v = Number(p[b] || 0); sum += v; addRow(b, v); });
            addRow('Subtotal', sum);
            if (autoUpgraded) {
              const upRow = document.createElement('div');
              upRow.className = 'row success';
              const l = document.createElement('div'); l.className = 'label'; l.textContent = 'Full Program Upgrade';
              const a = document.createElement('div'); a.className = 'amount'; a.textContent = `-${formatCurrency(upgradeSavings)}`;
              upRow.appendChild(l); upRow.appendChild(a); rowsHost.appendChild(upRow);
              const sub = document.createElement('div'); sub.className = 'sublabel';
              // If we can infer remaining blocks, show them specifically
              const bp = getProgramPricing(state.program)?.blocks || {};
              const allBlocks = Object.keys(bp);
              const remaining = allBlocks.filter(b => !blocks.includes(b));
              const remText = remaining.length ? `✓ Includes ${remaining.join(', ')} at no extra cost` : '✓ Includes remaining blocks at no extra cost';
              sub.textContent = remText;
              rowsHost.appendChild(sub);
            }
          } else {
            addRow('Program Price', base);
          }
        }

        // Discount line
        const discountRow = qs('#revDiscountRow');
        const discountLabel = qs('#revDiscountLabel');
        const discountAmountEl = qs('#revDiscount');
        if (discountRow && discountLabel && discountAmountEl) {
          if (discount > 0) {
            const codeTxt = (state.coupon?.fields?.['Coupon Code'] || couponCode.value.trim() || '').toUpperCase();
            discountLabel.textContent = codeTxt ? `Discount (${codeTxt})` : 'Discount';
            discountAmountEl.textContent = `-${formatCurrency(discount)}`;
            discountRow.classList.remove('hidden');
            discountRow.classList.add('discount');
          } else {
            discountRow.classList.add('hidden');
          }
        }

        // Divider before total always visible
        const preTotal = qs('#preTotalDivider');
        if (preTotal) preTotal.style.display = 'block';

        amountDueEl.textContent = formatCurrency(due);

        // Smart savings note visibility
        const upgradeNote = qs('#upgradeNote');
        if (upgradeNote) upgradeNote.style.display = autoUpgraded ? 'block' : 'none';
      }

      function populateConfirmationPage() {
        if (!state.sessionRecord) return;
        const f = state.sessionRecord.fields || {};
        const isFull = state.attendanceType === 'Full' || state.attendanceType === 'F';
        const blocks = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
        const derived = computeDerivedDates(state.sessionRecord, state.program, isFull, blocks);
        const human = formatHumanRange(derived.start, derived.end);
        const loc = f['City'] && f['State'] ? `${f['City']}, ${f['State']}` : (f['City'] || f['State'] || 'Online');
        const participantName = `${firstName?.value || ''} ${lastName?.value || ''}`.trim() || '—';
        const participantEmail = email?.value || '—';
        
        const setText = (sel, text) => { const el = qs(sel); if (el) el.textContent = text || '—'; };
        
        // Update header subtitle
        const confProgramSpan = qs('#confProgram');
        if (confProgramSpan) {
          confProgramSpan.textContent = state.program || 'program';
        }
        
        // Update format badge
        const formatBadge = qs('#confFormatBadge');
        if (formatBadge) {
          let formatText = state.format || 'In-Person';
          // Convert to uppercase with hyphen preserved
          formatText = formatText.toUpperCase();
          formatBadge.textContent = formatText;
        }
        
        // Populate confirmation summary
        setText('#confParticipant', participantName);
        setText('#confEmail', participantEmail);
        setText('#confProgramName', state.program || '—');
        setText('#confDates', human);
        setText('#confLocation', loc);
        setText('#confEnrollmentFee', formatCurrency(state.amountDue || 0));
      }

      function validateContact(renderErrors = false) {
        const errs = {};
        
        const fn = firstName.value.trim();
        const ln = lastName.value.trim();
        const ph = phone.value.replace(/\D/g,'');
        const em = email.value.trim();
        
        if (fn.length < 2) errs.firstName = '⚠ First name is required';
        if (ln.length < 2) errs.lastName = '⚠ Last name is required';
        if (ph.length !== 10) errs.phone = '⚠ Please enter a valid phone number';
        if (!em || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em)) errs.email = '⚠ Please enter a valid email';
        
        // Render inline errors only when requested
        if (renderErrors) {
          renderFieldError('#firstName', errs.firstName);
          renderFieldError('#lastName', errs.lastName);
          renderFieldError('#phone', errs.phone);
          renderFieldError('#email', errs.email);
        }
        return Object.keys(errs).length ? 'Invalid form' : '';
      }

      function renderFieldError(selector, msg) {
        const input = qs(selector);
        if (!input) return;
        let err = input.nextElementSibling && input.nextElementSibling.classList?.contains('field-error') ? input.nextElementSibling : null;
        if (!err) {
          err = document.createElement('div');
          err.className = 'field-error';
          input.parentElement.appendChild(err);
        }
        err.textContent = msg || '';
        err.style.display = msg ? 'block' : 'none';
        if (msg) err.style.color = '#EF4444';
        err.style.fontSize = '14px';
        err.style.marginTop = '6px';
      }

      function cityCode(city) { return (city || '').replace(/[^A-Za-z]/g,'').substring(0,2).toUpperCase() || 'XX'; }
      function monthYY(date) { if (!date) return '0000'; const mm = (date.getMonth()+1).toString().padStart(2,'0'); const yy = date.getFullYear().toString().slice(-2); return `${mm}${yy}`; }

      function buildRegistrationCode() {
        const fCode = formatCodeMap[state.format] || 'NA';
        const pInfo = blockProgramMap[state.program];
        const pCode = pInfo?.code || programCodeFallback(state.program);
        const isFull = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
        const blocks = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
        const blockDigits = blocks.map(b => (b.match(/\d+/) || [''])[0]).filter(Boolean).sort().join('');
        const blockCode = isFull ? 'F' : (blockDigits || 'X');
        const fields = state.sessionRecord?.fields || {};
        const cCode = cityCode(fields['City'] || 'Online');
        const mmyy = monthYY(state.derivedStart || (fields['Session Start Date'] ? parseAirtableLocal(fields['Session Start Date']) : null));
        return `${fCode}-${pCode}${blockCode}-${cCode}-${mmyy}`;
      }

      async function applyCoupon() {
        // If a coupon is already applied, clicking the button removes it
        if (state.coupon) {
          state.coupon = null;
          state.couponDiscount = 0;
          couponMsg.textContent = '';
          couponMsg.classList.remove('text-success', 'text-danger');
          updateCouponUI();
          updateReview();
          return;
        }

        const code = couponCode.value.trim().slice(0, 20);
        if (!code) { couponMsg.textContent = 'Enter a coupon code'; return; }
        couponMsg.textContent = '';
        couponSpinner.classList.remove('hidden');
        applyCouponBtn.disabled = true; const prevLabel = applyCouponBtn.textContent; applyCouponBtn.textContent = 'Applying...';
        try {
          const filter = `LOWER({Coupon Code})='${code.toLowerCase().replace(/'/g, "\\'")}'`;
          const data = await airtableList(TABLE_COUPONS, { filterByFormula: filter, maxRecords: 1 });
          const rec = (data.records || [])[0];
          // If not found in Airtable, still allow rule-based codes below
          if (!rec) {
            const isFullNow = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
            const blocksNow = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
            const baseForCalc = Number((getProgramPricing(state.program)?.full) ?? (state.basePrice || Number(state.sessionRecord?.fields?.['Program Pricing'] || 0)));
            const subtotal = computeAmountDue(baseForCalc, state.program, isFullNow, blocksNow);
            const ruleCheck = applyCouponRules(code, state.program, isFullNow, blocksNow.length);
            if (ruleCheck && ruleCheck.valid) {
              const amount = Number(ruleCheck.amount || 0);
              const dtype = String(ruleCheck.type || 'Flat');
              const discount = dtype.toLowerCase() === 'percent' ? Math.round(subtotal * (amount/100) * 100)/100 : amount;
              state.coupon = { id: null, fields: { 'Coupon Code': ruleCheck.code } };
              state.couponDiscount = Math.min(discount, subtotal);
              couponMsg.textContent = `✓ Coupon applied! You'll see your discount on the next page.`;
              couponMsg.classList.remove('text-danger'); couponMsg.classList.add('text-success');
              updateCouponUI();
              updateReview();
              return;
            }
            couponMsg.textContent = 'Invalid coupon.'; couponMsg.classList.remove('text-success'); couponMsg.classList.add('text-danger'); state.coupon = null; state.couponDiscount = 0; updateReview(); return;
          }
          const fields = rec.fields || {};
          // Robust Active flag handling: checkbox, single select, or alt field names
          const activeField =
            fields['Active?'] ??
            fields['Active'] ??
            fields['Is Active'] ??
            fields['active'] ??
            fields['is_active'];
          const activeText = (activeField && typeof activeField === 'object')
            ? (activeField.name ?? activeField.value ?? activeField.label ?? '')
            : activeField;
          const truthy = new Set(['true','yes','active','1','y','enabled','on']);
          const isActive = (activeText === true) || truthy.has(String(activeText).trim().toLowerCase());
          const exp = fields['Expiration Date'] ? new Date(fields['Expiration Date']) : null;
          const today = new Date(); today.setHours(0,0,0,0);
          if (!isActive) { couponMsg.textContent = 'Coupon inactive.'; couponMsg.classList.add('text-danger'); state.coupon = null; state.couponDiscount = 0; updateReview(); return; }
          if (exp && exp < today) { couponMsg.textContent = 'Coupon expired.'; couponMsg.classList.add('text-danger'); state.coupon = null; state.couponDiscount = 0; updateReview(); return; }
          // Validate program applicability if possible
          const applies = couponAppliesToProgram(rec, state.program);
          if (!applies) { couponMsg.textContent = 'Coupon not valid for selected program.'; couponMsg.classList.add('text-danger'); state.coupon = null; state.couponDiscount = 0; updateReview(); return; }
          // Enforce rule overrides (PP500/PP300/PP100)
          const isFullNow = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
          const blocksNow = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
          const baseForCalc = Number((getProgramPricing(state.program)?.full) ?? (state.basePrice || Number(state.sessionRecord?.fields?.['Program Pricing'] || 0)));
          const subtotal = computeAmountDue(baseForCalc, state.program, isFullNow, blocksNow);
          const ruleCheck = applyCouponRules(code, state.program, isFullNow, blocksNow.length);
          let amount = Number(fields['Discount Amount'] || 0);
          let dtype = String(fields['Discount Type'] || 'Flat');
          if (ruleCheck) {
            if (!ruleCheck.valid) { couponMsg.textContent = ruleCheck.reason || 'Coupon not applicable for this selection.'; couponMsg.classList.add('text-danger'); state.coupon = null; state.couponDiscount = 0; updateReview(); return; }
            amount = Number(ruleCheck.amount || amount);
            dtype = String(ruleCheck.type || dtype);
          }
          const discount = dtype.toLowerCase() === 'percent' ? Math.round(subtotal * (amount/100) * 100)/100 : amount;
          state.coupon = rec;
          state.couponDiscount = Math.min(discount, subtotal);
          couponMsg.textContent = `✓ Coupon applied! You'll see your discount on the next page.`;
          couponMsg.classList.remove('text-danger'); couponMsg.classList.add('text-success');
          updateCouponUI();
          updateReview();
        } catch (err) {
          console.error(err);
          couponMsg.textContent = 'Error validating coupon.';
          couponMsg.classList.remove('text-success'); couponMsg.classList.add('text-danger');
        } finally {
          couponSpinner.classList.add('hidden');
          applyCouponBtn.disabled = false; applyCouponBtn.textContent = state.coupon ? 'Remove' : prevLabel;
        }
      }

      function updateCouponUI() {
        const applied = !!state.coupon;
        couponCode.disabled = applied;
        applyCouponBtn.textContent = applied ? 'Remove' : 'Apply Coupon';
      }

      function couponAppliesToProgram(couponRecord, programName) {
        const f = couponRecord?.fields || {};
        // Attempt direct check via a possible text/lookup field of program names
        const possibleFields = Object.keys(f).filter(k => /valid program/i.test(k));
        for (const key of possibleFields) {
          const val = f[key];
          if (Array.isArray(val)) {
            // Can be array of names or linked IDs; try names
            if (val.some(v => String(v).toLowerCase().includes(programName.toLowerCase()))) return true;
          } else if (typeof val === 'string') {
            if (val.toLowerCase().includes(programName.toLowerCase())) return true;
          }
        }
        // If we cannot determine, default to true to avoid blocking valid coupons
        return true;
      }

      // Confirmation Modal Functions
      
      function showContentByFormat(format) {
        // Normalize format
        const normalizedFormat = String(format || 'in-person').toLowerCase().replace(/\s+/g, '-');
        
        // Get all elements with data-show-if attribute
        const conditionalElements = document.querySelectorAll('[data-show-if]');
        
        conditionalElements.forEach(element => {
          const showFor = element.getAttribute('data-show-if').split(',').map(f => f.trim().toLowerCase());
          
          if (showFor.includes(normalizedFormat)) {
            element.classList.add('visible');
            // Set display based on element type
            if (element.classList.contains('detail-row') || element.classList.contains('step-card')) {
              element.style.display = 'flex';
            } else {
              element.style.display = 'block';
            }
          } else {
            element.classList.remove('visible');
            element.style.display = 'none';
          }
        });
        
        console.log(`✓ Confirmation content adjusted for: ${normalizedFormat}`);
      }
      
      function updateConfirmationFormatBadge(format) {
        const badge = document.getElementById('formatBadgeConf');
        if (!badge) return;
        
        const formatMap = {
          'in-person': 'IN-PERSON',
          'virtual': 'VIRTUAL',
          'on-demand': 'ON-DEMAND'
        };
        
        const normalizedFormat = String(format || 'in-person').toLowerCase().replace(/\s+/g, '-');
        badge.textContent = formatMap[normalizedFormat] || 'IN-PERSON';
      }
      
      function calculateConfirmationInfoSendDate(programStartDate) {
        if (!programStartDate) return 'soon';
        
        try {
          // Use parseAirtableLocal to avoid timezone issues
          const start = parseAirtableLocal(programStartDate);
          if (!start || isNaN(start.getTime())) return 'soon';
          
          // Calculate 7 days before
          const infoDate = new Date(start);
          infoDate.setDate(infoDate.getDate() - 7);
          
          // Format as "Month Day, Year"
          const options = { year: 'numeric', month: 'long', day: 'numeric' };
          return infoDate.toLocaleDateString('en-US', options);
        } catch (e) {
          console.warn('Error calculating info send date:', e);
          return 'soon';
        }
      }
      
      function replaceConfirmationInfoSendDates(format) {
        const normalizedFormat = String(format || 'in-person').toLowerCase().replace(/\s+/g, '-');
        
        // Only for in-person and virtual
        if (normalizedFormat !== 'in-person' && normalizedFormat !== 'virtual') return;
        
        // Get start date from state
        const startDate = state.derivedStart ? formatYMDLocal(state.derivedStart) : 
                         (state.sessionRecord?.fields?.['Session Start Date'] || null);
        
        if (!startDate) return;
        
        const calculatedDate = calculateConfirmationInfoSendDate(startDate);
        
        // Replace all {{info_send_date}} placeholders or .info-date elements
        document.querySelectorAll('.info-date').forEach(el => {
          el.textContent = calculatedDate;
        });
      }
      
      function populateConfirmationData() {
        // Get form values - prioritize state values (stored before modal closes)
        // Then try DOM queries as fallback
        const firstNameInput = document.querySelector('#iamlModalOverlay #firstName') || document.querySelector('#firstName');
        const lastNameInput = document.querySelector('#iamlModalOverlay #lastName') || document.querySelector('#lastName');
        const emailInput = document.querySelector('#iamlModalOverlay #email') || document.querySelector('#email');
        
        // Get values from state first (most reliable), then DOM, then fallback variables
        const fn = state.contactFirstName || firstNameInput?.value || firstName?.value || '';
        const ln = state.contactLastName || lastNameInput?.value || lastName?.value || '';
        const em = state.contactEmail || emailInput?.value || email?.value || '';
        
        console.log('📝 Populating confirmation data:', {
          firstName: fn,
          lastName: ln,
          email: em,
          fromState: {
            firstName: state.contactFirstName,
            lastName: state.contactLastName,
            email: state.contactEmail
          }
        });
        const prog = state.program || 'Certificate in Employee Relations Law';
        const price = formatCurrency(state.amountDue || 0);
        
        // Populate participant info - use querySelectorAll to update ALL elements with these IDs (duplicates exist)
        const confirmationModal = document.getElementById('confirmationOverlay');
        const modalScope = confirmationModal || document;
        
        // Update all elements with each ID (there are duplicates in the HTML)
        const nameText = `${fn} ${ln}`.trim() || '—';
        const emailText = em || '—';
        
        modalScope.querySelectorAll('#confName').forEach(el => {
          el.textContent = nameText;
          el.innerText = nameText;
        });
        
        modalScope.querySelectorAll('#confEmail').forEach(el => {
          el.textContent = emailText;
          el.innerText = emailText;
        });
        
        modalScope.querySelectorAll('#confProgram').forEach(el => {
          el.textContent = prog;
          el.innerText = prog;
        });
        
        modalScope.querySelectorAll('#confPrice').forEach(el => {
          el.textContent = price;
          el.innerText = price;
        });
        
        console.log('✅ Set all confirmation elements:', {
          name: nameText,
          email: emailText,
          program: prog,
          price: price,
          nameCount: modalScope.querySelectorAll('#confName').length,
          emailCount: modalScope.querySelectorAll('#confEmail').length
        });
        
        // Update subtitle with program name
        const subtitleEl = document.getElementById('confirmationSubtitle');
        if (subtitleEl) {
          subtitleEl.innerHTML = `Your spot in the ${prog} is almost confirmed.<br>See below for next steps to finalize your enrollment.`;
        }
        
        // Populate dates (for in-person and virtual) - check multiple sources, update ALL duplicates
        let dateText = '—';
        
        // Try derived dates first (these account for block selections)
        if (state.derivedStart && state.derivedEnd) {
          dateText = formatHumanRange(state.derivedStart, state.derivedEnd);
          console.log('📅 Using derived dates:', dateText);
        } 
        // If derived dates not available but we have sessionRecord, compute them
        else if (state.sessionRecord?.fields) {
          // Compute derived dates accounting for block selection
          const isFull = state.attendanceType === 'Full' || state.attendanceType === 'F';
          const blocks = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
          const computed = computeDerivedDates(state.sessionRecord, state.program, isFull, blocks);
          
          if (computed.start && computed.end) {
            dateText = formatHumanRange(computed.start, computed.end);
            // Store computed dates in state for next time
            state.derivedStart = computed.start;
            state.derivedEnd = computed.end;
            console.log('📅 Computed dates from sessionRecord:', dateText);
          } else {
            // Fallback to raw sessionRecord dates
            const startDate = state.sessionRecord.fields['Session Start Date'];
            const endDate = state.sessionRecord.fields['Session End Date'];
            console.log('📅 SessionRecord dates:', { startDate, endDate });
            if (startDate && endDate) {
              const start = parseAirtableLocal(startDate);
              const end = parseAirtableLocal(endDate);
              if (start && end) {
                dateText = formatHumanRange(start, end);
                console.log('📅 Formatted from sessionRecord:', dateText);
              }
            } else if (startDate) {
              const start = parseAirtableLocal(startDate);
              if (start) {
                dateText = formatHumanRange(start, start);
                console.log('📅 Single date from sessionRecord:', dateText);
              }
            }
          }
        }
        // Fallback to dates stored in state
        else if (state.startDate || state.endDate) {
          const start = state.startDate ? (typeof state.startDate === 'string' ? parseAirtableLocal(state.startDate) : state.startDate) : null;
          const end = state.endDate ? (typeof state.endDate === 'string' ? parseAirtableLocal(state.endDate) : state.endDate) : null;
          if (start || end) {
            dateText = formatHumanRange(start, end);
            console.log('📅 Using state dates:', dateText);
          }
        }
        
        if (dateText === '—') {
          console.warn('⚠️ No dates found for confirmation modal');
        }
        
        // Update ALL elements with confDates ID (duplicates exist)
        modalScope.querySelectorAll('#confDates').forEach(el => {
          el.textContent = dateText;
          el.innerText = dateText;
        });
        
        console.log('✅ Set all confDates to:', dateText, `(${modalScope.querySelectorAll('#confDates').length} elements)`);
        
        // Populate location - check multiple sources, update ALL duplicates
        let locationText = '—';
        
        if (state.format === 'Virtual') {
          locationText = 'Live Virtual Classroom';
          console.log('📍 Virtual format - using:', locationText);
        } else if (state.format === 'On-Demand') {
          locationText = 'Online Learning Platform';
          console.log('📍 On-Demand format - using:', locationText);
        } 
        // Prioritize state values (stored before modal closes)
        else if (state.city || state.state) {
          const city = state.city || '';
          const stateValue = state.state || '';
          console.log('📍 State location values:', { city, state: stateValue });
          if (city || stateValue) {
            locationText = `${city}${city && stateValue ? ', ' : ''}${stateValue}`;
            console.log('📍 Formatted from state:', locationText);
          }
        }
        // Fallback to sessionRecord
        else if (state.sessionRecord?.fields) {
          const city = state.sessionRecord.fields['City'] || '';
          const stateValue = state.sessionRecord.fields['State'] || '';
          console.log('📍 SessionRecord location:', { city, state: stateValue });
          if (city || stateValue) {
            locationText = `${city}${city && stateValue ? ', ' : ''}${stateValue}`;
            console.log('📍 Formatted location:', locationText);
          }
        }
        
        if (locationText === '—') {
          console.warn('⚠️ No location found for confirmation modal');
        }
        
        // Update ALL elements with confLocation ID (duplicates exist)
        modalScope.querySelectorAll('#confLocation').forEach(el => {
          el.textContent = locationText;
          el.innerText = locationText;
        });
        
        console.log('✅ Set all confLocation to:', locationText, `(${modalScope.querySelectorAll('#confLocation').length} elements)`);
      }
      
      function showConfirmationModal() {
        try {
          console.log('📋 Showing confirmation modal with format:', state.format);
          console.log('📋 State data available:', {
            hasSessionRecord: !!state.sessionRecord,
            derivedStart: state.derivedStart,
            derivedEnd: state.derivedEnd,
            contactEmail: state.contactEmail,
            city: state.city,
            state: state.state
          });
          
          // Close registration modal first
          closeModal();
          
          // Scroll everything to top FIRST (before showing modal)
          window.scrollTo({ top: 0, behavior: 'instant' });
          document.body.style.overflow = 'hidden';
          
          // Show the overlay
          const overlay = document.getElementById('confirmationOverlay');
          if (overlay) {
            // Reset scroll positions before showing
            overlay.scrollTop = 0;
            
            // Show the modal - remove inline style first, then set aria-hidden to false
            // This will trigger the CSS selector .confirmation-overlay[aria-hidden="false"]
            overlay.removeAttribute('style');
            overlay.setAttribute('aria-hidden', 'false');
            
            // Populate data AFTER modal is shown (so elements are in DOM)
            // Use requestAnimationFrame to ensure DOM is ready
            requestAnimationFrame(() => {
              // Populate all confirmation data
              populateConfirmationData();
              
              // Update format badge
              updateConfirmationFormatBadge(state.format);
              
              // Show/hide content based on format
              showContentByFormat(state.format);
              
              // Replace info send dates
              replaceConfirmationInfoSendDates(state.format);
              
              // Force scroll reset after display (double-check)
              window.scrollTo({ top: 0, behavior: 'instant' });
              overlay.scrollTop = 0;
              
              // Scroll modal content to top
              const modal = overlay.querySelector('.confirmation-modal');
              if (modal) {
                modal.scrollTop = 0;
              }
              
              // Double-check population after a brief delay (in case of timing issues)
              setTimeout(() => {
                populateConfirmationData();
                console.log('✅ Confirmation modal displayed and data populated');
              }, 50);
            });
          } else {
            console.error('❌ Confirmation overlay element not found');
          }
          
          console.log('✅ Confirmation modal displayed');
        } catch (error) {
          console.error('Error showing confirmation modal:', error);
          // Fallback to redirect
          window.location.href = 'https://www.iaml.com/thank-you';
        }
      }
      
      function closeConfirmationModal() {
        const overlay = document.getElementById('confirmationOverlay');
        if (overlay) {
          overlay.setAttribute('aria-hidden', 'true');
          // Set inline style to ensure it's hidden
          overlay.style.cssText = 'display: none !important;';
        }
        // Restore scrolling
        document.body.style.overflow = '';
        console.log('✓ Confirmation modal closed');
      }

      async function submitRegistration() {
        state.showFieldErrors = true;
        const contactErr = validateContact(true);
        if (contactErr) { showGlobalMessage(contactErr, true); return; }
        showGlobalMessage('Submitting registration...');
        globalSpinner.classList.remove('hidden');
        submitBtn.disabled = true;
        const f = state.sessionRecord?.fields || {};
        const isFullForSubmit = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
        const blocksForSubmit = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
        const derived = computeDerivedDates(state.sessionRecord, state.program, isFullForSubmit, blocksForSubmit);
        const due = state.amountDue;
        const registrationCode = buildRegistrationCode();
        const payload = {
          first_name: firstName.value.trim(),
          last_name: lastName.value.trim(),
          title: title.value.trim(),
          company_name: company.value.trim(),
          phone: phone.value.trim(),
          email: email.value.trim(),
          selected_program: state.program,
          program_format: state.format,
          selected_location: (f['City'] && f['State']) ? `${f['City']}, ${f['State']}` : (f['City'] || f['State'] || 'Online'),
          program_start_date: derived.start ? formatYMDLocal(derived.start) : (f['Session Start Date'] || ''),
          program_end_date: derived.end ? formatYMDLocal(derived.end) : (f['Session End Date'] || ''),
          attendance_type__3_block_programs: state.attendanceType === 'F' ? 'Full' : state.attendanceType,
          coupon_code_used: state.coupon ? (state.coupon.fields?.['Coupon Code'] || couponCode.value.trim()) : '',
          discount_amount: Number(state.couponDiscount || 0),
          registration_code: registrationCode,
          amount_due: Number(due || 0),
        };
        try {
          const res = await fetch(GHL_WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if (!res.ok) throw new Error(`Webhook error ${res.status}`);
          // Increment coupon usage if applicable
          if (state.coupon) {
            try {
              if (state.coupon.id) {
                const currentTimes = Number(state.coupon.fields?.['Times Used'] || 0);
                await airtablePatch(TABLE_COUPONS, state.coupon.id, { 'Times Used': currentTimes + 1 });
              } else {
                // Attempt to find the record by code and increment
                const codeToInc = (state.coupon.fields?.['Coupon Code'] || couponCode.value || '').trim();
                if (codeToInc) {
                  const filter = `LOWER({Coupon Code})='${codeToInc.toLowerCase().replace(/'/g, "\\'")}'`;
                  const data = await airtableList(TABLE_COUPONS, { filterByFormula: filter, maxRecords: 1 });
                  const rec = (data.records || [])[0];
                  if (rec && rec.id) {
                    const currentTimes = Number(rec.fields?.['Times Used'] || 0);
                    await airtablePatch(TABLE_COUPONS, rec.id, { 'Times Used': currentTimes + 1 });
                  }
                }
              }
            } catch (e) { console.warn('Failed to increment coupon usage', e); }
          }
          showGlobalMessage('');
          
          // Store form values in state before closing modal (so confirmation modal can access them)
          state.contactFirstName = firstName?.value?.trim() || '';
          state.contactLastName = lastName?.value?.trim() || '';
          state.contactEmail = email?.value?.trim() || '';
          state.contactPhone = phone?.value?.trim() || '';
          state.contactTitle = title?.value?.trim() || '';
          state.contactCompany = company?.value?.trim() || '';
          
          // Store location and dates in state for confirmation
          if (state.sessionRecord?.fields) {
            state.city = state.sessionRecord.fields['City'] || '';
            state.state = state.sessionRecord.fields['State'] || '';
            state.startDate = state.sessionRecord.fields['Session Start Date'] || null;
            state.endDate = state.sessionRecord.fields['Session End Date'] || null;
          }
          
          // Ensure derived dates are stored
          if (derived.start) state.derivedStart = derived.start;
          if (derived.end) state.derivedEnd = derived.end;
          
          // Close registration modal and show confirmation modal
          closeModal();
          // Show confirmation modal with delay for smooth transition
          setTimeout(() => {
            showConfirmationModal();
          }, 300);
        } catch (err) {
          showGlobalMessage('Submission failed. Please try again.', true);
        } finally {
          globalSpinner.classList.add('hidden');
          submitBtn.disabled = false;
        }
      }

      function onSessionChange(id) {
        state.sessionId = id;
        state.sessionRecord = null;
        state.basePrice = 0;
        state.couponDiscount = 0;
        discountLine.classList.add('hidden');
        couponMsg.textContent = '';
      }

      async function hydrateSelectedSession() {
        if (!state.sessionId) return;
        // Bypass Airtable fetch for synthesized sessions (e.g., virtual certificates / on-demand)
        try {
          const sid = String(state.sessionId || '');
          const isSynthetic = sid.startsWith('virtualcert:') || sid.startsWith('ondemand:') || !/^rec/.test(sid);
          if (isSynthetic) {
            const rec = state.sessionRecord || { id: sid, fields: {
              Program: state.program,
              Format: state.format,
              'Program Pricing': getProgramPricing(state.program)?.full || 0,
              City: state.format === 'Virtual' ? 'Online' : (state.sessionRecord?.fields?.City || ''),
              State: state.sessionRecord?.fields?.State || '',
              'Session Start Date': state.sessionRecord?.fields?.['Session Start Date'] || '',
              'Session End Date': state.sessionRecord?.fields?.['Session End Date'] || ''
            } };
            state.sessionRecord = rec;
            const hardBase = getProgramPricing(state.program)?.full;
            const price = Number(hardBase != null ? hardBase : (rec.fields?.['Program Pricing'] || 0));
            state.basePrice = price;
            const detailsEl = qs('#sessionDetails');
            if (detailsEl) {
              const label = formatSessionLabel(rec);
              detailsEl.textContent = `${label} • Base Price ${formatCurrency(price)}`;
            }
            showGlobalMessage('');
            updateReview();
            return;
          }
        } catch (_) { /* fall through to normal fetch */ }
        try {
          showGlobalMessage('Loading session details...');
          globalSpinner.classList.remove('hidden');
          const url = `https://api.airtable.com/v0/${encodeURIComponent(AIRTABLE_BASE_ID)}/${encodeURIComponent(TABLE_SESSIONS)}/${encodeURIComponent(state.sessionId)}`;
          const res = await fetch(url, { headers: { Authorization: `Bearer ${AIRTABLE_API_KEY}` } });
          if (!res.ok) throw new Error('Failed to load session details');
          const rec = await res.json();
          state.sessionRecord = rec;
          configureBlocksForProgram(state.program, state.sessionRecord);
          const label = formatSessionLabel(rec);
          const hardBase = getProgramPricing(state.program)?.full;
          const price = Number(hardBase != null ? hardBase : (rec.fields?.['Program Pricing'] || 0));
          state.basePrice = price;
          // Derived date display when blocks are selected (guard for missing details element)
          const isFull = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || state.attendanceType === 'Full';
          const blocks = Array.isArray(state.attendanceBlocks) ? state.attendanceBlocks : [];
          const derivedDates = computeDerivedDates(rec, state.program, isFull, blocks);
          const rangeDetails = formatRangeOrSingle(derivedDates.start, derivedDates.end);
          const city = rec.fields?.['City'] || '';
          const st = rec.fields?.['State'] || '';
          const cityState = city && st ? `${city}, ${st}` : (city || st || 'Online');

          const detailsEl = qs('#sessionDetails');
          if (detailsEl) {
            if (!isFull && blocks.length > 0 && rangeDetails) {
              detailsEl.textContent = `${formatHumanRange(derivedDates.start, derivedDates.end)} — ${cityState} • Base Price ${formatCurrency(price)}`;
            } else {
              detailsEl.textContent = `${label} • Base Price ${formatCurrency(price)}`;
            }
          }
          showGlobalMessage('');
          updateReview();
        } catch (err) {
          showGlobalMessage('Could not load session details.', true);
        } finally {
          globalSpinner.classList.add('hidden');
        }
      }

      function advance() {
        if (state.step === 1) {
          const selectedFormat = (document.querySelector('input[name="format"]:checked')?.value) || (formatSelect ? formatSelect.value : '');
          if (!selectedFormat) { showGlobalMessage('Please select a format.', true); return; }
          state.format = selectedFormat;
          subTitle.textContent = `${state.format} registration`;
          setStep(2);
        } else if (state.step === 2) {
          const selectedProgram = (document.querySelector('input[name="program"]:checked')?.value) || (programSelect ? programSelect.value : '');
          if (!selectedProgram) { showGlobalMessage('Please select a program.', true); return; }
          state.program = selectedProgram;
          showGlobalMessage('');
          setStep(3);
          // Show block options immediately based on program defaults
          configureBlocksForProgram(state.program, null);
          // Load sessions immediately (needed by Step 4 and URL builder)
          loadSessions(state.program, state.format, { silent: true });
        } else if (state.step === 3) {
          const hasSelection = (document.querySelector('input[name="attendanceTypeFull"]')?.checked) || Array.from(document.querySelectorAll('input[name="attendanceBlocks"]')).some(c => c.checked);
          if (!hasSelection) { showGlobalMessage('Please select your attendance preference', true); return; }
          showGlobalMessage('');
          setStep(4);
        } else if (state.step === 4) {
          // Timeline selection: require a selected session card
          if (!state.sessionId) { showGlobalMessage('Please select a session.', true); return; }
          showGlobalMessage('');
          setStep(5);
          // Final cleanup to ensure Step 5 is completely clean
          setTimeout(() => {
            const s5 = qs('#step5');
            if (s5) {
              s5.querySelectorAll('input[name="attendanceTypeFull"], input[name="attendanceBlocks"], .option-row, #attendanceOptions').forEach(el => el.remove());
            }
          }, 50);
          hydrateSelectedSession();
        } else if (state.step === 5) {
          const err = validateContact();
          if (err) { showGlobalMessage(err, true); return; }
          showGlobalMessage('');
          updateReview();
          setStep(6);
        }
      }

      function back() {
        if (state.step > 1) setStep(state.step - 1);
      }

      // Event listeners
      if (openModalBtn) openModalBtn.addEventListener('click', openModal);
      // Use event delegation for registerModalBtn to work with dynamically added buttons
      document.addEventListener('click', function(e) {
        const target = e.target.closest('#registerModalBtn');
        if (target) {
          e.preventDefault();
          e.stopPropagation();
          openModal();
        }
      });
      closeModalBtn.addEventListener('click', closeModal);
      // Add event listeners for confirmation modal close buttons (both top X and bottom Close button)
      // Use querySelectorAll to get all buttons that should close the confirmation modal
      const closeConfirmationBtns = document.querySelectorAll('#closeConfirmationBtn, #closeConfirmationBtnTop');
      closeConfirmationBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          closeConfirmationModal();
        });
      });
      
      // Also use event delegation for dynamically added buttons (in case modal is added later)
      document.addEventListener('click', function(e) {
        if (e.target && (e.target.id === 'closeConfirmationBtn' || e.target.id === 'closeConfirmationBtnTop')) {
          e.preventDefault();
          e.stopPropagation();
          closeConfirmationModal();
        }
      });
      nextBtn.addEventListener('click', advance);
      backBtn.addEventListener('click', back);
      submitBtn.addEventListener('click', submitRegistration);
      if (formatSelect) formatSelect.addEventListener('change', async () => {
        state.format = formatSelect.value; subTitle.textContent = `${state.format} registration`;
        await loadProgramsForFormat(state.format);
        advanceAfterDelay(2);
      });
      getFormatRadios().forEach(r => r.addEventListener('change', async (e) => {
        state.format = e.target.value; subTitle.textContent = `${state.format} registration`;
        await loadProgramsForFormat(state.format);
        advanceAfterDelay(2);
      }));
      programSelect && programSelect.addEventListener('change', async () => await handleProgramChosen(programSelect.value));
      getProgramRadios().forEach(r => r.addEventListener('change', async () => await handleProgramChosen(r.value)));
      if (sessionSelect) {
        sessionSelect.addEventListener('change', () => { onSessionChange(sessionSelect.value); hydrateSelectedSession(); advanceAfterDelay(5); });
      }
      // Attendance selection logic (Full vs blocks)
      function fullRadio() { return document.querySelector('input[name="attendanceTypeFull"]'); }
      function blockChecks() { return Array.from(document.querySelectorAll('input[name="attendanceBlocks"]')); }
      function computeAttendanceFromUI() {
        if (fullRadio() && fullRadio().checked) return { kind: 'full', blocks: [] };
        const chosen = blockChecks().filter(c => c.checked).map(c => c.value);
        return { kind: chosen.length ? 'blocks' : 'none', blocks: chosen };
      }
      function updateNextEnabled() {
        if (state.step === 3) {
          const hasAttendance = (fullRadio()?.checked) || blockChecks().some(c => c.checked);
          nextBtn.disabled = !hasAttendance;
          return;
        }
        if (state.step === 4) {
          nextBtn.disabled = !state.sessionId;
          return;
        }
        if (state.step === 5) {
          // Only validate if we're actually on step 5 and form is visible
          const step5 = qs('#step5');
          if (step5 && !step5.classList.contains('hidden')) {
            // Disable until contact form is valid (silent check)
            const err = validateContact(false);
            nextBtn.disabled = !!err;
          } else {
            // If step 5 is hidden, don't validate
            nextBtn.disabled = false;
          }
          return;
        }
        nextBtn.disabled = false;
      }
      function onAttendanceChange() {
        const att = computeAttendanceFromUI();
        state.attendanceBlocks = att.blocks;
        state.attendanceType = att.kind === 'full' ? 'Full' : (att.blocks.join(', ') || state.attendanceType);
        syncFullRadio();
        updateReview();
        updateNextEnabled();
      }
      function anyBlockChecked() { return blockChecks().some(c => c.checked); }
      function syncFullRadio() {
        const fr = fullRadio();
        if (!fr) return;
        // Keep full option always enabled; just reflect current checked state
        fr.disabled = false;
        fr.setAttribute('aria-checked', String(!!fr.checked));
      }
      if (fullRadio()) fullRadio().addEventListener('change', (e) => {
        const checked = !!e.target.checked;
        if (checked) {
          // Selecting Full clears any selected blocks but keeps them enabled
          blockChecks().forEach(c => { c.checked = false; c.disabled = false; });
          state.attendanceBlocks = [];
          state.attendanceType = 'Full';
          // Auto-advance to Step 4 (session selection)
          advanceAfterDelay(4);
        }
        syncFullRadio();
        updateReview();
        updateNextEnabled();
        if (state.step === 4) prepareStep4();
      });
      blockChecks().forEach(c => c.addEventListener('change', () => {
        // Selecting any block unchecks Full immediately, but does not disable it
        if (fullRadio()) {
          fullRadio().checked = false;
          fullRadio().removeAttribute('checked');
        }
        const chosen = blockChecks().filter(x => x.checked).map(x => x.value);
        state.attendanceBlocks = chosen;
        state.attendanceType = (chosen.length ? chosen.join(', ') : state.attendanceType);
        syncFullRadio();
        updateReview();
        updateNextEnabled();
        if (state.step === 4) prepareStep4();
      }));
      [firstName, lastName, title, company, phone, email].forEach(el => el.addEventListener('input', () => {
        // Auto-format phone number
        if (el === phone) {
          const digits = phone.value.replace(/\D/g,'').slice(0,10);
          let out = digits;
          if (digits.length > 6) out = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
          else if (digits.length > 3) out = `(${digits.slice(0,3)}) ${digits.slice(3)}`;
          phone.value = out;
        }
        updateReview();
        if (state.step === 5) updateNextEnabled();
      }));
      [firstName, lastName, phone, email].forEach(el => el.addEventListener('blur', () => {
        if (state.step === 5 && state.showFieldErrors) validateContact(true);
      }));
      applyCouponBtn.addEventListener('click', (e) => { e.preventDefault(); applyCoupon(); });

      // URL Builder interactions
      function toggleBuilder(active) {
        urlBuilderPanel.hidden = !active;
        urlBuilderPanel.dataset.builderActive = String(!!active);
        urlBuilderToggle.classList.toggle('hidden', active);
      }
      urlBuilderToggle.addEventListener('click', () => toggleBuilder(true));

      function ensureModalOpen() {
        if (modalOverlay.dataset.open !== 'true') openModal();
      }

      // Observe step 5 for any unintended attendance injections and purge
      (function observeStep5() {
        const s5 = qs('#step5');
        if (!s5 || !window.MutationObserver) return;
        const mo = new MutationObserver((mutations) => {
          let dirty = false;
          mutations.forEach(m => {
            if ([...m.addedNodes].some(node => node.nodeType === 1 && (
              node.matches?.('#attendanceOptions, .attendance-section, .option-row, #step3, input[name="attendanceTypeFull"], input[name="attendanceBlocks"]') ||
              node.querySelector?.('#attendanceOptions, .attendance-section, .option-row, #step3, input[name="attendanceTypeFull"], input[name="attendanceBlocks"]')
            ))) dirty = true;
          });
          if (dirty) hardResetStep5();
        });
        mo.observe(s5, { childList: true, subtree: true });
      })();

      // Global observer: if any duplicate step nodes are injected, re-apply visibility rules
      (function observeSteps() {
        const root = document.querySelector('.iaml-content');
        if (!root || !window.MutationObserver) return;
        const mo = new MutationObserver((mutations) => {
          let dirty = false;
          mutations.forEach(m => {
            [...m.addedNodes].forEach(node => {
              if (node.nodeType !== 1) return;
              if (/^step[1-6]$/.test(node.id)) dirty = true;
              if (node.querySelector?.('[id^="step"]')) dirty = true;
            });
          });
          if (dirty) {
            document.querySelectorAll('[id^="step"]').forEach(el => {
              el.classList.toggle('hidden', el.id !== ('step' + state.step));
            });
            if (state.step === 5) purgeAttendanceFromStep5?.();
          }
        });
        mo.observe(root, { childList: true, subtree: true });
      })();

      async function syncFormatFromBuilder() {
        const fmt = builderFormat.value;
        builderGenerateUrl();
        if (!fmt) return;
        ensureModalOpen();
        formatSelect.value = fmt;
        state.format = fmt;
        // If program is selected too, load sessions
        if (programSelect.value) {
          await loadSessions(state.program || programSelect.value, fmt);
        }
        setStep(2);
      }

      async function syncProgramFromBuilder() {
        const prog = builderProgram.value;
        builderGenerateUrl();
        if (!prog) return;
        ensureModalOpen();
        programSelect.value = prog;
        state.program = prog;
        // Load sessions for selected format+program
        if (state.format) await loadSessions(prog, state.format);
        setStep(3);
      }

      function syncBlockFromBuilder() {
        const blk = builderBlock.value; // '' | Block 1 | Block 2 | Block 3
        builderGenerateUrl();
        if (!blk) {
          const full = document.querySelector('input[name="attendanceType"][value="Full"]');
          if (full) full.checked = true;
          state.attendanceType = 'Full';
          return;
        }
        const radio = Array.from(document.querySelectorAll('input[name="attendanceType"]')).find(r => r.value.toLowerCase() === blk.toLowerCase());
        if (radio) { radio.checked = true; state.attendanceType = radio.value; }
      }

      async function syncSessionFromBuilder() {
        const sess = builderSession.value;
        builderGenerateUrl();
        if (!sess) return;
        ensureModalOpen();
        // Try to set the session dropdown if option is present
        const opt = Array.from(sessionSelect.options).find(o => o.value === sess);
        if (opt) sessionSelect.value = sess;
        state.sessionId = sess;
        await hydrateSelectedSession();
        setStep(5);
      }

      builderFormat.addEventListener('change', () => { builderRefreshSessions(); syncFormatFromBuilder(); });
      builderProgram.addEventListener('change', () => { builderRefreshSessions(); syncProgramFromBuilder(); });
      builderBlock.addEventListener('change', () => { syncBlockFromBuilder(); });
      builderSession.addEventListener('change', () => { syncSessionFromBuilder(); });
      copyBuilderUrl.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(builderUrl.value); builderMsg.textContent = 'Copied!'; } catch { builderMsg.textContent = 'Copy failed'; }
        setTimeout(() => builderMsg.textContent = '', 1200);
      });

      async function builderRefreshSessions() {
        const fmt = builderFormat.value; const prog = builderProgram.value;
        builderSession.innerHTML = '<option value="" disabled selected>Select program + format</option>';
        builderGenerateUrl();
        if (!fmt || !prog) return;
        try {
          const filter = `AND({Program}='${prog.replace(/'/g, "\\'")}', {Format}='${fmt.replace(/'/g, "\\'")}')`;
          const data = await airtableList(TABLE_SESSIONS, { filterByFormula: filter, maxRecords: 100, sort: [{ field: 'Session Start Date', direction: 'asc' }] });
          (data.records || []).forEach(rec => {
            const opt = document.createElement('option');
            opt.value = rec.id;
            opt.textContent = formatSessionLabel(rec);
            builderSession.appendChild(opt);
          });
        } catch (e) { console.warn('Builder sessions load failed', e); }
      }

      function builderGenerateUrl() {
        const base = 'https://www.iaml.com/register?register=1';
        const params = new URLSearchParams();
        const fmt = builderFormat.value; const prog = builderProgram.value; const blk = builderBlock.value; const sess = builderSession.value;
        if (prog) params.set('program', prog);
        if (fmt) params.set('format', fmt);
        if (sess) params.set('sessionId', sess);
        if (blk) { params.set('source', 'subprogram'); params.set('subTitle', blk); }
        builderUrl.value = `${base}${params.toString() ? '&' + params.toString() : ''}`;
      }

      // Prefill and auto-advance via query params
      function getQueryParams() {
        const p = new URLSearchParams(window.location.search);
        return {
          register: p.get('register'),
          program: p.get('program'),
          format: p.get('format'),
          sessionId: p.get('sessionId'),
          source: p.get('source'),
          subTitle: p.get('subTitle'),
          builder: p.get('builder'),
          loader: p.get('loader'), // overlay | skeleton | chip
        };
      }
      async function applyPrefill() {
        const qp = getQueryParams();
        // demo loader mode: default to overlay unless overridden via query
        window.demoLoaderMode = qp.loader || 'overlay';
        if (qp.builder === '1') { urlBuilderToggle.classList.remove('hidden'); toggleBuilder(true); }
        else {
          // Remove builder completely unless explicitly requested
          try { urlBuilderPanel?.remove(); } catch {}
          try { urlBuilderToggle?.remove(); } catch {}
        }
        if (qp.register === '1') openModal();
        if (qp.format) {
          if (formatSelect) { formatSelect.value = qp.format; }
          const r = getFormatRadios().find(x => x.value === qp.format);
          if (r) r.checked = true;
          state.format = qp.format;
        }
        if (qp.program && ALLOWED_PROGRAMS.includes(qp.program)) {
          if (programSelect) programSelect.value = qp.program;
          const pr = getProgramRadios().find(x => x.value === qp.program);
          if (pr) pr.checked = true;
          state.program = qp.program;
        }
        if (state.format && state.program) {
          await loadSessions(state.program, state.format);
        }
        if (qp.sessionId) {
          state.sessionId = qp.sessionId;
          // Try to select if present in dropdown; else leave selected but still hydrate
          const opt = Array.from(sessionSelect.options).find(o => o.value === qp.sessionId);
          if (opt) sessionSelect.value = qp.sessionId;
          await hydrateSelectedSession();
        }
        // Respect source/subTitle for blocks
        if (qp.source === 'subprogram' && qp.subTitle && /Block\s+[123]/i.test(qp.subTitle)) {
          const blk = qp.subTitle.match(/Block\s+[123]/i)[0];
          const radio = Array.from(document.querySelectorAll('input[name="attendanceType"]')).find(r => r.value.toLowerCase() === blk.toLowerCase());
          if (radio) { radio.checked = true; state.attendanceType = radio.value; }
        }
        // Auto-advance steps: if we have format+program, go to step 3; if sessionId as well, go to contact step
        if (state.format) setStep(2);
        if (state.format && state.program) setStep(3);
        if (state.sessionId) setStep(5);
        // One-time cleanup: ensure Step 5 doesn't show attendance UI if pre-rendered
        purgeAttendanceFromStep5();
      }

      // Initialize
      setStep(1);
      // Populate allowed programs for modal and (if present) builder
      populateProgramOptions(qs('#programSelect'));
      populateProgramOptions(qs('#builderProgram'));
      populateProgramOptions(codeProg);
      // Initialize virtual certificate pairs for Virtual format
      setTimeout(() => { try { generateVirtualCertificatePairs(); } catch {} }, 0);
      // Initialize Code Builder city list once selections are ready
      setTimeout(() => { try { codeBuilderPopulateCities().then(genCodeSnippet); } catch {} }, 0);

      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
      async function codeBuilderPopulateCities() {
        if (!codeFmt || !codeProg || !codeCity) return;
        const fmt = codeFmt.value;
        const prog = codeProg.value;
        codeCity.innerHTML = '<option value="" disabled selected>Loading…</option>';
        if (!fmt || !prog) { codeCity.innerHTML = '<option value="" disabled selected>Select format and program first</option>'; return; }
        try {
          const list = await fetchCitiesForSelection(prog, fmt);
          if (!list.length) { codeCity.innerHTML = '<option value="" disabled selected>No upcoming locations found</option>'; return; }
          codeCity.innerHTML = '<option value="" disabled selected>Select city/state</option>';
          list.forEach(({ city, state }) => {
            const opt = document.createElement('option');
            opt.value = JSON.stringify({ city, state });
            opt.textContent = city && state ? `${city}, ${state}` : (city || state || 'Online');
            codeCity.appendChild(opt);
          });
        } catch (e) { codeCity.innerHTML = '<option value="" disabled selected>Failed to load locations</option>'; }
      }

      function genCodeSnippet() {
        const fmt = codeFmt?.value || '';
        const prog = codeProg?.value || '';
        let city = codeCity?.value || '';
        let st = codeState?.value || '';
        try { if (city && city.startsWith('{')) { const obj = JSON.parse(city); city = obj.city || ''; st = obj.state || ''; } } catch {}
        const style = codeStyle?.value || 'data';
        const selector = codeSelector?.value || '';
        const modalUrl = 'https://www.iaml.com/assets/iaml-registration-modal.html';
        const loaderUrl = 'https://www.iaml.com/assets/js/iaml-loader.js';
        const scOpen = '<scr' + 'ipt';
        const scClose = '</scr' + 'ipt>';
        if (style === 'data') {
          const attrs = [
            'data-iaml-register',
            fmt ? `data-iaml-format="${escapeHtml(fmt)}"` : '',
            prog ? `data-iaml-program="${escapeHtml(prog)}"` : '',
            city ? `data-iaml-city="${escapeHtml(city)}"` : '',
            st ? `data-iaml-state="${escapeHtml(st)}"` : '',
          ].filter(Boolean).join(' ');
          codeOutput.value = `${scOpen} src="${loaderUrl}" data-iaml-modal-url="${modalUrl}" data-iaml-autobind="true">${scClose}\n<!-- Add these attributes to your existing <button> -->\n<!-- ${attrs} -->`;
        } else if (style === 'onclick') {
          const call = `window.IAMLRegistration && IAMLRegistration.open({format:'${escapeHtml(fmt)}',program:'${escapeHtml(prog)}',city:'${escapeHtml(city)}',state:'${escapeHtml(st)}'}); return false;`;
          codeOutput.value = `${scOpen} src="${loaderUrl}" data-iaml-modal-url="${modalUrl}">${scClose}\n<!-- Add this onclick to your existing <button> -->\nonclick="${call}"`;
        } else {
          const sel = selector || '#myButtonId';
          const call = `IAMLRegistration.open({format:'${escapeHtml(fmt)}',program:'${escapeHtml(prog)}',city:'${escapeHtml(city)}',state:'${escapeHtml(st)}'});`;
          codeOutput.value = `${scOpen} src="${loaderUrl}" data-iaml-modal-url="${modalUrl}">${scClose}\n${scOpen}>\ndocument.querySelector('${escapeHtml(sel)}')?.addEventListener('click', async function(e){ e.preventDefault(); if(window.IAMLLoader){ await IAMLLoader.ensureModalInjected(); } ${call} });\n${scClose}`;
        }
      }

      [codeFmt, codeProg, codeCity, codeState, codeStyle, codeSelector].forEach(el => el && el.addEventListener('change', genCodeSnippet));
      if (codeFmt) codeFmt.addEventListener('change', () => { codeBuilderPopulateCities().then(genCodeSnippet); });
      if (codeProg) codeProg.addEventListener('change', () => { codeBuilderPopulateCities().then(genCodeSnippet); });
      if (codeCity) codeCity.addEventListener('change', genCodeSnippet);
      if (copyCode) copyCode.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(codeOutput.value || ''); qs('#codeMsg').textContent = 'Copied!'; } catch { qs('#codeMsg').textContent = 'Copy failed'; }
        setTimeout(() => { const m = qs('#codeMsg'); if (m) m.textContent = ''; }, 1200);
      });
      // Add event listeners to form fields for real-time validation
      [firstName, lastName, phone, email].forEach(field => {
        if (field) {
          field.addEventListener('input', () => {
            // Add a small delay to ensure the value is updated
            setTimeout(updateNextEnabled, 10);
          });
          field.addEventListener('blur', () => {
            setTimeout(updateNextEnabled, 10);
          });
          field.addEventListener('change', () => {
            setTimeout(updateNextEnabled, 10);
          });
        }
      });
      
      applyPrefill();
      // One-time safety cleanup in case DOM was pre-rendered with attendance under step 5
      hardResetStep5();
      // Render step 2 progress on initial load (hidden until step 2 shows)
      renderProgressForStep2();
      renderProgressForStep3();
    })();
  </script>
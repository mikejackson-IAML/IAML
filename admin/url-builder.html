<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registration URL Builder | IAML Admin</title>
  <meta name="robots" content="noindex, nofollow">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
      color: #f8fafc;
      padding: 2rem;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 2rem;
      text-align: center;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(10px);
    }

    .card-title {
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #94a3b8;
      margin-bottom: 1rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #e2e8f0;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      color: #f8fafc;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.2s;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    select option {
      background: #1e293b;
      color: #f8fafc;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checkbox-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .checkbox-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .checkbox-item label {
      margin: 0;
      cursor: pointer;
    }

    .url-output {
      background: #0f172a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 0.875rem;
      word-break: break-all;
      color: #22d3ee;
      min-height: 60px;
    }

    .url-output.empty {
      color: #64748b;
      font-style: italic;
    }

    .button-row {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #f8fafc;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .copy-success {
      background: #22c55e !important;
    }

    .session-info {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-top: 0.5rem;
    }

    .hidden {
      display: none !important;
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #94a3b8;
      font-size: 0.875rem;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      color: #f87171;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .info-text {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    @media (max-width: 640px) {
      body {
        padding: 1rem;
      }

      .button-row {
        flex-direction: column;
      }

      .btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Registration URL Builder</h1>
      <p class="subtitle">Generate pre-filled registration links for IAML programs</p>
    </header>

    <div class="card">
      <h2 class="card-title">Program Selection</h2>

      <div class="form-group">
        <label for="format">Format</label>
        <select id="format">
          <option value="">-- Select Format --</option>
          <option value="in-person">In-Person</option>
          <option value="virtual">Virtual</option>
          <option value="on-demand">On-Demand</option>
        </select>
      </div>

      <div class="form-group">
        <label for="program">Program</label>
        <select id="program">
          <option value="">-- Select Program --</option>
          <option value="employee-relations-law">Certificate in Employee Relations Law</option>
          <option value="strategic-employment-law">Advanced Certificate in Strategic Employment Law</option>
          <option value="strategic-hr">Certificate in Strategic HR Management</option>
          <option value="workplace-investigations">Certificate in Workplace Investigations</option>
          <option value="employee-benefits-law">Certificate in Employee Benefits Law</option>
          <option value="advanced-benefits-law">Advanced Certificate in Employee Benefits Law</option>
        </select>
      </div>

      <div class="form-group" id="blocksGroup">
        <label>Blocks (optional)</label>
        <p class="info-text">Leave unchecked to let the user choose, or pre-select specific blocks</p>
        <div class="checkbox-group" id="blocksContainer">
          <!-- Populated by JS -->
        </div>
      </div>

      <div class="form-group" id="sessionGroup">
        <label for="session">Session (optional)</label>
        <select id="session">
          <option value="">-- User will select --</option>
        </select>
        <div class="loading hidden" id="sessionLoading">
          <div class="spinner"></div>
          <span>Loading sessions...</span>
        </div>
        <div class="error-message hidden" id="sessionError"></div>
        <p class="session-info" id="sessionInfo"></p>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Generated URL</h2>
      <div class="url-output empty" id="urlOutput">Select a format and program to generate a URL</div>
      <div class="button-row">
        <button class="btn btn-primary" id="copyBtn" disabled>
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke-width="2"/>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke-width="2"/>
          </svg>
          Copy URL
        </button>
        <a href="#" class="btn btn-secondary" id="previewBtn" target="_blank" style="display: none; text-decoration: none;">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" stroke-width="2"/>
            <polyline points="15,3 21,3 21,9" stroke-width="2"/>
            <line x1="10" y1="14" x2="21" y2="3" stroke-width="2"/>
          </svg>
          Preview
        </a>
      </div>
    </div>
  </div>

  <!-- Environment Configuration -->
  <script src="/js/env-config.local.js"></script>
  <script>
    if (typeof ENV_CONFIG === 'undefined') {
      window.ENV_CONFIG = {};
    }
  </script>

  <script>
    (function() {
      'use strict';

      // Program configuration - which programs have blocks
      const BLOCK_PROGRAMS = {
        'employee-relations-law': ['Block I', 'Block II', 'Block III'],
        'strategic-employment-law': ['Block I', 'Block II', 'Block III'],
        'workplace-investigations': ['Block I', 'Block II']
      };

      // Elements
      const formatEl = document.getElementById('format');
      const programEl = document.getElementById('program');
      const sessionEl = document.getElementById('session');
      const blocksGroup = document.getElementById('blocksGroup');
      const blocksContainer = document.getElementById('blocksContainer');
      const urlOutput = document.getElementById('urlOutput');
      const copyBtn = document.getElementById('copyBtn');
      const previewBtn = document.getElementById('previewBtn');
      const sessionLoading = document.getElementById('sessionLoading');
      const sessionError = document.getElementById('sessionError');
      const sessionInfo = document.getElementById('sessionInfo');

      // State
      let currentSessions = [];

      // Initialize
      function init() {
        formatEl.addEventListener('change', handleSelectionChange);
        programEl.addEventListener('change', handleProgramChange);
        sessionEl.addEventListener('change', updateURL);
        blocksContainer.addEventListener('change', updateURL);
        copyBtn.addEventListener('click', copyURL);

        // Initially hide blocks
        blocksGroup.classList.add('hidden');
        document.getElementById('sessionGroup').classList.add('hidden');
      }

      function handleSelectionChange() {
        const format = formatEl.value;
        const program = programEl.value;

        // Show/hide session based on format
        const sessionGroup = document.getElementById('sessionGroup');
        if (format === 'on-demand') {
          sessionGroup.classList.add('hidden');
          sessionEl.value = '';
        } else if (format && program) {
          sessionGroup.classList.remove('hidden');
          loadSessions();
        }

        updateURL();
      }

      function handleProgramChange() {
        const program = programEl.value;
        const format = formatEl.value;

        // Handle blocks
        if (BLOCK_PROGRAMS[program]) {
          populateBlocks(BLOCK_PROGRAMS[program]);
          blocksGroup.classList.remove('hidden');
        } else {
          blocksGroup.classList.add('hidden');
          blocksContainer.innerHTML = '';
        }

        // Handle sessions
        const sessionGroup = document.getElementById('sessionGroup');
        if (format && format !== 'on-demand' && program) {
          sessionGroup.classList.remove('hidden');
          loadSessions();
        } else if (!program) {
          sessionGroup.classList.add('hidden');
        }

        updateURL();
      }

      function populateBlocks(blocks) {
        blocksContainer.innerHTML = blocks.map((block, index) => `
          <label class="checkbox-item">
            <input type="checkbox" name="block" value="${index + 1}">
            <span>${block}</span>
          </label>
        `).join('');
      }

      async function loadSessions() {
        const format = formatEl.value;
        const program = programEl.value;

        if (!format || !program || format === 'on-demand') return;

        // Show loading
        sessionLoading.classList.remove('hidden');
        sessionError.classList.add('hidden');
        sessionEl.innerHTML = '<option value="">Loading...</option>';
        sessionEl.disabled = true;

        try {
          // Map program slug to full name for filtering
          const programNames = {
            'employee-relations-law': 'Certificate in Employee Relations Law',
            'strategic-employment-law': 'Advanced Certificate in Strategic Employment Law',
            'strategic-hr': 'Certificate in Strategic HR Management',
            'workplace-investigations': 'Certificate in Workplace Investigations',
            'employee-benefits-law': 'Certificate in Employee Benefits Law',
            'advanced-benefits-law': 'Advanced Certificate in Employee Benefits Law'
          };

          const formatNames = {
            'in-person': 'In-Person',
            'virtual': 'Virtual'
          };

          // Fetch sessions from Airtable proxy
          const tableId = ENV_CONFIG.AIRTABLE_PROGRAMS_TABLE || '';
          const viewId = ENV_CONFIG.AIRTABLE_VIEW_ID || '';

          if (!tableId) {
            throw new Error('Airtable configuration not found');
          }

          const url = `/api/airtable-programs?table=${encodeURIComponent(tableId)}&view=${encodeURIComponent(viewId)}&maxRecords=100`;
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error('Failed to fetch sessions');
          }

          const data = await response.json();
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          // Filter and sort sessions
          currentSessions = data.records
            .filter(record => {
              const fields = record.fields;
              // Match program
              if (!fields.Program || !fields.Program.includes(programNames[program])) {
                return false;
              }
              // Match format
              if (fields.Format !== formatNames[format]) {
                return false;
              }
              // Must have start date and be in the future
              if (!fields['Session Start Date']) {
                return false;
              }
              const startDate = new Date(fields['Session Start Date'] + 'T12:00:00');
              return startDate >= today;
            })
            .sort((a, b) => {
              const dateA = new Date(a.fields['Session Start Date']);
              const dateB = new Date(b.fields['Session Start Date']);
              return dateA - dateB;
            });

          // Populate dropdown
          sessionEl.innerHTML = '<option value="">-- User will select --</option>';

          currentSessions.forEach(session => {
            const fields = session.fields;
            const startDate = new Date(fields['Session Start Date'] + 'T12:00:00');
            const endDate = fields['Session End Date'] ? new Date(fields['Session End Date'] + 'T12:00:00') : null;

            let dateStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            if (endDate) {
              dateStr += ` - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            }

            const location = format === 'virtual'
              ? 'Virtual'
              : `${fields.City || ''}, ${fields.State || ''}`.trim().replace(/^,\s*|,\s*$/g, '') || 'TBD';

            const option = document.createElement('option');
            option.value = session.id;
            option.textContent = `${location} - ${dateStr}`;
            sessionEl.appendChild(option);
          });

          sessionEl.disabled = false;
          sessionLoading.classList.add('hidden');

          if (currentSessions.length === 0) {
            sessionInfo.textContent = 'No upcoming sessions found for this program/format combination.';
          } else {
            sessionInfo.textContent = `${currentSessions.length} upcoming session${currentSessions.length !== 1 ? 's' : ''} found.`;
          }

        } catch (error) {
          console.error('Error loading sessions:', error);
          sessionLoading.classList.add('hidden');
          sessionError.textContent = 'Could not load sessions. The URL will work without a session pre-selected.';
          sessionError.classList.remove('hidden');
          sessionEl.innerHTML = '<option value="">-- User will select --</option>';
          sessionEl.disabled = false;
        }
      }

      function updateURL() {
        const format = formatEl.value;
        const program = programEl.value;
        const session = sessionEl.value;
        const selectedBlocks = Array.from(blocksContainer.querySelectorAll('input:checked')).map(cb => cb.value);

        if (!format || !program) {
          urlOutput.textContent = 'Select a format and program to generate a URL';
          urlOutput.classList.add('empty');
          copyBtn.disabled = true;
          previewBtn.style.display = 'none';
          return;
        }

        // Build URL
        const baseUrl = window.location.origin;
        const params = new URLSearchParams();
        params.set('format', format);
        params.set('program', program);

        if (selectedBlocks.length > 0) {
          params.set('blocks', selectedBlocks.join(','));
        }

        if (session) {
          params.set('session', session);
        }

        const url = `${baseUrl}/register.html?${params.toString()}`;

        urlOutput.textContent = url;
        urlOutput.classList.remove('empty');
        copyBtn.disabled = false;
        previewBtn.href = url;
        previewBtn.style.display = 'inline-flex';
      }

      function copyURL() {
        const url = urlOutput.textContent;
        if (!url || urlOutput.classList.contains('empty')) return;

        navigator.clipboard.writeText(url).then(() => {
          copyBtn.classList.add('copy-success');
          copyBtn.innerHTML = `
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <polyline points="20,6 9,17 4,12" stroke-width="2"/>
            </svg>
            Copied!
          `;

          setTimeout(() => {
            copyBtn.classList.remove('copy-success');
            copyBtn.innerHTML = `
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke-width="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke-width="2"/>
              </svg>
              Copy URL
            `;
          }, 2000);
        }).catch(err => {
          console.error('Failed to copy:', err);
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = url;
          textArea.style.position = 'fixed';
          textArea.style.left = '-9999px';
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);

          copyBtn.textContent = 'Copied!';
          setTimeout(() => {
            copyBtn.innerHTML = `
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke-width="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke-width="2"/>
              </svg>
              Copy URL
            `;
          }, 2000);
        });
      }

      // Initialize on load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
